{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-wide' %}
{% endblock %}

{% block content %}
{% set bucket_presets = digital_code_bucket_presets or [] %}
{% set roster = digital_code_roster or [] %}
{% set extra_buckets = digital_code_extra_buckets or [] %}

<div class="digital-codes-page">
  <div class="digital-codes-page__header">
    <div>
      <p class="digital-codes-eyebrow">Admin tool</p>
      <h1>Digital Codes</h1>
      <p>Upload comma-separated codes or distribute them.</p>
    </div>
    {% if digital_codes.supported %}
      <div class="digital-codes-actions">
        <button type="button" class="btn primary" data-open-modal="upload">⬆️ Upload codes</button>
        <button type="button" class="btn" data-open-modal="send">✉️ Send code</button>
      </div>
    {% endif %}
  </div>

  {% if digital_codes.supported %}
    <section class="digital-codes-summary">
      <div class="summary-card">
        <p>Total active codes</p>
        <strong>{{ digital_codes.available_count }}</strong>
      </div>
      <div class="summary-card">
        <p>Delivered all-time</p>
        <strong>{{ digital_codes.assigned_count }}</strong>
      </div>
    </section>

    <section class="digital-codes-history">
      <div class="history-header">
        <div>
          <h3>Recent deliveries</h3>
          <p class="muted">Latest codes that landed in trainer inboxes.</p>
        </div>
        {% if digital_codes.assigned_recent %}
          <button type="button" class="btn" data-open-modal="send">Send another</button>
        {% endif %}
      </div>
      {% if digital_codes.assigned_recent %}
        <ul class="digital-code-history-list">
          {% for record in digital_codes.assigned_recent[:6] %}
            {% set code_value = record.code or '' %}
            {% set code_tail = code_value[-4:] %}
            <li>
              <div class="history-code">
                <code>••••{{ code_tail }}</code>
                <span>{{ record.category_label or 'Bucket' }}</span>
              </div>
              <div class="history-meta">
                <strong>{{ record.assigned_to or 'Unknown trainer' }}</strong>
                <small>
                  {{ record.redeemed_display or 'Just now' }}
                  {% if record.assigned_by %} • by {{ record.assigned_by }}{% endif %}
                </small>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No codes have been sent yet. Once you send a code, the delivery log will appear here.</p>
      {% endif %}
    </section>
  {% else %}
    <section class="digital-codes-empty">
      <h3>Supabase required</h3>
      <p class="muted">Connect Supabase to unlock digital code upload and delivery tooling.</p>
    </section>
  {% endif %}
</div>

{% if digital_codes.supported %}

<!-- Upload modal -->
<div class="digital-modal" id="digitalUploadModal" aria-hidden="true" hidden data-modal-root="upload" data-modal-open-class="is-open" data-modal-body-class="digital-modal-open" data-modal-lock-scroll="true">
  <div class="digital-modal__overlay" data-modal-close></div>
  <div class="digital-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="uploadModalTitle">
    <div class="digital-modal__header">
      <div>
        <p class="digital-codes-eyebrow">Upload</p>
        <h3 id="uploadModalTitle">Add digital codes</h3>
      </div>
      <button type="button" class="digital-modal__close" data-modal-close aria-label="Close">&times;</button>
    </div>
    <form method="post" action="{{ url_for('admin_digital_codes_upload') }}" class="digital-form" id="uploadForm">
      <label>
        <span>Comma separated codes (max {{ digital_codes.upload_limit }})</span>
        <textarea name="codes_csv" rows="5" placeholder="ABC-123, DEF-456, GHI-789" required></textarea>
      </label>
      <label>
        <span>Choose a bucket</span>
        <select name="bucket_choice_upload" data-upload-bucket>
          {% for preset in bucket_presets %}
            <option value="{{ preset.slug }}" {% if preset.slug == digital_code_default_bucket %}selected{% endif %}>{{ preset.label }}</option>
          {% endfor %}
          {% for option in extra_buckets %}
            <option value="{{ option.slug }}">{{ option.label }}</option>
          {% endfor %}
          <option value="custom">Create a new bucket…</option>
        </select>
      </label>
      <label data-upload-custom hidden>
        <span>New bucket name</span>
        <input type="text" name="bucket_choice_upload_custom" maxlength="80" placeholder="e.g. Event-exclusive bundle">
      </label>
      <label>
        <span>Batch label <small>(optional)</small></span>
        <input type="text" name="batch_label" maxlength="80" placeholder="GO Fest July drop">
      </label>
      <div class="digital-modal__actions">
        <button type="button" class="btn" data-modal-close>Cancel</button>
        <button type="submit" class="btn primary">Upload</button>
      </div>
    </form>
  </div>
</div>

<!-- Send modal -->
<div class="digital-modal" id="digitalSendModal" aria-hidden="true" hidden data-modal-root="send" data-modal-open-class="is-open" data-modal-body-class="digital-modal-open" data-modal-lock-scroll="true">
  <div class="digital-modal__overlay" data-modal-close></div>
  <div class="digital-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="sendModalTitle">
    <div class="digital-modal__header">
      <div>
        <p class="digital-codes-eyebrow">Delivery</p>
        <h3 id="sendModalTitle">Send a digital code</h3>
      </div>
      <button type="button" class="digital-modal__close" data-modal-close aria-label="Close">&times;</button>
    </div>
    <form method="post" action="{{ url_for('admin_digital_codes_assign') }}" class="digital-form" id="sendForm">
      <div class="trainer-picker" data-trainer-picker>
        <label>
          <span>Trainer username</span>
          <input type="search" placeholder="Search trainers…" data-trainer-search autocomplete="off">
        </label>
        <div class="trainer-picker__list" data-trainer-list>
          {% if roster %}
            {% for trainer in roster %}
              <button type="button"
                      class="trainer-picker__option"
                      data-username="{{ trainer.trainer_username }}"
                      data-account="{{ trainer.account_type or 'Trainer' }}">
                <span>{{ trainer.trainer_username }}</span>
                <small>{{ trainer.account_type or 'Trainer' }}</small>
              </button>
            {% endfor %}
          {% else %}
            <p class="empty-note">Trainer roster unavailable. Enter username manually below.</p>
          {% endif %}
        </div>
        <label class="manual-entry">
          <span>Manual entry</span>
          <input type="text" placeholder="Trainer username" data-trainer-manual>
        </label>
        <input type="hidden" name="trainer_username" data-trainer-input required>
        <p class="trainer-picker__selected" data-trainer-selected>Pick a trainer to continue.</p>
      </div>

      <label>
        <span>Bucket</span>
        <select name="bucket_choice" data-bucket-select>
          {% for preset in bucket_presets %}
            <option value="{{ preset.slug }}" {% if preset.slug == digital_code_default_bucket %}selected{% endif %}>{{ preset.label }}</option>
          {% endfor %}
          {% for option in extra_buckets %}
            <option value="{{ option.slug }}">{{ option.label }}</option>
          {% endfor %}
          <option value="custom">Custom bucket…</option>
        </select>
      </label>

      <div class="bucket-preview" data-bucket-preview>
        <p data-bucket-label>Digital Reward Bundle</p>
        <p class="muted" data-bucket-reason>Upload or send a code to see the reason preview.</p>
        <p class="muted" data-bucket-reward></p>
      </div>

      <label class="digital-code-checkbox">
        <input type="checkbox" name="use_generic_override" data-override-toggle>
        <span>Use generic override (custom bucket + messaging)</span>
      </label>

      <div class="override-fields" data-override-fields hidden>
        <label>
          <span>Custom bucket name</span>
          <input type="text" name="custom_bucket_name" maxlength="80" placeholder="Community Giveaway">
        </label>
        <label>
          <span>Custom reason shown to trainers</span>
          <textarea name="custom_reason" rows="3" placeholder="Why the trainer received this code"></textarea>
        </label>
        <label>
          <span>Custom reward description</span>
          <textarea name="custom_reward" rows="2" placeholder="Redeem this code for… (optional)"></textarea>
        </label>
        <label>
          <span>Custom inbox subject</span>
          <input type="text" name="custom_subject" placeholder="Here’s a special code from RDAB">
        </label>
      </div>

      <div class="digital-modal__actions">
        <button type="button" class="btn" data-modal-close>Cancel</button>
        <button type="submit" class="btn primary">Send inbox code</button>
      </div>
    </form>
  </div>
</div>

<!-- Confirmation modal -->
<div class="digital-modal" id="digitalConfirmModal" aria-hidden="true" hidden data-modal-root="confirm" data-modal-open-class="is-open" data-modal-body-class="digital-modal-open" data-modal-lock-scroll="true">
  <div class="digital-modal__overlay" data-modal-close></div>
  <div class="digital-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle">
    <div class="digital-modal__header">
      <div>
        <p class="digital-codes-eyebrow">Confirm</p>
        <h3 id="confirmModalTitle">Send this code?</h3>
      </div>
      <button type="button" class="digital-modal__close" data-modal-close aria-label="Close">&times;</button>
    </div>
    <div class="confirm-summary">
      <dl>
        <div>
          <dt>Trainer</dt>
          <dd data-confirm-trainer>–</dd>
        </div>
        <div>
          <dt>Bucket</dt>
          <dd data-confirm-bucket>–</dd>
        </div>
        <div>
          <dt>Reason</dt>
          <dd data-confirm-reason>–</dd>
        </div>
        <div>
          <dt>Subject</dt>
          <dd data-confirm-subject>{{ digital_code_subject_default }}</dd>
        </div>
      </dl>
      <p class="muted">This operation will send <strong>1</strong> code from the selected bucket.</p>
      <div class="confirm-preview" data-confirm-preview></div>
    </div>
    <div class="digital-modal__actions">
      <button type="button" class="btn" data-close-confirm>Go back</button>
      <button type="button" class="btn primary" data-confirm-send>Send now</button>
    </div>
  </div>
</div>

<script>
(() => {
  const bucketPresets = {{ bucket_presets|tojson }};
  const defaultBucket = "{{ digital_code_default_bucket }}";
  const defaultSubject = {{ digital_code_subject_default|tojson }};
  const presetMap = {};
  bucketPresets.forEach((preset) => {
    presetMap[preset.slug] = preset;
  });
  const sendModal = document.getElementById("digitalSendModal");
  const confirmModal = document.getElementById("digitalConfirmModal");
  let pendingForm = null;

  // Upload custom bucket toggle
  const uploadBucketSelect = document.querySelector("[data-upload-bucket]");
  const uploadCustomField = document.querySelector("[data-upload-custom]");
  if (uploadBucketSelect && uploadCustomField) {
    uploadBucketSelect.addEventListener("change", () => {
      uploadCustomField.hidden = uploadBucketSelect.value !== "custom";
    });
  }

  // Trainer picker
  document.querySelectorAll("[data-trainer-picker]").forEach((picker) => {
    const searchInput = picker.querySelector("[data-trainer-search]");
    const manualInput = picker.querySelector("[data-trainer-manual]");
    const list = picker.querySelector("[data-trainer-list]");
    const hiddenInput = picker.querySelector("[data-trainer-input]");
    const selectedLabel = picker.querySelector("[data-trainer-selected]");

    function setTrainer(username) {
      if (!hiddenInput) return;
      hiddenInput.value = username || "";
      if (selectedLabel) {
        selectedLabel.textContent = username ? `Selected: ${username}` : "Pick a trainer to continue.";
      }
    }

    if (list) {
      list.addEventListener("click", (event) => {
        const option = event.target.closest(".trainer-picker__option");
        if (!option) return;
        event.preventDefault();
        const username = option.dataset.username;
        setTrainer(username);
        if (searchInput) {
          searchInput.value = username;
        }
      });
    }

    if (manualInput) {
      manualInput.addEventListener("input", () => setTrainer(manualInput.value.trim()));
    }

    if (searchInput && list) {
      searchInput.addEventListener("input", () => {
        const term = searchInput.value.trim().toLowerCase();
        list.querySelectorAll(".trainer-picker__option").forEach((option) => {
          const username = option.dataset.username.toLowerCase();
          const account = (option.dataset.account || "").toLowerCase();
          const match = !term || username.includes(term) || account.includes(term);
          option.hidden = !match;
        });
      });
    }
  });

  // Bucket preview logic
  const bucketSelect = document.querySelector("[data-bucket-select]");
  const bucketPreview = document.querySelector("[data-bucket-preview]");
  const bucketReason = document.querySelector("[data-bucket-reason]");
  const bucketReward = document.querySelector("[data-bucket-reward]");
  const bucketLabel = document.querySelector("[data-bucket-label]");
  const overrideToggle = document.querySelector("[data-override-toggle]");
  const overrideFields = document.querySelector("[data-override-fields]");

  function updateBucketPreview() {
    if (!bucketSelect || !bucketPreview) return;
    const value = bucketSelect.value;
    const preset = presetMap[value];
    if (value === "custom") {
      bucketLabel.textContent = "Custom bucket";
      bucketReason.textContent = "Set your own reason inside the override section.";
      bucketReward.textContent = "";
      overrideFields.hidden = false;
      overrideToggle.checked = true;
    } else {
      bucketLabel.textContent = preset ? preset.label : "Bucket";
      bucketReason.textContent = preset ? preset.reason : "This bucket follows RDAB’s standard messaging.";
      bucketReward.textContent = preset && preset.reward_description ? preset.reward_description : "";
      if (!overrideToggle.checked) {
        overrideFields.hidden = true;
      }
    }
  }

  if (bucketSelect) {
    if (defaultBucket) {
      const match = Array.from(bucketSelect.options || []).find((opt) => opt.value === defaultBucket);
      if (match) {
        bucketSelect.value = defaultBucket;
      }
    }
    bucketSelect.addEventListener("change", updateBucketPreview);
    updateBucketPreview();
  }

  if (overrideToggle && overrideFields) {
    overrideToggle.addEventListener("change", () => {
      overrideFields.hidden = !overrideToggle.checked;
    });
  }

  // Confirmation dialog
  const sendForm = document.getElementById("sendForm");
  const confirmTrainer = document.querySelector("[data-confirm-trainer]");
  const confirmBucket = document.querySelector("[data-confirm-bucket]");
  const confirmReason = document.querySelector("[data-confirm-reason]");
  const confirmSubject = document.querySelector("[data-confirm-subject]");
  const confirmPreview = document.querySelector("[data-confirm-preview]");
  const confirmButton = document.querySelector("[data-confirm-send]");

  function buildPreviewText(trainer, bucketText, reasonText, rewardText) {
    return `
      <p><strong>Message preview</strong></p>
      <p>Hello ${trainer || 'Trainer'},</p>
      <p>${reasonText || 'You received a digital reward from RDAB.'}</p>
      ${rewardText ? `<p>${rewardText}</p>` : ""}
      <p>Includes a link to redeem the code and instructions on how to use it.</p>
    `;
  }

  if (sendForm) {
    sendForm.addEventListener("submit", (event) => {
      if (sendForm.dataset.confirmed === "true") {
        sendForm.dataset.confirmed = "";
        return;
      }
      event.preventDefault();

      const trainerValue = sendForm.querySelector("[data-trainer-input]")?.value || sendForm.querySelector("[data-trainer-manual]")?.value || "";
      if (!trainerValue) {
        alert("Select a trainer before sending.");
        return;
      }

      const bucketValue = bucketSelect ? bucketSelect.value : "";
      const preset = presetMap[bucketValue];
      const bucketText = preset ? preset.label : (sendForm.querySelector("[name='custom_bucket_name']")?.value || "Custom bucket");
      const reasonText =
        sendForm.querySelector("[name='custom_reason']")?.value?.trim() ||
        (preset ? preset.reason : "You received a digital reward from RDAB.");
      const rewardText =
        sendForm.querySelector("[name='custom_reward']")?.value?.trim() ||
        (preset ? preset.reward_description : "");
      const subjectText =
        sendForm.querySelector("[name='custom_subject']")?.value?.trim() ||
        (preset ? preset.subject : defaultSubject);

      if (confirmTrainer) confirmTrainer.textContent = trainerValue;
      if (confirmBucket) confirmBucket.textContent = bucketText;
      if (confirmReason) confirmReason.textContent = reasonText;
      if (confirmSubject) confirmSubject.textContent = subjectText;
      if (confirmPreview) confirmPreview.innerHTML = buildPreviewText(trainerValue, bucketText, reasonText, rewardText);

      pendingForm = sendForm;
      if (window.ModalHub) {
        window.ModalHub.open('confirm');
      } else if (confirmModal) {
        confirmModal.classList.add('is-open');
      }
    });
  }

  if (confirmButton) {
    confirmButton.addEventListener("click", () => {
      if (!pendingForm) return;
      pendingForm.dataset.confirmed = "true";
      if (window.ModalHub) {
        window.ModalHub.close('confirm');
        window.ModalHub.close('send');
      } else {
        confirmModal?.classList.remove('is-open');
        sendModal?.classList.remove('is-open');
      }
      pendingForm.submit();
      pendingForm = null;
    });
  }
})();
</script>
{% endif %}

<style>
.digital-codes-page__header {
  display:flex;
  justify-content:space-between;
  gap:18px;
  align-items:flex-start;
  flex-wrap:wrap;
  margin-bottom:20px;
}
.digital-codes-eyebrow {
  text-transform:uppercase;
  font-size:0.72rem;
  letter-spacing:0.24em;
  color:#94a3b8;
  margin:0 0 4px;
}
.digital-codes-actions {
  display:flex;
  gap:12px;
}
.digital-codes-empty {
  background:#fff;
  border-radius:18px;
  padding:18px;
  box-shadow:0 12px 24px rgba(15,23,42,0.08);
}
.digital-codes-summary {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px;
  margin-bottom:20px;
}
.summary-card {
  background:#0f172a;
  color:#f8fafc;
  border-radius:18px;
  padding:16px;
  box-shadow:0 12px 24px rgba(15,23,42,0.28);
}
.summary-card p {
  margin:0;
  text-transform:uppercase;
  font-size:0.75rem;
  letter-spacing:0.24em;
  color:#94a3b8;
}
.summary-card strong {
  display:block;
  font-size:1.9rem;
  margin-top:4px;
}
.digital-codes-history {
  background:#fff;
  border-radius:18px;
  padding:18px;
  box-shadow:0 12px 24px rgba(15,23,42,0.08);
  margin-top:14px;
}
.history-header {
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:center;
}
.digital-code-history-list {
  list-style:none;
  margin:16px 0 0;
  padding:0;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.digital-code-history-list li {
  display:flex;
  justify-content:space-between;
  align-items:center;
  border:1px solid #e2e8f0;
  border-radius:14px;
  padding:10px 14px;
  background:#f8fafc;
}
.history-code {
  display:flex;
  flex-direction:column;
  gap:2px;
}
.history-code code {
  font-family:"JetBrains Mono","SFMono-Regular",Consolas,monospace;
  background:#0f172a;
  color:#fff;
  border-radius:10px;
  padding:2px 8px;
  font-weight:600;
  letter-spacing:0.08em;
}
.history-code span {
  font-size:0.82rem;
  color:#475467;
}
.history-meta {
  text-align:right;
}
.history-meta small {
  color:#64748b;
}
.btn {
  border:none;
  border-radius:999px;
  padding:10px 18px;
  font-weight:600;
  cursor:pointer;
  background:#e2e8f0;
  color:#0f172a;
}
.btn.primary {
  background:#2563eb;
  color:#fff;
}
.digital-modal {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:var(--z-overlay);
}
.digital-modal.is-open {
  display:flex;
}
.digital-modal__overlay {
  position:absolute;
  inset:0;
  background:rgba(15,23,42,0.6);
}
.digital-modal__dialog {
  position:relative;
  background:#fff;
  border-radius:20px;
  padding:22px;
  width:min(620px, 90vw);
  max-height:90vh;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
  box-shadow:0 20px 40px rgba(15,23,42,0.25);
  z-index:var(--z-dialog);
}
.digital-modal__header {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  margin-bottom:16px;
}
.digital-modal__close {
  border:none;
  background:transparent;
  font-size:1.5rem;
  cursor:pointer;
  color:#0f172a;
}
.digital-form {
  display:flex;
  flex-direction:column;
  gap:14px;
}
.digital-form label {
  display:flex;
  flex-direction:column;
  gap:6px;
  font-weight:600;
  color:#0f172a;
}
.digital-form input,
.digital-form textarea,
.digital-form select {
  border:1px solid #d7dee8;
  border-radius:12px;
  padding:10px 12px;
  font:inherit;
  background:#f8fafc;
}
.digital-modal__actions {
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:8px;
}
.muted {
  color:#64748b;
  margin:4px 0 0;
}
.trainer-picker {
  border:1px solid #e2e8f0;
  border-radius:16px;
  padding:14px;
  background:#f8fafc;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.trainer-picker__list {
  max-height:180px;
  overflow:auto;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:8px;
}
.trainer-picker__option {
  border:1px solid #dbe2f0;
  border-radius:12px;
  padding:10px;
  background:#fff;
  text-align:left;
  cursor:pointer;
}
.trainer-picker__option span {
  display:block;
  font-weight:600;
  color:#0f172a;
}
.trainer-picker__option small {
  color:#64748b;
}
.trainer-picker__selected {
  margin:0;
  font-style:italic;
  color:#475467;
}
.bucket-preview {
  border-radius:16px;
  padding:14px;
  background:#eef2ff;
}
.bucket-preview p {
  margin:0 0 6px;
}
.digital-code-checkbox {
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:600;
}
.override-fields {
  border:1px dashed #cbd5f5;
  border-radius:16px;
  padding:12px;
  background:#fff;
}
.confirm-summary dl {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:10px;
  margin:0 0 12px;
}
.confirm-summary dt {
  font-size:0.75rem;
  text-transform:uppercase;
  letter-spacing:0.18em;
  color:#64748b;
  margin-bottom:2px;
}
.confirm-summary dd {
  margin:0;
  font-weight:600;
}
.confirm-preview {
  border-radius:12px;
  background:#f8fafc;
  padding:12px;
  font-size:0.9rem;
  color:#0f172a;
}
.manual-entry span {
  font-weight:600;
  color:#0f172a;
}
.manual-entry input {
  width:100%;
}
.empty-note {
  margin:0;
  font-style:italic;
  color:#94a3b8;
}
.btn:disabled {
  opacity:0.6;
  cursor:not-allowed;
}
body.digital-modal-open {
  overflow:hidden;
}
@media (max-width:640px) {
  .digital-modal__dialog {
    padding:16px;
  }
  .digital-codes-actions {
    width:100%;
  }
  .digital-codes-actions .btn {
    flex:1;
  }
}
</style>
{% endblock %}
