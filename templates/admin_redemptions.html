{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-wide' %}
{% endblock %}

{% block content %}

<h1>üéÅ Redemptions Manager</h1>

<!-- Stat Cards -->
<div class="stats-summary">
  <div class="stat-card">
    <h3 id="stat-total">{{ stats.total }}</h3>
    <p>Total</p>
  </div>
  <div class="stat-card">
    <h3 id="stat-pending">{{ stats.pending }}</h3>
    <p>Pending</p>
  </div>
  <div class="stat-card">
    <h3 id="stat-fulfilled">{{ stats.fulfilled }}</h3>
    <p>Fulfilled</p>
  </div>
  <div class="stat-card">
    <h3 id="stat-cancelled">{{ stats.cancelled }}</h3>
    <p>Cancelled</p>
  </div>
</div>

<!-- Filters -->
<form method="get" class="filters">
  <label>
    Status:
    <select name="status" onchange="this.form.submit()">
      <option value="ALL" {% if status_filter=='ALL' %}selected{% endif %}>All</option>
      <option value="PENDING" {% if status_filter=='PENDING' %}selected{% endif %}>Pending</option>
      <option value="FULFILLED" {% if status_filter=='FULFILLED' %}selected{% endif %}>Fulfilled</option>
      <option value="CANCELLED" {% if status_filter=='CANCELLED' %}selected{% endif %}>Cancelled</option>
    </select>
  </label>
  <label>
    Trainer:
    <input type="text" name="search" value="{{ search_user }}" placeholder="Search by username">
  </label>
  <button type="submit">Filter</button>
</form>

<!-- Redemption Logs -->
<h2>üóÇÔ∏è Recent Redemptions</h2>
<div class="table-scroll">
  <table class="stats-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Trainer</th>
        <th>Status</th>
        <th>Item</th>
        <th>Pickup Meetup</th>
        <th>Stamps</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for r in redemptions %}
      <tr data-id="{{ r.id }}">
        <td>{{ r.created_at|to_date }}</td>
        <td>{{ r.trainer_username }}</td>
        <td class="status-cell">{{ r.status }}</td>
        <td>{{ (r.item_snapshot.name if r.item_snapshot else '') or 'Unknown Item' }}</td>
        <td class="meetup-cell">{{ r.meetup_display or '‚Äî' }}</td>
        <td>{{ r.stamps_spent }}</td>
        <td class="actions-cell">
          {% if r.status == "PENDING" %}
            <button type="button" class="success action-btn"
                    data-id="{{ r.id }}" data-action="fulfill">
              Fulfill
            </button>
            <button type="button" class="danger action-btn"
                    data-id="{{ r.id }}" data-action="cancel">
              Cancel
            </button>
          {% else %}
            <span class="muted">‚Äî</span>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7">No redemptions found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
<div class="pagination">
  {% if page > 1 %}
    <a href="{{ url_for('admin_redemptions', page=page-1, status=status_filter, search=search_user) }}">‚¨Ö Prev</a>
  {% endif %}
  <span>Page {{ page }}</span>
  {% if has_more %}
    <a href="{{ url_for('admin_redemptions', page=page+1, status=status_filter, search=search_user) }}">Next ‚û°</a>
  {% endif %}
</div>

<style>
.stats-summary {display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:24px;}
.stat-card {background:#fff;border-radius:16px;padding:18px;text-align:center;box-shadow:0 10px 24px rgba(15,23,42,0.12);}
.stat-card h3 { margin:0; font-size:1.8em; color:#1d4ed8; }
.stat-card p { margin:6px 0 0; font-size:0.9em; color:#64748b; font-weight:600; }

.filters {display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;align-items:flex-end;}
.filters label {font-size:0.9em;color:#475569;font-weight:600;display:flex;flex-direction:column;gap:6px;}
.filters input, .filters select {padding:10px 12px;border:1px solid #d7dbe6;border-radius:12px;font-size:0.9rem;}
.filters button {background:#3a8dde;color:#fff;border:none;padding:10px 16px;border-radius:999px;font-weight:600;cursor:pointer;box-shadow:0 8px 20px rgba(58,141,222,0.25);}

.table-scroll{overflow-x:auto;border-radius:16px;box-shadow:0 10px 24px rgba(15,23,42,0.12);}
.stats-table { width:100%; border-collapse:separate; border-spacing:0; min-width:720px; }
.stats-table th { text-align:left; font-size:0.85rem; font-weight:700; padding:12px 14px; background:#f1f5f9; color:#1f2937; }
.stats-table td { padding:12px 14px; border-top:1px solid #e2e8f0; font-size:0.9rem; color:#334155; }
.stats-table tbody tr:nth-child(even){ background:#f8fafc; }
.meetup-cell { max-width:240px; white-space:normal; word-break:break-word; color:#1f2937; }
.muted{color:#94a3b8;}
.success {background:#22c55e;color:white;border:none;padding:8px 12px;border-radius:999px;font-weight:600;cursor:pointer;box-shadow:0 6px 16px rgba(34,197,94,0.22);}
.danger {background:#ef4444;color:white;border:none;padding:8px 12px;border-radius:999px;font-weight:600;cursor:pointer;box-shadow:0 6px 16px rgba(239,68,68,0.22);}
.pagination {margin-top:18px;display:flex;justify-content:center;gap:12px;align-items:center;}
.pagination a{color:#1d4ed8;text-decoration:none;font-weight:600;}
</style>

<!-- AJAX Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".action-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const redemptionId = btn.dataset.id;
      const action = btn.dataset.action;

      if (action === "cancel" &&
          !confirm("Cancel this redemption?")) return;

      try {
        const resp = await fetch(`/admin/redemptions/${redemptionId}/${action}`, {
          method: "POST",
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
        const data = await resp.json();

        if (data.success) {
          const row = btn.closest("tr");
          row.querySelector(".status-cell").textContent = data.new_status;
          row.querySelector(".actions-cell").innerHTML = "<span style='color:#777;'>‚Äî</span>";

          // Update stat cards
          if (data.stats) {
            document.getElementById("stat-total").textContent = data.stats.total;
            document.getElementById("stat-pending").textContent = data.stats.pending;
            document.getElementById("stat-fulfilled").textContent = data.stats.fulfilled;
            document.getElementById("stat-cancelled").textContent = data.stats.cancelled;
          }
        } else {
          alert("‚ùå " + (data.error || "Failed to update"));
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Request failed");
      }
    });
  });
});
</script>

{% endblock %}
