{% extends "base.html" %}
{% block content %}

<h1>üéÅ Redemptions Manager</h1>

<!-- Stat Cards -->
<div class="stats-summary">
  <div class="stat-card">
    <h3 id="stat-total">{{ stats.total }}</h3>
    <p>Total</p>
  </div>
  <div class="stat-card">
    <h3 id="stat-pending">{{ stats.pending }}</h3>
    <p>Pending</p>
  </div>
  <div class="stat-card">
    <h3 id="stat-fulfilled">{{ stats.fulfilled }}</h3>
    <p>Fulfilled</p>
  </div>
  <div class="stat-card">
    <h3 id="stat-cancelled">{{ stats.cancelled }}</h3>
    <p>Cancelled</p>
  </div>
</div>

<!-- Filters -->
<form method="get" class="filters">
  <label>
    Status:
    <select name="status" onchange="this.form.submit()">
      <option value="ALL" {% if status_filter=='ALL' %}selected{% endif %}>All</option>
      <option value="PENDING" {% if status_filter=='PENDING' %}selected{% endif %}>Pending</option>
      <option value="FULFILLED" {% if status_filter=='FULFILLED' %}selected{% endif %}>Fulfilled</option>
      <option value="CANCELLED" {% if status_filter=='CANCELLED' %}selected{% endif %}>Cancelled</option>
    </select>
  </label>
  <label>
    Trainer:
    <input type="text" name="search" value="{{ search_user }}" placeholder="Search by username">
  </label>
  <button type="submit">Filter</button>
</form>

<!-- Redemption Logs -->
<h2>üóÇÔ∏è Recent Redemptions</h2>
<table class="stats-table">
  <thead>
    <tr>
      <th>Date</th>
      <th>Trainer</th>
      <th>Status</th>
      <th>Item</th>
      <th>Stamps</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for r in redemptions %}
    <tr data-id="{{ r.id }}">
      <td>{{ r.created_at|to_date }}</td>
      <td>{{ r.trainer_username }}</td>
      <td class="status-cell">{{ r.status }}</td>
      <td>{{ (r.item_snapshot.name if r.item_snapshot else '') or 'Unknown Item' }}</td>
      <td>{{ r.stamps_spent }}</td>
      <td class="actions-cell">
        {% if r.status == "PENDING" %}
          <button type="button" class="success action-btn"
                  data-id="{{ r.id }}" data-action="fulfill">
            Fulfill
          </button>
          <button type="button" class="danger action-btn"
                  data-id="{{ r.id }}" data-action="cancel">
            Cancel
          </button>
        {% else %}
          <span style="color:#777;">‚Äî</span>
        {% endif %}
      </td>
    </tr>
    {% else %}
    <tr><td colspan="6">No redemptions found.</td></tr>
    {% endfor %}
  </tbody>
</table>

<!-- Pagination -->
<div class="pagination">
  {% if page > 1 %}
    <a href="{{ url_for('admin_redemptions', page=page-1, status=status_filter, search=search_user) }}">‚¨Ö Prev</a>
  {% endif %}
  <span>Page {{ page }}</span>
  {% if has_more %}
    <a href="{{ url_for('admin_redemptions', page=page+1, status=status_filter, search=search_user) }}">Next ‚û°</a>
  {% endif %}
</div>

<style>
.stats-summary {
  display:flex;
  gap:12px;
  margin-bottom:20px;
}
.stat-card {
  flex:1;
  background:#fff;
  border-radius:10px;
  padding:15px;
  text-align:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.stat-card h3 { margin:0; font-size:1.8em; color:#3a8dde; }
.stat-card p { margin:6px 0 0; font-size:0.9em; color:#555; }

.filters {
  display:flex;
  gap:10px;
  margin-bottom:20px;
  flex-wrap:wrap;
}
.filters label {
  font-size:0.9em;
  color:#333;
}
.filters input, .filters select {
  margin-left:6px;
  padding:6px 8px;
  border:1px solid #ccc;
  border-radius:6px;
}
.filters button {
  background:#3a8dde;
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}

.stats-table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
.stats-table th, .stats-table td {
  padding:10px;
  border:1px solid #ddd;
  text-align:left;
}
.stats-table th {
  background:#f4f7fa;
  color:#333;
}
.success {
  background:#4caf50;
  color:white;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}
.danger {
  background:#ef4444;
  color:white;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  font-weight:600;
  cursor:pointer;
}
.pagination {
  margin-top:15px;
  display:flex;
  justify-content:center;
  gap:10px;
  align-items:center;
}
</style>

<!-- AJAX Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".action-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const redemptionId = btn.dataset.id;
      const action = btn.dataset.action;

      if (action === "cancel" &&
          !confirm("Cancel this redemption?")) return;

      try {
        const resp = await fetch(`/admin/redemptions/${redemptionId}/${action}`, {
          method: "POST",
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
        const data = await resp.json();

        if (data.success) {
          const row = btn.closest("tr");
          row.querySelector(".status-cell").textContent = data.new_status;
          row.querySelector(".actions-cell").innerHTML = "<span style='color:#777;'>‚Äî</span>";

          // Update stat cards
          if (data.stats) {
            document.getElementById("stat-total").textContent = data.stats.total;
            document.getElementById("stat-pending").textContent = data.stats.pending;
            document.getElementById("stat-fulfilled").textContent = data.stats.fulfilled;
            document.getElementById("stat-cancelled").textContent = data.stats.cancelled;
          }
        } else {
          alert("‚ùå " + (data.error || "Failed to update"));
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Request failed");
      }
    });
  });
});
</script>

{% endblock %}