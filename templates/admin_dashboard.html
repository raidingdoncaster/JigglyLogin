{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-wide' %}
{% endblock %}

{% block content %}

<!-- Header -->
<div class="admin-header">
  <h1>üëë Admin Dashboard</h1>
  <p>Manage Catalog, Meet-ups, Redemptions, and System Settings.</p>
</div>

<!-- Quick Stats -->
<div class="admin-stats">
  <div class="stat-card">
    <h3>üì¶</h3>
    <p>Active Catalog Items</p>
    <span>{{ active_catalog_items or 0 }}</span>
  </div>
  <div class="stat-card">
    <h3>üéÅ</h3>
    <p>Pending Redemptions</p>
    <span>{{ pending_redemptions or 0 }}</span>
  </div>
  <div class="stat-card">
    <h3>üë•</h3>
    <p>Registered Trainers</p>
    <span>{{ registered_trainers or 0 }}</span>
  </div>
</div>

<!-- Admin Apps -->
<div class="explore">
  <h3>üõ†Ô∏è Management Panels</h3>
  <div class="explore-grid">
    <a class="explore-card" href="{{ url_for('admin_trainers') }}">
      <img src="{{ url_for('static', filename='icons/admin/trainer-manager.png') }}" alt="Trainer Manager">
      <span>Trainer Manager</span>
    </a>
    <a class="explore-card" href="{{ url_for('admin_classic_stamps') }}">
      <img src="{{ url_for('static', filename='icons/classic.png') }}" alt="Classic Stamps">
      <span>Classic Stamps</span>
    </a>
    <a class="explore-card" href="{{ url_for('admin_stats') }}">
      <img src="{{ url_for('static', filename='icons/admin/rdab-stats.png') }}" alt="RDAB Stats">
      <span>RDAB Stats</span>
    </a>
    {% if show_leagues_app %}
      <a class="explore-card" href="{{ url_for('admin_leagues') }}">
        <img src="{{ url_for('static', filename='icons/leagues-app.png') }}" alt="Leagues Hub">
        <span>Leagues Hub</span>
      </a>
    {% endif %}
    <a class="explore-card" href="{{ url_for('admin_notifications') }}">
      <img src="{{ url_for('static', filename='icons/admin/notification-center.png') }}" alt="Notifications Center">
      <span>Notifications Center</span>
    </a>
    <a class="explore-card" href="{{ url_for('admin_catalog') }}">
      <img src="{{ url_for('static', filename='icons/admin/catalog-manager.png') }}" alt="Catalog Manager">
      <span>Catalog Manager</span>
    </a>
    <a class="explore-card" href="{{ url_for('admin_bulletin') }}">
      <img src="{{ url_for('static', filename='icons/admin/community-bulletin.svg') }}" alt="Community Bulletin">
      <span>Community Bulletin</span>
    </a>
    {% if show_city_perks_app %}
      <a class="explore-card" href="{{ url_for('admin_city_perks.list_city_perks') }}">
        <img src="{{ url_for('static', filename='icons/perks-app.png') }}" alt="City Perks">
        <span>City Perks</span>
      </a>
    {% endif %}
    <a class="explore-card" href="{{ url_for('admin_meetups') }}">
      <img src="{{ url_for('static', filename='icons/admin/meetups-manager.png') }}" alt="Meetup Manager">
      <span>Meetups Manager</span>
    </a>
    <a class="explore-card" href="{{ url_for('admin_calendar_events') }}">
      <img src="{{ url_for('static', filename='icons/catalog-app.png') }}" alt="Calendar Events">
      <span>Calendar Events</span>
    </a>
    <a class="explore-card" href="{{ url_for('admin_redemptions') }}">
      <img src="{{ url_for('static', filename='icons/admin/redemptions-manager.png') }}" alt="Redemptions Manager">
      <span>Redemptions Manager</span>
    </a>
</div>
</div>

<!-- Digital Codes Panel -->
  {% if digital_codes.supported %}
    <section class="digital-codes-panel">
      <div class="digital-code-summary-widget">
        <div class="digital-code-summary-total">
          <p>Total active codes</p>
          <strong>{{ digital_codes.available_count }}</strong>
        </div>
        <div class="digital-code-summary-buckets">
          {% if digital_codes.available_bucket_totals %}
            {% for bucket in digital_codes.available_bucket_totals %}
              <span class="digital-code-chip">
                {{ bucket.category or 'General' }} ¬∑ {{ bucket.count }}
              </span>
            {% endfor %}
          {% else %}
            <span class="digital-code-chip is-empty">No buckets yet</span>
          {% endif %}
        </div>
      </div>
      <div class="digital-codes-header">
        <div>
          <p class="digital-codes-eyebrow">Digital Codes</p>
          <h3>Reward Codes Inbox Drops</h3>
        <p>Upload comma-separated codes, then assign them directly to trainers with an inbox notification.</p>
      </div>
      <div class="digital-codes-metrics">
        <div>
          <span>Available</span>
          <strong>{{ digital_codes.available_count }}</strong>
        </div>
        <div>
          <span>Delivered</span>
          <strong>{{ digital_codes.assigned_count }}</strong>
        </div>
      </div>
    </div>
    {% if digital_codes.error %}
      <div class="digital-code-alert">{{ digital_codes.error }}</div>
    {% endif %}
    <div class="digital-codes-grid">
      <form class="digital-code-card" method="post" action="{{ url_for('admin_digital_codes_upload') }}">
        <h4>1. Upload Codes</h4>
        <label for="codes_csv">Comma separated codes (max {{ digital_codes.upload_limit }})</label>
        <textarea id="codes_csv" name="codes_csv" rows="4" placeholder="ABC-123,DEF-456" required></textarea>
        <label for="code_category">Category bucket</label>
        <input
          id="code_category"
          name="code_category"
          type="text"
          list="digital-code-category-options"
          value="{{ digital_codes.default_category }}"
          maxlength="80"
          placeholder="e.g. Catalog Rewards"
        >
        <label for="batch_label">Batch label <small>(optional, helps with tracking)</small></label>
        <input id="batch_label" name="batch_label" type="text" maxlength="80" placeholder="Example: GO Fest April drop">
        <button type="submit">Upload Codes</button>
      </form>
      <form class="digital-code-card" method="post" action="{{ url_for('admin_digital_codes_assign') }}">
        <h4>2. Send to a Trainer</h4>
        <label for="trainer_username">Trainer username</label>
        <input id="trainer_username" name="trainer_username" type="text" list="digital-code-trainers" placeholder="Trainer name" required autocomplete="off">
        <label for="code_id">Choose a specific code (optional)</label>
        <select id="code_id" name="code_id">
          <option value="">Auto-pick next available</option>
          {% for code in digital_codes.available_codes %}
            <option value="{{ code.id }}">{{ code.code }} ({{ code.category }})</option>
          {% endfor %}
        </select>
        <label for="assign_category">Preferred bucket (auto-pick)</label>
        <select id="assign_category" name="code_category">
          <option value="">Any bucket</option>
          {% for category in digital_codes.category_options %}
            <option value="{{ category }}">{{ category }}</option>
          {% endfor %}
        </select>
        <label for="subject">Inbox subject</label>
        <input id="subject" name="subject" type="text" value="{{ digital_code_subject_default }}">
        <label for="reward_contents">Reward contents <small>(used for custom buckets)</small></label>
        <textarea id="reward_contents" name="reward_contents" rows="3" placeholder="e.g., Redeem for Mega Energy and Stardust boosts"></textarea>
        <label for="assignment_source">Source tag</label>
        <input
          id="assignment_source"
          name="assignment_source"
          type="text"
          list="digital-code-source-options"
          maxlength="80"
          value="{{ digital_code_source_default or 'admin_dashboard_manual' }}"
          placeholder="catalog_redemption"
        >
        <button type="submit">Send Inbox Code</button>
      </form>
      <div class="digital-code-card digital-code-card--inventory">
        <h4>Inventory</h4>
        {% if digital_codes.available_buckets %}
          <div class="digital-code-buckets">
            {% for bucket in digital_codes.available_buckets %}
              <section class="digital-code-bucket">
                <header>
                  <strong>{{ bucket.category or 'General' }}</strong>
                  <span class="digital-code-tag">{{ bucket.count }}</span>
                </header>
                <ul>
                  {% for record in bucket.codes %}
                    <li>
                      <code>{{ record.code }}</code>
                      <span>{{ record.batch_label or 'Unlabelled batch' }}</span>
                      <small>{{ record.created_display }}</small>
                    </li>
                  {% endfor %}
                </ul>
              </section>
            {% endfor %}
          </div>
        {% else %}
          <p class="digital-code-empty">No codes uploaded yet.</p>
        {% endif %}
      </div>
      <div class="digital-code-card digital-code-card--history">
        <h4>Recent deliveries</h4>
        {% if digital_codes.assigned_recent %}
          <ul>
            {% for record in digital_codes.assigned_recent %}
              <li>
                <div>
                  <code>{{ record.code }}</code> ‚Üí <strong>{{ record.assigned_to or 'Unknown' }}</strong>
                  <span class="digital-code-tag">{{ record.category or 'General' }}</span>
                </div>
                <small>
                  Redeemed {{ record.redeemed_display or 'Just now' }}
                  {% if record.assigned_by %}
                    ‚Ä¢ by {{ record.assigned_by }}
                    {% if record.assigned_by_type %} ({{ record.assigned_by_type|title }}){% endif %}
                  {% endif %}
                  {% if record.assigned_source %} ‚Ä¢ via {{ record.assigned_source }}{% endif %}
                  {% if record.batch_label %} ‚Ä¢ {{ record.batch_label }}{% endif %}
                </small>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="digital-code-empty">Deliveries will appear here once you send a code.</p>
        {% endif %}
      </div>
    </div>
  </section>
  <datalist id="digital-code-trainers">
    {% for trainer in digital_code_roster %}
      <option value="{{ trainer.trainer_username }}"></option>
    {% endfor %}
  </datalist>
  <datalist id="digital-code-category-options">
    {% for category in digital_codes.category_options %}
      <option value="{{ category }}"></option>
    {% endfor %}
  </datalist>
  <datalist id="digital-code-source-options">
    {% for source in digital_codes.source_suggestions %}
      <option value="{{ source }}"></option>
    {% endfor %}
  </datalist>
{% else %}
  <section class="digital-codes-panel is-disabled">
    <div>
      <p class="digital-codes-eyebrow">Digital Codes</p>
      <h3>Supabase required</h3>
      <p>Connect Supabase to enable bulk code uploads and inbox delivery tooling.</p>
    </div>
  </section>
{% endif %}

<!-- RDAB Support Widget -->
<div class="rdab-support-widget">
  <div class="rdab-support-widget__header">
    <div>
      <p class="rdab-support-widget__eyebrow">Support Ops</p>
      <h3>RDAB Support</h3>
    </div>
    <a class="rdab-support-widget__cta" href="{{ url_for('admin_rdab_support') }}">View RDAB Support</a>
  </div>
  <div class="rdab-support-widget__body">
    <p class="rdab-support-widget__empty">No support threads yet. This panel is standing by for future tooling.</p>
  </div>
</div>

<div class="testing-banner">
  <div>
    <p class="testing-banner__eyebrow">Prototype Lab</p>
    <h3>Testing Grounds</h3>
    <p>Try experimental features like the Advent Calendar before trainers see them.</p>
  </div>
  <div class="testing-banner__actions">
    <a class="testing-banner__cta" href="{{ url_for('admin_testing_grounds') }}">Enter Testing Grounds</a>
    <a class="testing-banner__cta is-secondary" href="{{ url_for('player_advent.view_calendar') }}">Open Player Advent</a>
  </div>
</div>

<style>
.admin-header { text-align:center; margin-bottom:20px; }
.admin-header h1 { margin:0; }
.admin-header p { color:#666; font-size:0.95em; }

.admin-stats {
  display:flex;
  gap:16px;
  margin-bottom:24px;
  flex-wrap:nowrap;
  overflow-x:auto;
  scrollbar-width:none;
}
.admin-stats::-webkit-scrollbar { display:none; }
.stat-card {
  background:#fff;
  border-radius:14px;
  padding:18px;
  text-align:center;
  box-shadow:0 8px 20px rgba(15,23,42,0.12);
  flex:1 1 200px;
  min-width:200px;
}
.stat-card h3 { margin:0; font-size:1.5em; }
.stat-card p { margin:6px 0; font-size:0.9em; color:#3a8dde; }
.stat-card span { font-size:1.3em; font-weight:700; }

.explore-grid {
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:14px;
  margin-top:18px;
}
.explore-card {
  background:transparent;
  border-radius:16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:12px 0;
  text-decoration:none;
  color:#333;
  transition:transform .18s ease;
}
.explore-card:hover { transform:translateY(-3px); }
.explore-card img { width:clamp(56px,15vw,80px); height:clamp(56px,15vw,80px); filter:drop-shadow(0 12px 20px rgba(15,23,42,0.18)); }
.explore-card span {
  margin-top:8px;
  font-size:0.9em;
  font-weight:600;
  text-shadow:0 6px 12px rgba(15,23,42,0.1);
}
.explore-card.is-disabled {
  opacity:0.45;
  pointer-events:none;
  filter:grayscale(0.2);
}
.explore-card.is-disabled small {
  display:block;
  margin-top:4px;
  font-size:0.75em;
  color:#667085;
}
.digital-codes-panel {
  margin-top:30px;
  padding:24px;
  border-radius:24px;
  background:#f8fafc;
  box-shadow:inset 0 0 0 1px rgba(15,23,42,0.04);
}
.digital-codes-panel.is-disabled {
  background:#f1f5f9;
  text-align:center;
  opacity:0.7;
}
.digital-codes-header {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:18px;
  flex-wrap:wrap;
}
.digital-codes-eyebrow {
  text-transform:uppercase;
  font-size:0.72rem;
  letter-spacing:0.24em;
  color:#94a3b8;
  margin:0 0 6px;
}
.digital-codes-metrics {
  display:flex;
  gap:18px;
}
.digital-codes-metrics div {
  background:#fff;
  border-radius:16px;
  padding:12px 18px;
  min-width:120px;
  box-shadow:0 6px 16px rgba(15,23,42,0.08);
  text-align:center;
}
.digital-codes-metrics span {
  display:block;
  font-size:0.78rem;
  text-transform:uppercase;
  letter-spacing:0.08em;
  color:#64748b;
}
.digital-codes-metrics strong {
  display:block;
  font-size:1.4rem;
  color:#0f172a;
}
.digital-codes-grid {
  margin-top:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:18px;
}
.digital-code-card {
  background:#fff;
  border-radius:18px;
  padding:18px;
  box-shadow:0 12px 24px rgba(15,23,42,0.08);
  display:flex;
  flex-direction:column;
  gap:12px;
}
.digital-code-card h4 {
  margin:0;
  font-size:1rem;
}
.digital-code-card label {
  font-size:0.85rem;
  font-weight:600;
  color:#0f172a;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.digital-code-card label small {
  font-weight:400;
  color:#64748b;
}
.digital-code-card input,
.digital-code-card textarea,
.digital-code-card select {
  width:100%;
  border-radius:12px;
  border:1px solid #d7dee8;
  padding:10px 12px;
  font:inherit;
  background:#f8fafc;
}
.digital-code-card textarea {
  resize:vertical;
  min-height:100px;
}
.digital-code-card button {
  margin-top:auto;
  align-self:flex-end;
  padding:10px 20px;
  border-radius:999px;
  background:#2563eb;
  color:#fff;
  border:none;
  font-weight:600;
  cursor:pointer;
  transition:background .18s ease;
}
.digital-code-card button:hover { background:#1e40af; }
.digital-code-card ul {
  list-style:none;
  padding:0;
  margin:0;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.digital-code-card li code {
  background:#eff6ff;
  color:#1d4ed8;
  font-family:"JetBrains Mono", "SFMono-Regular", Consolas, monospace;
  border-radius:10px;
  padding:3px 10px;
  display:inline-block;
}
.digital-code-card li span {
  display:block;
  font-size:0.8rem;
  color:#4b5563;
}
.digital-code-card li small {
  display:block;
  font-size:0.75rem;
  color:#94a3b8;
}
.digital-code-empty {
  margin:0;
  color:#64748b;
  font-style:italic;
}
.digital-code-alert {
  background:#fef2f2;
  border:1px solid #fecaca;
  border-radius:16px;
  padding:10px 16px;
  color:#b91c1c;
  font-weight:600;
}
.digital-code-summary-widget {
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  gap:16px;
  margin-bottom:20px;
  padding:16px 20px;
  border-radius:20px;
  background:#0f172a;
  color:#f8fafc;
  box-shadow:0 14px 30px rgba(15,23,42,0.4);
}
.digital-code-summary-total p {
  margin:0;
  text-transform:uppercase;
  font-size:0.75rem;
  letter-spacing:0.22em;
  color:#94a3b8;
}
.digital-code-summary-total strong {
  display:block;
  font-size:2rem;
  margin-top:4px;
}
.digital-code-summary-buckets {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.digital-code-chip {
  border-radius:999px;
  background:#e0f2fe;
  color:#0369a1;
  padding:4px 14px;
  font-size:0.8rem;
  font-weight:600;
}
.digital-code-chip.is-empty {
  background:#cbd5f5;
  color:#1e1b4b;
}
.digital-code-tag {
  border-radius:999px;
  background:#e0f2fe;
  color:#0369a1;
  padding:2px 10px;
  font-size:0.75rem;
  font-weight:600;
}
.digital-code-buckets {
  display:flex;
  flex-direction:column;
  gap:14px;
}
.digital-code-bucket header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:6px;
}
.digital-code-bucket ul {
  gap:10px;
}
.rdab-support-widget {
  margin-top:28px;
  padding:24px;
  border-radius:20px;
  background:#fff;
  box-shadow:0 12px 28px rgba(15,23,42,0.12);
}
.rdab-support-widget__header {
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:18px;
  flex-wrap:wrap;
}
.rdab-support-widget__eyebrow {
  margin:0;
  text-transform:uppercase;
  font-size:0.72rem;
  letter-spacing:0.24em;
  color:#94a3b8;
}
.rdab-support-widget__header h3 {
  margin:4px 0 0;
}
.rdab-support-widget__cta {
  margin-left:auto;
  padding:10px 18px;
  border-radius:999px;
  background:var(--brand);
  color:#fff;
  text-decoration:none;
  font-weight:600;
  font-size:0.9rem;
  white-space:nowrap;
  box-shadow:0 12px 24px rgba(58,141,222,0.35);
}
.rdab-support-widget__cta:hover {
  background:#2f73bb;
}
.rdab-support-widget__body {
  margin-top:18px;
  min-height:140px;
  border:2px dashed rgba(148,163,184,0.5);
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:28px;
  text-align:center;
  color:#64748b;
}
.rdab-support-widget__empty {
  margin:0;
  font-weight:600;
}
.testing-banner {
  margin-top:32px;
  padding:20px 24px;
  border-radius:18px;
  background:linear-gradient(135deg,#1f1c2c,#928dab);
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
  flex-wrap:wrap;
}
.testing-banner__eyebrow {
  text-transform:uppercase;
  font-size:0.75rem;
  letter-spacing:0.2em;
  margin:0 0 6px 0;
}
.testing-banner h3 {
  margin:0 0 4px 0;
}
.testing-banner p {
  margin:0;
  max-width:520px;
}
.testing-banner__cta {
  background:#fff;
  color:#1f1c2c;
  padding:12px 24px;
  border-radius:999px;
  text-decoration:none;
  font-weight:600;
  white-space:nowrap;
}
.testing-banner__actions {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.testing-banner__cta.is-secondary {
  background:transparent;
  color:#fff;
  border:1px solid rgba(255,255,255,0.6);
}
.testing-banner__cta:hover {
  background:rgba(255,255,255,0.85);
}
@media(max-width:720px){
  .admin-header{ text-align:left; }
  .rdab-support-widget__header{
    flex-direction:column;
    align-items:flex-start;
  }
  .rdab-support-widget__cta{
    width:100%;
    text-align:center;
  }
  .testing-banner {
    flex-direction:column;
    align-items:flex-start;
  }
  .testing-banner__cta {
    width:100%;
    text-align:center;
  }
}
</style>

{% endblock %}
