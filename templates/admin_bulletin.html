{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-wide' %}
{% endblock %}

{% block content %}
<section class="bulletin-admin">
  <div class="bulletin-admin__header">
    <div>
      <p class="bulletin-admin__eyebrow">Community Ops</p>
      <h1>üì∞ Community Bulletin</h1>
      <p>Monitor analytics, moderate comments, and compose new posts with the responsive builder.</p>
    </div>
  </div>

  {% if not supabase_enabled %}
    <div class="bulletin-admin__alert">
      <strong>Supabase is disabled.</strong>
      <p>Enable Supabase credentials to manage the Community Bulletin.</p>
    </div>
  {% else %}
    <div class="bulletin-admin__stats">
      <div class="stat-card">
        <p>Total Posts</p>
        <strong>{{ stats.total_posts }}</strong>
      </div>
      <div class="stat-card">
        <p>Published</p>
        <strong>{{ stats.published_posts }}</strong>
      </div>
      <div class="stat-card">
        <p>Featured</p>
        <strong>{{ stats.featured_posts }}</strong>
      </div>
      <div class="stat-card">
        <p>Likes Logged</p>
        <strong>{{ stats.total_likes }}</strong>
      </div>
      <div class="stat-card">
        <p>Total Comments</p>
        <strong>{{ stats.total_comments }}</strong>
      </div>
    </div>

    <div class="bulletin-admin__grid">
      <section class="bulletin-card">
        <div class="bulletin-card__head">
          <div>
            <h2>Posts</h2>
            <p>Tap a row to edit in the builder.</p>
          </div>
        </div>
        <div class="bulletin-table__wrap">
          <table class="bulletin-table">
            <thead>
              <tr>
                <th>Title</th>
                <th>Status</th>
                <th>Published</th>
                <th>Feature</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for post in posts %}
              <tr>
                <td>
                  <strong>{{ post.title }}</strong>
                  <small>{{ post.slug }}</small>
                </td>
                <td>
                  <span class="status-pill status-{{ (post.status or 'draft')|lower }}">{{ post.status or 'draft' }}</span>
                </td>
                <td>{{ post.published_at|to_date if post.published_at else '‚Äî' }}</td>
                <td>
                  <button type="button"
                          class="pill-btn {{ 'is-active' if post.is_featured else '' }}"
                          data-feature-post
                          data-post-id="{{ post.id }}"
                          data-featured="{{ 'true' if post.is_featured else 'false' }}">
                    {{ '‚òÖ Featured' if post.is_featured else '‚òÜ Feature' }}
                  </button>
                </td>
                <td>
                  <div class="table-actions">
                    <button type="button"
                            class="pill-btn"
                            data-edit-post
                            data-post-id="{{ post.id }}">Edit</button>
                    <button type="button"
                            class="pill-btn is-danger"
                            data-delete-post
                            data-post-id="{{ post.id }}">Delete</button>
                    {% if post.slug %}
                      <a class="pill-btn is-link" href="{{ url_for('community_bulletin_post', slug=post.slug) }}" target="_blank" rel="noopener">View</a>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5">No posts yet. Create one using the builder below.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section class="bulletin-card">
        <h2>Latest Comments</h2>
        <ul class="bulletin-comments">
          {% for comment in latest_comments %}
          <li>
            <div class="comment-meta">
              <img src="{{ comment.avatar }}" alt="{{ comment.trainer_username }}" />
              <div>
                <strong>{{ comment.trainer_username }}</strong>
                <small>{{ comment.created_at|to_date }} ¬∑ {{ comment.post_title or 'Unknown post' }}</small>
              </div>
            </div>
            <p>{{ comment.body }}</p>
            <form method="post" action="{{ url_for('admin_bulletin_delete_comment_route', comment_id=comment.id) }}">
              <button type="submit" class="pill-btn is-danger">Delete</button>
            </form>
          </li>
          {% else %}
          <li>No comments yet.</li>
          {% endfor %}
        </ul>
      </section>
    </div>

    <section class="bulletin-card bulletin-actions">
      <div class="bulletin-card__head">
        <div>
          <h2>Community Bulletin Actions</h2>
          <p>Launch focused workflows without crowding the dashboard.</p>
        </div>
      </div>
      <div class="bulletin-actions__buttons">
        <button type="button" class="pill-btn is-primary" data-open-modal="builder" data-new-post>‚úèÔ∏è Compose Post</button>
        <button type="button" class="pill-btn" data-open-modal="author">‚ûï Add Author</button>
        <button type="button" class="pill-btn" data-open-modal="author-list">üë• View Authors</button>
      </div>
    </section>

    <div class="bulletin-modal" data-modal="builder">
      <div class="bulletin-modal__backdrop" data-modal-close></div>
      <div class="bulletin-modal__dialog is-wide">
        <header class="bulletin-modal__header">
          <div>
            <h3>Post Builder</h3>
            <p>Craft responsive stories with reusable section blocks.</p>
          </div>
          <button type="button" class="pill-btn is-secondary" data-modal-close aria-label="Close builder">‚úï</button>
        </header>
        <div class="bulletin-modal__body">
          <section class="bulletin-builder"
                   data-bulletin-builder
                   data-posts='{{ posts|tojson|safe }}'
                   data-authors='{{ authors|tojson|safe }}'>
            <div class="bulletin-card__head">
              <div>
                <h2>Post Details</h2>
                <p>Set the essentials before adding section blocks.</p>
              </div>
              <button type="button" class="pill-btn is-secondary" data-reset-builder>Reset</button>
            </div>
            <form id="bulletinBuilderForm">
              <input type="hidden" name="id">
              <div class="builder-grid">
                <label>
                  <span>Title</span>
                  <input type="text" name="title" required>
                </label>
                <label>
                  <span>Slug</span>
                  <input type="text" name="slug" required>
                </label>
                <label>
                  <span>Summary</span>
                  <textarea name="summary" rows="2"></textarea>
                </label>
                <label>
                  <span>Author</span>
                  <select name="author_id">
                    <option value="">‚Äî Select author ‚Äî</option>
                  </select>
                </label>
                <label>
                  <span>Primary Tag</span>
                  <input type="text" name="tag" placeholder="Events">
                </label>
                <label>
                  <span>Category</span>
                  <input type="text" name="category" placeholder="Events">
                </label>
                <label>
                  <span>Read Time</span>
                  <input type="text" name="read_time" placeholder="5 min read">
                </label>
                <label>
                  <span>Hero Image URL</span>
                  <div class="input-with-btn">
                    <input type="text" name="hero_image" placeholder="https://.../heroes/slug.webp">
                    <button type="button" class="pill-btn is-secondary" data-upload-target="hero_image" data-upload-type="hero">Upload</button>
                  </div>
                </label>
                <label>
                  <span>Header Image URL</span>
                  <div class="input-with-btn">
                    <input type="text" name="header_image" placeholder="https://.../slides/slug/slide-01.webp">
                    <button type="button" class="pill-btn is-secondary" data-upload-target="header_image" data-upload-type="header">Upload</button>
                  </div>
                </label>
                <label>
                  <span>Tags (comma separated)</span>
                  <input type="text" name="tags" placeholder="events, go tour, tips">
                </label>
                <label>
                  <span>Status</span>
                  <select name="status">
                    <option value="draft">Draft</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="published">Published</option>
                  </select>
                </label>
                <label>
                  <span>Published At</span>
                  <input type="datetime-local" name="published_at">
                </label>
                <label>
                  <span>Scheduled Publish</span>
                  <input type="datetime-local" name="scheduled_publish_at">
                </label>
                <label class="checkbox-field">
                  <input type="checkbox" name="is_featured">
                  <span>Feature on bulletin landing</span>
                </label>
              </div>

              <div class="builder-sections__head">
                <h3>Sections</h3>
                <button type="button" class="pill-btn" data-add-section>+ Add Section</button>
              </div>
              <div class="builder-sections" data-builder-sections>
                <p class="builder-sections__empty">No sections yet. Add a block to begin.</p>
              </div>

              <div class="builder-actions">
                <button type="submit" class="pill-btn is-primary">Save Post</button>
              </div>
            </form>
          </section>
        </div>
      </div>
    </div>

    <div class="bulletin-modal" data-modal="author">
      <div class="bulletin-modal__backdrop" data-modal-close></div>
      <div class="bulletin-modal__dialog">
        <header class="bulletin-modal__header">
          <div>
            <h3>New Author Profile</h3>
            <p>Set up writers once and reuse them across posts.</p>
          </div>
          <button type="button" class="pill-btn is-secondary" data-modal-close aria-label="Close author modal">‚úï</button>
        </header>
        <div class="bulletin-modal__body">
          <form id="authorForm" class="builder-grid">
            <input type="hidden" name="id">
            <label>
              <span>Display Name</span>
              <input type="text" name="display_name" required>
            </label>
            <label>
              <span>Avatar URL</span>
              <div class="input-with-btn">
                <input type="text" name="avatar_url" placeholder="https://.../authors/avatar.webp">
                <button type="button" class="pill-btn is-secondary" data-upload-target="avatar_url" data-upload-type="author">Upload</button>
              </div>
            </label>
            <label>
              <span>Website / Link</span>
              <input type="text" name="link_url" placeholder="https://example.com">
            </label>
            <label>
              <span>Bio</span>
              <textarea name="bio" rows="2"></textarea>
            </label>
            <label>
              <span>Social Handles (JSON or icon|label|url per line)</span>
              <textarea name="social_handles" rows="2" placeholder='[{"icon":"üì∏","label":"Instagram","url":"https://"}]'></textarea>
            </label>
            <div class="builder-actions">
              <button type="submit" class="pill-btn is-primary">Save Author</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="bulletin-modal" data-modal="author-list">
      <div class="bulletin-modal__backdrop" data-modal-close></div>
      <div class="bulletin-modal__dialog">
        <header class="bulletin-modal__header">
          <div>
            <h3>Author Profiles</h3>
            <p>Review existing writers and their bios.</p>
          </div>
          <button type="button" class="pill-btn is-secondary" data-modal-close aria-label="Close author list">‚úï</button>
        </header>
        <div class="bulletin-modal__body">
          <div class="author-list">
            {% for author in authors %}
            <article class="author-card">
              <div class="author-card__head">
                <img src="{{ (author.avatar_url or 'avatars/avatar1.png')|bulletin_media }}" alt="{{ author.display_name }}">
                <div>
                  <strong>{{ author.display_name }}</strong>
                  {% if author.link_url %}
                  <a href="{{ author.link_url }}" target="_blank" rel="noopener">{{ author.link_url }}</a>
                  {% endif %}
                </div>
              </div>
              {% if author.bio %}
              <p>{{ author.bio }}</p>
              {% endif %}
              {% set socials = author.social_handles or [] %}
              {% if socials %}
              <div class="author-card__socials">
                {% for handle in socials %}
                <span>{{ handle.icon or 'üîó' }} {{ handle.label }}</span>
                {% endfor %}
              </div>
              {% endif %}
              <div class="author-card__actions">
                <button type="button"
                        class="pill-btn is-secondary"
                        data-edit-author
                        data-author-id="{{ author.id }}">Edit</button>
                <button type="button"
                        class="pill-btn is-danger"
                        data-delete-author
                        data-author-id="{{ author.id }}">Delete</button>
              </div>
            </article>
            {% else %}
            <p class="author-list__empty">No authors yet. Add your first profile from the actions panel.</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</section>

<style>
.bulletin-admin__header { margin-bottom: 18px; }
.bulletin-admin__eyebrow {
  text-transform: uppercase;
  letter-spacing: 0.3em;
  font-size: 0.7rem;
  color: #94a3b8;
  margin-bottom: 6px;
}
.bulletin-admin__alert {
  padding: 18px;
  border-radius: 16px;
  background: #fef2f2;
  color: #b91c1c;
}
.bulletin-admin__stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.stat-card {
  padding: 16px;
  border-radius: 18px;
  background: #fff;
  box-shadow: 0 10px 24px rgba(15, 23, 42, 0.1);
}
.stat-card p { margin: 0; font-size: 0.85rem; color: #64748b; }
.stat-card strong { font-size: 1.6rem; }

.bulletin-admin__grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 18px;
  margin-bottom: 24px;
}
.bulletin-card {
  padding: 18px;
  border-radius: 20px;
  background: #fff;
  box-shadow: 0 12px 28px rgba(15, 23, 42, 0.1);
}
.bulletin-card__head {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  margin-bottom: 12px;
}
.bulletin-table__wrap {
  overflow: auto;
  max-height: 460px;
}
.bulletin-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}
.bulletin-table th,
.bulletin-table td {
  padding: 10px;
  border-bottom: 1px solid #e2e8f0;
  text-align: left;
  vertical-align: top;
}
.bulletin-table strong { display: block; }
.bulletin-table small { color: #64748b; }
.status-pill {
  display: inline-flex;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 0.75rem;
  text-transform: capitalize;
}
.status-published { background: #ecfdf5; color: #047857; }
.status-draft { background: #f1f5f9; color: #0f172a; }
.status-scheduled { background: #fff7ed; color: #b45309; }
.table-actions {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.pill-btn {
  border: none;
  border-radius: 999px;
  padding: 6px 14px;
  font-weight: 600;
  cursor: pointer;
  background: #eef2ff;
  color: #0f172a;
}
.pill-btn.is-link { background: #dbeafe; color: #1d4ed8; text-decoration: none; display: inline-flex; align-items: center; }
.pill-btn.is-active { background: #fde68a; color: #92400e; }
.pill-btn.is-secondary { background: #f8fafc; }
.pill-btn.is-danger { background: #fee2e2; color: #b91c1c; }
.pill-btn.is-primary { background: #0f172a; color: #fff; }

.bulletin-comments {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-height: 460px;
  overflow-y: auto;
  padding-right: 6px;
}
.bulletin-comments li {
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 12px;
}
.comment-meta {
  display: flex;
  gap: 10px;
  align-items: center;
}
.comment-meta img {
  width: 38px;
  height: 38px;
  border-radius: 999px;
  object-fit: cover;
}
.bulletin-comments p { margin: 6px 0; }

.bulletin-builder {
  padding: 18px;
  border-radius: 20px;
  background: #fff;
  box-shadow: 0 12px 28px rgba(15, 23, 42, 0.1);
}
.bulletin-actions__buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}
.bulletin-modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1100;
}
.bulletin-modal.is-open {
  display: flex;
}
.bulletin-modal__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(2, 6, 23, 0.75);
}
.bulletin-modal__dialog {
  position: relative;
  background: #f8fafc;
  border-radius: 24px;
  width: min(640px, 95vw);
  min-height: 0;
  max-height: 92vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 0;
  box-shadow: 0 30px 80px rgba(2, 6, 23, 0.35);
}
.bulletin-modal__dialog.is-wide {
  width: min(1200px, 96vw);
}
.bulletin-modal__header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  padding: 18px 24px;
  border-bottom: 1px solid #e2e8f0;
}
.bulletin-modal__body {
  padding: 24px;
  overflow-y: auto;
  flex: 1;
  min-height: 0;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
body.modal-open {
  overflow: hidden;
}
.author-list {
  display: flex;
  flex-direction: column;
  gap: 14px;
}
.author-card {
  background: #fff;
  border-radius: 18px;
  padding: 14px;
  border: 1px solid #e2e8f0;
}
.author-card__head {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 6px;
}
.author-card__head img {
  width: 48px;
  height: 48px;
  border-radius: 999px;
  object-fit: cover;
}
.author-card__socials {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  font-size: 0.8rem;
  color: #475569;
}
.author-card__actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
  flex-wrap: wrap;
}
.author-list__empty {
  text-align: center;
  color: #94a3b8;
}
.builder-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 14px;
  margin-bottom: 16px;
}
.builder-grid label {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 0.85rem;
  color: #475569;
}
.builder-grid input,
.builder-grid select,
.builder-grid textarea {
  border-radius: 12px;
  border: 1px solid #cbd5f5;
  padding: 10px;
  font: inherit;
}
.input-with-btn {
  display: flex;
  gap: 8px;
  align-items: center;
}
.input-with-btn input {
  flex: 1;
}
.input-with-btn button {
  flex-shrink: 0;
}
.help-tip {
  border: none;
  width: 22px;
  height: 22px;
  border-radius: 999px;
  background: #1d4ed8;
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  position: relative;
}
.help-tip::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: calc(100% + 10px);
  left: 50%;
  transform: translateX(-50%);
  background: #0f172a;
  color: #fff;
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 0.75rem;
  line-height: 1.2;
  width: min(240px, 60vw);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
  z-index: 5;
}
.help-tip:focus::after,
.help-tip:hover::after {
  opacity: 1;
}
.checkbox-field {
  flex-direction: row;
  align-items: center;
  gap: 8px;
}
.builder-sections__head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.builder-sections__empty {
  text-align: center;
  color: #94a3b8;
  background: #f8fafc;
  border-radius: 16px;
  padding: 14px;
}
.builder-section {
  border: 1px solid #e2e8f0;
  border-radius: 16px;
  padding: 14px;
  margin-bottom: 12px;
  background: #f8fafc;
}
.builder-section__controls {
  align-items: center;
}
.builder-section__row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 10px;
  margin-bottom: 8px;
}
.section-config {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.list-block {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.list-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 8px;
  align-items: center;
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  border: 1px solid #e2e8f0;
}
.builder-section textarea {
  width: 100%;
  min-height: 90px;
  border-radius: 12px;
  border: 1px solid #cbd5f5;
  padding: 10px;
  font-family: var(--font-mono, monospace);
}
.builder-section__actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
.builder-actions {
  text-align: right;
  margin-top: 10px;
}

@media (max-width: 1024px) {
  .bulletin-admin__grid {
    grid-template-columns: 1fr;
  }
}
</style>

{% if supabase_enabled %}
<input type="file" id="bulletinUploadInput" accept="image/*" hidden>
<script>
(function () {
  var builder = document.querySelector("[data-bulletin-builder]");
  if (!builder) return;

  var posts = [];
  var authors = [];
  try { posts = JSON.parse(builder.dataset.posts || "[]"); } catch (err) { posts = []; }
  try { authors = JSON.parse(builder.dataset.authors || "[]"); } catch (err) { authors = []; }
  var authorMap = {};

  var modalRegistry = {};
  document.querySelectorAll("[data-modal]").forEach(function (modal) {
    var key = modal.dataset.modal;
    if (key) {
      modalRegistry[key] = modal;
    }
    modal.addEventListener("click", function (evt) {
      if (evt.target.classList.contains("bulletin-modal__backdrop") || evt.target.closest("[data-modal-close]")) {
        closeModal(modal);
      }
    });
  });

  function openModal(name) {
    var modal = modalRegistry[name];
    if (!modal) return;
    modal.classList.add("is-open");
    document.body.classList.add("modal-open");
  }

  function closeModal(modal) {
    if (!modal) return;
    modal.classList.remove("is-open");
    if (!document.querySelector(".bulletin-modal.is-open")) {
      document.body.classList.remove("modal-open");
    }
  }

  var SECTION_TIPS = {
    "rich_text": "Stack multi-paragraph stories. Blank lines create new paragraphs and you can drop in simple HTML (bold, italics, anchors).",
    "detail-grid": "Great for schedules or quick stats. Add as many label/value pairs as you need.",
    "callouts": "Use short highlight cards with an optional emoji, heading, and supporting copy.",
    "carousel": "Upload a swipeable gallery. Each slide takes a Supabase image plus caption, and you can link out to a full album.",
    "media-block": "Insert a standalone photo with caption/credit. Ideal for inline photography between text sections.",
    "link-list": "Group external resources such as RSVP links, documents, or how-to guides.",
  };

  var form = document.getElementById("bulletinBuilderForm");
  var authorSelect = form.querySelector("select[name='author_id']");
  var sectionsContainer = form.querySelector("[data-builder-sections]");
  var addSectionBtn = form.querySelector("[data-add-section]");
  var resetBtns = document.querySelectorAll("[data-reset-builder]");
  var featureButtons = document.querySelectorAll("[data-feature-post]");
  var editButtons = document.querySelectorAll("[data-edit-post]");
  var deletePostButtons = document.querySelectorAll("[data-delete-post]");
  var currentPostId = null;
  var uploadInput = document.getElementById("bulletinUploadInput");
  var pendingUploadTarget = null;
  var pendingUploadElement = null;
  var pendingUploadType = null;
  var authorForm = document.getElementById("authorForm");
  var authorIdInput = authorForm ? authorForm.querySelector("[name='id']") : null;

  authors.forEach(function (author) {
    if (author && author.id) {
      authorMap[author.id] = author;
    }
    var opt = document.createElement("option");
    opt.value = author.id;
    opt.textContent = author.display_name;
    authorSelect.appendChild(opt);
  });

  function localDateValue(isoString) {
    if (!isoString) return "";
    try {
      var dt = new Date(isoString);
      var iso = dt.toISOString();
      return iso.substring(0, 16);
    } catch (err) {
      return "";
    }
  }

  function createSectionRow(section) {
    var block = document.createElement("div");
    block.className = "builder-section";
    var sectionType = section && (section.section_type || section.type) ? (section.section_type || section.type) : "rich_text";
    block.innerHTML = `
      <div class="builder-section__row builder-section__controls">
        <label>
          <span>Section Type</span>
          <select name="section_type">
            <option value="rich_text">Rich Text</option>
            <option value="detail-grid">Detail Grid</option>
            <option value="callouts">Callouts</option>
            <option value="carousel">Carousel</option>
            <option value="media-block">Photo Block</option>
            <option value="link-list">Link List</option>
          </select>
        </label>
        <button type="button" class="help-tip" data-tooltip="" aria-label="Section help tooltip">?</button>
      </div>
      <label>
        <span>Heading</span>
        <input type="text" name="section_heading">
      </label>
      <div class="section-config" data-section-config></div>
      <div class="builder-section__actions">
        <button type="button" class="pill-btn is-secondary" data-move-up>‚ñ≤</button>
        <button type="button" class="pill-btn is-secondary" data-move-down>‚ñº</button>
        <button type="button" class="pill-btn is-danger" data-remove-section>Remove</button>
      </div>
    `;
    block.querySelector("[name='section_type']").value = sectionType;
    block.querySelector("[name='section_heading']").value = section && section.title ? section.title : "";
    renderSectionConfig(block, section);
    block.addEventListener("click", function (evt) {
      if (evt.target.matches("[data-remove-section]")) {
        block.remove();
        if (!sectionsContainer.children.length) {
          sectionsContainer.innerHTML = '<p class="builder-sections__empty">No sections yet. Add a block to begin.</p>';
        }
      }
      if (evt.target.matches("[data-move-up]")) {
        var prev = block.previousElementSibling;
        if (prev) sectionsContainer.insertBefore(block, prev);
      }
      if (evt.target.matches("[data-move-down]")) {
        var next = block.nextElementSibling;
        if (next) sectionsContainer.insertBefore(next, block);
      }
    });
    return block;
  }

  function ensureHelpTip(block, type) {
    var tip = block.querySelector(".help-tip");
    if (tip) {
      tip.dataset.tooltip = SECTION_TIPS[type] || "Configure this section.";
    }
  }

  function renderSectionConfig(block, section) {
    var type = block.querySelector("[name='section_type']").value || "rich_text";
    ensureHelpTip(block, type);
    var payload = (section && section.payload) || {};
    var config = block.querySelector("[data-section-config]");
    config.innerHTML = "";

    function setRichText(data) {
      var text = "";
      if (data && Array.isArray(data.body)) {
        text = data.body.join("\n\n");
      }
      config.innerHTML = `
        <label>
          <span>Content</span>
          <textarea rows="4" data-rich-text placeholder="Write your paragraphs. Use blank lines to separate blocks."></textarea>
        </label>
      `;
      config.querySelector("[data-rich-text]").value = text;
    }

    function addDetailRow(list, data) {
      var row = document.createElement("div");
      row.className = "list-row";
      row.dataset.detailRow = "true";
      row.innerHTML = `
        <input type="text" data-detail-label placeholder="Label" value="${data && data.label ? data.label : ""}">
        <input type="text" data-detail-value placeholder="Value" value="${data && data.value ? data.value : ""}">
        <input type="text" data-detail-meta placeholder="Meta (optional)" value="${data && data.meta ? data.meta : ""}">
        <button type="button" class="pill-btn is-danger" data-remove-row>Remove</button>
      `;
      list.appendChild(row);
    }

    function addCalloutRow(list, data) {
      var row = document.createElement("div");
      row.className = "list-row";
      row.dataset.calloutRow = "true";
      row.innerHTML = `
        <input type="text" data-callout-icon placeholder="Icon/Emoji" value="${data && data.icon ? data.icon : ""}">
        <input type="text" data-callout-heading placeholder="Heading" value="${data && data.heading ? data.heading : ""}">
        <input type="text" data-callout-body placeholder="Body" value="${data && data.body ? data.body : ""}">
        <button type="button" class="pill-btn is-danger" data-remove-row>Remove</button>
      `;
      list.appendChild(row);
    }

    function addSlideRow(list, data) {
      var row = document.createElement("div");
      row.className = "list-row";
      row.dataset.slideRow = "true";
      row.innerHTML = `
        <div class="input-with-btn">
          <input type="text" data-slide-image placeholder="Image URL" value="${data && data.image ? data.image : ""}">
          <button type="button" class="pill-btn is-secondary" data-upload-ref="prev" data-upload-type="slide">Upload</button>
        </div>
        <input type="text" data-slide-caption placeholder="Caption" value="${data && data.caption ? data.caption : ""}">
        <button type="button" class="pill-btn is-danger" data-remove-row>Remove</button>
      `;
      list.appendChild(row);
    }

    function addLinkRow(list, data) {
      var row = document.createElement("div");
      row.className = "list-row";
      row.dataset.linkRow = "true";
      row.innerHTML = `
        <input type="text" data-link-label placeholder="Label" value="${data && data.label ? data.label : ""}">
        <input type="text" data-link-url placeholder="URL" value="${data && data.url ? data.url : ""}">
        <input type="text" data-link-description placeholder="Description" value="${data && data.description ? data.description : ""}">
        <button type="button" class="pill-btn is-danger" data-remove-row>Remove</button>
      `;
      list.appendChild(row);
    }

    if (type === "rich_text") {
      setRichText(payload);
    } else if (type === "detail-grid") {
      config.innerHTML = `
        <div class="list-block" data-detail-list></div>
        <button type="button" class="pill-btn is-secondary" data-add-detail>+ Add Row</button>
      `;
      var list = config.querySelector("[data-detail-list]");
      (payload.details || []).forEach(function (detail) { addDetailRow(list, detail); });
      if (!list.children.length) addDetailRow(list);
    } else if (type === "callouts") {
      config.innerHTML = `
        <div class="list-block" data-callout-list></div>
        <button type="button" class="pill-btn is-secondary" data-add-callout>+ Add Callout</button>
      `;
      var calloutList = config.querySelector("[data-callout-list]");
      (payload.callouts || []).forEach(function (callout) { addCalloutRow(calloutList, callout); });
      if (!calloutList.children.length) addCalloutRow(calloutList);
    } else if (type === "carousel") {
      config.innerHTML = `
        <div class="list-block" data-slide-list></div>
        <button type="button" class="pill-btn is-secondary" data-add-slide>+ Add Slide</button>
        <label>
          <span>Album URL</span>
          <input type="text" data-carousel-album placeholder="https://..." value="${payload.album_url || ""}">
        </label>
        <label>
          <span>Description</span>
          <textarea rows="3" data-carousel-description placeholder="Optional context">${payload.description || ""}</textarea>
        </label>
      `;
      var slideList = config.querySelector("[data-slide-list]");
      (payload.slides || []).forEach(function (slide) { addSlideRow(slideList, slide); });
      if (!slideList.children.length) addSlideRow(slideList);
    } else if (type === "media-block") {
      var fullbleed = payload.fullbleed;
      if (typeof fullbleed === "string") {
        fullbleed = fullbleed.toLowerCase() === "true";
      } else {
        fullbleed = !!fullbleed;
      }
      config.innerHTML = `
        <label>
          <span>Image</span>
          <div class="input-with-btn">
            <input type="text" data-media-image placeholder="https://.../attachments/photo.webp" value="${payload.image || ""}">
            <button type="button" class="pill-btn is-secondary" data-upload-ref="prev" data-upload-type="media">Upload</button>
          </div>
        </label>
        <label>
          <span>Alt text</span>
          <input type="text" data-media-alt placeholder="Describe the image" value="${payload.alt || ""}">
        </label>
        <label>
          <span>Caption</span>
          <textarea rows="2" data-media-caption placeholder="Shown beneath the image">${payload.caption || ""}</textarea>
        </label>
        <label>
          <span>Photo credit</span>
          <input type="text" data-media-credit placeholder="Photo by‚Ä¶" value="${payload.credit || ""}">
        </label>
        <label class="checkbox-field">
          <input type="checkbox" data-media-fullbleed ${fullbleed ? "checked" : ""}>
          <span>Make this image full-width</span>
        </label>
      `;
    } else if (type === "link-list") {
      config.innerHTML = `
        <div class="list-block" data-link-list></div>
        <button type="button" class="pill-btn is-secondary" data-add-link>+ Add Link</button>
      `;
      var linkList = config.querySelector("[data-link-list]");
      (payload.links || []).forEach(function (link) { addLinkRow(linkList, link); });
      if (!linkList.children.length) addLinkRow(linkList);
    }
  }

  function clearSections() {
    sectionsContainer.innerHTML = '<p class="builder-sections__empty">No sections yet. Add a block to begin.</p>';
  }

  function addSection(section) {
    if (sectionsContainer.querySelector(".builder-sections__empty")) {
      sectionsContainer.innerHTML = "";
    }
    sectionsContainer.appendChild(createSectionRow(section));
  }

  addSectionBtn.addEventListener("click", function () {
    addSection();
  });

  function resetBuilder() {
    currentPostId = null;
    form.reset();
    form.elements.id.value = "";
    clearSections();
  }

  resetBtns.forEach(function (btn) {
    btn.addEventListener("click", function () {
      resetBuilder();
    });
  });

  function resetAuthorForm() {
    if (!authorForm) return;
    authorForm.reset();
    if (authorIdInput) {
      authorIdInput.value = "";
    }
  }

  function populateAuthorForm(author) {
    if (!authorForm || !author) return;
    resetAuthorForm();
    if (authorIdInput) {
      authorIdInput.value = author.id || "";
    }
    authorForm.elements.display_name.value = author.display_name || "";
    authorForm.elements.avatar_url.value = author.avatar_url || "";
    authorForm.elements.link_url.value = author.link_url || "";
    authorForm.elements.bio.value = author.bio || "";
    var handles = author.social_handles;
    if (!handles) {
      authorForm.elements.social_handles.value = "";
    } else if (typeof handles === "string") {
      authorForm.elements.social_handles.value = handles;
    } else {
      authorForm.elements.social_handles.value = JSON.stringify(handles, null, 2);
    }
  }

  document.addEventListener("click", function (evt) {
    var trigger = evt.target.closest("[data-open-modal]");
    if (trigger) {
      evt.preventDefault();
      if (trigger.hasAttribute("data-new-post")) {
        resetBuilder();
      }
      if ((trigger.dataset.openModal || "") === "author" && !trigger.dataset.authorId) {
        resetAuthorForm();
      }
      openModal(trigger.dataset.openModal);
    }

    var editAuthorBtn = evt.target.closest("[data-edit-author]");
    if (editAuthorBtn) {
      var author = authorMap[editAuthorBtn.dataset.authorId];
      if (author) {
        populateAuthorForm(author);
        openModal("author");
      }
    }

    var deleteAuthorBtn = evt.target.closest("[data-delete-author]");
    if (deleteAuthorBtn) {
      var authorId = deleteAuthorBtn.dataset.authorId;
      if (authorId && confirm("Delete this author profile?")) {
        fetch("/admin/community-bulletin/author/" + authorId + "/delete", {
          method: "POST",
        })
          .then(function (resp) { return resp.json(); })
          .then(function (data) {
            if (!data.deleted) throw new Error(data.error || "Unable to delete author");
            alert("Author deleted.");
            window.location.reload();
          })
          .catch(function (err) {
            console.warn(err);
            alert(err.message || "Unable to delete author.");
          });
      }
    }
  });

  document.addEventListener("keydown", function (evt) {
    if (evt.key === "Escape") {
      var open = document.querySelector(".bulletin-modal.is-open");
      if (open) {
        closeModal(open);
      }
    }
  });

  sectionsContainer.addEventListener("change", function (evt) {
    if (evt.target.matches("select[name='section_type']")) {
      var block = evt.target.closest(".builder-section");
      renderSectionConfig(block, null);
    }
  });

  sectionsContainer.addEventListener("click", function (evt) {
    if (evt.target.matches("[data-add-detail]")) {
      var list = evt.target.closest(".section-config").querySelector("[data-detail-list]");
      var row = document.createElement("div");
      row.className = "list-row";
      row.dataset.detailRow = "true";
      row.innerHTML = `
        <input type="text" data-detail-label placeholder="Label">
        <input type="text" data-detail-value placeholder="Value">
        <input type="text" data-detail-meta placeholder="Meta">
        <button type="button" class="pill-btn is-danger" data-remove-row>Remove</button>
      `;
      list.appendChild(row);
    }
    if (evt.target.matches("[data-add-callout]")) {
      var cList = evt.target.closest(".section-config").querySelector("[data-callout-list]");
      var row = document.createElement("div");
      row.className = "list-row";
      row.dataset.calloutRow = "true";
      row.innerHTML = `
        <input type="text" data-callout-icon placeholder="Icon/Emoji">
        <input type="text" data-callout-heading placeholder="Heading">
        <input type="text" data-callout-body placeholder="Body">
        <button type="button" class="pill-btn is-danger" data-remove-row>Remove</button>
      `;
      cList.appendChild(row);
    }
    if (evt.target.matches("[data-add-slide]")) {
      var sList = evt.target.closest(".section-config").querySelector("[data-slide-list]");
      var row = document.createElement("div");
      row.className = "list-row";
      row.dataset.slideRow = "true";
      row.innerHTML = `
        <div class="input-with-btn">
          <input type="text" data-slide-image placeholder="Image URL">
          <button type="button" class="pill-btn is-secondary" data-upload-ref="prev" data-upload-type="slide">Upload</button>
        </div>
        <input type="text" data-slide-caption placeholder="Caption">
        <button type="button" class="pill-btn is-danger" data-remove-row>Remove</button>
      `;
      sList.appendChild(row);
    }
    if (evt.target.matches("[data-add-link]")) {
      var lList = evt.target.closest(".section-config").querySelector("[data-link-list]");
      var row = document.createElement("div");
      row.className = "list-row";
      row.dataset.linkRow = "true";
      row.innerHTML = `
        <input type="text" data-link-label placeholder="Label">
        <input type="text" data-link-url placeholder="URL">
        <input type="text" data-link-description placeholder="Description">
        <button type="button" class="pill-btn is-danger" data-remove-row>Remove</button>
      `;
      lList.appendChild(row);
    }
    if (evt.target.matches("[data-remove-row]")) {
      evt.target.closest(".list-row").remove();
    }
  });

  function loadPostIntoBuilder(postId) {
    var post = posts.find(function (p) { return p.id === postId; });
    if (!post) return;
    currentPostId = post.id;
    form.elements.id.value = post.id || "";
    form.elements.title.value = post.title || "";
    form.elements.slug.value = post.slug || "";
    form.elements.summary.value = post.summary || "";
    form.elements.author_id.value = post.author_id || "";
    form.elements.category.value = post.category || "";
    form.elements.tag.value = post.tag || "";
    form.elements.tags.value = (post.tags || []).join(", ");
    form.elements.read_time.value = post.read_time || "";
    form.elements.hero_image.value = post.hero_image || "";
    form.elements.header_image.value = post.header_image || "";
    form.elements.status.value = (post.status || "draft").toLowerCase();
    form.elements.published_at.value = localDateValue(post.published_at);
    form.elements.scheduled_publish_at.value = localDateValue(post.scheduled_publish_at);
    form.elements.is_featured.checked = !!post.is_featured;

    clearSections();
    (post.content_sections || []).forEach(function (section) {
      addSection(section);
    });
    if (!sectionsContainer.children.length) {
      clearSections();
    }
  }

  editButtons.forEach(function (btn) {
    btn.addEventListener("click", function () {
      loadPostIntoBuilder(btn.dataset.postId);
      openModal("builder");
    });
  });

  featureButtons.forEach(function (btn) {
    btn.addEventListener("click", function () {
      var postId = btn.dataset.postId;
      var featured = btn.dataset.featured === "true";
      fetch("/admin/community-bulletin/post/" + postId + "/feature", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ is_featured: !featured }),
      })
      .then(function (resp) { return resp.json(); })
      .then(function (data) {
        if (typeof data.is_featured === "undefined") throw new Error(data.error || "Unable to update feature");
        btn.dataset.featured = data.is_featured ? "true" : "false";
        btn.classList.toggle("is-active", data.is_featured);
        btn.textContent = data.is_featured ? "‚òÖ Featured" : "‚òÜ Feature";
        alert("Feature flag updated.");
        window.location.reload();
      })
      .catch(function (err) {
        console.warn(err);
        alert("Unable to update feature flag.");
      });
    });
  });

  deletePostButtons.forEach(function (btn) {
    btn.addEventListener("click", function () {
      var postId = btn.dataset.postId;
      if (!postId) return;
      if (!confirm("Delete this post? This cannot be undone.")) {
        return;
      }
      fetch("/admin/community-bulletin/post/" + postId + "/delete", {
        method: "POST",
      })
        .then(function (resp) { return resp.json(); })
        .then(function (data) {
          if (!data.deleted) throw new Error(data.error || "Unable to delete post");
          alert("Post deleted.");
          window.location.reload();
        })
        .catch(function (err) {
          console.warn(err);
          alert(err.message || "Unable to delete post.");
        });
    });
  });

  function readRichText(block) {
    var field = block.querySelector("[data-rich-text]");
    if (!field) return [];
    return field.value
      .split(/\n{2,}/)
      .map(function (p) { return p.trim(); })
      .filter(Boolean);
  }

  function readDetailRows(block) {
    return Array.from(block.querySelectorAll("[data-detail-row]")).map(function (row) {
      return {
        label: row.querySelector("[data-detail-label]").value,
        value: row.querySelector("[data-detail-value]").value,
        meta: row.querySelector("[data-detail-meta]").value,
      };
    }).filter(function (detail) { return detail.label || detail.value; });
  }

  function readCalloutRows(block) {
    return Array.from(block.querySelectorAll("[data-callout-row]")).map(function (row) {
      return {
        icon: row.querySelector("[data-callout-icon]").value,
        heading: row.querySelector("[data-callout-heading]").value,
        body: row.querySelector("[data-callout-body]").value,
      };
    }).filter(function (callout) { return callout.heading || callout.body; });
  }

  function readSlideRows(block) {
    return Array.from(block.querySelectorAll("[data-slide-row]")).map(function (row) {
      return {
        image: row.querySelector("[data-slide-image]").value,
        caption: row.querySelector("[data-slide-caption]").value,
      };
    }).filter(function (slide) { return slide.image; });
  }

  function readLinkRows(block) {
    return Array.from(block.querySelectorAll("[data-link-row]")).map(function (row) {
      return {
        label: row.querySelector("[data-link-label]").value,
        url: row.querySelector("[data-link-url]").value,
        description: row.querySelector("[data-link-description]").value,
      };
    }).filter(function (link) { return link.label || link.url; });
  }

  function collectSections() {
    return Array.from(sectionsContainer.querySelectorAll(".builder-section")).map(function (block) {
      var type = block.querySelector("[name='section_type']").value;
      var payload = {};
      if (type === "rich_text") {
        payload.body = readRichText(block);
      } else if (type === "detail-grid") {
        payload.details = readDetailRows(block);
      } else if (type === "callouts") {
        payload.callouts = readCalloutRows(block);
      } else if (type === "carousel") {
        payload.slides = readSlideRows(block);
        payload.album_url = (block.querySelector("[data-carousel-album]") || {}).value || "";
        payload.description = (block.querySelector("[data-carousel-description]") || {}).value || "";
      } else if (type === "media-block") {
        var imageInput = block.querySelector("[data-media-image]");
        var altInput = block.querySelector("[data-media-alt]");
        var captionInput = block.querySelector("[data-media-caption]");
        var creditInput = block.querySelector("[data-media-credit]");
        var fullbleedToggle = block.querySelector("[data-media-fullbleed]");
        payload.image = imageInput ? imageInput.value : "";
        payload.alt = altInput ? altInput.value : "";
        payload.caption = captionInput ? captionInput.value : "";
        payload.credit = creditInput ? creditInput.value : "";
        payload.fullbleed = fullbleedToggle ? fullbleedToggle.checked : false;
      } else if (type === "link-list") {
        payload.links = readLinkRows(block);
      }
      var sectionData = {
        section_type: type,
        heading: block.querySelector("[name='section_heading']").value,
        payload: payload,
      };
      if (type === "media-block" && !payload.image) {
        return null;
      }
      return sectionData;
    }).filter(Boolean);
  }

  form.addEventListener("submit", function (evt) {
    evt.preventDefault();
    var sectionsData = collectSections();
    var payload = {
      id: form.elements.id.value || null,
      title: form.elements.title.value,
      slug: form.elements.slug.value,
      summary: form.elements.summary.value,
      author_id: form.elements.author_id.value || null,
      category: form.elements.category.value,
      tag: form.elements.tag.value,
      read_time: form.elements.read_time.value,
      hero_image: form.elements.hero_image.value,
      header_image: form.elements.header_image.value,
      tags: (form.elements.tags.value || "").split(",").map(function (tag) { return tag.trim(); }).filter(Boolean),
      status: form.elements.status.value,
      published_at: form.elements.published_at.value,
      scheduled_publish_at: form.elements.scheduled_publish_at.value,
      is_featured: form.elements.is_featured.checked,
      sections: sectionsData,
    };
    fetch("/admin/community-bulletin/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    })
      .then(function (resp) { return resp.json(); })
      .then(function (data) {
        if (!data.post) throw new Error(data.error || "Unable to save post");
        alert("Post saved! Refreshing data.");
        window.location.reload();
      })
      .catch(function (err) {
        console.warn(err);
        alert(err.message || "Unable to save post.");
      });
  });

  document.addEventListener("click", function (evt) {
    var btn = evt.target.closest("[data-upload-target], [data-upload-ref]");
    if (!btn) return;
    evt.preventDefault();
    pendingUploadType = btn.dataset.uploadType || "attachment";
    if (btn.dataset.uploadRef === "prev") {
      pendingUploadElement = btn.previousElementSibling;
      pendingUploadTarget = null;
    } else {
      pendingUploadTarget = btn.dataset.uploadTarget || null;
      pendingUploadElement = null;
    }
    uploadInput.value = "";
    uploadInput.click();
  });

  function setTargetValue(targetName, value) {
    if (!targetName) return;
    var field = document.querySelector("[name='" + targetName + "']");
    if (field) field.value = value;
  }

  function uploadAsset(file, type) {
    var formData = new FormData();
    formData.append("asset", file);
    return fetch("/admin/community-bulletin/upload?type=" + encodeURIComponent(type), {
      method: "POST",
      body: formData,
    }).then(function (resp) { return resp.json(); });
  }

  uploadInput.addEventListener("change", function () {
    if (!uploadInput.files.length) return;
    var file = uploadInput.files[0];
    uploadAsset(file, pendingUploadType || "attachment")
      .then(function (data) {
        if (!data.url) throw new Error(data.error || "Upload failed");
        if (pendingUploadElement) {
          pendingUploadElement.value = data.url;
        } else if (pendingUploadTarget) {
          setTargetValue(pendingUploadTarget, data.url);
        }
      })
      .catch(function (err) {
        console.warn(err);
        alert(err.message || "Upload failed");
      })
      .finally(function () {
        pendingUploadTarget = null;
        pendingUploadElement = null;
        pendingUploadType = null;
      });
  });

  authorForm && authorForm.addEventListener("submit", function (evt) {
    evt.preventDefault();
    var payload = {
      id: authorIdInput && authorIdInput.value ? authorIdInput.value : null,
      display_name: authorForm.elements.display_name.value,
      avatar_url: authorForm.elements.avatar_url.value,
      link_url: authorForm.elements.link_url.value,
      bio: authorForm.elements.bio.value,
      social_handles: authorForm.elements.social_handles.value,
    };
    fetch("/admin/community-bulletin/authors", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    })
      .then(function (resp) { return resp.json(); })
      .then(function (data) {
        if (!data.author) throw new Error(data.error || "Unable to save author");
        alert("Author saved!");
        window.location.reload();
      })
      .catch(function (err) {
        console.warn(err);
        alert(err.message || "Unable to save author.");
      });
  });

  function setInitialSections() {
    if (!posts.length) {
      addSection();
    }
  }

  setInitialSections();
})();
</script>
{% endif %}
{% endblock %}
