{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-cozy' %}
{% endblock %}

{% block content %}
<a class="bp-back" href="{{ url_for('community_bulletin') }}">‚¨Ö Back to RDAB Community Bulletin</a>

<section class="bp-hero">
  <div class="bp-hero-media">
    <img src="{{ (post.hero_image or post.header_image)|bulletin_media }}" alt="{{ post.title }} header art">
  </div>
  <div class="bp-hero-copy">
    <span class="bp-pill">{{ post.tag }}</span>
    <h1>{{ post.title }}</h1>
    <div class="bp-hero-meta">
      <div>
        <span class="bp-meta-label">Published</span>
        <p>{{ post.published_at|to_date }}</p>
      </div>
      <div>
        <span class="bp-meta-label">Author</span>
        <div class="bp-author-inline">
          <img src="{{ (post.author_avatar or 'avatars/avatar1.png')|bulletin_media }}" alt="{{ post.author or 'RDAB Staff' }} avatar">
          <span>{{ post.author or 'RDAB Staff' }}</span>
        </div>
      </div>
      <div>
        <span class="bp-meta-label">Read time</span>
        <p>{{ post.read_time or '3 min read' }}</p>
      </div>
    </div>
  </div>
</section>

{% if memory_album %}
<section class="bp-memory-banner">
  <div>
    <p class="bp-memory-eyebrow">Memory album</p>
    <h3>View {{ memory_album.slide_count }} highlight photos from this post</h3>
    <p>{{ memory_album.summary or post.summary }}</p>
  </div>
  <button type="button"
          class="bp-memory-btn"
          data-memory-launch="{{ memory_album.id }}"
          data-memory-start="0">
    View the full memory
  </button>
</section>
{% endif %}

<div class="bp-layout">
  <article class="bp-article"
           data-bulletin-slug="{{ post.slug }}"
           data-initial-comments='{{ (post.comment_threads or [])|tojson|safe }}'
           data-can-comment="{{ 'true' if trainer else 'false' }}"
           data-liked="{{ 'true' if post.get('liked_by_me') else 'false' }}"
           data-is-pwa="{{ 'true' if is_pwa else 'false' }}"
           data-max-comment-depth="{{ max_comment_depth or 2 }}">
    {% if toc_sections %}
    <div class="bp-card bp-toc-card">
      <div class="bp-card-title">
        <span>üìë Page Contents</span>
      </div>
      <ol>
        {% for section in toc_sections %}
        <li><a href="#{{ section.id }}">{{ section.title }}</a></li>
        {% endfor %}
      </ol>
    </div>
    {% endif %}

    {% for section in sections %}
      <section class="bp-section" id="{{ section.id }}">
        {% if section.title %}
        <div class="bp-section-heading">
          <h2>{{ section.title }}</h2>
        </div>
        {% endif %}

        {% if section.type == "rich_text" %}
          {% for paragraph in section.body or [] %}
          <p class="bp-body-paragraph">{{ paragraph|safe }}</p>
          {% endfor %}
        {% elif section.type == "detail-grid" %}
          <dl class="bp-detail-grid">
            {% for detail in section.details or [] %}
            <div class="bp-detail-row">
              <dt>{{ detail.label }}</dt>
              <dd>
                <strong>{{ detail.value }}</strong>
                {% if detail.meta %}
                <span>{{ detail.meta }}</span>
                {% endif %}
              </dd>
            </div>
            {% endfor %}
          </dl>
        {% elif section.type == "callouts" %}
          <div class="bp-callouts">
            {% for callout in section.callouts or [] %}
            <article class="bp-callout-card">
              {% if callout.icon %}
              <span class="bp-callout-icon">{{ callout.icon }}</span>
              {% endif %}
              <h3>{{ callout.heading }}</h3>
              <p>{{ callout.body }}</p>
            </article>
            {% endfor %}
          </div>
        {% elif section.type == "carousel" and section.slides %}
          {% set section_offset = memory_album.section_offsets.get(section.id) if memory_album else none %}
          <div class="bp-carousel" data-carousel>
            <div class="bp-carousel-track" data-carousel-track>
              {% for slide in section.slides %}
              {% set slide_index = (section_offset + loop.index0) if section_offset is not none else loop.index0 %}
              <figure class="bp-carousel-slide"
                      {% if memory_album %}
                      data-photo-trigger
                      data-memory-album="{{ memory_album.id }}"
                      data-photo-index="{{ slide_index }}"
                      role="button"
                      tabindex="0"
                      {% endif %}>
                <img src="{{ slide.image|bulletin_media }}"
                     alt="{{ slide.caption or ('Slide ' ~ loop.index) }}"
                     data-photo-src="{{ slide.image|bulletin_media }}">
                {% if slide.caption %}
                <figcaption>{{ slide.caption }}</figcaption>
                {% endif %}
              </figure>
              {% endfor %}
            </div>
            <div class="bp-carousel-controls">
              <button type="button" class="bp-carousel-nav" data-carousel-prev aria-label="Previous slide">‚Äπ</button>
              <span class="bp-carousel-indicator" data-carousel-indicator>01/{{ '%02d' % (section.slides|length) }}</span>
              <button type="button" class="bp-carousel-nav" data-carousel-next aria-label="Next slide">‚Ä∫</button>
              {% if memory_album and section_offset is not none %}
              <button type="button"
                      class="bp-carousel-album"
                      data-memory-launch="{{ memory_album.id }}"
                      data-memory-start="{{ section_offset }}">
                View the full memory
              </button>
              {% elif section.album_url %}
              <a class="bp-carousel-album" href="{{ section.album_url }}" target="_blank" rel="noopener">Open album ‚Üó</a>
              {% endif %}
            </div>
            {% if section.description %}
            <p class="bp-carousel-description">{{ section.description }}</p>
            {% endif %}
          </div>
        {% elif section.type == "media-block" and section.image %}
          {% set media_offset = memory_album.section_offsets.get(section.id) if memory_album else none %}
          <figure class="bp-media-block {{ 'is-full' if section.fullbleed else '' }}"
                  {% if memory_album and media_offset is not none %}
                  data-photo-trigger
                  data-memory-album="{{ memory_album.id }}"
                  data-photo-index="{{ media_offset }}"
                  role="button"
                  tabindex="0"
                  {% endif %}>
            <img src="{{ section.image|bulletin_media }}"
                 alt="{{ section.alt or section.caption or section.title or post.title }}"
                 data-photo-src="{{ section.image|bulletin_media }}">
            {% if section.caption or section.credit %}
            <figcaption>
              {% if section.caption %}
              <span>{{ section.caption }}</span>
              {% endif %}
              {% if section.credit %}
              <span class="bp-media-credit">{{ section.credit }}</span>
              {% endif %}
            </figcaption>
            {% endif %}
          </figure>
        {% elif section.type == "link-list" %}
          <div class="bp-link-list">
            {% for link in section.links or [] %}
            <a class="bp-link-card" href="{{ link.url }}" target="_blank" rel="noopener">
              <div>
                <strong>{{ link.label }}</strong>
                {% if link.description %}
                <p>{{ link.description }}</p>
                {% endif %}
              </div>
              <span>‚Üó</span>
            </a>
            {% endfor %}
          </div>
        {% endif %}
      </section>
    {% endfor %}
  </article>

  <aside class="bp-sidebar">
    <div class="bp-card">
      <div class="bp-card-title">
        <span>Author & Tags</span>
      </div>
      <div class="bp-share-row">
        <button type="button" class="bp-copy-link" data-copy-link data-url="{{ request.url }}">Copy link</button>
        <div class="bp-share-icons">
          {% for handle in post.social_handles or [] %}
          <a href="{{ handle.url }}" target="_blank" rel="noopener" title="{{ handle.label }}">{{ handle.icon }}</a>
          {% endfor %}
        </div>
      </div>
      {% if post.tags %}
      <div class="bp-tag-list">
        {% for tag in post.tags %}
        <span class="bp-chip">{{ tag }}</span>
        {% endfor %}
      </div>
      {% endif %}
      <div class="bp-author-card">
        <img src="{{ (post.author_avatar or 'avatars/avatar1.png')|bulletin_media }}" alt="{{ post.author or 'RDAB Staff' }} avatar">
        <div>
          <strong>{{ post.author or 'RDAB Staff' }}</strong>
          {% if post.author_link %}
          <a href="{{ post.author_link }}" target="_blank" rel="noopener">{{ post.author_link }}</a>
          {% endif %}
          {% if post.author_bio %}
          <p>{{ post.author_bio }}</p>
          {% endif %}
          {% if post.social_handles %}
          <div class="bp-author-socials">
            {% for handle in post.social_handles %}
            <a href="{{ handle.url }}" target="_blank" rel="noopener">{{ handle.label }}</a>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    {% if related_posts %}
    <div class="bp-card">
      <div class="bp-card-title">
        <span>Trending üî•</span>
      </div>
      <div class="bp-related-list">
        {% for related in related_posts %}
        <a class="bp-related-item" href="{{ url_for('community_bulletin_post', slug=related.slug) }}">
          <img src="{{ related.header_image|bulletin_media }}" alt="{{ related.title }}">
          <div>
            <strong>{{ related.title }}</strong>
            <span>{{ related.author or 'RDAB Staff' }} ‚Ä¢ {{ related.published_at|to_date }}</span>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </aside>
</div>

<div class="bp-back-bottom">
  <a class="bp-btn-outline" href="{{ url_for('community_bulletin') }}">‚Üê View all bulletin posts</a>
</div>

<div class="bp-comments-panel" data-comments-panel id="comments">
  <div class="bp-comments-backdrop" data-comments-close></div>
  <div class="bp-comments-sheet">
    <header class="bp-comments-header">
      <button type="button" class="bp-comments-back" data-comments-close aria-label="Close comments">‚Üê Back</button>
      <div>
        <h3>Comments</h3>
        <p data-comments-count>{{ post.comment_count or (post.comment_threads or [])|length }} community replies</p>
      </div>
      <button type="button" class="bp-comments-close" data-comments-close aria-label="Close comments">‚úï</button>
    </header>
    <div class="bp-thread-view" data-thread-view hidden aria-hidden="true">
      <div class="bp-thread-view__backdrop" data-thread-close></div>
      <div class="bp-thread-view__dialog" role="dialog" aria-modal="true" tabindex="-1" data-thread-dialog>
        <header class="bp-thread-view__header">
          <button type="button" class="bp-thread-view__back" data-thread-close aria-label="Back to all comments">‚Üê Back to comments</button>
          <div>
            <h4>Comment thread</h4>
            <p data-thread-count>0 replies</p>
          </div>
          <button type="button" class="bp-thread-view__close" data-thread-close aria-label="Close thread">‚úï</button>
        </header>
        <div class="bp-thread-view__body" data-thread-body>
          <p class="bp-comment-empty">Select "View replies" to open a thread.</p>
        </div>
      </div>
    </div>
    <div class="bp-comments-content" data-comments-container>
      <p class="bp-comment-empty">Loading comments‚Ä¶</p>
    </div>
    {% set can_comment = trainer is not none %}
    <form class="bp-comment-form" aria-label="Leave a comment" data-comment-form>
      <label for="commentInput">
        {% if can_comment %}
          Add a comment
        {% else %}
          Log in to comment
        {% endif %}
      </label>
      <div class="bp-reply-banner is-hidden" data-reply-banner>
        Replying to <strong data-reply-target-label></strong>
        <button type="button" data-reply-cancel>Cancel</button>
      </div>
      <textarea id="commentInput"
                name="comment"
                rows="3"
                placeholder="{% if can_comment %}Share tips, shout-outs, or feedback‚Ä¶{% else %}Log in to join the conversation{% endif %}"
                {% if not can_comment %}disabled{% endif %}
                data-comment-input></textarea>
      <input type="hidden" name="parent_id" data-comment-parent>
      <div class="content-filter-progress"
           data-content-filter-progress
           role="status"
           aria-live="polite"
           hidden>
        <span class="content-filter-progress__spinner" aria-hidden="true"></span>
        <span>Give us just a second, we're checking this to keep the community safe.</span>
      </div>
      <button type="submit" {% if not can_comment %}disabled{% endif %}>Post Comment</button>
      {% if not can_comment %}
        <div class="bp-login-inline">
          <small class="bp-comment-hint">You need to be logged in as a trainer to add comments.</small>
          {% if not is_pwa %}
          <button type="button" class="bp-login-inline__btn" data-open-login-modal>Log in</button>
          {% endif %}
        </div>
      {% endif %}
    </form>
  </div>
</div>

{% if not trainer %}
<div class="bp-login-modal" data-login-modal hidden data-login-endpoint="{{ url_for('api_session_login') }}">
  <div class="bp-login-modal__backdrop" data-login-close></div>
  <div class="bp-login-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="bpWebLoginTitle" tabindex="-1">
    <button type="button" class="bp-login-modal__close" data-login-close aria-label="Close login form">‚úï</button>
    <h3 id="bpWebLoginTitle">Log in to RDAB</h3>
    <p>Use your trainer credentials to leave comments and reactions from the browser.</p>
    <form data-login-form>
      <label for="webLoginUsername">Trainer Name</label>
      <input id="webLoginUsername"
             name="username"
             type="text"
             autocomplete="username"
             required>
      <label for="webLoginPin">4-digit PIN</label>
      <input id="webLoginPin"
             name="pin"
             type="password"
             inputmode="numeric"
             pattern="\d{4}"
             maxlength="4"
             autocomplete="current-password"
             required>
      <button type="submit">Log in</button>
      <p class="bp-login-modal__error" data-login-error role="alert"></p>
    </form>
    <p class="bp-login-modal__note">
      Need an account?
      To create an account you must sign up using the RDAB app.
      Find out how to install it
      <a href="{{ url_for('home', install='1') }}#install" target="_blank" rel="noopener">here</a>.
    </p>
  </div>
</div>
{% endif %}

<div class="bp-engagement-bar" data-engagement-bar>
  <button class="bp-engage-btn {{ 'is-liked' if post.get('liked_by_me') else '' }}"
          data-like-button
          data-base-like="{{ post.like_count or 0 }}"
          data-liked="{{ 'true' if post.get('liked_by_me') else 'false' }}">
    <span>‚ù§Ô∏è Like</span>
    <span class="bp-like-count" data-like-count>{{ post.like_count or 0 }}</span>
  </button>
  <button class="bp-engage-btn" data-comments-toggle>
    üí¨ Comments
  </button>
  <button class="bp-engage-btn" data-back-top>
    ‚¨Ü Back to top
  </button>
</div>

<style>
.bp-back {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  text-decoration: none;
  color: #1d4ed8;
  font-weight: 600;
  margin-bottom: 12px;
}

.bp-hero {
  display: grid;
  grid-template-columns: minmax(280px, 1fr) minmax(260px, 360px);
  gap: 24px;
  padding: 24px;
  border-radius: 32px;
  background: #fff;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.1);
  margin-bottom: 32px;
}

.bp-memory-banner {
  background: linear-gradient(120deg, #0f172a, #1e3a8a);
  color: #fff;
  border-radius: 28px;
  padding: 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 18px;
  margin-bottom: 32px;
  box-shadow: 0 24px 40px rgba(2, 6, 23, 0.3);
}

.bp-memory-eyebrow {
  letter-spacing: 0.2em;
  text-transform: uppercase;
  font-size: 0.75rem;
  margin: 0 0 6px 0;
  color: #94a3b8;
  font-weight: 700;
}

.bp-memory-banner h3 {
  margin: 0;
  font-size: 1.4rem;
}

.bp-memory-banner p {
  margin: 6px 0 0 0;
  color: rgba(248, 250, 252, 0.85);
}

.bp-memory-btn {
  border: none;
  border-radius: 18px;
  padding: 12px 18px;
  font-size: 1rem;
  font-weight: 700;
  color: #0f172a;
  background: linear-gradient(120deg, #3a8dde, #68f7d0);
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  box-shadow: 0 12px 20px rgba(56, 189, 248, 0.3);
}

.bp-memory-btn:hover,
.bp-memory-btn:focus-visible {
  transform: translateY(-2px);
}

.bp-hero-media img {
  width: 100%;
  border-radius: 24px;
  object-fit: cover;
  max-height: 360px;
}

.bp-pill {
  display: inline-flex;
  padding: 6px 14px;
  border-radius: 999px;
  background: #d1fae5;
  color: #047857;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  font-size: 0.75rem;
}

.bp-hero-copy h1 {
  margin: 12px 0;
  font-size: 2.4rem;
  color: #0f172a;
  line-height: 1.2;
  word-break: break-word;
  hyphens: auto;
}

.bp-hero-meta {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 12px;
}

.bp-meta-label {
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #94a3b8;
}

.bp-author-inline {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
}

.bp-author-inline img {
  width: 40px;
  height: 40px;
  border-radius: 999px;
  object-fit: cover;
}

.bp-layout {
  display: grid;
  grid-template-columns: minmax(0, 1fr) 320px;
  gap: 24px;
}

.bp-article {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.bp-card {
  background: #fff;
  border-radius: 24px;
  padding: 18px;
  box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
}

.bp-card-title {
  font-weight: 700;
  color: #0f172a;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.bp-toc-card ol {
  margin: 0;
  padding-left: 18px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.bp-toc-card a {
  text-decoration: none;
  color: #0f172a;
  font-weight: 600;
}

.bp-section {
  background: #fff;
  border-radius: 24px;
  padding: 24px;
  box-shadow: 0 18px 36px rgba(15, 23, 42, 0.08);
}

.bp-section-heading h2 {
  margin: 0 0 14px 0;
  font-size: 1.6rem;
}

.bp-body-paragraph {
  font-size: 1rem;
  line-height: 1.7;
  color: #0f172a;
  margin-bottom: 14px;
}

.bp-detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
}

.bp-media-block {
  margin: 0;
  border-radius: 22px;
  overflow: hidden;
  background: #020617;
  display: flex;
  flex-direction: column;
  gap: 0;
}
.bp-media-block.is-full {
  margin-left: -24px;
  margin-right: -24px;
  width: calc(100% + 48px);
  border-radius: 0;
}
.bp-media-block img {
  width: 100%;
  display: block;
  max-height: 520px;
  object-fit: cover;
}
.bp-media-block figcaption {
  padding: 12px 18px;
  background: #020617;
  color: #e2e8f0;
  font-size: 0.85rem;
  display: flex;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
}
.bp-media-credit {
  opacity: 0.7;
}

.bp-detail-row {
  background: #f8fafc;
  border-radius: 16px;
  padding: 14px;
}

.bp-detail-row dt {
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.1em;
  color: #64748b;
  margin-bottom: 6px;
}

.bp-detail-row strong {
  font-size: 1rem;
  color: #0f172a;
}

.bp-detail-row span {
  display: block;
  font-size: 0.85rem;
  color: #475569;
}

.bp-callouts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 14px;
}

.bp-callout-card {
  border-radius: 18px;
  padding: 16px;
  background: #eef2ff;
}

.bp-callout-icon {
  font-size: 1.5rem;
}

.bp-callout-card h3 {
  margin: 8px 0;
}

.bp-carousel {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.bp-carousel-track {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  gap: 16px;
  border-radius: 22px;
}

.bp-carousel-track::-webkit-scrollbar {
  display: none;
}

.bp-carousel-slide {
  min-width: 100%;
  border-radius: 22px;
  overflow: hidden;
  position: relative;
  scroll-snap-align: center;
  background: #0f172a;
  color: #fff;
}

.bp-carousel-slide img {
  width: 100%;
  height: 320px;
  object-fit: cover;
  display: block;
}

.bp-carousel-slide figcaption {
  padding: 12px 16px;
  font-size: 0.95rem;
}

.bp-carousel-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.bp-carousel-nav {
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 999px;
  background: #0f172a;
  color: #fff;
  font-size: 1.3rem;
  cursor: pointer;
}

.bp-carousel-indicator {
  font-weight: 700;
  color: #0f172a;
}

.bp-carousel-album {
  margin-left: auto;
  text-decoration: none;
  font-weight: 600;
  color: #0f172a;
  padding: 8px 14px;
  border-radius: 999px;
  background: #d1fae5;
  border: none;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.bp-carousel-description {
  margin: 0;
  color: #475569;
}

.bp-link-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.bp-link-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  text-decoration: none;
  padding: 14px;
  border-radius: 16px;
  background: #f8fafc;
  color: #0f172a;
  font-weight: 600;
}

.bp-link-card p {
  margin: 4px 0 0 0;
  font-size: 0.9rem;
  font-weight: normal;
  color: #475569;
}

.bp-share-row {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  align-items: center;
  margin-bottom: 12px;
}

.bp-copy-link {
  border: none;
  background: #0f172a;
  color: #fff;
  border-radius: 999px;
  padding: 8px 16px;
  font-weight: 600;
  cursor: pointer;
}

.bp-share-icons a {
  width: 36px;
  height: 36px;
  border-radius: 12px;
  background: #e2e8f0;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
}

.bp-tag-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 12px;
}

.bp-chip {
  padding: 6px 12px;
  border-radius: 999px;
  background: #f1f5f9;
  font-size: 0.85rem;
  font-weight: 600;
}

.bp-author-card {
  display: flex;
  gap: 12px;
}

.bp-author-card img {
  width: 72px;
  height: 72px;
  border-radius: 16px;
  object-fit: cover;
}

.bp-author-card a {
  font-size: 0.9rem;
  color: #2563eb;
  text-decoration: none;
}

.bp-author-card p {
  margin: 6px 0;
  color: #475569;
}

.bp-author-socials {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.bp-author-socials a {
  color: #0f172a;
  font-weight: 600;
}

.bp-related-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.bp-related-item {
  display: flex;
  gap: 12px;
  text-decoration: none;
  color: #0f172a;
  align-items: center;
}

.bp-related-item img {
  width: 56px;
  height: 56px;
  border-radius: 16px;
  object-fit: cover;
}

.bp-related-item span {
  font-size: 0.85rem;
  color: #475569;
}

.bp-sidebar {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.bp-back-bottom {
  margin-top: 32px;
  text-align: center;
}

.bp-btn-outline {
  display: inline-flex;
  padding: 10px 20px;
  border-radius: 999px;
  border: 2px solid #0f172a;
  text-decoration: none;
  color: #0f172a;
  font-weight: 600;
}

.bp-comments-panel {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 1000;
}

.bp-comments-panel.is-open {
  pointer-events: auto;
}

.bp-comments-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(2, 6, 23, 0.5);
  opacity: 0;
  transition: opacity 0.25s ease;
}

.bp-comments-panel.is-open .bp-comments-backdrop {
  opacity: 1;
}

.bp-comments-sheet {
  position: absolute;
  right: 0;
  top: 72px;
  width: min(420px, 100%);
  height: calc(100% - 72px);
  background: #fff;
  border-top-left-radius: 24px;
  border-bottom-left-radius: 24px;
  box-shadow: -8px 0 30px rgba(15, 23, 42, 0.2);
  transform: translateX(100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.bp-comments-panel.is-open .bp-comments-sheet {
  transform: translateX(0);
}

.bp-comments-header {
  padding: 20px;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.bp-comments-header h3 {
  margin: 0;
}

.bp-comments-header p {
  margin: 4px 0 0 0;
  color: #475569;
  font-size: 0.9rem;
}

.bp-comments-close {
  border: none;
  background: #f1f5f9;
  border-radius: 999px;
  width: 36px;
  height: 36px;
  font-size: 1rem;
  cursor: pointer;
}

.bp-comments-back {
  border: none;
  background: transparent;
  color: #0f172a;
  font-weight: 600;
  font-size: 0.9rem;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
}

.bp-comments-content {
  padding: 16px 20px;
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.bp-comment {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  width: 100%;
  min-width: 0;
}

.bp-comment--highlight .bp-comment-body {
  background: #eef4ff;
  box-shadow: 0 0 0 2px rgba(58, 141, 222, 0.25);
}

.bp-comment-avatar img {
  width: 44px;
  height: 44px;
  border-radius: 999px;
  object-fit: cover;
}

.bp-comment-body {
  background: #f8fafc;
  border-radius: 16px;
  padding: 12px 14px;
  flex: 1;
  min-width: 0;
  word-break: break-word;
  overflow-wrap: anywhere;
}

.bp-comment-empty {
  text-align: center;
  color: #475569;
}

.bp-comment-meta {
  display: flex;
  gap: 8px;
  font-size: 0.85rem;
  color: #475569;
}

.bp-comment-meta strong {
  color: #0f172a;
}

.bp-comment-trainer {
  border: none;
  background: transparent;
  padding: 0;
  margin: 0;
  font: inherit;
  font-weight: 700;
  color: #0f172a;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.bp-comment-trainer::after {
  content: "‚Üó";
  font-size: 0.75em;
  color: #64748b;
  opacity: 0;
  transform: translateY(-2px);
  transition: opacity 0.15s ease;
}

.bp-comment-trainer:hover::after,
.bp-comment-trainer:focus-visible::after {
  opacity: 1;
}

.bp-comment-trainer:focus-visible {
  outline: 2px solid #2563eb;
  outline-offset: 2px;
  border-radius: 6px;
}

.bp-comment-replies {
  margin-top: 12px;
  margin-left: 8px;
  padding-left: 20px;
  border-left: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.bp-comment--reply .bp-comment-body {
  background: #fff;
  border: 1px solid #e2e8f0;
}

.bp-comment .bp-reply-btn {
  border: none;
  background: transparent;
  color: #2563eb;
  font-weight: 600;
  cursor: pointer;
  padding: 0;
  margin-top: 6px;
}

.bp-thread-toggle {
  margin-top: 8px;
  width: 100%;
  border: none;
  background: #eef2ff;
  color: #0f172a;
  font: inherit;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 12px;
  cursor: pointer;
}

.bp-thread-toggle span:first-child {
  color: #475569;
  font-weight: 500;
}

.bp-thread-toggle span:last-child {
  color: #2563eb;
}

.bp-thread-toggle:hover,
.bp-thread-toggle:focus-visible {
  background: #e0e7ff;
}

.bp-thread-toggle:focus-visible {
  outline: 2px solid #2563eb;
  outline-offset: 2px;
}

.bp-reply-banner {
  background: #ecfdf5;
  border-radius: 12px;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.85rem;
}

.bp-reply-banner.is-hidden {
  display: none;
}

.bp-reply-banner button {
  border: none;
  background: transparent;
  color: #047857;
  font-weight: 600;
  cursor: pointer;
}

.bp-comment-form {
  padding: 16px 20px 20px 20px;
  border-top: 1px solid #e2e8f0;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.bp-comment-form textarea {
  border-radius: 12px;
  border: 1px solid #cbd5f5;
  padding: 10px;
  resize: none;
  font-family: inherit;
}

.bp-comment-form button {
  border: none;
  border-radius: 999px;
  padding: 10px 16px;
  background: #0f172a;
  color: #fff;
  font-weight: 600;
}

.bp-comment-form button[disabled] {
  opacity: 0.5;
  cursor: not-allowed;
}

.bp-comment-hint {
  font-size: 0.8rem;
  color: #64748b;
}

.bp-login-inline {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  flex-wrap: wrap;
}

.bp-login-inline__btn {
  border: none;
  border-radius: 999px;
  background: #1d4ed8;
  color: #fff;
  padding: 6px 14px;
  font-weight: 600;
  cursor: pointer;
}

.bp-login-inline__btn:hover,
.bp-login-inline__btn:focus-visible {
  background: #2563eb;
}

.bp-login-modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1200;
  padding: 24px;
}

.bp-login-modal.is-open {
  display: flex;
}

.bp-login-modal__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(2, 6, 23, 0.6);
  backdrop-filter: blur(2px);
}

.bp-login-modal__dialog {
  position: relative;
  background: #fff;
  border-radius: 24px;
  width: min(420px, 100%);
  padding: 24px;
  box-shadow: 0 30px 60px rgba(15, 23, 42, 0.35);
  z-index: 1;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.bp-login-modal__dialog h3 {
  margin: 0;
}

.bp-login-modal__dialog p {
  margin: 0;
  color: #475569;
}

.bp-login-modal__dialog form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.bp-login-modal__dialog label {
  font-size: 0.85rem;
  font-weight: 600;
  color: #0f172a;
}

.bp-login-modal__dialog input {
  border-radius: 12px;
  border: 1px solid #cbd5f5;
  padding: 10px;
  font-size: 1rem;
}

.bp-login-modal__dialog button[type="submit"] {
  border: none;
  background: #0f172a;
  color: #fff;
  padding: 10px 16px;
  border-radius: 999px;
  font-weight: 600;
  cursor: pointer;
}

.bp-login-modal__close {
  position: absolute;
  top: 12px;
  right: 12px;
  border: none;
  background: transparent;
  font-size: 1.2rem;
  cursor: pointer;
}

.bp-login-modal__error {
  min-height: 1.2em;
  color: #dc2626;
  font-weight: 600;
}

.bp-login-modal__note {
  font-size: 0.85rem;
  color: #475569;
}

.bp-login-modal__note a {
  color: #1d4ed8;
  font-weight: 600;
}

body.bp-modal-open {
  overflow: hidden;
}

.bp-thread-view {
  position: absolute;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 16px;
  z-index: 5;
  pointer-events: none;
}

.bp-thread-view.is-open {
  display: flex;
  pointer-events: auto;
}

.bp-thread-view__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(15, 23, 42, 0.45);
  backdrop-filter: blur(1px);
}

.bp-thread-view__dialog {
  position: relative;
  background: #fff;
  border-radius: 24px;
  width: min(520px, calc(100% - 32px));
  max-width: 100%;
  max-height: calc(100% - 56px);
  display: flex;
  flex-direction: column;
  box-shadow: 0 20px 45px rgba(15, 23, 42, 0.2);
  z-index: 1;
  overflow: hidden;
}

.bp-thread-view__header {
  padding: 16px 20px;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.bp-thread-view__header h4 {
  margin: 0;
  font-size: 1rem;
}

.bp-thread-view__header p {
  margin: 4px 0 0 0;
  color: #475569;
  font-size: 0.85rem;
}

.bp-thread-view__body {
  padding: 16px 20px 20px;
  overflow-y: auto;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.bp-thread-view__close,
.bp-thread-view__back {
  border: none;
  background: transparent;
  font-weight: 600;
  cursor: pointer;
}

.bp-thread-view__close {
  font-size: 1rem;
  color: #0f172a;
}

.bp-thread-view__back {
  color: #2563eb;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.bp-thread-view__dialog .bp-comment {
  background: transparent;
}

.bp-thread-view__dialog .bp-comment-body {
  background: #f8fafc;
}

.bp-engagement-bar {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%) translateY(120%);
  background: #0f172a;
  color: #fff;
  border-radius: 999px;
  padding: 10px;
  display: flex;
  gap: 8px;
  box-shadow: 0 16px 30px rgba(2, 6, 23, 0.35);
  z-index: 900;
  transition: transform 0.3s ease, opacity 0.3s ease;
  opacity: 0;
}

.bp-engagement-bar.is-visible {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.bp-engage-btn {
  border: none;
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  padding: 10px 16px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  cursor: pointer;
  position: relative;
  overflow: visible;
}

.bp-engage-btn .bp-like-count {
  background: #fff;
  color: #0f172a;
  padding: 4px 8px;
  border-radius: 999px;
  font-size: 0.85rem;
}

.bp-engage-btn.is-liked {
  background: #f97316;
}

.bp-like-particle {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  font-size: 1.2rem;
  animation: bp-like-burst 800ms ease-out forwards;
}

@keyframes bp-like-burst {
  0% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  100% {
    transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, -40px))) scale(0.4);
    opacity: 0;
  }
}

@media (max-width: 640px) {
  .bp-comments-sheet {
    width: 100%;
    border-radius: 0;
    top: 56px;
    height: calc(100% - 56px);
  }

  .bp-engagement-bar {
    width: calc(100% - 24px);
    flex-wrap: wrap;
    justify-content: center;
    padding: 10px 12px;
  }

  .bp-media-block.is-full {
    margin-left: -16px;
    margin-right: -16px;
    width: calc(100% + 32px);
  }

  .bp-thread-view__dialog {
    border-radius: 16px;
    width: 100%;
    max-height: 100%;
  }
}

@media (max-width: 480px) {
  .bp-hero,
  .bp-section,
  .bp-card {
    padding: 16px;
    border-radius: 20px;
  }

  .bp-hero-copy h1 {
    font-size: 1.85rem;
  }

  .bp-hero-meta {
    grid-template-columns: 1fr;
  }

  .bp-comment-replies {
    margin-left: 0;
    padding-left: 12px;
  }

  .bp-thread-view__dialog {
    width: 100%;
    max-height: calc(100% - 32px);
  }
}
@media (max-width: 1024px) {
  .bp-layout {
    grid-template-columns: 1fr;
  }

  .bp-sidebar {
    order: -1;
  }
}

@media (max-width: 768px) {
  .bp-hero {
    grid-template-columns: 1fr;
  }

  .bp-hero-copy h1 {
    font-size: 2rem;
  }
}
</style>

<script>
(function () {
  document.querySelectorAll("[data-carousel]").forEach(function (carousel) {
    var track = carousel.querySelector("[data-carousel-track]");
    var slides = carousel.querySelectorAll(".bp-carousel-slide");
    if (!track || slides.length === 0) return;
    var prev = carousel.querySelector("[data-carousel-prev]");
    var next = carousel.querySelector("[data-carousel-next]");
    var indicator = carousel.querySelector("[data-carousel-indicator]");
    var active = 0;

    function updateIndicator() {
      if (indicator) {
        var total = slides.length;
        indicator.textContent = String(active + 1).padStart(2, "0") + "/" + String(total).padStart(2, "0");
      }
    }

    function goTo(index) {
      active = (index + slides.length) % slides.length;
      var target = slides[active];
      track.scrollTo({
        left: target.offsetLeft - track.offsetLeft,
        behavior: "smooth",
      });
      updateIndicator();
    }

    prev && prev.addEventListener("click", function () { goTo(active - 1); });
    next && next.addEventListener("click", function () { goTo(active + 1); });

    var scrollTimeout;
    track.addEventListener("scroll", function () {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(function () {
        var scrollLeft = track.scrollLeft;
        var closest = 0;
        var minDiff = Infinity;
        slides.forEach(function (slide, idx) {
          var diff = Math.abs(slide.offsetLeft - scrollLeft);
          if (diff < minDiff) {
            minDiff = diff;
            closest = idx;
          }
        });
        active = closest;
        updateIndicator();
      }, 80);
    });

    updateIndicator();
  });

  document.querySelectorAll("[data-copy-link]").forEach(function (btn) {
    btn.addEventListener("click", async function () {
      var url = btn.dataset.url;
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(url);
        } else {
          var input = document.createElement("input");
          input.value = url;
          document.body.appendChild(input);
          input.select();
          document.execCommand("copy");
          document.body.removeChild(input);
        }
        var original = btn.textContent;
        btn.textContent = "Link copied!";
        setTimeout(function () { btn.textContent = original; }, 1500);
      } catch (err) {
        console.warn("Copy failed", err);
        alert("Copy this link instead:\\n" + url);
      }
    });
  });
})();

(function () {
  var article = document.querySelector("[data-bulletin-slug]");
  var slug = article ? article.dataset.bulletinSlug : null;
  var canComment = article ? article.dataset.canComment === "true" : false;
  var isPwaContext = article ? article.dataset.isPwa === "true" : false;
  var loginUrl = "{{ url_for('login') }}";
  var loginApiUrl = "{{ url_for('api_session_login') }}";
  var MAX_THREAD_DEPTH = {{ max_comment_depth or 2 }};
  if (article && article.dataset.maxCommentDepth) {
    var parsedDepth = parseInt(article.dataset.maxCommentDepth, 10);
    if (!isNaN(parsedDepth)) {
      MAX_THREAD_DEPTH = parsedDepth;
    }
  }
  var viewerUsername = "{{ (trainer.get('trainer_username') if trainer is mapping else trainer)|default('', true)|lower }}";
  var commentsData = [];
  if (article && article.dataset.initialComments) {
    try {
      commentsData = JSON.parse(article.dataset.initialComments);
    } catch (err) {
      commentsData = [];
    }
  }
  var THREAD_PLACEHOLDER = '<p class="bp-comment-empty">Select "View replies" to open a thread.</p>';
  var threadFocusRequest = (window.location.hash || "").toLowerCase().indexOf("comments") !== -1;
  var loginModal = document.querySelector("[data-login-modal]");
  var loginForm = loginModal ? loginModal.querySelector("[data-login-form]") : null;
  var loginError = loginModal ? loginModal.querySelector("[data-login-error]") : null;
  var loginModalCloseEls = loginModal ? loginModal.querySelectorAll("[data-login-close]") : [];
  var loginTriggers = document.querySelectorAll("[data-open-login-modal]");
  var loginSubmitButton = loginForm ? loginForm.querySelector("button[type='submit']") : null;
  var loginApiEndpoint = loginModal && loginModal.dataset.loginEndpoint ? loginModal.dataset.loginEndpoint : loginApiUrl;

  var scrollLock = window.__overlayLock || {
    lock: function () { document.body.style.overflow = "hidden"; },
    unlock: function () { document.body.style.overflow = ""; },
  };

  var bar = document.querySelector("[data-engagement-bar]");
  if (bar) {
    var showThreshold = 260;
    var handleScroll = function () {
      if (window.scrollY > showThreshold) {
        bar.classList.add("is-visible");
      } else {
        bar.classList.remove("is-visible");
      }
    };
    window.addEventListener("scroll", handleScroll);
    handleScroll();
  }

  var backTop = document.querySelector("[data-back-top]");
  if (backTop) {
    backTop.addEventListener("click", function () {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  }

  function openLoginModal() {
    if (!loginModal) {
      window.location.href = loginUrl;
      return;
    }
    loginModal.classList.add("is-open");
    loginModal.removeAttribute("hidden");
    document.body.classList.add("bp-modal-open");
    if (loginError) {
      loginError.textContent = "";
    }
    if (loginForm) {
      loginForm.reset();
      var firstInput = loginForm.querySelector("input");
      if (firstInput) {
        window.setTimeout(function () { firstInput.focus(); }, 30);
      }
    }
  }

  function closeLoginModal() {
    if (!loginModal) return;
    loginModal.classList.remove("is-open");
    loginModal.setAttribute("hidden", "hidden");
    document.body.classList.remove("bp-modal-open");
  }

  function promptLogin() {
    if (isPwaContext) {
      window.location.href = loginUrl;
      return;
    }
    openLoginModal();
  }

  loginModalCloseEls.forEach(function (btn) {
    btn.addEventListener("click", function () {
      closeLoginModal();
    });
  });
  if (loginModal) {
    loginModal.addEventListener("click", function (evt) {
      if (evt.target === loginModal) {
        closeLoginModal();
      }
    });
  }
  loginTriggers.forEach(function (btn) {
    btn.addEventListener("click", function (evt) {
      evt.preventDefault();
      promptLogin();
    });
  });
  if (loginForm) {
    loginForm.addEventListener("submit", function (evt) {
      evt.preventDefault();
      var usernameField = loginForm.querySelector("[name='username']");
      var pinField = loginForm.querySelector("[name='pin']");
      var username = usernameField ? usernameField.value.trim() : "";
      var pin = pinField ? pinField.value.trim() : "";
      if (!username || !pin) {
        if (loginError) {
          loginError.textContent = "Enter your trainer name and PIN.";
        }
        return;
      }
      if (loginSubmitButton) loginSubmitButton.disabled = true;
      fetch(loginApiEndpoint || loginApiUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
        },
        body: JSON.stringify({ username: username, pin: pin }),
      })
        .then(function (resp) {
          return resp.json().catch(function () { return {}; }).then(function (body) {
            return { ok: resp.ok, body: body };
          });
        })
        .then(function (payload) {
          if (!payload.ok || !payload.body || payload.body.success === false) {
            var error = (payload.body && payload.body.error) ? payload.body.error : "Unable to log in.";
            throw new Error(error);
          }
          if (loginError) loginError.textContent = "";
          window.location.reload();
        })
        .catch(function (err) {
          if (loginError) {
            loginError.textContent = err && err.message ? err.message : "Unable to log in.";
          }
        })
        .finally(function () {
          if (loginSubmitButton) loginSubmitButton.disabled = false;
        });
    });
  }

  function escapeHtml(value) {
    return (value || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function resolveAvatar(path) {
    if (!path) return "/static/avatars/avatar1.png";
    if (path.startsWith("http") || path.startsWith("/")) return path;
    return "/static/" + path;
  }

  function formatDate(value) {
    if (!value) return "";
    try {
      var date = new Date(value);
      return date.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
    } catch (err) {
      return value;
    }
  }

  function totalCommentCount(list) {
    return (Array.isArray(list) ? list : []).reduce(function (sum, comment) {
      return sum + 1 + totalCommentCount(comment.replies || []);
    }, 0);
  }

  function replyCount(comment) {
    if (!comment || !Array.isArray(comment.replies)) return 0;
    return totalCommentCount(comment.replies);
  }

  function findCommentById(id, list) {
    if (!id) return null;
    var search = Array.isArray(list) ? list : commentsData;
    for (var i = 0; i < search.length; i++) {
      var comment = search[i];
      if ((comment.id || "").toString() === id.toString()) {
        return comment;
      }
      var nested = findCommentById(id, comment.replies || []);
      if (nested) {
        return nested;
      }
    }
    return null;
  }

  var commentsContainer = document.querySelector("[data-comments-container]");
  var commentsCountLabel = document.querySelector("[data-comments-count]");
  var threadView = document.querySelector("[data-thread-view]");
  var threadBody = threadView ? threadView.querySelector("[data-thread-body]") : null;
  var threadCountLabel = threadView ? threadView.querySelector("[data-thread-count]") : null;
  var threadDialog = threadView ? threadView.querySelector("[data-thread-dialog]") : null;
  var threadCloseEls = threadView ? threadView.querySelectorAll("[data-thread-close]") : [];

  function renderThread(comment) {
    if (!threadBody || !comment) return;
    threadBody.innerHTML = commentTemplate(comment, { showReplies: true });
    var totalReplies = replyCount(comment);
    if (threadCountLabel) {
      threadCountLabel.textContent = totalReplies
        ? totalReplies + (totalReplies === 1 ? " reply" : " replies")
        : "No replies yet";
    }
  }

  function openThread(comment) {
    if (!threadView || !comment) return;
    threadView.dataset.threadOpen = comment.id || "";
    renderThread(comment);
    threadView.classList.add("is-open");
    threadView.removeAttribute("hidden");
    threadView.setAttribute("aria-hidden", "false");
    if (threadDialog) {
      threadDialog.focus();
    }
  }

  function closeThreadView() {
    if (!threadView || !threadView.classList.contains("is-open")) {
      return false;
    }
    threadView.classList.remove("is-open");
    threadView.setAttribute("hidden", "hidden");
    threadView.setAttribute("aria-hidden", "true");
    delete threadView.dataset.threadOpen;
    if (threadBody) {
      threadBody.scrollTop = 0;
      threadBody.innerHTML = THREAD_PLACEHOLDER;
    }
    return true;
  }

  threadCloseEls.forEach(function (btn) {
    btn.addEventListener("click", function () {
      closeThreadView();
    });
  });

  function commentTemplate(comment, options) {
    if (!comment) return "";
    options = options || {};
    var isReply = !!options.isReply;
    var showReplies = !!options.showReplies;
    var authorLabel = escapeHtml(comment.author || "Trainer");
    var trainerProfileUrl = comment.trainer_profile_url || "";
    var trainerUsername = (comment.trainer_username || "").toString();
    var normalizedTrainer = trainerUsername.toLowerCase();
    var isOwnComment = Boolean(viewerUsername && normalizedTrainer && normalizedTrainer === viewerUsername);
    var trainerButton = (trainerProfileUrl
      ? '<button type="button" class="bp-comment-trainer" data-trainer-profile-trigger data-trainer-profile-username="' + escapeHtml(trainerUsername) + '" data-trainer-profile-url="' + escapeHtml(trainerProfileUrl) + '" data-trainer-display="' + authorLabel + '"' + (isOwnComment ? " data-trainer-profile-own" : "") + ">" + authorLabel + "</button>"
      : "<strong>" + authorLabel + "</strong>");
    var commentId = escapeHtml(comment.id || "");
    var replies = Array.isArray(comment.replies) ? comment.replies : [];
    var repliesMarkup = "";
    var repliesTotal = replyCount(comment);
    if (showReplies && replies.length) {
      repliesMarkup = '<div class="bp-comment-replies">' + replies.map(function (reply) {
        return commentTemplate(reply, { isReply: true, showReplies: true });
      }).join("") + "</div>";
    } else if (!showReplies && repliesTotal) {
      repliesMarkup =
        '<button type="button" class="bp-thread-toggle" data-thread-trigger="' + commentId + '" aria-haspopup="dialog">' +
          '<span>' + repliesTotal + (repliesTotal === 1 ? " reply" : " replies") + "</span>" +
          "<span>View replies</span>" +
        "</button>";
    }
    var depth = typeof comment.depth === "number" ? comment.depth : 0;
    var allowReply = canComment && depth < MAX_THREAD_DEPTH;
    var replyBtn = allowReply
      ? '<button type="button" class="bp-reply-btn" data-reply-target="' + commentId + '" data-reply-author="' + authorLabel + '">Reply</button>'
      : "";
    var classes = "bp-comment" + (isReply ? " bp-comment--reply" : "");
    return (
      '<article class="' + classes + '" data-comment-id="' + commentId + '">' +
        '<div class="bp-comment-avatar">' +
          '<img src="' + escapeHtml(resolveAvatar(comment.avatar)) + '" alt="' + authorLabel + '">' +
        "</div>" +
        '<div class="bp-comment-body">' +
          '<div class="bp-comment-meta">' +
            trainerButton +
            "<span>" + escapeHtml(formatDate(comment.timestamp)) + "</span>" +
          "</div>" +
          "<p>" + escapeHtml(comment.body || "") + "</p>" +
          replyBtn +
          repliesMarkup +
        "</div>" +
      "</article>"
    );
  }

  function updateCommentsUI(list) {
    commentsData = Array.isArray(list) ? list : [];
    if (commentsContainer) {
      if (!commentsData.length) {
        commentsContainer.innerHTML = '<p class="bp-comment-empty">Be the first to leave a comment.</p>';
      } else {
        commentsContainer.innerHTML = commentsData.map(function (comment) {
          return commentTemplate(comment, { showReplies: false });
        }).join("");
      }
    }
    var totalCount = totalCommentCount(commentsData);
    if (commentsCountLabel) {
      commentsCountLabel.textContent = totalCount + (totalCount === 1 ? " community reply" : " community replies");
    }
    if (threadView && threadView.classList.contains("is-open")) {
      var openId = threadView.dataset.threadOpen;
      if (openId) {
        var activeThread = findCommentById(openId, commentsData);
        if (activeThread) {
          renderThread(activeThread);
        } else {
          closeThreadView();
        }
      } else {
        closeThreadView();
      }
    }
  }

  updateCommentsUI(commentsData);
  var LIKE_EMOJIS = ["‚ú®", "üí´", "üåü", "üéâ", "üí•", "üî•", "‚ù§Ô∏è"];

  function burstLikeParticles(button) {
    if (!button) return;
    var total = 10;
    for (var i = 0; i < total; i++) {
      var particle = document.createElement("span");
      particle.className = "bp-like-particle";
      particle.textContent = LIKE_EMOJIS[Math.floor(Math.random() * LIKE_EMOJIS.length)];
      var dx = (Math.random() * 80 - 40) + "px";
      var dy = (-40 - Math.random() * 60) + "px";
      particle.style.setProperty("--dx", dx);
      particle.style.setProperty("--dy", dy);
      particle.style.left = (40 + Math.random() * 20) + "%";
      button.appendChild(particle);
      particle.addEventListener("animationend", function () {
        if (this && this.parentNode) {
          this.parentNode.removeChild(this);
        }
      });
    }
  }

  var likeButton = document.querySelector("[data-like-button]");
  if (likeButton && slug) {
    var countEl = likeButton.querySelector("[data-like-count]");
    var baseLikes = parseInt(likeButton.dataset.baseLike || "0", 10);
    var liked = likeButton.dataset.liked === "true";
    if (liked) {
      likeButton.classList.add("is-liked");
    }
    likeButton.addEventListener("click", function () {
      if (!canComment) {
        promptLogin();
        return;
      }
      var wasLiked = liked;
      fetch("/api/bulletin/" + slug + "/like", { method: "POST" })
        .then(function (resp) { return resp.json(); })
        .then(function (data) {
          if (data && typeof data.like_count !== "undefined") {
            var newLiked = !!data.liked;
            var justLiked = newLiked && !wasLiked;
            liked = newLiked;
            likeButton.classList.toggle("is-liked", liked);
            if (countEl) {
              countEl.textContent = data.like_count;
            }
            if (justLiked) {
              burstLikeParticles(likeButton);
            }
          } else {
            throw new Error(data && data.error ? data.error : "Unable to like this post");
          }
        })
        .catch(function (err) {
          console.warn(err);
          alert("Unable to update like right now. Please try again later.");
        });
    });
  }

  var commentsPanel = document.querySelector("[data-comments-panel]");
  var commentsToggles = document.querySelectorAll("[data-comments-toggle]");
  var commentsCloseEls = document.querySelectorAll("[data-comments-close]");
  var commentsLoadedOnce = false;

  function refreshComments() {
    if (!slug) return;
    if (commentsContainer) {
      commentsContainer.innerHTML = '<p class="bp-comment-empty">Loading comments‚Ä¶</p>';
    }
    return fetch("/api/bulletin/" + slug + "/comments")
      .then(function (resp) { return resp.json(); })
      .then(function (data) {
        if (data && Array.isArray(data.comments)) {
          updateCommentsUI(data.comments);
        }
      })
      .catch(function () {
        if (commentsContainer) {
          commentsContainer.innerHTML = '<p class="bp-comment-empty">Unable to load comments right now.</p>';
        }
      });
  }

  function openComments() {
    if (!commentsPanel || commentsPanel.classList.contains("is-open")) return;
    commentsPanel.classList.add("is-open");
    scrollLock.lock();
    if (!commentsLoadedOnce) {
      commentsLoadedOnce = true;
      refreshComments();
    }
  }

  function closeComments() {
    if (!commentsPanel || !commentsPanel.classList.contains("is-open")) return;
    closeThreadView();
    commentsPanel.classList.remove("is-open");
    scrollLock.unlock();
  }

  commentsToggles.forEach(function (btn) {
    btn.addEventListener("click", openComments);
  });
  commentsCloseEls.forEach(function (btn) {
    btn.addEventListener("click", closeComments);
  });

  document.addEventListener("keydown", function (evt) {
    if (evt.key === "Escape") {
      if (loginModal && loginModal.classList.contains("is-open")) {
        closeLoginModal();
        return;
      }
      if (closeThreadView()) return;
      closeComments();
    }
  });

  if (threadFocusRequest && commentsPanel) {
    openComments();
  }

  var form = document.querySelector("[data-comment-form]");
  var textarea = form ? form.querySelector("[data-comment-input]") : null;
  var parentInput = form ? form.querySelector("[data-comment-parent]") : null;
  var replyBanner = form ? form.querySelector("[data-reply-banner]") : null;
  var replyLabel = form ? form.querySelector("[data-reply-target-label]") : null;
  var replyCancel = form ? form.querySelector("[data-reply-cancel]") : null;
  var filterProgress = form ? form.querySelector("[data-content-filter-progress]") : null;

  function clearReplyTarget() {
    if (parentInput) parentInput.value = "";
    if (replyBanner) replyBanner.classList.add("is-hidden");
    if (replyLabel) replyLabel.textContent = "";
  }

  replyCancel && replyCancel.addEventListener("click", function () {
    clearReplyTarget();
  });

  function toggleFilterProgress(active) {
    if (!filterProgress) return;
    filterProgress.hidden = !active;
  }

  function runCommentFilter(value) {
    var filter = window.RDABContentFilter;
    if (!filter || typeof filter.scan !== "function") {
      return Promise.resolve({ allowed: true });
    }
    toggleFilterProgress(true);
    return filter.scan(value)
      .then(function (result) {
        toggleFilterProgress(false);
        return result;
      })
      .catch(function (err) {
        console.warn("Content filter error:", err);
        toggleFilterProgress(false);
        return { allowed: true };
      });
  }

  function handleReplyClick(evt) {
    var btn = evt.target.closest("[data-reply-target]");
    if (!btn || !canComment) return false;
    var targetId = btn.getAttribute("data-reply-target");
    var targetAuthor = btn.getAttribute("data-reply-author") || "Trainer";
    if (parentInput) parentInput.value = targetId || "";
    if (replyLabel) replyLabel.textContent = targetAuthor;
    if (replyBanner) replyBanner.classList.remove("is-hidden");
    textarea && textarea.focus();
    closeThreadView();
    return true;
  }

  function handleThreadToggle(evt) {
    var toggle = evt.target.closest("[data-thread-trigger]");
    if (!toggle) return false;
    var targetId = toggle.getAttribute("data-thread-trigger");
    if (!targetId) return false;
    var comment = findCommentById(targetId, commentsData);
    if (comment) {
      openThread(comment);
    }
    return true;
  }

  commentsContainer && commentsContainer.addEventListener("click", function (evt) {
    if (handleReplyClick(evt)) return;
    handleThreadToggle(evt);
  });

  threadBody && threadBody.addEventListener("click", function (evt) {
    handleReplyClick(evt);
  });

  form && form.addEventListener("submit", function (evt) {
    evt.preventDefault();
    if (!canComment || !slug) {
      promptLogin();
      return;
    }
    if (!textarea) return;
    var body = textarea.value.trim();
    if (!body) {
      alert("Please enter a comment.");
      return;
    }
    var submitBtn = form.querySelector("button[type='submit']");
    if (submitBtn) submitBtn.disabled = true;
    var payload = {
      body: body,
      parent_id: parentInput && parentInput.value ? parentInput.value : null,
    };
    runCommentFilter(body).then(function (result) {
      if (!result.allowed) {
        if (window.RDABContentFilter && typeof window.RDABContentFilter.showWarning === "function") {
          window.RDABContentFilter.showWarning(result);
        }
        if (submitBtn) submitBtn.disabled = false;
        return;
      }
      fetch("/api/bulletin/" + slug + "/comments", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
        .then(function (resp) {
          return resp.json().then(function (body) {
            return { ok: resp.ok, body: body };
          });
        })
        .then(function (payload) {
          if (!payload.ok) {
            var error = new Error(payload.body && payload.body.error ? payload.body.error : "Unable to post comment");
            if (payload.body && payload.body.filter) {
              error.isFilter = true;
              error.filter = payload.body.filter;
            }
            throw error;
          }
          var data = payload.body;
          if (data && Array.isArray(data.comments)) {
            updateCommentsUI(data.comments);
            textarea.value = "";
            clearReplyTarget();
          } else {
            throw new Error("Unable to post comment");
          }
        })
        .catch(function (err) {
          console.warn(err);
          if (err && err.isFilter && err.filter && window.RDABContentFilter && typeof window.RDABContentFilter.showWarning === "function") {
            window.RDABContentFilter.showWarning(err.filter);
          } else {
            alert(err && err.message ? err.message : "Unable to post comment right now. Please try again soon.");
          }
        })
        .finally(function () {
          if (submitBtn) submitBtn.disabled = false;
        });
    });
  });
})();
</script>
{% include "partials/memory_overlay.html" %}
{% endblock %}
