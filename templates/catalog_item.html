{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-cozy' %}
{% endblock %}

{% block content %}

<div class="item-card-detail">
  <!-- Thumbnail with Cost + Watch -->
  <div class="item-thumb" style="background-image:url('{{ item.image_url or url_for('static', filename='icons/catalog-app.png') }}')">
    <div class="cost-badge">
      <img src="{{ url_for('static', filename='passport/stamper.png') }}" alt="Cost">
      <span>{{ item.cost_stamps }}</span>
    </div>
    <button id="watchBtn" class="watch-btn" data-id="{{ item.id }}">
      <img 
        src="{{ url_for('static', filename='catalog/binocularsa.png') if item.id not in watch_ids else url_for('static', filename='catalog/binocularsb.png') }}" 
        alt="Watchlist">
    </button>
  </div>

  <!-- Meta Info -->
  <div class="item-meta">
    <h1>{{ item.name }}</h1>
    <p class="desc">{{ item.description or 'No description provided.' }}</p>

    <div class="status-row">
      <span class="stock {{ 'low' if (item.stock or 0) <= 3 else '' }}">
        ðŸ“¦ {{ item.stock }} in stock
      </span>
    </div>

    {% if item.tags and item.tags|length %}
    <div class="tags">
      {% for t in item.tags %}
      <span class="tag">#{{ t }}</span>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  <!-- Actions -->
  <div class="item-actions">
    {% set can_redeem = (item.active and (item.stock or 0) > 0) %}
    {% if can_redeem %}
      <a href="{{ url_for('catalog_redeem', item_id=item.id) }}" class="buy-btn">
        <img src="{{ url_for('static', filename='catalog/container/trade.PNG') }}" alt="Redeem">
      </a>
    {% else %}
      <button disabled class="buy-btn">Unavailable</button>
    {% endif %}
    <a href="{{ url_for('catalog') }}" class="back-btn">â¬… Back to Catalog</a>
  </div>
</div>

<style>
.item-card-detail {
  background:#fff;
  border-radius:18px;
  padding:22px;
  box-shadow:0 12px 28px rgba(15,23,42,0.14);
  display:flex;
  flex-direction:column;
  gap:18px;
}

.item-thumb {
  position:relative;
  width:100%;
  height:240px;
  border-radius:18px;
  background:#eef3f8 center/cover no-repeat;
}

.cost-badge {
  position:absolute;
  top:8px;left:8px;
  display:flex;align-items:center;gap:6px;
  background:rgba(255,255,255,.9);
  padding:2px 6px;
  border-radius:12px;
  font-weight:bold;
}
.cost-badge img {width:24px;height:24px;}

.watch-btn {
  position:absolute;
  top:10px;right:10px;
  background:rgba(15,23,42,0.08);
  border:none;
  border-radius:50%;
  width:40px;height:40px;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:background .2s ease;
}
.watch-btn:hover{background:rgba(15,23,42,0.18);}
.watch-btn img {width:24px;height:24px;}

.item-meta h1 {margin:0 0 6px;font-size:1.5em;}
.item-meta .desc {color:#444;margin-bottom:8px;}

.status-row {margin-bottom:6px;}
.stock {font-weight:600;padding:3px 8px;border-radius:8px;background:#f4f7fa;}
.stock.low {background:#fff5f5;color:#b91c1c;}

.tags {display:flex;flex-wrap:wrap;gap:6px;}
.tag {background:#eef2ff;color:#3a8dde;padding:4px 8px;border-radius:6px;font-size:0.8em;}

.item-actions {display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
.buy-btn {
  display:inline-flex;align-items:center;justify-content:center;
  background:none;border:none;cursor:pointer;
}
.buy-btn img {width:64px;height:64px;}
.buy-btn[disabled]{opacity:.6;cursor:not-allowed;}

.back-btn {
  background:#eef2ff;
  color:#3a8dde;
  padding:10px 16px;
  border-radius:999px;
  text-decoration:none;
  font-weight:600;
  box-shadow:0 6px 16px rgba(58,141,222,0.18);
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("watchBtn");
  if (btn) {
    btn.addEventListener("click", () => {
      fetch(`/watchlist/toggle/{{ item.id }}`, {method:"POST"})
        .then(r=>r.json())
        .then(data=>{
          if(data.success){
            const img=btn.querySelector("img");
            img.src = data.watched
              ? "{{ url_for('static', filename='catalog/binocularsb.png') }}"
              : "{{ url_for('static', filename='catalog/binocularsa.png') }}";
          }
        });
    });
  }
});
</script>

{% endblock %}
