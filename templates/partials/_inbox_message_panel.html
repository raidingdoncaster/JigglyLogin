{% set panel_mode = panel_mode | default(false) %}
{% set is_digital = msg.is_digital_code if msg.is_digital_code is defined else ((msg.type or '')|lower == 'system' and 'code' in ((msg.subject or '')|lower ~ ' ' ~ (msg.message or '')|lower)) %}
<section class="inbox-message-panel {{ 'inbox-message-panel--modal' if panel_mode else '' }}"
         data-message-id="{{ msg.id }}"
         data-message-type="{{ (msg.type or '')|lower }}"
         data-message-digital="{{ 'true' if is_digital else 'false' }}">
  <div class="msg-card {{ 'msg-card--digital' if is_digital else '' }}">
    <div class="head">
      <div class="left">
        <div class="subject">{{ msg.subject }}</div>
        <div class="meta">
          {% if msg.type %}<span class="type-pill">{{ msg.type }}</span>{% endif %}
          <span class="date">{{ msg.sent_at|to_date }}</span>
          {% if msg.audience and msg.audience != 'ALL' %}
            <span class="aud">To: {{ msg.audience }}</span>
          {% endif %}
        </div>
      </div>
      <div class="right">
        {% if panel_mode %}
          <a class="btn secondary"
             href="{{ url_for('inbox', panel=1) }}"
             data-inbox-panel-link="true">⬅ Inbox</a>
          <button type="button"
                  class="btn tertiary"
                  data-inbox-panel-close>✕ Close</button>
        {% else %}
          <a class="btn secondary" href="{{ url_for('inbox') }}">⬅ Back to Inbox</a>
        {% endif %}
      </div>
    </div>

    {% set metadata = msg.metadata or {} %}
    {% set comment_thread = metadata.comment_reply %}
    {% set comment_thread_url = metadata.url if comment_thread else None %}
    {% set comment_thread_cta = metadata.cta_label if comment_thread else None %}
    {% set body_content = msg.message or '' %}
    <div class="body">
      {% if '<' in body_content %}
        {{ body_content|safe }}
      {% else %}
        {{ body_content|nl2br }}
      {% endif %}

      {% if comment_thread %}
        {% set parent_body = comment_thread.parent.body if comment_thread.parent else '' %}
        {% set reply_body = comment_thread.reply.body if comment_thread.reply else '' %}
        <div class="thread-card">
          <div class="thread-header">
            Conversation on <strong>{{ metadata.post_title or 'the community bulletin' }}</strong>
          </div>
          <div class="thread-comments">
            <div class="thread-bubble yours">
              <p class="bubble-label">Your comment</p>
              <p class="comment-text">{{ (parent_body or 'Comment unavailable')|e|replace('\n','<br>')|safe }}</p>
            </div>
            <div class="thread-bubble reply">
              <p class="bubble-label">Reply from {{ (comment_thread.reply.author or 'Trainer') if comment_thread.reply else 'Trainer' }}</p>
              <p class="comment-text">{{ (reply_body or 'Reply unavailable')|e|replace('\n','<br>')|safe }}</p>
            </div>
          </div>
          {% if comment_thread_url %}
          <div class="cta">
            <a class="btn primary" href="{{ comment_thread_url }}">{{ comment_thread_cta or 'Open comment thread' }}</a>
          </div>
          {% endif %}
        </div>
      {% endif %}

      {% if metadata.url and not comment_thread %}
      <div class="cta">
        <a class="btn primary"
           href="{{ metadata.url }}"
           {% if msg.type == 'receipt' %}data-inbox-receipt-link{% endif %}>
          {{ metadata.cta_label or ( 'View receipt' if msg.type == 'receipt' else 'View details') }}
        </a>
      </div>
      {% endif %}
    </div>
  </div>
</section>

<style>
.msg-card { background:#fff; border-radius:18px; padding:22px; box-shadow:0 12px 28px rgba(15,23,42,0.14); display:flex; flex-direction:column; gap:16px; position:relative; overflow:hidden; }
.msg-card--digital{
  background:#fff7ed;
  background:linear-gradient(130deg,#fff7ed,#fff8d6);
  box-shadow:0 20px 36px rgba(236,72,153,0.35);
  animation:digitalPulse 6s ease-in-out infinite;
}
.msg-card--digital::before{
  content:"";
  position:absolute;
  inset:-20% 0 0 0;
  background-image:url("data:image/svg+xml,%3Csvg width='240' height='160' viewBox='0 0 240 160' xmlns='http://www.w3.org/2000/svg'%3E%3Cg opacity='0.3' stroke='%23fbbf24' stroke-width='8' fill='none'%3E%3Cpath d='M-20 40 L60 0 L140 40 L220 0 L300 40'/%3E%3C/g%3E%3C/svg%3E");
  background-size:200px 140px;
  mix-blend-mode:normal;
  opacity:0.4;
  pointer-events:none;
}
.msg-card--digital .subject,
.msg-card--digital .meta,
.msg-card--digital .body{
  color:#7c2d12;
}
.msg-card--digital .btn.primary{
  background:#ec4899;
  box-shadow:0 12px 26px rgba(236,72,153,0.35);
}
.msg-card--digital .btn.primary:hover{
  background:#db2777;
}
.msg-card--digital .type-pill{
  background:rgba(124,45,18,0.15);
  color:#7c2d12;
}
.head { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap; }
.subject { font-weight:800; font-size:1.2em; color:#1f2937; }
.meta { margin-top:4px; display:flex; gap:8px; align-items:center; color:#475569; font-size:.9em; flex-wrap:wrap; }
.type-pill { font-size:.75em; padding:2px 10px; border-radius:999px; background:#eef2ff; color:#334155; text-transform:uppercase; font-weight:700; }
.body { color:#1f2937; line-height:1.6; word-break:break-word; }
.body p { margin:0 0 12px 0; }
.body p:last-child { margin-bottom:0; }
.body ul, .body ol { margin:0 0 12px 18px; padding-left:18px; }
.body li { margin-bottom:6px; }
.body a { color:#3a8dde; text-decoration:underline; font-weight:600; }
.cta { margin-top:16px; }
.btn { text-decoration:none; padding:10px 18px; border-radius:999px; font-weight:700; display:inline-flex; align-items:center; gap:6px; border:0; cursor:pointer; }
.btn.primary { background:#3a8dde; color:#fff; box-shadow:0 8px 20px rgba(58,141,222,0.25); }
.btn.secondary { background:#eef2ff; color:#3a8dde; }
.btn.tertiary { background:#fff; color:#0f172a; box-shadow:0 4px 12px rgba(15,23,42,0.12); }
.aud { background:#f4f4f5; padding:2px 8px; border-radius:999px; font-size:.8em; font-weight:600; }
.thread-card { margin-top:18px; padding:16px; border-radius:14px; background:#f8fafc; border:1px solid #e2e8f0; }
.thread-header { font-weight:600; margin-bottom:12px; color:#0f172a; }
.thread-comments { display:flex; flex-direction:column; gap:12px; }
.thread-bubble { padding:12px; border-radius:12px; background:#fff; border:1px solid #dbeafe; box-shadow:0 4px 12px rgba(15,23,42,0.06); }
.thread-bubble.yours { border-color:#c7d2fe; }
.thread-bubble.reply { border-color:#bfdbfe; background:#f0f7ff; }
.bubble-label { font-size:.8em; font-weight:700; color:#475569; margin-bottom:6px; text-transform:uppercase; letter-spacing:.04em; }
.comment-text { margin:0; color:#0f172a; line-height:1.4; }
.msg-card--digital .thread-card{
  background:rgba(255,255,255,0.7);
  border-color:rgba(124,45,18,0.25);
}
@keyframes digitalPulse{
  0%{transform:translateY(0);}
  50%{transform:translateY(-2px);}
  100%{transform:translateY(0);}
}
</style>
