{% set background_file = trainer.trainer_card_background or 'default.png' %}
{% set background_url = url_for('static', filename='backgrounds/' ~ background_file) %}
{% set passport_panel_id = ('passportDrawer-' ~ (trainer.trainer_username | replace(' ', '-') | lower)) %}

<div class="trainer-panel"
     data-trainer-panel
     data-panel-mode="{{ 'modal' if modal_view else 'page' }}"
     data-panel-refresh-url="{{ url_for('admin_trainer_panel', username=trainer.trainer_username) }}">
  <div class="admin-header">
    <h1>üë§ Manage Trainer</h1>
    <p>Update details and stamps for <strong class="identity-text">{{ trainer.trainer_username }}</strong></p>
  </div>

  <div class="trainer-panel-alert" data-panel-alert role="status" aria-live="polite" hidden></div>

  <div class="panel-quick-actions">
    <button type="button"
            class="btn btn-secondary"
            data-passport-load
            data-passport-url="{{ url_for('admin_trainer_passport', username=trainer.trainer_username) }}"
            data-passport-label-open="Hide Passport"
            aria-controls="{{ passport_panel_id }}"
            aria-expanded="false">
      <span data-passport-label>View Passport</span>
    </button>
  </div>

  <div class="trainer-detail-card" style="--trainer-panel-bg: url('{{ background_url }}');">
    <div class="trainer-card-overlay"></div>
    <img src="{{ url_for('static', filename='avatars/' ~ trainer.avatar_icon) }}"
         alt="Avatar" class="avatar-lg">
    <h2 class="trainer-username">{{ trainer.trainer_username }}</h2>
    <p><strong>Account Type:</strong> {{ 'Standard' if trainer.account_type|lower == 'standard' else trainer.account_type }}</p>
    <p><strong>Campfire Username:</strong> <span class="identity-text">{{ trainer.campfire_username or 'N/A' }}</span></p>
    <p><strong>Current Stamps:</strong> {{ trainer.stamps or 0 }}</p>
    <p class="trainer-background-label">Background: <span class="identity-text">{{ background_file }}</span></p>
  </div>

  <div id="{{ passport_panel_id }}" class="passport-drawer" data-passport-panel hidden>
    <div class="passport-drawer__header">
      <div>
        <p class="passport-drawer__eyebrow">Passport Overview</p>
        <h3>üìò Lugia Ledger</h3>
      </div>
      <button type="button" class="passport-drawer__close" data-passport-close aria-label="Close passport view">&times;</button>
    </div>
    <div class="passport-drawer__body" data-passport-body>
      <p class="passport-drawer__placeholder">Select "View Passport" to load this trainer's stamp history.</p>
    </div>
  </div>

  <div class="management-actions">
    <div class="action-box" data-action-box>
      <button type="button" class="action-toggle" data-action-toggle aria-expanded="false">
        <span>üÜî Change Trainer Username</span>
        <span class="chevron" aria-hidden="true"></span>
      </button>
      <div class="action-box-body" data-action-body hidden>
        <form action="{{ url_for('admin_change_trainer_username_v2', username=trainer.trainer_username) }}" method="post">
          <input type="text" name="new_trainer_username" value="{{ trainer.trainer_username }}" placeholder="New trainer username" required>
          <button type="submit">Update Username</button>
        </form>
        <p class="action-note">Updates their login name. Make sure the new username is unique.</p>
      </div>
    </div>

    <div class="action-box" data-action-box>
      <button type="button" class="action-toggle" data-action-toggle aria-expanded="false">
        <span>üéüÔ∏è Adjust Stamps</span>
        <span class="chevron" aria-hidden="true"></span>
      </button>
      <div class="action-box-body" data-action-body hidden>
        <form action="{{ url_for('admin_adjust_stamps_v2', username=trainer.trainer_username) }}" method="post">
          <input type="number" name="count" placeholder="Amount" required>
          <input type="text" name="reason" placeholder="Reason (optional)">
          <select name="action" required>
            <option value="award">‚ûï Award</option>
            <option value="remove">‚ûñ Remove</option>
          </select>
          <button type="submit">Update Stamps</button>
        </form>
      </div>
    </div>

    <div class="action-box" data-action-box>
      <button type="button" class="action-toggle" data-action-toggle aria-expanded="false">
        <span>üëë Change Account Type</span>
        <span class="chevron" aria-hidden="true"></span>
      </button>
      <div class="action-box-body" data-action-body hidden>
        <form action="{{ url_for('admin_change_account_type_v2', username=trainer.trainer_username) }}" method="post">
          <select name="account_type" required>
            <option value="standard" {% if trainer.account_type|lower == "standard" %}selected{% endif %}>Standard</option>
            <option value="Kids Account" {% if trainer.account_type == "Kids Account" %}selected{% endif %}>Kids Account</option>
            <option value="Admin" {% if trainer.account_type == "Admin" %}selected{% endif %}>Admin</option>
          </select>
          <button type="submit">Update Type</button>
        </form>
      </div>
    </div>

    <div class="action-box" data-action-box>
      <button type="button" class="action-toggle" data-action-toggle aria-expanded="false">
        <span>üîë Reset PIN</span>
        <span class="chevron" aria-hidden="true"></span>
      </button>
      <div class="action-box-body" data-action-body hidden>
        <form action="{{ url_for('admin_reset_pin_v2', username=trainer.trainer_username) }}" method="post">
          <input type="password" name="new_pin" maxlength="4" pattern="\d{4}" placeholder="New 4-digit PIN" required>
          <button type="submit">Reset PIN</button>
        </form>
        <p class="action-note">PINs are required to be exactly 4 digits.</p>
      </div>
    </div>

    <div class="action-box" data-action-box>
      <button type="button" class="action-toggle" data-action-toggle aria-expanded="false">
        <span>üî• Campfire Username</span>
        <span class="chevron" aria-hidden="true"></span>
      </button>
      <div class="action-box-body" data-action-body hidden>
        <form action="{{ url_for('admin_change_campfire_username_v2', username=trainer.trainer_username) }}" method="post">
          <input type="text" name="new_campfire_username" value="{{ trainer.campfire_username }}" placeholder="Campfire username (optional)">
          <button type="submit">Save Campfire</button>
        </form>
        <p class="action-note">Enter without the @ symbol. Leave blank to clear the saved Campfire username.</p>
      </div>
    </div>

    <div class="action-box" data-action-box>
      <button type="button" class="action-toggle" data-action-toggle aria-expanded="false">
        <span>üß† Memorable Password</span>
        <span class="chevron" aria-hidden="true"></span>
      </button>
      <div class="action-box-body" data-action-body hidden>
        <form action="{{ url_for('admin_change_memorable_password_v2', username=trainer.trainer_username) }}" method="post">
          <input type="text" name="new_memorable_password" placeholder="New memorable password" required>
          <button type="submit">Update Memorable</button>
        </form>
        <p class="action-note">Players use this during recovery. Keep it easy to remember.</p>
      </div>
    </div>

    <div class="action-box action-box--danger" data-action-box>
      <button type="button" class="action-toggle" data-action-toggle aria-expanded="false">
        <span>‚õî Deactivate & Delete Account</span>
        <span class="chevron" aria-hidden="true"></span>
      </button>
      <div class="action-box-body" data-action-body hidden>
        <div class="delete-account-flow"
             data-delete-flow
             data-delete-trainer="{{ trainer.trainer_username }}"
             data-delete-verify-url="{{ url_for('admin_verify_trainer_delete', username=trainer.trainer_username) }}">
          <div class="delete-account-alert" data-delete-alert hidden></div>

          <section class="delete-step" data-delete-step="intro">
            <p class="delete-step__eyebrow">Permanent deletion</p>
            <p class="delete-step__copy">
              Deactivating this trainer PERMANENTLY DELETES THE ACCOUNT, STAMPS, HISTORY, MESSAGING AND ALL RELATED FUNCTIONS from the RDAB app and Lugia‚Äôs databases forever (!!).
              Once completed, it can never be returned to the player and the data cannot be restored. This happens instantly after deletion.
            </p>
            <button type="button" class="btn btn-secondary delete-step__primary" data-delete-continue>I understand, continue</button>
          </section>

          <form class="delete-step" data-delete-step="password" novalidate hidden>
            <p class="delete-step__eyebrow">Verify admin access</p>
            <p class="delete-step__copy">
              Confirm the admin dashboard password to continue this deletion. This ensures only authorised admins can wipe trainers.
            </p>
            <label for="deleteAdminPassword-{{ trainer.trainer_username }}">Admin dashboard password</label>
            <input type="password"
                   id="deleteAdminPassword-{{ trainer.trainer_username }}"
                   name="admin_password"
                   inputmode="text"
                   autocomplete="current-password"
                   placeholder="Enter admin dashboard password"
                   data-delete-password
                   required>
            <div class="delete-step__actions">
              <button type="button" class="btn btn-secondary" data-delete-back data-delete-back-step="intro">Back</button>
              <button type="button" class="btn btn-danger" data-delete-verify data-loading-label="Verifying‚Ä¶">Verify password</button>
            </div>
          </form>

          <form class="delete-step"
                data-delete-step="confirm"
                action="{{ url_for('admin_delete_trainer_account', username=trainer.trainer_username) }}"
                method="post"
                hidden>
            <input type="hidden" name="delete_token" value="" data-delete-token>
            <p class="delete-step__eyebrow">Final confirmation</p>
            <p class="delete-step__copy delete-step__copy--strong">
              You are deleting the account <strong class="identity-text">{{ trainer.trainer_username }}</strong> and all of its related data and assets, please tap to confirm this process.
            </p>
            <div class="delete-step__actions">
              <button type="button" class="btn btn-secondary" data-delete-back data-delete-back-step="password">Back</button>
              <button type="submit" class="btn btn-danger" data-delete-submit data-loading-label="Deleting‚Ä¶">Delete account now</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  {% if show_back_link %}
    <div class="panel-back-link">
      <a href="{{ url_for('admin_trainers') }}" class="btn">‚¨Ö Back to Trainer Manager</a>
    </div>
  {% endif %}
</div>

<style>
.trainer-panel {
  display:flex;
  flex-direction:column;
  gap:18px;
}
.trainer-panel-alert {
  border-radius:14px;
  padding:12px 16px;
  font-size:0.9em;
  border:1px solid transparent;
  background:#f1f5f9;
  color:#1e293b;
  box-shadow:0 4px 10px rgba(15,23,42,0.08);
}
.trainer-panel-alert[hidden] {
  display:none;
}
.trainer-panel-alert.is-success {
  border-color:#34d399;
  background:#ecfdf5;
  color:#065f46;
}
.trainer-panel-alert.is-error {
  border-color:#f87171;
  background:#fef2f2;
  color:#991b1b;
}
.trainer-panel-alert.is-info {
  border-color:#93c5fd;
  background:#eff6ff;
  color:#1d4ed8;
}
.panel-quick-actions {
  display:flex;
  justify-content:flex-end;
}
.panel-quick-actions .btn {
  background:#fff;
  color:#3a8dde;
  border:1px solid #3a8dde;
  box-shadow:none;
}
.panel-quick-actions .btn:hover {
  background:#3a8dde10;
}
.trainer-detail-card {
  position:relative;
  border-radius:18px;
  padding:24px;
  text-align:center;
  box-shadow:0 12px 28px rgba(15,23,42,0.14);
  background-size:cover;
  background-position:center;
  background-image:var(--trainer-panel-bg, none);
  overflow:hidden;
}
.trainer-card-overlay {
  position:absolute;
  inset:0;
  background:rgba(255,255,255,0.88);
  border-radius:inherit;
}
.trainer-detail-card > * {
  position:relative;
  z-index:1;
}
.trainer-background-label {
  font-size:0.85em;
  color:#4b5563;
  margin-top:12px;
}
.avatar-lg {
  width:100px;
  height:100px;
  border-radius:50%;
  border:3px solid #3a8dde;
  margin-bottom:12px;
  box-shadow:0 8px 20px rgba(58,141,222,0.25);
}
.passport-drawer {
  border:1px solid #e2e8f0;
  border-radius:18px;
  padding:18px;
  background:#f9fafb;
  box-shadow:0 10px 24px rgba(15,23,42,0.08);
}
.passport-drawer[hidden] {
  display:none;
}
.passport-drawer__header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
.passport-drawer__eyebrow {
  margin:0;
  text-transform:uppercase;
  letter-spacing:0.2em;
  font-size:0.65em;
  color:#94a3b8;
}
.passport-drawer__header h3 {
  margin:4px 0 0;
}
.passport-drawer__close {
  background:rgba(15,23,42,0.08);
  border:0;
  width:34px;
  height:34px;
  border-radius:50%;
  font-size:1.3em;
  cursor:pointer;
}
.passport-drawer__close:hover {
  background:rgba(15,23,42,0.16);
}
.passport-drawer__placeholder {
  margin:0;
  padding:40px 20px;
  text-align:center;
  color:#64748b;
}
.passport-drawer__placeholder--error {
  color:#b91c1c;
}
.management-actions {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap:18px;
}
.action-box {
  background:#fff;
  border-radius:16px;
  box-shadow:0 10px 24px rgba(15,23,42,0.12);
  overflow:hidden;
}
.action-toggle {
  width:100%;
  border:0;
  background:transparent;
  font-size:1em;
  font-weight:600;
  color:#1f2937;
  padding:16px 18px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  cursor:pointer;
}
.action-toggle:focus-visible {
  outline:2px solid #3a8dde;
  outline-offset:2px;
}
.chevron {
  width:18px;
  height:18px;
  border:2px solid #94a3b8;
  border-left:0;
  border-top:0;
  transform:rotate(45deg);
  transition:transform .2s ease;
}
.action-box.is-open .chevron {
  transform:rotate(-135deg);
}
.action-box-body {
  padding:0 18px 18px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.action-box form {
  display:flex;
  flex-direction:column;
  gap:8px;
}
.action-box input,
.action-box select {
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #d7dbe6;
  font-size:0.95rem;
  transition:border-color .2s ease, box-shadow .2s ease;
}
.action-box input:focus,
.action-box select:focus {
  outline:none;
  border-color:#3a8dde;
  box-shadow:0 0 0 3px rgba(58,141,222,0.2);
}
.action-box button[type="submit"] {
  padding:10px 16px;
  border:none;
  background:#3a8dde;
  color:white;
  font-weight:600;
  border-radius:999px;
  cursor:pointer;
  box-shadow:0 8px 20px rgba(58,141,222,0.25);
  transition:transform .2s ease, box-shadow .2s ease;
}
.action-box button[type="submit"]:hover {
  transform:translateY(-1px);
  box-shadow:0 12px 26px rgba(58,141,222,0.3);
}
.action-note {
  margin:0;
  font-size:0.78rem;
  color:#6b7280;
}
.action-box--danger {
  border:1px solid #fecaca;
}
.action-box--danger .action-box-body {
  background:#fff1f2;
}
.action-box--danger .action-toggle {
  color:#991b1b;
}
.delete-account-alert {
  margin:4px 0 8px;
  padding:10px 14px;
  border-radius:12px;
  font-size:0.85rem;
  border:1px solid transparent;
}
.delete-account-alert[hidden] {
  display:none;
}
.delete-account-alert.is-success {
  background:#ecfdf5;
  border-color:#34d399;
  color:#065f46;
}
.delete-account-alert.is-error {
  background:#fef2f2;
  border-color:#fecaca;
  color:#991b1b;
}
.delete-account-alert.is-info {
  background:#eef2ff;
  border-color:#c7d2fe;
  color:#4338ca;
}
.delete-step {
  display:flex;
  flex-direction:column;
  gap:10px;
  padding:6px 0;
}
.delete-step__eyebrow {
  margin:0;
  text-transform:uppercase;
  letter-spacing:0.2em;
  font-size:0.68rem;
  color:#b91c1c;
}
.delete-step__copy {
  margin:0;
  font-size:0.9rem;
  color:#4b5563;
}
.delete-step__copy--strong {
  font-weight:600;
  color:#991b1b;
}
.delete-step__actions {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.delete-step__primary {
  align-self:flex-start;
}
.panel-back-link {
  text-align:center;
}
.trainer-panel .btn {
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:10px 18px;
  border-radius:999px;
  text-decoration:none;
  font-weight:600;
}
.trainer-panel .btn:not(.btn-danger):not(.btn-secondary) {
  background:#3a8dde;
  color:#fff;
  box-shadow:0 8px 20px rgba(58,141,222,0.25);
}
.trainer-panel .btn:not(.btn-danger):not(.btn-secondary):hover {
  transform:translateY(-1px);
  box-shadow:0 8px 26px rgba(58,141,222,0.3);
}
.trainer-panel .btn-secondary {
  background:#fff;
  color:#1f2937;
  border:1px solid #cbd5f5;
  box-shadow:none;
}
.trainer-panel .btn-secondary:hover {
  background:#eef2ff;
  box-shadow:0 4px 12px rgba(99,102,241,0.15);
}
.trainer-panel .btn-danger {
  background:#dc2626;
  color:#fff;
  box-shadow:0 8px 20px rgba(220,38,38,0.25);
}
.trainer-panel .btn-danger:hover {
  transform:translateY(-1px);
  box-shadow:0 10px 28px rgba(220,38,38,0.32);
}

@media(max-width:640px) {
  .action-toggle {
    font-size:0.95em;
  }
  .chevron {
    width:14px;
    height:14px;
  }
}
</style>
