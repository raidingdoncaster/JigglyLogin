{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-cozy' %}
{% endblock %}

{% block content %}
<h2>ðŸ“¨ Inbox</h2>

{% if latest_bulletin_post %}
<section class="bulletin-widget">
  <div class="bulletin-heading">
    <div class="bulletin-logo">
      <span>News</span>
    </div>
    <div>
      <p class="bulletin-eyebrow">RDAB Community Bulletin</p>
      <h3 class="bulletin-title">Stay in the loop with community updates, roadmaps, and spotlights.</h3>
    </div>
  </div>

  <div class="bulletin-card">
    <div class="bulletin-card-text">
      <p class="bulletin-label">Latest Post</p>
      <h4>{{ latest_bulletin_post.title }}</h4>
      <p class="bulletin-meta">
        {{ latest_bulletin_post.tag }} Â· {{ latest_bulletin_post.read_time }} Â· {{ latest_bulletin_post.published_at|to_date }}
      </p>
      <p class="bulletin-summary">{{ latest_bulletin_post.summary }}</p>
    </div>
    <div class="bulletin-card-art">
      <img src="{{ url_for('static', filename=latest_bulletin_post.header_image) }}"
           alt="Header art for {{ latest_bulletin_post.title }}">
    </div>
  </div>

  <a class="bulletin-cta" href="{{ url_for('community_bulletin') }}">View Community Bulletin â†’</a>
</section>
{% endif %}

<!-- Tabs -->
<div class="tabs">
  <a class="tab {{ 'active' if tab == 'all' else '' }}" href="{{ url_for('inbox', tab='all', sort=sort_by) }}">All</a>
  <a class="tab {{ 'active' if tab == 'notifications' else '' }}" href="{{ url_for('inbox', tab='notifications', sort=sort_by) }}">Notifications</a>
  <a class="tab {{ 'active' if tab == 'receipts' else '' }}" href="{{ url_for('inbox', tab='receipts', sort=sort_by) }}">Receipts</a>
</div>

<!-- Sorting / Filtering -->
<div class="inbox-filters">
  <form method="get" action="{{ url_for('inbox') }}">
    <input type="hidden" name="tab" value="{{ tab }}">
    <label for="sort">Sort by:</label>
    <select name="sort" id="sort" onchange="this.form.submit()">
      <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Newest First</option>
      <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>Oldest First</option>
      <option value="unread" {% if sort_by == 'unread' %}selected{% endif %}>Unread Only</option>
      <option value="read" {% if sort_by == 'read' %}selected{% endif %}>Read Only</option>
      <option value="type" {% if sort_by == 'type' %}selected{% endif %}>By Type</option>
    </select>
  </form>
</div>

<!-- Inbox Items -->
<div class="inbox-container">
  {% for msg in inbox %}
    {% set read = trainer in (msg.read_by or []) %}
    <a href="{{ url_for('inbox_message', message_id=msg.id) }}" class="inbox-card-link">
      <div class="inbox-card {{ 'read' if read else 'unread' }}">
        <div class="inbox-row1">
          <h3>{{ msg.subject }}</h3>
          {% if msg.type %}
            <span class="type-pill">{{ msg.type }}</span>
          {% endif %}
        </div>
        <p class="inbox-date">{{ msg.sent_at|to_date }}</p>
        <p class="snippet">{{ msg.message|striptags|replace('\r\n', ' ')|replace('\n', ' ')|truncate(110) }}</p>
      </div>
    </a>
  {% else %}
    <p class="empty-state">No messages yet.</p>
  {% endfor %}
</div>

<div class="actions-row">
  <a href="{{ url_for('dashboard') }}" class="btn">â¬… Back to Dashboard</a>
</div>

<style>
.bulletin-widget {
  background: #f0f7ff;
  border-radius: 28px;
  padding: 20px 22px;
  margin: 10px 0 22px 0;
  box-shadow: 0 18px 30px rgba(56, 103, 214, 0.15);
}
.bulletin-heading {
  display: flex;
  gap: 14px;
  align-items: center;
  margin-bottom: 14px;
}
.bulletin-logo {
  width: 58px;
  height: 58px;
  border-radius: 999px;
  background: linear-gradient(135deg, #5ab5ff, #2d6be8);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-weight: 700;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.bulletin-eyebrow {
  margin: 0;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: #1d3e85;
  font-weight: 700;
}
.bulletin-title {
  margin: 2px 0 0 0;
  font-size: 1.05rem;
  color: #0f172a;
}
.bulletin-card {
  background: #79c9ff;
  border-radius: 28px;
  padding: 18px;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  color: #0f172a;
}
.bulletin-card-text {
  flex: 1 1 220px;
}
.bulletin-card-art {
  flex: 0 0 200px;
  display: flex;
  justify-content: center;
  align-items: center;
}
.bulletin-card-art img {
  width: 100%;
  max-width: 220px;
  border-radius: 20px;
  box-shadow: 0 12px 25px rgba(15, 23, 42, 0.25);
}
.bulletin-label {
  text-transform: uppercase;
  font-size: 0.85rem;
  margin: 0 0 6px 0;
  font-weight: 700;
}
.bulletin-card h4 {
  margin: 0;
  font-size: 1.3rem;
  color: #082042;
}
.bulletin-meta {
  margin: 6px 0 10px 0;
  font-size: 0.85rem;
  color: #03305f;
  font-weight: 600;
}
.bulletin-summary {
  margin: 0;
  font-size: 0.95rem;
}
.bulletin-cta {
  display: inline-flex;
  margin-top: 16px;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  text-decoration: none;
  color: #06468a;
  background: #c3f8da;
  border-radius: 999px;
  padding: 10px 16px;
  box-shadow: inset 0 0 0 1px rgba(6, 70, 138, 0.15);
}
.bulletin-cta:hover {
  background: #b0f1ce;
}
.tabs {
  display:flex; gap:8px; margin:8px 0 10px 0;
}
.tab {
  text-decoration:none; padding:6px 10px; border-radius:999px;
  background:#eef2ff; color:#334155; font-weight:700; font-size:.9em;
}
.tab.active { background:#3a8dde; color:#fff; }

.inbox-filters {
  margin-top: 6px;
  margin-bottom: 12px;
  text-align: right;
}
.inbox-filters select {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 0.9em;
}
.inbox-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 10px;
}
.inbox-card-link {
  text-decoration: none;
  color: inherit;
}
.inbox-card {
  background: #fff;
  border-radius: 16px;
  padding: 18px;
  box-shadow: 0 12px 28px rgba(15,23,42,0.12);
  transition: background 0.3s ease, transform 0.2s ease;
}
.inbox-card.unread {
  border-left: 5px solid #3a8dde;
  background: #f0f8ff;
}
.inbox-card.read {
  border-left: 5px solid #aaa;
  opacity: 0.85;
}
.inbox-card:hover{transform:translateY(-2px);}
.inbox-row1 {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.inbox-card h3 {
  margin: 0;
  font-size: 1.05em;
  color: #3a8dde;
}
.type-pill {
  font-size: 0.75em;
  padding: 2px 8px;
  border-radius: 999px;
  background: #eef2ff;
  color: #334155;
  text-transform: uppercase;
}
.inbox-date {
  font-size: 0.8em;
  color: #777;
  margin: 5px 0;
}
.snippet {
  color: #555;
  font-size: 0.9em;
}
.actions-row{margin-top:20px;text-align:center;}
.btn {
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:10px 18px;
  background:#3a8dde;
  color:#fff;
  border-radius:999px;
  text-decoration:none;
  font-weight:600;
  box-shadow:0 8px 20px rgba(58,141,222,0.25);
}
.empty-state{text-align:center;color:#64748b;font-weight:600;}
</style>
{% endblock %}
