{% extends "base.html" %}

{% block page_csettings %}
  {% set container_class = 'is-cozy' %}
{% endblock %}

{% block content %}
<div class="login-launcher" data-login-launcher aria-live="polite" aria-busy="true">
  <div class="login-launcher__halo"></div>
  <div class="login-launcher__card">
    <div class="login-launcher__logo">RDAB</div>
    <p class="login-launcher__text">Warming up your Aurora Passportâ€¦</p>
    <div class="login-launcher__meter">
      <div class="login-launcher__meter-fill"></div>
    </div>
  </div>
</div>

<div class="auth-shell auth-shell--aurora auth-shell--snowfall">
  <section class="auth-hero auth-hero--login">
    <div class="hero-text">
      <span class="hero-pill">Aurora passport</span>
      <h1>Compact new login, same RDAB magic.</h1>
      <p>Sign in to stay synced with Doncasterâ€™s PokÃ©mon GO community, unlock frosted rewards, and keep every stamp safe in the cloud.</p>
      <ul class="hero-points">
        <li>Live stamp balance + inbox badges update without reloading.</li>
        <li>Frosted gradients echo the in-person passport you already carry.</li>
        <li>Optimised for quick check-ins from any winter raid stop.</li>
      </ul>
    </div>
    <div class="hero-media aurora-preview" aria-hidden="true">
      <div class="passport-card">
        <div class="passport-card__eyebrow">Trainer preview</div>
        <div class="passport-card__title">Trailblazer</div>
        <div class="passport-card__stats">
          <strong>12</strong>
          <span>stamps logged</span>
        </div>
        <div class="passport-card__progress">
          <div class="passport-card__progress-fill" style="--progress:68%;"></div>
        </div>
        <div class="passport-card__chips">
          <span>Advent</span>
          <span>Passport</span>
          <span>Meetup</span>
        </div>
      </div>
      <div class="passport-card passport-card--mini">
        <p>Next reward</p>
        <strong>Frosted avatar</strong>
        <span class="passport-card__badge">3 stamps away</span>
      </div>
    </div>
  </section>

  <style>
    .login-launcher{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,#0f172a,#020617 70%);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9000;
      overflow:hidden;
      transition:opacity .6s ease, visibility .6s ease;
    }
    .login-launcher.is-hidden{
      opacity:0;
      visibility:hidden;
      pointer-events:none;
    }
    .login-launcher__halo{
      position:absolute;
      width:120vmax;
      height:120vmax;
      background:conic-gradient(from 90deg,#38bdf8,#a855f7,#ec4899,#38bdf8);
      filter:blur(140px);
      animation:launcherSpin 18s linear infinite;
      opacity:0.35;
    }
    @keyframes launcherSpin{
      to{transform:rotate(360deg);}
    }
    .login-launcher__card{
      position:relative;
      padding:32px clamp(28px,5vw,42px);
      border-radius:32px;
      background:rgba(2,6,23,0.8);
      border:1px solid rgba(255,255,255,0.12);
      backdrop-filter:blur(24px);
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:18px;
      box-shadow:0 35px 80px rgba(2,6,23,0.65);
      color:#f8fafc;
      max-width:min(480px,90vw);
    }
    .login-launcher__logo{
      font-family:var(--identity-font,'Space Grotesk',monospace);
      font-size:1.6rem;
      letter-spacing:0.4em;
      text-transform:uppercase;
      margin:0 auto;
    }
    .login-launcher__text{
      margin:0;
      font-size:1rem;
      color:rgba(248,250,252,0.85);
    }
    .login-launcher__meter{
      width:100%;
      height:8px;
      border-radius:999px;
      background:rgba(255,255,255,0.15);
      overflow:hidden;
      position:relative;
    }
    .login-launcher__meter-fill{
      width:100%;
      height:100%;
      background:linear-gradient(90deg,#38bdf8,#a855f7,#ec4899,#38bdf8);
      animation:launcherMeter 2.6s ease-in-out infinite;
    }
    @keyframes launcherMeter{
      0%{transform:translateX(-100%);}
      50%{transform:translateX(0);}
      100%{transform:translateX(100%);}
    }

    .auth-shell--snowfall{ position:relative; }
    .auth-shell--aurora{
      position:relative;
      padding:clamp(18px,4vw,42px);
      border-radius:32px;
      background:#030617;
      background-image:
        radial-gradient(circle at 15% 20%, rgba(59,130,246,0.45), transparent 45%),
        radial-gradient(circle at 80% 0%, rgba(167,139,250,0.45), transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(34,197,94,0.25), transparent 40%);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:clamp(18px,4vw,32px);
      box-shadow:0 30px 80px rgba(2,6,23,0.55);
    }
    .auth-shell--aurora::before,
    .auth-shell--aurora::after{
      content:"";
      position:absolute;
      inset:-30% -20%;
      background:linear-gradient(120deg,#0f172a,#1e3a8a,#22d3ee,#f472b6 70%,#a855f7);
      opacity:0.45;
      filter:blur(70px);
      animation:auroraFlow 22s ease-in-out infinite;
      transform:translate3d(0,0,0);
      z-index:0;
    }
    @keyframes auroraFlow{
      0%{transform:translate3d(0,0,0) rotate(0deg); background-position:0% 50%;}
      50%{transform:translate3d(3%, -3%,0) rotate(5deg); background-position:100% 50%;}
      100%{transform:translate3d(0,0,0) rotate(0deg); background-position:0% 50%;}
    }
    .auth-shell--aurora::after{
      animation-delay:-8s;
      opacity:0.35;
      mix-blend-mode:screen;
    }
    .auth-shell--aurora > *{
      position:relative;
      z-index:1;
    }

    .snowfall-layer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:1200;
      overflow:hidden;
      mix-blend-mode:screen;
      opacity:0.85;
    }
    .snowflake{
      position:absolute;
      top:-10%;
      width:var(--size,8px);
      height:var(--size,8px);
      border-radius:50%;
      background:radial-gradient(circle,rgba(255,255,255,0.95) 0%,rgba(255,255,255,0.4) 60%,rgba(255,255,255,0) 100%);
      box-shadow:0 0 12px rgba(148,197,255,0.45);
      opacity:var(--opacity,0.6);
      animation:snowDrift var(--duration,14s) linear infinite;
      transform:translate3d(0,-10%,0) scale(var(--scale,1));
    }
    @keyframes snowDrift{
      0%{transform:translate3d(0,-10%,0) scale(var(--scale,1));}
      100%{transform:translate3d(var(--drift, 24px),110vh,0) scale(var(--scale,1));}
    }
    @media (prefers-reduced-motion: reduce){
      .snowfall-layer{display:none !important;}
      .auth-shell--aurora::before,
      .auth-shell--aurora::after{animation:none;}
    }

    .auth-hero--login{
      display:flex;
      flex-wrap:wrap;
      align-items:stretch;
      justify-content:space-between;
      gap:clamp(18px,4vw,32px);
      padding:clamp(18px,4vw,32px);
      border-radius:28px;
      background:rgba(15,23,42,0.35);
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter:blur(24px);
    }
    .hero-text{
      flex:1 1 320px;
      display:flex;
      flex-direction:column;
      gap:14px;
      color:#f8fafc;
    }
    .auth-hero--login .hero-media{
      display:flex;
      justify-content:center;
    }
    .hero-pill{
      align-self:flex-start;
      padding:6px 14px;
      border-radius:999px;
      background:rgba(255,255,255,0.08);
      letter-spacing:0.24em;
      text-transform:uppercase;
      font-size:0.62rem;
      font-weight:600;
    }
    .auth-hero--login h1{
      margin:0;
      font-size:clamp(1.45rem,1.8vw,1.9rem);
      color:#fff;
    }
    .auth-hero--login p{
      margin:0;
      color:rgba(226,232,240,0.94);
      line-height:1.5;
    }
    .hero-points{
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:8px;
      color:rgba(226,232,240,0.9);
    }
    .hero-points li{
      display:flex;
      gap:8px;
      align-items:flex-start;
      font-size:0.92rem;
    }
    .hero-points li::before{
      content:"âœ¦";
      color:#a5f3fc;
      font-size:0.8rem;
      margin-top:2px;
    }

    .aurora-preview{
      flex:0 0 clamp(260px,34%,340px);
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .passport-card{
      position:relative;
      border-radius:28px;
      padding:22px;
      background:linear-gradient(135deg,rgba(15,23,42,0.85),rgba(79,70,229,0.7));
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 20px 45px rgba(15,23,42,0.35);
      overflow:hidden;
      color:#f8fafc;
    }
    .passport-card::after{
      content:"";
      position:absolute;
      inset:12px;
      border-radius:24px;
      background:radial-gradient(circle at 20% 20%,rgba(255,255,255,0.2),transparent 55%);
      pointer-events:none;
    }
    .passport-card__eyebrow{
      letter-spacing:0.28em;
      font-size:0.62rem;
      text-transform:uppercase;
      color:rgba(255,255,255,0.75);
    }
    .passport-card__title{
      font-size:1.2rem;
      margin:8px 0 16px;
    }
    .passport-card__stats{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .passport-card__stats strong{
      font-size:2.6rem;
      line-height:1;
    }
    .passport-card__stats span{
      opacity:0.75;
      font-weight:500;
      font-size:0.9rem;
    }
    .passport-card__progress{
      width:100%;
      height:6px;
      border-radius:999px;
      background:rgba(255,255,255,0.2);
      margin:18px 0 12px;
      overflow:hidden;
    }
    .passport-card__progress-fill{
      width:var(--progress,60%);
      height:100%;
      border-radius:inherit;
      background:linear-gradient(90deg,#a5f3fc,#f472b6,#f97316);
      animation:progressPulse 3.6s ease-in-out infinite;
    }
    @keyframes progressPulse{
      0%,100%{filter:drop-shadow(0 0 6px rgba(165,243,252,0.6));}
      50%{filter:drop-shadow(0 0 12px rgba(248,113,113,0.8));}
    }
    .passport-card__chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .passport-card__chips span{
      padding:6px 12px;
      border-radius:999px;
      background:rgba(15,23,42,0.65);
      border:1px solid rgba(255,255,255,0.12);
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.18em;
    }
    .passport-card--mini{
      background:rgba(15,23,42,0.7);
      border:1px dashed rgba(255,255,255,0.25);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .passport-card--mini p{
      margin:0;
      text-transform:uppercase;
      letter-spacing:0.18em;
      font-size:0.7rem;
      color:rgba(248,250,252,0.75);
    }
    .passport-card--mini strong{
      font-size:1.15rem;
    }
    .passport-card__badge{
      align-self:flex-start;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(56,189,248,0.2);
      border:1px solid rgba(125,211,252,0.35);
      font-size:0.8rem;
    }

    .auth-card{
      border-radius:28px;
      padding:clamp(20px,4vw,30px);
      background:rgba(3,7,30,0.75);
      border:1px solid rgba(255,255,255,0.1);
      box-shadow:0 25px 55px rgba(2,6,23,0.45);
      backdrop-filter:blur(24px);
      color:#f8fafc;
      max-width:520px;
    }
    .auth-card h2{
      margin:0 0 6px;
      font-size:1.4rem;
    }
    .auth-card .auth-subtitle{
      margin:0 0 18px;
      color:rgba(226,232,240,0.85);
      font-size:0.95rem;
    }
    .auth-label{
      color:rgba(248,250,252,0.78);
      font-weight:600;
    }
    .auth-input{
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.35);
      background:rgba(15,23,42,0.45);
      color:#f8fafc;
      box-shadow:none;
    }
    .auth-input::placeholder{
      color:rgba(226,232,240,0.6);
    }
    .auth-input-row{
      gap:10px;
    }
    .auth-btn{
      border-radius:999px;
    }
    .auth-btn--primary{
      background:linear-gradient(120deg,#38bdf8,#a855f7);
      border:none;
      box-shadow:0 20px 35px rgba(56,189,248,0.25);
    }
    .auth-btn--secondary,
    .auth-btn--ghost,
    .auth-btn--outline{
      border-color:rgba(255,255,255,0.25);
      color:#e2e8f0;
    }
    .auth-links{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:12px;
      margin-top:18px;
    }

    .auth-tip{
      border-radius:18px;
      background:rgba(15,23,42,0.45);
      border:1px solid rgba(59,130,246,0.35);
      color:#e2e8f0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 16px;
      margin-top:18px;
    }
    #reminder-text{
      transition:opacity 0.35s ease;
    }
    #pokeball-loader{
      width:26px;
      height:26px;
      border-radius:50%;
      border:3px solid rgba(248,250,252,0.4);
      border-top-color:#f472b6;
      animation:spin 1.4s linear infinite;
    }
    #pokeball-loader.pop{
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin{
      to{transform:rotate(360deg);}
    }

    .policy-cta{
      border-radius:22px;
      padding:20px 22px;
      background:rgba(15,23,42,0.4);
      border:1px solid rgba(255,255,255,0.12);
      color:#f8fafc;
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .policy-cta h3{
      margin:0;
    }
    .policy-cta p{
      margin:0;
      max-width:440px;
      color:rgba(226,232,240,0.9);
    }

    @media(max-width:720px){
      .auth-shell--aurora{
        border-radius:0;
        padding:16px 14px 32px;
      }
      .auth-hero--login{
        flex-direction:column;
      }
      .aurora-preview{
        width:100%;
      }
      .auth-card{
        width:100%;
      }
    }
  </style>

  <section class="auth-card">
    <h2>Welcome back</h2>
    <p class="auth-subtitle">Enter your exact Trainer Name and PIN to unlock the Aurora Passport experience.</p>
    <form action="{{ url_for('login') }}" method="post" class="auth-form">
      <label class="auth-label" for="login-username">Trainer Name</label>
      <input id="login-username" class="auth-input" type="text" name="username" placeholder="Exact Trainer Name" required>

      <label class="auth-label" for="login-pin">4-digit PIN</label>
      <div class="auth-input-row">
        <input id="login-pin" class="auth-input" type="password" name="pin" placeholder="Enter your PIN" pattern="\d{4}" maxlength="4" required>
        <button type="button" class="auth-btn auth-btn--outline" onclick="togglePin('login-pin', this)">Show</button>
      </div>

      <button type="submit" class="auth-btn auth-btn--primary auth-btn--full">Log in</button>
    </form>

    <div class="auth-tip" id="reminder-carousel">
      <span id="reminder-text">ðŸ”‘ Never share your PIN or memorable password with anyone â€“ admins will never ask for it.</span>
      <div id="pokeball-loader"></div>
    </div>

    <div class="auth-links">
      <a href="{{ url_for('signup') }}" class="auth-btn auth-btn--secondary">Create account</a>
      <a href="{{ url_for('recover') }}" class="auth-btn auth-btn--ghost">Forgot PIN?</a>
    </div>
  </section>

  <section class="policy-cta">
    <h3>Need the details?</h3>
    <p>Read how we protect trainers, manage prizes, and keep the RDAB app running safely.</p>
    <a href="{{ url_for('policies_index') }}?pwa=1&amp;source=login" class="auth-btn auth-btn--primary">View policies</a>
  </section>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const loginLauncher = document.querySelector('[data-login-launcher]');
    if (loginLauncher) {
      const MIN_DURATION = 3000;
      const startTime = performance && performance.now ? performance.now() : Date.now();
      let launcherSettled = false;
      const settleLauncher = () => {
        if (launcherSettled) return;
        launcherSettled = true;
        const now = performance && performance.now ? performance.now() : Date.now();
        const elapsed = now - startTime;
        const delay = Math.max(0, MIN_DURATION - elapsed);
        setTimeout(() => {
          loginLauncher.classList.add('is-hidden');
          setTimeout(() => loginLauncher.remove(), 700);
        }, delay);
      };
      if (document.readyState === 'complete') {
        settleLauncher();
      } else {
        window.addEventListener('load', settleLauncher, { once: true });
      }
      setTimeout(() => settleLauncher(), MIN_DURATION + 4000); // Fallback if load never fires
    }

    const loginShell = document.querySelector('.auth-shell--snowfall');
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');

    if (loginShell && !prefersReducedMotion.matches) {
      const layerId = 'login-snowfall-layer';
      let snowLayer = document.getElementById(layerId);

      if (!snowLayer) {
        snowLayer = document.createElement('div');
        snowLayer.id = layerId;
        snowLayer.className = 'snowfall-layer';
        snowLayer.setAttribute('aria-hidden', 'true');
        document.body.appendChild(snowLayer);
      } else {
        snowLayer.innerHTML = '';
      }

      const flakeTarget = window.matchMedia('(max-width: 640px)').matches ? 28 : 60;

      for (let i = 0; i < flakeTarget; i++) {
        const flake = document.createElement('span');
        flake.className = 'snowflake';
        flake.style.left = `${Math.random() * 100}%`;
        flake.style.animationDelay = `${Math.random() * 12}s`;
        flake.style.setProperty('--size', `${4 + Math.random() * 12}px`);
        flake.style.setProperty('--duration', `${10 + Math.random() * 10}s`);
        flake.style.setProperty('--opacity', (0.25 + Math.random() * 0.55).toFixed(2));
        flake.style.setProperty('--scale', (0.55 + Math.random() * 1).toFixed(2));
        flake.style.setProperty('--drift', `${(Math.random() - 0.5) * 180}px`);
        snowLayer.appendChild(flake);
      }
    }

    let reminders = [
      "ðŸ“± Add the Raiding Doncaster and Beyond app to your homescreen! Just press the share button, then add to home!",
      "ðŸŽ‰ Every check-in brings you closer to rewards â€“ donâ€™t miss out!",
      "ðŸ”„ Forgot your PIN? Use the recovery option with your memorable password.",
      "âœï¸ Write down your memorable password somewhere safe so you donâ€™t lose access.",
      "ðŸŽ® Remember: signing in here helps track your Passport stamps, check-ins, and prizes!"
    ];

    reminders = reminders
      .map(value => ({ value, sort: Math.random() }))
      .sort((a, b) => a.sort - b.sort)
      .map(({ value }) => value);

    let currentIndex = 0;
    const reminderElement = document.getElementById("reminder-text");
    const pokeball = document.getElementById("pokeball-loader");

    if (reminderElement && pokeball) {
      setInterval(() => {
        reminderElement.style.opacity = 0;
        setTimeout(() => {
          currentIndex = (currentIndex + 1) % reminders.length;
          reminderElement.textContent = reminders[currentIndex];
          reminderElement.style.opacity = 1;
          pokeball.classList.add("pop");
          setTimeout(() => pokeball.classList.remove("pop"), 300);
        }, 1000);
      }, 7000);
    }
  });
</script>
{% endblock %}
