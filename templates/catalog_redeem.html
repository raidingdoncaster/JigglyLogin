{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-cozy' %}
{% endblock %}

{% block content %}

<div class="item-card-detail">
  <!-- Item Thumbnail with Cost -->
  <div class="item-thumb" style="background-image:url('{{ item.image_url or url_for('static', filename='icons/catalog-app.png') }}')">
    <div class="cost-badge">
      <img src="{{ url_for('static', filename='passport/stamper.png') }}" alt="Cost">
      <span>{{ item.cost_stamps }}</span>
    </div>
  </div>

  <!-- Meta Info -->
  <div class="item-meta">
    <h1>Redeem: {{ item.name }}</h1>
    <p class="desc">{{ item.description or '' }}</p>

    <div class="status-row">
      <span class="stock {{ 'low' if (item.stock or 0) <= 3 else '' }}">
        üì¶ {{ item.stock }} in stock
      </span>
      <span class="balance {{ 'bad' if balance < item.cost_stamps else 'good' }}">
        üí∞ Your balance: {{ balance }}
      </span>
    </div>

    {% if balance < item.cost_stamps %}
    <p class="warn">You don‚Äôt have enough stamps to redeem this prize.</p>
    {% endif %}
  </div>

  <!-- Redemption Form -->
  <form method="post" class="redeem-form" onsubmit="return confirmSubmit(this);">
    <h3>üóìÔ∏è Choose a Meet-up for pickup</h3>
    {% if meetups and meetups|length %}
      <div class="meetups">
        {% for m in meetups %}
        <label class="meetup">
          <input type="radio" name="meetup_id" value="{{ m.id }}" required>
          <div>
            <strong>{{ m.name }}</strong><br>
            <span class="muted">{{ m.location }} ‚Ä¢ {{ m.date|to_date }} @ {{ m.start_time }}</span>
          </div>
        </label>
        {% endfor %}
      </div>
    {% else %}
      <p>No active meet-ups available right now.</p>
    {% endif %}

    <label class="confirm">
      <input type="checkbox" name="confirm" value="yes" required>
      I confirm I want to spend {{ item.cost_stamps }} stamps for <strong>{{ item.name }}</strong>.
    </label>

    <div class="item-actions">
      <button type="submit" class="buy-btn" id="redeemBtn"
        {% if balance < item.cost_stamps or not meetups %}disabled{% endif %}>
        <img src="{{ url_for('static', filename='catalog/container/trade.PNG') }}" alt="Redeem">
      </button>
      <a href="{{ url_for('catalog_item', item_id=item.id) }}" class="back-btn">‚¨Ö Cancel</a>
    </div>
  </form>
</div>

<!-- üîπ LOADING OVERLAY -->
<div id="order-loading" style="display:none;">
  <img src="{{ url_for('static', filename='catalog/container/trade.PNG') }}" alt="Loading">
  <div class="msg" id="order-msg">Slakoth is processing your order, please be patient‚Ä¶</div>
  <div class="percent" id="order-percent">0%</div>
</div>

<style>
.item-card-detail {background:#fff;border-radius:18px;padding:22px;box-shadow:0 12px 28px rgba(15,23,42,0.14);display:flex;flex-direction:column;gap:18px;}
.item-thumb {position:relative;width:100%;height:200px;border-radius:18px;background:#eef3f8 center/cover no-repeat;}
.cost-badge {position:absolute;top:8px;left:8px;display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.9);padding:2px 6px;border-radius:12px;font-weight:bold;}
.cost-badge img {width:24px;height:24px;}
.item-meta h1 {margin:0 0 6px;font-size:1.4em;}
.item-meta .desc {color:#444;margin-bottom:8px;}
.stock {font-weight:600;padding:3px 8px;border-radius:8px;background:#f4f7fa;}
.stock.low {background:#fff5f5;color:#b91c1c;}
.balance.good {background:#e8f7ef;color:#065f46;padding:3px 8px;border-radius:8px;}
.balance.bad {background:#fff5f5;color:#b91c1c;padding:3px 8px;border-radius:8px;}
.warn {color:#b91c1c;font-weight:600;margin-top:6px;}
.redeem-form {background:#f9fafb;padding:16px;border-radius:16px;display:flex;flex-direction:column;gap:12px;}
.redeem-form h3{margin:0;color:#1d4ed8;font-size:1rem;}
.meetups {display:flex;flex-direction:column;gap:10px;}
.meetup {display:flex;gap:10px;align-items:flex-start;border:1px solid #e2e8f0;border-radius:12px;padding:12px;background:#fff;box-shadow:0 6px 16px rgba(15,23,42,0.08);}
.meetup input{margin-top:6px;}
.muted {color:#6b7280;font-size:.9em;}
.confirm {display:flex;align-items:center;gap:6px;margin:12px 0;}
.item-actions {display:flex;gap:12px;align-items:center;}
.buy-btn {background:none;border:none;cursor:pointer;}
.buy-btn img {width:56px;height:56px;}
.buy-btn[disabled]{opacity:.6;cursor:not-allowed;}
.back-btn {background:#eef2ff;color:#1d4ed8;padding:10px 16px;border-radius:999px;text-decoration:none;font-weight:600;box-shadow:0 6px 16px rgba(29,78,216,0.18);}

/* üîπ Loading overlay styling */
#order-loading {
  position:fixed; inset:0;
  background:rgba(255,255,255,.97);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  z-index:99999; text-align:center;
  font-weight:600; font-size:1.1em; color:#333;
}
#order-loading img {
  width:90px; height:90px;
  animation:spinBounce 1.2s infinite;
}
@keyframes spinBounce {
  0% {transform:rotate(0) scale(1);}
  50% {transform:rotate(180deg) scale(1.1);}
  100% {transform:rotate(360deg) scale(1);}
}
#order-loading .msg {margin-top:12px;}
#order-loading .percent {margin-top:8px;font-size:0.9em;color:#666;}
</style>

<script>
function confirmSubmit(form){
  const btn=document.getElementById("redeemBtn");
  if(btn){
    btn.disabled=true; // üß± stop double click
  }
  showLoading(); // ‚ö° trigger loader instantly
  return true; // allow normal form submit
}

function showLoading(){
  const loader=document.getElementById("order-loading");
  loader.style.display="flex";

  const messages=[
    "Slakoth is processing your order, please be patient‚Ä¶",
    "Eliminating potential Ultra Beast threats‚Ä¶",
    "Rotom is checking our warehouse‚Ä¶",
    "Delibird is printing your receipt‚Ä¶",
    "Professor Willow is checking if Gyms are still under construction‚Ä¶"
  ];

  let msgIndex=0;
  let percent=0;
  const msgEl=document.getElementById("order-msg");
  const pctEl=document.getElementById("order-percent");

  const interval=setInterval(()=>{
    percent+=5;
    if(percent>100) percent=100;
    pctEl.textContent=percent+"%";

    if(percent % 25===0 && msgIndex<messages.length){
      msgEl.textContent=messages[msgIndex];
      msgIndex++;
    }

    if(percent===100) clearInterval(interval);
  },200); // runs ~4s total
}
</script>

{% endblock %}
