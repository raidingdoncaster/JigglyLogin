{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-wide' %}
{% endblock %}

{% block content %}
{% set roster = trainer_roster or [] %}
{% set categories = notification_categories or [] %}
{% set type_choices = notification_types or [] %}

<h1>üì¢ Notifications Center</h1>
<p>Compose inbox announcements, target the right trainers, and review recent sends.</p>
<div id="notifAlert" class="inline-toast is-hidden" role="status" aria-live="polite"></div>

<!-- Compose -->
<details class="card compose-card" id="composeCard">
  <summary class="compose-card__summary">
    <div>
      <p class="eyebrow">Comms toolkit</p>
      <h3>‚ûï Compose notification</h3>
      <p class="muted">Write rich HTML-friendly messages and choose the perfect audience.</p>
    </div>
    <span class="summary-action" aria-hidden="true"></span>
  </summary>
  <div class="compose-card__body" id="composeBody">
    <form method="post" class="compose-form" id="composeForm">
      <div class="form-grid">
        <label>
          <span>Type</span>
          <select name="type">
            {% for value, label in type_choices %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </label>
        <label class="subject-field">
          <span>Subject</span>
          <input type="text" name="subject" placeholder="Weekly meetup update" required>
        </label>
      </div>

      <div class="editor">
        <div class="editor-toolbar" data-editor="message">
          <button type="button" data-format="strong" title="Bold"><strong>B</strong></button>
          <button type="button" data-format="em" title="Italic"><em>I</em></button>
          <button type="button" data-format="ul" title="Bullet list">‚Ä¢ List</button>
          <button type="button" data-format="a" title="Link">üîó Link</button>
          <button type="button" data-format="br" title="Line break">‚Üµ</button>
        </div>
        <textarea id="notifMessage" name="message" rows="6" required placeholder="Hi trainers! &lt;strong&gt;Saturday meetup&lt;/strong&gt; starts at 10:00."></textarea>
        <p class="editor-helper">
          Supports <code>&lt;strong&gt;</code>, <code>&lt;em&gt;</code>, lists, and links. HTML is sanitized automatically.
        </p>
      </div>

      <div class="audience-section">
        <div class="audience-header">
          <div>
            <h4>Audience</h4>
            <p>Target everyone or hand-pick trainers. Use the quick chips for select all/clear.</p>
          </div>
          <p class="audience-selected">
            Selected: <span id="audienceSelectedCount">0</span>
          </p>
        </div>
        <div class="audience-mode">
          <label class="chip-option">
            <input type="radio" name="audience_mode" value="all" checked>
            <span>All trainers</span>
          </label>
          <label class="chip-option">
            <input type="radio" name="audience_mode" value="targeted">
            <span>Targeted trainers</span>
          </label>
        </div>

        <div class="audience-panel" id="audiencePanel" hidden>
          <div class="audience-controls">
            <input type="search" id="audienceSearch" placeholder="Search trainers‚Ä¶" aria-label="Search trainers">
            <div class="chip-row">
              <button type="button" class="chip" data-select="all">Select All</button>
              <button type="button" class="chip" data-select="none">Clear</button>
              {% for acct in account_types or [] %}
                <button type="button" class="chip" data-select-group="{{ acct|lower }}">{{ acct }}</button>
              {% endfor %}
            </div>
          </div>
          <div class="audience-list" id="audienceList" aria-live="polite">
            {% if roster %}
              {% for trainer in roster %}
                <label class="audience-option"
                       data-username="{{ trainer.trainer_username|lower }}"
                       data-account-type="{{ trainer.account_type|lower }}">
                  <input type="checkbox" name="audience_multi" value="{{ trainer.trainer_username }}">
                  <div class="option-details">
                    <span class="name">{{ trainer.trainer_username }}</span>
                    <span class="meta">{{ trainer.account_type }}</span>
                  </div>
                </label>
              {% endfor %}
            {% else %}
              <p class="empty-note">Trainer roster unavailable. Use manual entry below.</p>
            {% endif %}
          </div>
          <label class="manual-entry">
            <span>Manual usernames (comma separated)</span>
            <input type="text" name="audience_manual" placeholder="e.g. Psyduck, Misty">
          </label>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn primary">üöÄ Send notification</button>
      </div>
    </form>
  </div>
</details>

<!-- Notification Hub -->
<section class="card notification-hub">
  <div class="hub-header">
    <div>
      <h2>üóÇÔ∏è Recent notifications</h2>
      <p>Browse the last 100 sends, search for keywords, or filter by type.</p>
    </div>
    <div class="hub-toolbar">
      <input type="search" id="notificationSearch" placeholder="Search subject or body‚Ä¶" aria-label="Search notifications">
      <select id="notificationSort" aria-label="Sort notifications">
        <option value="newest">Newest first</option>
        <option value="oldest">Oldest first</option>
        <option value="audience">Audience A ‚Üí Z</option>
        <option value="type">Type</option>
      </select>
    </div>
  </div>

  <div class="category-pills" id="notificationCategories">
    <button type="button" class="pill active" data-type="all">All</button>
    {% for cat in categories %}
      <button type="button" class="pill" data-type="{{ cat.value }}">{{ cat.label }}</button>
    {% endfor %}
  </div>

  <div class="hub-layout">
    <div class="notification-list" id="notificationList" role="list">
      {% for n in notifications %}
        {% set row_type = (n.type or 'announcement')|lower %}
        {% set data_payload = {
          "id": n.id,
          "subject": n.subject,
          "message": n.message,
          "type": n.type,
          "audience": n.audience,
          "sent_at": n.sent_at
        } %}
        <article class="notification-card"
                 data-id="{{ n.id }}"
                 data-type="{{ row_type }}"
                 data-audience="{{ n.audience or 'ALL' }}"
                 data-date="{{ n.sent_at or '' }}"
                 data-search="{{ (n.subject ~ ' ' ~ (n.message or ''))|striptags|lower }}"
                 tabindex="0"
                 role="listitem">
          <div class="notification-card__header">
            <span class="type-pill">{{ n.type or 'Announcement' }}</span>
            <time datetime="{{ n.sent_at or '' }}">{{ n.sent_at|to_date }}</time>
          </div>
          <h3>{{ n.subject or 'Notification' }}</h3>
          <p class="notification-card__snippet">{{ (n.message or 'No message provided.')|striptags|truncate(160, True) }}</p>
          <p class="notification-card__audience">
            {{ 'All Trainers' if n.audience == 'ALL' else ('To: ' ~ n.audience) }}
          </p>
          <template data-notification-json>{{ data_payload|tojson }}</template>
        </article>
      {% endfor %}
      <p class="empty-state{% if notifications %} is-hidden{% endif %}" id="notificationListEmpty">
        {% if notifications %}No notifications match the filters.{% else %}No notifications yet.{% endif %}
      </p>
    </div>

    <aside class="notification-detail" id="notificationDetail">
      <div class="detail-empty" id="notificationDetailEmpty">
        Select a notification to preview its full message.
      </div>
      <div class="detail-body" id="notificationDetailBody" hidden>
        <p class="detail-meta" id="notificationDetailMeta"></p>
        <h3 id="notificationDetailSubject">Notification</h3>
        <p class="detail-audience" id="notificationDetailAudience"></p>
        <p class="detail-date" id="notificationDetailSent"></p>
        <div class="detail-message" id="notificationDetailMessage"></div>

        <form id="notificationEditForm" class="detail-form" hidden>
          <label>
            <span>Type</span>
            <select id="notificationEditType">
              {% for value, label in type_choices %}
                <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            <span>Subject</span>
            <input type="text" id="notificationEditSubject" required>
          </label>
          <label>
            <span>Message (HTML allowed)</span>
            <textarea id="notificationEditMessage" rows="6" required></textarea>
          </label>
          <div class="detail-form__actions">
            <button type="submit" class="btn primary" id="notificationSaveBtn">üíæ Save changes</button>
          </div>
        </form>

        <p class="detail-status" id="notificationDetailStatus"></p>
        <div class="detail-actions">
          <button type="button" class="btn secondary" id="notificationEditBtn">Edit</button>
          <button type="button" class="btn danger" id="notificationDeleteBtn">Delete</button>
        </div>
      </div>
    </aside>
  </div>
</section>

<style>
.inline-toast {
  margin: 12px 0;
  padding: 10px 14px;
  border-radius: 12px;
  font-weight: 600;
  background: #ecfdf3;
  color: #027a48;
  box-shadow: 0 8px 20px rgba(2, 122, 72, 0.15);
}
.inline-toast.is-hidden { display: none; }
.inline-toast.is-error { background:#fef3f2; color:#b42318; box-shadow:0 8px 20px rgba(180,35,24,0.15); }
.is-hidden { display:none !important; }

.card {
  background:#fff;
  border-radius:18px;
  padding:20px;
  box-shadow:0 14px 30px rgba(15,23,42,0.12);
}
.compose-card {
  margin-top:18px;
  background:linear-gradient(135deg,#f1f5ff,#fff0fb);
  border:1px solid rgba(59,130,246,0.25);
  box-shadow:0 16px 36px rgba(37,99,235,0.15);
}
.compose-card__summary {
  display:flex;
  justify-content:space-between;
  gap:16px;
  align-items:flex-start;
  cursor:pointer;
  list-style:none;
}
.compose-card__summary::-webkit-details-marker { display:none; }
.compose-card__summary::marker { content:""; }
.compose-card__summary h3 { margin:4px 0; }
.compose-card__summary .eyebrow {
  margin:0;
  text-transform:uppercase;
  letter-spacing:0.08em;
  font-size:0.75em;
  color:#475467;
}
.compose-card__summary .muted {
  margin:0;
  color:#475467;
  font-size:0.9em;
}
.summary-action {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius:999px;
  padding:8px 16px;
  font-weight:600;
  color:#2563eb;
  border:1px solid rgba(37,99,235,0.25);
  background:#fff;
  box-shadow:0 8px 20px rgba(37,99,235,0.2);
}
.summary-action::after { content:"Expand form"; }
.compose-card[open] .summary-action::after { content:"Hide form"; }
.compose-card__body {
  margin-top:18px;
  padding-top:16px;
  border-top:1px dashed rgba(71,85,105,0.25);
}

.compose-form { display:flex; flex-direction:column; gap:20px; }
.form-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.form-grid label span,
.audience-section label span {
  font-weight:600;
  font-size:.9em;
  color:#475467;
  margin-bottom:4px;
  display:block;
}
.form-grid select,
.subject-field input,
.manual-entry input {
  width:100%;
  padding:10px 14px;
  border-radius:12px;
  border:1px solid #d0d5dd;
  font-size:0.95em;
}

.editor { display:flex; flex-direction:column; gap:8px; }
.editor-toolbar {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.editor-toolbar button {
  border:1px solid #d0d5dd;
  background:#fff;
  border-radius:8px;
  padding:6px 10px;
  cursor:pointer;
  font-weight:600;
}
.editor textarea {
  width:100%;
  border-radius:16px;
  border:1px solid #d0d5dd;
  padding:12px 14px;
  min-height:140px;
  font-size:0.95em;
  resize:vertical;
}
.editor-helper {
  margin:0;
  font-size:0.85em;
  color:#475467;
}
.editor-helper code {
  background:#f4f4f5;
  padding:2px 6px;
  border-radius:6px;
}

.audience-section {
  border:1px solid #e4e7ec;
  border-radius:18px;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.audience-header {
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.audience-header h4 { margin:0; }
.audience-header p { margin:0; color:#475467; }
.audience-selected { font-weight:600; color:#1d2939; }
.audience-mode {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.chip-option {
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid #d0d5dd;
  cursor:pointer;
  font-weight:600;
}
.chip-option input { accent-color:#3a8dde; }

.audience-panel {
  border-top:1px solid #e4e7ec;
  padding-top:12px;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.audience-controls {
  display:flex;
  flex-direction:column;
  gap:10px;
}
#audienceSearch {
  width:100%;
  padding:10px 14px;
  border-radius:12px;
  border:1px solid #d0d5dd;
}
.chip-row {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.chip {
  border:none;
  background:#eef2ff;
  color:#344054;
  border-radius:999px;
  padding:6px 12px;
  font-weight:600;
  cursor:pointer;
}
.audience-list {
  max-height:260px;
  overflow:auto;
  border:1px solid #e4e7ec;
  border-radius:16px;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.audience-option {
  display:flex;
  gap:10px;
  align-items:center;
  border-radius:12px;
  padding:10px;
  border:1px solid #e4e7ec;
}
.audience-option input { accent-color:#3a8dde; }
.option-details { display:flex; flex-direction:column; }
.option-details .name { font-weight:700; }
.option-details .meta { font-size:0.8em; color:#475467; }
.manual-entry input { margin-top:4px; }
.empty-note { margin:0; color:#9ca3af; font-style:italic; }

.form-actions {
  display:flex;
  justify-content:flex-end;
}
.btn {
  border:none;
  border-radius:999px;
  padding:10px 18px;
  font-weight:700;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.btn.primary {
  border:none;
  background:#3a8dde;
  color:#fff;
  border-radius:999px;
  padding:12px 20px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 12px 24px rgba(58,141,222,0.3);
}
.btn.secondary {
  background:#eef2ff;
  color:#1d2939;
}
.btn.outline {
  background:#fff;
  border:1px solid #d0d5dd;
  color:#1d2939;
}
.btn.danger {
  background:#fef3f2;
  color:#b42318;
}
.btn:disabled {
  opacity:0.6;
  cursor:not-allowed;
}

.notification-hub {
  margin-top:32px;
  display:flex;
  flex-direction:column;
  gap:16px;
}
.hub-header {
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:16px;
  flex-wrap:wrap;
}
.hub-header h2 { margin:0; }
.hub-header p { margin:4px 0 0; color:#475467; }
.hub-toolbar {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.hub-toolbar input,
.hub-toolbar select {
  padding:8px 12px;
  border-radius:12px;
  border:1px solid #d0d5dd;
}
.category-pills {
  margin:4px 0 0;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.pill {
  border:none;
  border-radius:999px;
  padding:6px 12px;
  background:#f4f4f5;
  font-weight:600;
  cursor:pointer;
}
.pill.active {
  background:#3a8dde;
  color:#fff;
}

.hub-layout {
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:18px;
}
.notification-list {
  display:flex;
  flex-direction:column;
  gap:12px;
  max-height:640px;
  overflow:auto;
  padding-right:4px;
}
.notification-card {
  border:1px solid #e4e7ec;
  border-radius:16px;
  padding:16px;
  background:#fff;
  box-shadow:0 10px 20px rgba(15,23,42,0.08);
  cursor:pointer;
  transition:transform .15s ease, border-color .15s ease;
}
.notification-card.is-active {
  border-color:#3a8dde;
  box-shadow:0 12px 28px rgba(58,141,222,0.22);
  transform:translateY(-2px);
}
.notification-card:focus-visible {
  outline:3px solid rgba(58,141,222,0.4);
  outline-offset:3px;
}
.notification-card__header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:0.85em;
  color:#475467;
}
.notification-card__header time {
  font-variant-numeric:tabular-nums;
}
.notification-card h3 {
  margin:8px 0 6px;
  font-size:1.05rem;
}
.notification-card__snippet {
  margin:0 0 8px;
  color:#475467;
  font-size:0.9rem;
}
.notification-card__audience {
  margin:0;
  font-size:0.85rem;
  color:#0f172a;
  font-weight:600;
}
.empty-state {
  margin:0;
  padding:24px;
  border:1px dashed #d0d5dd;
  border-radius:16px;
  text-align:center;
  color:#475467;
}

.notification-detail {
  border:1px solid #e4e7ec;
  border-radius:18px;
  padding:20px;
  background:#f8fafc;
  min-height:320px;
}
.detail-empty {
  margin:0;
  color:#475467;
  font-style:italic;
}
.detail-body {
  display:flex;
  flex-direction:column;
  gap:12px;
}
.detail-meta {
  margin:0;
  text-transform:uppercase;
  letter-spacing:0.2em;
  font-size:0.75rem;
  color:#64748b;
}
.detail-audience,
.detail-date {
  margin:0;
  color:#475467;
}
.detail-message {
  padding:12px 0;
  border-top:1px solid #e2e8f0;
  border-bottom:1px solid #e2e8f0;
  line-height:1.6;
  color:#1d2939;
}
.detail-form {
  display:flex;
  flex-direction:column;
  gap:12px;
}
.detail-form label span {
  font-weight:600;
  font-size:0.9em;
  color:#475467;
  display:block;
  margin-bottom:4px;
}
.detail-form input,
.detail-form select,
.detail-form textarea {
  width:100%;
  border-radius:12px;
  border:1px solid #d0d5dd;
  padding:10px 12px;
  font-size:0.95em;
}
.detail-form textarea {
  min-height:140px;
  resize:vertical;
}
.detail-form__actions {
  display:flex;
  justify-content:flex-end;
}
.detail-status {
  min-height:1.2em;
  margin:0;
  font-size:0.9em;
}
.detail-status.success { color:#027a48; }
.detail-status.error { color:#b42318; }
.detail-actions {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

@media(max-width:1024px){
  .hub-layout { grid-template-columns:repeat(1,minmax(0,1fr)); }
  .notification-list { max-height:none; }
}
@media(max-width:640px){
  .form-grid { grid-template-columns:repeat(1,minmax(0,1fr)); }
  .audience-section { padding:12px; }
  .hub-header { flex-direction:column; align-items:flex-start; }
  .hub-toolbar { width:100%; }
  .hub-toolbar input,
  .hub-toolbar select { flex:1; }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const notifAlert = document.getElementById("notifAlert");
  const composeForm = document.getElementById("composeForm");
  const messageField = document.getElementById("notifMessage");
  const editorToolbar = document.querySelector(".editor-toolbar");
  const audienceRadios = Array.from(document.querySelectorAll("input[name='audience_mode']"));
  const audiencePanel = document.getElementById("audiencePanel");
  const audienceCheckboxes = Array.from(document.querySelectorAll("input[name='audience_multi']"));
  const audienceSearch = document.getElementById("audienceSearch");
  const selectAllBtn = document.querySelector("[data-select='all']");
  const clearBtn = document.querySelector("[data-select='none']");
  const groupButtons = Array.from(document.querySelectorAll("[data-select-group]"));
  const audienceCount = document.getElementById("audienceSelectedCount");
  const manualInput = document.querySelector("input[name='audience_manual']");

  const notificationList = document.getElementById("notificationList");
  const notificationSearch = document.getElementById("notificationSearch");
  const notificationSort = document.getElementById("notificationSort");
  const categoryWrap = document.getElementById("notificationCategories");
  const emptyMessage = document.getElementById("notificationListEmpty");

  const detailEmpty = document.getElementById("notificationDetailEmpty");
  const detailBody = document.getElementById("notificationDetailBody");
  const detailMeta = document.getElementById("notificationDetailMeta");
  const detailSubject = document.getElementById("notificationDetailSubject");
  const detailAudience = document.getElementById("notificationDetailAudience");
  const detailSent = document.getElementById("notificationDetailSent");
  const detailMessage = document.getElementById("notificationDetailMessage");
  const editForm = document.getElementById("notificationEditForm");
  const editType = document.getElementById("notificationEditType");
  const editSubject = document.getElementById("notificationEditSubject");
  const editMessage = document.getElementById("notificationEditMessage");
  const editBtn = document.getElementById("notificationEditBtn");
  const deleteBtn = document.getElementById("notificationDeleteBtn");
  const saveBtn = document.getElementById("notificationSaveBtn");
  const detailStatus = document.getElementById("notificationDetailStatus");

  const filters = { search: "", category: "all", sort: "newest" };
  const state = { currentId: null, editing: false };
  const notificationStore = new Map();

  const setAlert = (message = "", tone = "success") => {
    if (!notifAlert) return;
    if (!message) {
      notifAlert.classList.add("is-hidden");
      notifAlert.textContent = "";
      notifAlert.classList.remove("is-error");
      return;
    }
    notifAlert.textContent = message;
    notifAlert.classList.remove("is-hidden");
    notifAlert.classList.toggle("is-error", tone === "error");
  };

  const getNotificationCards = () => {
    if (!notificationList) return [];
    return Array.from(notificationList.querySelectorAll(".notification-card"));
  };

  const registerNotification = (notification) => {
    if (!notification || !notification.id) return;
    notificationStore.set(String(notification.id), notification);
  };

  const hydrateNotificationStore = () => {
    document.querySelectorAll("[data-notification-json]").forEach((template) => {
      const card = template.closest(".notification-card");
      if (!card) return;
      try {
        const payload = JSON.parse(template.textContent || "{}");
        registerNotification(payload);
      } catch (err) {
        console.error("Failed to parse notification payload", err);
      } finally {
        template.remove();
      }
    });
  };

  const formatTypeLabel = (value) => {
    if (!value) return "Announcement";
    return value.toString().replace(/[_-]+/g, " ").replace(/\b\w/g, (char) => char.toUpperCase());
  };

  const formatDate = (value) => {
    if (!value) return "Unknown date";
    const parsed = new Date(value);
    if (!Number.isNaN(parsed.getTime())) {
      return parsed.toLocaleString();
    }
    return value;
  };

  const formatMessageHtml = (body) => {
    if (!body) return "<p>No message provided.</p>";
    if (/<[a-z][\s\S]*>/i.test(body)) return body;
    return body.replace(/\r?\n/g, "<br>");
  };

  const extractSnippet = (body) => {
    if (!body) return "No message provided.";
    const div = document.createElement("div");
    div.innerHTML = body;
    const text = div.textContent || div.innerText || "";
    return text.length > 160 ? `${text.slice(0, 157).trim()}‚Ä¶` : text;
  };

  const setDetailStatus = (message = "", tone = "") => {
    if (!detailStatus) return;
    detailStatus.textContent = message;
    detailStatus.classList.remove("success", "error");
    if (tone) detailStatus.classList.add(tone);
  };

  const toggleEditMode = (editing) => {
    state.editing = editing;
    if (editForm) editForm.hidden = !editing;
    if (detailMessage) detailMessage.hidden = editing;
    if (editBtn) {
      editBtn.textContent = editing ? "Cancel edit" : "Edit";
      editBtn.setAttribute("aria-pressed", editing ? "true" : "false");
    }
  };

  const setActionButtonsDisabled = (disabled) => {
    if (saveBtn) saveBtn.disabled = disabled;
    if (editBtn) editBtn.disabled = disabled;
    if (deleteBtn) deleteBtn.disabled = disabled;
  };

  const updateCardDom = (card, notification) => {
    if (!card || !notification) return;
    card.dataset.type = (notification.type || "announcement").toLowerCase();
    card.dataset.audience = notification.audience || "ALL";
    card.dataset.date = notification.sent_at || "";
    const div = document.createElement("div");
    div.innerHTML = notification.message || "";
    const searchText = `${(notification.subject || "").toLowerCase()} ${(div.textContent || div.innerText || "").toLowerCase()}`;
    card.dataset.search = searchText;
    const pill = card.querySelector(".type-pill");
    if (pill) pill.textContent = formatTypeLabel(notification.type);
    const title = card.querySelector("h3");
    if (title) title.textContent = notification.subject || "Notification";
    const snippet = card.querySelector(".notification-card__snippet");
    if (snippet) snippet.textContent = extractSnippet(notification.message);
    const audienceEl = card.querySelector(".notification-card__audience");
    if (audienceEl) {
      audienceEl.textContent = notification.audience === "ALL" ? "All Trainers" : `To: ${notification.audience || "Unknown"}`;
    }
    const time = card.querySelector("time");
    if (time) {
      time.textContent = formatDate(notification.sent_at);
      time.dateTime = notification.sent_at || "";
    }
  };

  const updateEmptyState = () => {
    if (!emptyMessage) return;
    const cards = getNotificationCards();
    const visible = cards.some((card) => !card.hidden);
    if (!cards.length) {
      emptyMessage.textContent = "No notifications yet.";
      emptyMessage.classList.remove("is-hidden");
      return;
    }
    if (!visible) {
      emptyMessage.textContent = "No notifications match the filters.";
      emptyMessage.classList.remove("is-hidden");
    } else {
      emptyMessage.classList.add("is-hidden");
    }
  };

  const sortCards = () => {
    if (!notificationList) return;
    const cards = getNotificationCards();
    const sorted = [...cards].sort((a, b) => {
      switch (filters.sort) {
        case "oldest":
          return Date.parse(a.dataset.date || "0") - Date.parse(b.dataset.date || "0");
        case "audience":
          return (a.dataset.audience || "").localeCompare(b.dataset.audience || "");
        case "type":
          return (a.dataset.type || "").localeCompare(b.dataset.type || "");
        case "newest":
        default:
          return Date.parse(b.dataset.date || "0") - Date.parse(a.dataset.date || "0");
      }
    });
    const referenceNode = (emptyMessage && notificationList.contains(emptyMessage)) ? emptyMessage : null;
    sorted.forEach((card) => notificationList.insertBefore(card, referenceNode));
  };

  const applyFilters = () => {
    const cards = getNotificationCards();
    cards.forEach((card) => {
      const matchesCategory = filters.category === "all" || card.dataset.type === filters.category;
      const haystack = `${card.dataset.search || ""} ${(card.dataset.audience || "").toLowerCase()}`;
      const matchesSearch = !filters.search || haystack.includes(filters.search);
      card.hidden = !(matchesCategory && matchesSearch);
    });
    sortCards();
    updateEmptyState();
  };

  const populateDetail = (notification) => {
    if (!notification) return;
    detailEmpty.hidden = true;
    detailBody.hidden = false;
    if (detailMeta) detailMeta.textContent = formatTypeLabel(notification.type);
    if (detailSubject) detailSubject.textContent = notification.subject || "Notification";
    if (detailAudience) {
      detailAudience.textContent = notification.audience === "ALL" ? "All Trainers" : `To: ${notification.audience || "Unknown"}`;
    }
    if (detailSent) detailSent.textContent = formatDate(notification.sent_at);
    if (detailMessage) {
      detailMessage.innerHTML = formatMessageHtml(notification.message);
      detailMessage.hidden = state.editing;
    }
    if (editType) editType.value = (notification.type || "announcement").toLowerCase();
    if (editSubject) editSubject.value = notification.subject || "";
    if (editMessage) editMessage.value = notification.message || "";
    setDetailStatus("");
  };

  const activateCard = (card) => {
    if (!card) return;
    const id = card.dataset.id;
    if (!id) return;
    const notification = notificationStore.get(id);
    if (!notification) {
      setAlert("Unable to load notification. Please refresh.", "error");
      return;
    }
    state.currentId = id;
    getNotificationCards().forEach((item) => item.classList.toggle("is-active", item === card));
    populateDetail(notification);
    toggleEditMode(false);
  };

  const initSelection = () => {
    const first = getNotificationCards().find((card) => !card.hidden);
    if (first) {
      activateCard(first);
    } else {
      state.currentId = null;
      detailBody.hidden = true;
      detailEmpty.hidden = false;
    }
  };

  hydrateNotificationStore();
  updateEmptyState();
  initSelection();

  if (notificationList) {
    notificationList.addEventListener("click", (event) => {
      const card = event.target.closest(".notification-card");
      if (!card) return;
      activateCard(card);
    });
    notificationList.addEventListener("keydown", (event) => {
      if (!["Enter", " "].includes(event.key)) return;
      const card = event.target.closest(".notification-card");
      if (!card) return;
      event.preventDefault();
      activateCard(card);
    });
  }

  if (notificationSearch) {
    notificationSearch.addEventListener("input", () => {
      filters.search = notificationSearch.value.trim().toLowerCase();
      applyFilters();
      initSelection();
    });
  }

  if (notificationSort) {
    notificationSort.addEventListener("change", () => {
      filters.sort = notificationSort.value;
      applyFilters();
    });
  }

  if (categoryWrap) {
    categoryWrap.addEventListener("click", (event) => {
      const button = event.target.closest(".pill[data-type]");
      if (!button) return;
      filters.category = button.dataset.type || "all";
      categoryWrap.querySelectorAll(".pill").forEach((pill) => pill.classList.toggle("active", pill === button));
      applyFilters();
      initSelection();
    });
  }

  if (editBtn) {
    editBtn.addEventListener("click", () => {
      if (!state.currentId) return;
      toggleEditMode(!state.editing);
      if (state.editing && editSubject) editSubject.focus();
    });
  }

  if (editForm) {
    editForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!state.currentId) return;
      const subject = editSubject.value.trim();
      const message = editMessage.value.trim();
      if (!subject || !message) {
        setDetailStatus("Subject and message are required.", "error");
        return;
      }
      setDetailStatus("Saving‚Ä¶");
      setActionButtonsDisabled(true);
      try {
        const response = await fetch(`/admin/notifications/${state.currentId}/update`, {
          method: "POST",
          headers: { "Content-Type": "application/json", Accept: "application/json" },
          body: JSON.stringify({ subject, message, type: editType.value })
        });
        const payload = await response.json();
        if (!response.ok || !payload.success) {
          throw new Error(payload.error || "Failed to update notification.");
        }
        const updated = payload.notification;
        registerNotification(updated);
        const card = getNotificationCards().find((item) => item.dataset.id === String(updated.id));
        if (card) updateCardDom(card, updated);
        populateDetail(updated);
        setDetailStatus("Notification updated.", "success");
        setAlert("Notification updated.", "success");
        applyFilters();
      } catch (err) {
        setDetailStatus(err.message || "Failed to update notification.", "error");
      } finally {
        setActionButtonsDisabled(false);
      }
    });
  }

  if (deleteBtn) {
    deleteBtn.addEventListener("click", async () => {
      if (!state.currentId) return;
      if (!confirm("Delete this notification?")) return;
      setDetailStatus("Deleting‚Ä¶");
      setActionButtonsDisabled(true);
      try {
        const response = await fetch(`/admin/notifications/${state.currentId}/delete`, {
          method: "POST",
          headers: { Accept: "application/json" }
        });
        const payload = await response.json();
        if (!response.ok || !payload.success) {
          throw new Error(payload.error || "Failed to delete notification.");
        }
        notificationStore.delete(state.currentId);
        const card = getNotificationCards().find((item) => item.dataset.id === state.currentId);
        if (card) card.remove();
        setDetailStatus("Notification deleted.", "success");
        setAlert("Notification deleted.", "success");
        state.currentId = null;
        updateEmptyState();
        initSelection();
      } catch (err) {
        setDetailStatus(err.message || "Failed to delete notification.", "error");
      } finally {
        setActionButtonsDisabled(false);
      }
    });
  }

  const getAudienceMode = () => {
    const checked = audienceRadios.find((radio) => radio.checked);
    return checked ? checked.value : "all";
  };

  const updateAudiencePanelVisibility = () => {
    if (!audiencePanel) return;
    audiencePanel.hidden = getAudienceMode() !== "targeted";
  };

  const updateAudienceCount = () => {
    if (!audienceCount) return;
    const count = audienceCheckboxes.filter((cb) => cb.checked).length;
    audienceCount.textContent = count;
  };

  audienceRadios.forEach((radio) => radio.addEventListener("change", () => {
    updateAudiencePanelVisibility();
    updateAudienceCount();
  }));
  updateAudiencePanelVisibility();
  updateAudienceCount();

  if (audienceSearch) {
    audienceSearch.addEventListener("input", () => {
      const query = audienceSearch.value.trim().toLowerCase();
      audienceCheckboxes.forEach((cb) => {
        const option = cb.closest(".audience-option");
        if (!option) return;
        const haystack = `${option.dataset.username || ""} ${option.dataset.accountType || ""}`;
        option.style.display = !query || haystack.includes(query) ? "" : "none";
      });
    });
  }

  if (selectAllBtn) {
    selectAllBtn.addEventListener("click", () => {
      audienceCheckboxes.forEach((cb) => { cb.checked = true; });
      updateAudienceCount();
    });
  }

  if (clearBtn) {
    clearBtn.addEventListener("click", () => {
      audienceCheckboxes.forEach((cb) => { cb.checked = false; });
      updateAudienceCount();
    });
  }

  groupButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const group = btn.dataset.selectGroup;
      const targets = audienceCheckboxes.filter((cb) => {
        const option = cb.closest(".audience-option");
        return option && option.dataset.accountType === group;
      });
      if (!targets.length) return;
      const shouldUncheck = targets.every((cb) => cb.checked);
      targets.forEach((cb) => { cb.checked = !shouldUncheck; });
      updateAudienceCount();
    });
  });

  if (composeForm) {
    composeForm.addEventListener("submit", (event) => {
      if (getAudienceMode() !== "targeted") {
        setAlert("");
        return;
      }
      const manualValues = (manualInput?.value || "")
        .split(",")
        .map((name) => name.trim())
        .filter(Boolean);
      const selected = audienceCheckboxes.filter((cb) => cb.checked);
      if (!selected.length && !manualValues.length) {
        event.preventDefault();
        setAlert("Select at least one trainer or provide manual usernames.", "error");
        return;
      }
      setAlert("");
    });
  }

  const wrapSelection = (format) => {
    if (!messageField) return;
    const { selectionStart, selectionEnd, value } = messageField;
    const selected = value.slice(selectionStart, selectionEnd);
    let insertText = selected;

    switch (format) {
      case "strong":
        insertText = `<strong>${selected || "Bold text"}</strong>`;
        break;
      case "em":
        insertText = `<em>${selected || "Italic text"}</em>`;
        break;
      case "ul":
        insertText = `<ul>\n<li>${selected || "List item"}</li>\n</ul>`;
        break;
      case "a": {
        const url = prompt("Enter URL", "https://");
        if (!url) return;
        insertText = `<a href="${url}" target="_blank" rel="noopener noreferrer">${selected || "Link text"}</a>`;
        break;
      }
      case "br":
        insertText = `${selected}<br>`;
        break;
      default:
        insertText = selected;
    }

    messageField.setRangeText(insertText, selectionStart, selectionEnd, "end");
    messageField.focus();
  };

  if (editorToolbar) {
    editorToolbar.addEventListener("click", (event) => {
      const btn = event.target.closest("button[data-format]");
      if (!btn) return;
      event.preventDefault();
      wrapSelection(btn.dataset.format);
    });
  }
});
</script>

{% endblock %}
