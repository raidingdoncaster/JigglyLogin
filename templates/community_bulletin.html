{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-cozy' %}
{% endblock %}

{% block content %}
<section class="cb-hero-stack">
  <div class="cb-feature-grid">
    {% for post in featured_posts %}
    <a class="cb-feature-card" id="feature-{{ post.slug }}"
       href="{{ url_for('community_bulletin_post', slug=post.slug) }}"
       style="background-image: linear-gradient(180deg, rgba(6,10,40,0.25), rgba(5,7,19,0.75)), url('{{ post.header_image|bulletin_media }}');">
      <div class="cb-feature-meta">
        <span class="cb-tag">{{ post.tag }}</span>
        <h2>{{ post.title }}</h2>
        <p>{{ post.summary }}</p>
        <div class="cb-author">
          <img src="{{ (post.author_avatar or 'avatars/avatar1.png')|bulletin_media }}" alt="{{ post.author or 'RDAB Staff' }} avatar">
          <div>
            <strong>{{ post.author or 'RDAB Staff' }}</strong>
            <span>{{ post.published_at|to_date }} ¬∑ {{ post.read_time or '3 min read' }}</span>
          </div>
        </div>
      </div>
    </a>
    {% endfor %}
  </div>
</section>

<section class="cb-latest-tools" id="{{ latest_post.slug if latest_post else 'latest' }}">
  <div class="cb-section-heading">
    <span class="cb-section-shadow">Latest</span>
    <h3>Latest updates</h3>
    <p>Fresh drops curated straight from RDAB HQ.</p>
  </div>
</section>

<section class="cb-latest-feed">
  {% for post in latest_feed %}
  <a class="cb-latest-item" href="{{ url_for('community_bulletin_post', slug=post.slug) }}">
    <div class="cb-latest-thumb">
      <img src="{{ post.header_image|bulletin_media }}" alt="{{ post.title }} artwork">
    </div>
    <div class="cb-latest-body">
      <p class="cb-tag">{{ post.category or post.tag }}</p>
      <h4>{{ post.title }}</h4>
      <p class="cb-latest-summary">{{ post.summary }}</p>
      <div class="cb-latest-meta">
        <img src="{{ (post.author_avatar or 'avatars/avatar1.png')|bulletin_media }}" alt="{{ post.author or 'RDAB Staff' }} avatar">
        <span>{{ post.author or 'RDAB Staff' }} ‚Ä¢ {{ post.published_at|to_date }} ‚Ä¢ {{ post.read_time or '3 min read' }}</span>
      </div>
    </div>
  </a>
  {% else %}
  <p class="cb-empty">Community Bulletin posts are on their way.</p>
  {% endfor %}
</section>


{% if memory_albums %}
<section class="cb-memory-block" id="memory-albums">
  <div class="cb-section-heading">
    <span class="cb-section-shadow">Memories</span>
    <h3>Memory albums</h3>
    <p>Swipe through the best photo drops from recent stories.</p>
  </div>
  <div class="cb-memory-grid">
    {% for album in memory_albums[:6] %}
    <article class="cb-memory-card">
      <div class="cb-memory-media">
        <img src="{{ (album.cover_image or album.slides[0].image)|bulletin_media }}" alt="{{ album.title }} memory cover">
        <div class="cb-memory-meta-pill">
          <span>{{ album.slide_count }} photos</span>
          <span>‚Ä¢</span>
          <span>{{ album.published_at|to_date if album.published_at else 'Soon' }}</span>
        </div>
      </div>
      <div class="cb-memory-body">
        <p class="cb-tag">{{ album.tag or 'Memory' }}</p>
        <h4>{{ album.title }}</h4>
        <p class="cb-memory-summary">{{ album.summary or 'Relive this community moment.' }}</p>
        <button type="button"
                class="cb-memory-btn"
                data-memory-launch="{{ album.id }}"
                data-memory-start="0">
          View the full memory
        </button>
      </div>
    </article>
    {% else %}
    <p class="cb-mini-empty">No memory albums yet ‚Äî upload a carousel to start one.</p>
    {% endfor %}
  </div>
</section>
{% endif %}

{% for section in category_sections %}
<section class="cb-category-block" id="category-{{ section.name|replace(' ', '-')|lower() }}">
  <div class="cb-section-heading">
    <span class="cb-section-shadow">{{ section.name }}</span>
    <h3>{{ section.name }}</h3>
    <p>Handpicked stories from the {{ section.name.lower() }} desk.</p>
  </div>
  <div class="cb-category-grid">
    {% set spotlight = section.posts[0] %}
    <a class="cb-spotlight-card"
       href="{{ url_for('community_bulletin_post', slug=spotlight.slug) }}"
       style="background-image: linear-gradient(160deg, rgba(8,12,34,0.5), rgba(6,8,20,0.85)), url('{{ spotlight.header_image|bulletin_media }}');">
      <div class="cb-feature-meta">
        <span class="cb-tag">{{ spotlight.tag }}</span>
        <h3>{{ spotlight.title }}</h3>
        <p>{{ spotlight.summary }}</p>
        <div class="cb-author">
          <img src="{{ (spotlight.author_avatar or 'avatars/avatar1.png')|bulletin_media }}" alt="{{ spotlight.author or 'RDAB Staff' }}">
          <div>
            <strong>{{ spotlight.author or 'RDAB Staff' }}</strong>
            <span>{{ spotlight.published_at|to_date }} ¬∑ {{ spotlight.read_time or '3 min read' }}</span>
          </div>
        </div>
      </div>
    </a>
    <div class="cb-mini-feed">
      {% for post in section.posts[1:] %}
      <a class="cb-mini-item" href="{{ url_for('community_bulletin_post', slug=post.slug) }}">
        <img src="{{ post.header_image|bulletin_media }}" alt="{{ post.title }}">
        <div>
          <p class="cb-tag">{{ post.tag }}</p>
          <h4>{{ post.title }}</h4>
          <span>{{ post.published_at|to_date }} ‚Ä¢ {{ post.read_time or '3 min read' }}</span>
        </div>
      </a>
      {% else %}
      <p class="cb-mini-empty">More {{ section.name.lower() }} posts are on the way.</p>
      {% endfor %}
    </div>
  </div>
</section>
{% endfor %}

<div class="cb-floating-search" data-search-bar>
  <button type="button" class="cb-floating-btn" data-search-trigger="search">üîç Search posts</button>
  <button type="button" class="cb-floating-btn" data-search-trigger="filters">üéõ Filters</button>
</div>

<div class="cb-search-overlay" data-search-overlay data-posts='{{ posts|tojson|safe }}'>
  <div class="cb-search-panel">
    <div class="cb-search-header">
      <div>
        <p class="cb-tag muted" data-search-mode-label>Search</p>
        <h3 data-search-title>Find bulletin posts</h3>
      </div>
      <button type="button" class="cb-search-close" data-search-close aria-label="Close search">‚úï</button>
    </div>
    <div class="cb-search-bar cb-search-bar--overlay">
      <span>üîç</span>
      <input type="text" placeholder="Type to search memories, news, guides‚Ä¶" data-search-input>
      <button type="button" data-clear-search>Clear</button>
    </div>
    <div class="cb-search-body">
      <div class="cb-search-results" data-search-results></div>
      <div class="cb-search-filters">
        <p>Categories</p>
        <div class="cb-filter-grid">
          {% for section in category_sections %}
          <button type="button" class="cb-filter-chip" data-filter-category="{{ section.name }}">{{ section.name }}</button>
          {% endfor %}
        </div>
        <p style="margin-top:16px;">Tags</p>
        <div class="cb-filter-grid">
          {% for tag in tag_filters %}
          <button type="button" class="cb-filter-chip" data-filter-tag="{{ tag }}">{{ tag }}</button>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="cb-search-footer">
      <small>Tap ‚úï or anywhere outside the panel to exit search.</small>
    </div>
  </div>
</div>

<style>
:root {
  --cb-deep: #050818;
  --cb-ink: #0f172a;
  --cb-iris: #3a8dde;
  --cb-mint: #68f7d0;
  --cb-cloud: #f4f7fb;
}

.cb-eyebrow {
  font-size: 0.75rem;
  letter-spacing: 0.4em;
  text-transform: uppercase;
  color: #8ed7ff;
  margin: 0 0 6px 0;
  font-weight: 700;
}

.cb-hero-stack {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
  padding: 24px;
  border-radius: 32px;
  background: linear-gradient(135deg, #0a1a42, #133a7c 55%, #13b9ff);
  color: #f3fbff;
  box-shadow: 0 30px 60px rgba(5, 13, 40, 0.45);
  margin-bottom: 32px;
}

.cb-feature-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 18px;
}

.cb-feature-card,
.cb-latest-item,
.cb-search-card,
.cb-spotlight-card,
.cb-mini-item {
  text-decoration: none;
  color: inherit;
}
.cb-feature-card {
  background-size: cover;
  background-position: center;
  border-radius: 26px;
  padding: 22px;
  min-height: 220px;
  display: flex;
  align-items: end;
  position: relative;
  overflow: hidden;
  box-shadow: 0 24px 40px rgba(3, 7, 18, 0.4);
}

.cb-feature-meta h2,
.cb-feature-meta h3 {
  margin: 8px 0 6px 0;
  color: #fff;
}

.cb-feature-meta p {
  margin: 0;
  color: #deecff;
}

.cb-tag {
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.12em;
  font-weight: 700;
  color: #fff;
}

.cb-tag.muted {
  color: #94a3b8;
}

.cb-author {
  margin-top: 18px;
  display: flex;
  gap: 10px;
  align-items: center;
}

.cb-author img,
.cb-latest-meta img {
  width: 40px;
  height: 40px;
  border-radius: 999px;
  border: 2px solid rgba(255,255,255,0.4);
  object-fit: cover;
}

.cb-author span {
  font-size: 0.85rem;
  color: #cbd5f5;
}

.cb-section-heading {
  margin-bottom: 12px;
  position: relative;
}

.cb-section-shadow {
  position: absolute;
  top: -24px;
  left: 0;
  font-size: 3rem;
  font-weight: 800;
  text-transform: uppercase;
  color: rgba(15, 23, 42, 0.05);
  letter-spacing: 0.1em;
}

.cb-section-heading h3 {
  margin: 0;
  font-size: 1.4rem;
  color: var(--cb-ink);
}

.cb-section-heading p {
  margin: 6px 0 0 0;
  color: #475569;
}

.cb-latest-tools {
  margin-bottom: 12px;
}

.cb-search-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  border-radius: 999px;
  padding: 8px 14px;
  background: #f4f7fb;
}

.cb-search-bar--overlay {
  border-radius: 16px;
  border: 1px solid #e2e8f0;
  background: #fff;
}

.cb-search-bar input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 0.95rem;
  padding: 6px;
}

.cb-search-bar input:focus {
  outline: none;
}

.cb-search-bar button {
  border: none;
  background: var(--cb-iris);
  color: white;
  border-radius: 999px;
  padding: 6px 14px;
  font-weight: 600;
  cursor: pointer;
}

.cb-floating-search {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;
  background: rgba(10, 14, 31, 0.9);
  border-radius: 999px;
  padding: 10px 14px;
  box-shadow: 0 20px 40px rgba(5, 13, 40, 0.3);
  z-index: 900;
}

.cb-floating-btn {
  border: none;
  background: rgba(255, 255, 255, 0.12);
  color: #fff;
  border-radius: 999px;
  padding: 8px 16px;
  font-weight: 600;
  cursor: pointer;
}

.cb-search-overlay {
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  z-index: 1200;
}

.cb-search-overlay.is-visible {
  display: flex;
}

.cb-search-panel {
  width: min(960px, 95vw);
  max-height: 92vh;
  background: #fff;
  color: #0f172a;
  border-radius: 28px;
  padding: 20px;
  box-shadow: 0 30px 70px rgba(2, 6, 23, 0.4);
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.cb-search-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}

.cb-search-close {
  border: none;
  background: #f1f5f9;
  color: #0f172a;
  border-radius: 999px;
  padding: 6px 14px;
  font-weight: 700;
  cursor: pointer;
}

.cb-search-body {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 18px;
  overflow-y: auto;
}

.cb-search-results {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
}

.cb-search-card {
  background: #0f172a;
  border-radius: 16px;
  padding: 12px;
  color: #fff;
  display: flex;
  flex-direction: column;
  gap: 8px;
  box-shadow: 0 14px 28px rgba(2, 6, 23, 0.35);
}

.cb-search-card img {
  width: 100%;
  border-radius: 12px;
  height: 120px;
  object-fit: cover;
}

.cb-search-card h5 {
  margin: 0;
  font-size: 1rem;
}

.cb-search-card p {
  margin: 0;
  font-size: 0.85rem;
  color: #cbd5f5;
}

.cb-search-filters {
  background: #f8fafc;
  border-radius: 20px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.05);
}

.cb-filter-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.cb-filter-chip {
  border: none;
  background: #e2e8f0;
  color: #0f172a;
  border-radius: 999px;
  padding: 6px 12px;
  font-size: 0.85rem;
  cursor: pointer;
  font-weight: 600;
}

.cb-filter-chip.is-active {
  background: #0f172a;
  color: #fff;
}

.cb-search-footer {
  text-align: right;
  color: #475569;
  font-size: 0.8rem;
}

.cb-search-empty {
  color: #94a3b8;
  font-weight: 600;
}

body.cb-modal-open {
  overflow: hidden;
}

.cb-latest-feed {
  display: flex;
  flex-direction: column;
  gap: 14px;
  margin-bottom: 32px;
}

.cb-memory-block {
  padding: 32px 24px 40px;
  background: #040a20;
  border-radius: 28px;
  color: #f8fbff;
  box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.15);
  margin-bottom: 48px;
}

.cb-memory-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 18px;
  margin-top: 18px;
}

.cb-memory-card {
  background: rgba(15, 23, 42, 0.65);
  border-radius: 20px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 100%;
  border: 1px solid rgba(148, 163, 184, 0.2);
}

.cb-memory-media {
  position: relative;
  aspect-ratio: 4 / 3;
  overflow: hidden;
}

.cb-memory-media img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.5s ease;
}

.cb-memory-card:hover .cb-memory-media img {
  transform: scale(1.05);
}

.cb-memory-meta-pill {
  position: absolute;
  bottom: 12px;
  left: 12px;
  right: 12px;
  background: rgba(2, 6, 23, 0.75);
  border-radius: 999px;
  padding: 6px 12px;
  display: flex;
  justify-content: center;
  gap: 6px;
  font-size: 0.8rem;
}

.cb-memory-body {
  padding: 16px 18px 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex: 1;
}

.cb-memory-summary {
  margin: 0;
  color: rgba(248, 251, 255, 0.85);
}

.cb-memory-btn {
  margin-top: auto;
  border: none;
  border-radius: 14px;
  padding: 10px 14px;
  background: linear-gradient(120deg, #3a8dde, #68f7d0);
  color: #0f172a;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.cb-memory-btn:hover,
.cb-memory-btn:focus-visible {
  transform: translateY(-2px);
}

.cb-empty {
  text-align: center;
  margin: 0;
  padding: 18px;
  border-radius: 18px;
  background: #f1f5f9;
  color: #475569;
  font-weight: 600;
}

.cb-latest-item {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 16px;
  padding: 12px;
  border-radius: 22px;
  background: #fff;
  box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
}

.cb-latest-thumb img {
  width: 100%;
  height: 110px;
  object-fit: cover;
  border-radius: 18px;
}

.cb-latest-body h4 {
  margin: 4px 0;
  font-size: 1.05rem;
}

.cb-latest-summary {
  margin: 0;
  color: #475569;
  font-size: 0.9rem;
}

.cb-latest-meta {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-top: 10px;
  font-size: 0.85rem;
  color: #475569;
}

.cb-category-block {
  margin-bottom: 40px;
}

.cb-category-grid {
  display: grid;
  grid-template-columns: minmax(240px, 1fr) minmax(220px, 320px);
  gap: 18px;
}

.cb-spotlight-card {
  border-radius: 28px;
  padding: 24px;
  min-height: 280px;
  display: flex;
  align-items: flex-end;
  box-shadow: 0 24px 40px rgba(5, 8, 20, 0.35);
  background-size: cover;
  background-position: center;
}

.cb-mini-feed {
  background: #0f172a;
  border-radius: 24px;
  padding: 16px;
  color: #fff;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.cb-mini-item {
  display: grid;
  grid-template-columns: 64px 1fr;
  gap: 10px;
  align-items: center;
}

.cb-mini-item img {
  width: 100%;
  height: 64px;
  object-fit: cover;
  border-radius: 18px;
}

.cb-mini-item h4 {
  margin: 2px 0 4px 0;
  font-size: 0.95rem;
}

.cb-mini-item span {
  font-size: 0.8rem;
  color: #cbd5f5;
}

.cb-mini-empty {
  margin: 0;
  font-size: 0.9rem;
  color: #cbd5f5;
}

@media (max-width: 960px) {
  .cb-hero-stack {
    grid-template-columns: 1fr;
  }
  .cb-category-grid {
    grid-template-columns: 1fr;
  }
  .cb-mini-feed {
    background: #fff;
    color: #0f172a;
  }
  .cb-mini-item span {
    color: #475569;
  }
  .cb-search-body {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 640px) {
  .cb-latest-item {
    grid-template-columns: 1fr;
  }
  .cb-memory-grid {
    grid-template-columns: 1fr;
  }
  .cb-latest-thumb img {
    height: 180px;
  }
  .cb-section-shadow {
    font-size: 2.4rem;
  }
  .cb-floating-search {
    width: calc(100% - 24px);
    flex-wrap: wrap;
    justify-content: center;
  }
  .cb-search-panel {
    width: 100%;
    padding: 16px;
    max-height: 96vh;
  }
}
</style>

<script>
(function () {
  var overlay = document.querySelector("[data-search-overlay]");
  var triggers = document.querySelectorAll("[data-search-trigger]");
  if (!overlay || !triggers.length) return;

  var body = document.body;
  var searchInput = overlay.querySelector("[data-search-input]");
  var resultsWrap = overlay.querySelector("[data-search-results]");
  var closeBtn = overlay.querySelector("[data-search-close]");
  var clearBtn = overlay.querySelector("[data-clear-search]");
  var modeLabel = overlay.querySelector("[data-search-mode-label]");
  var modeTitle = overlay.querySelector("[data-search-title]");
  var chips = overlay.querySelectorAll("[data-filter-category], [data-filter-tag]");
  var floatingBar = document.querySelector("[data-search-bar]");

  var selectedCategories = new Set();
  var selectedTags = new Set();
  var posts = [];

  try {
    posts = JSON.parse(overlay.dataset.posts || "[]");
  } catch (err) {
    posts = [];
  }

  if (!posts.length && floatingBar) {
    floatingBar.style.display = "none";
  }

  var staticRoot = "{{ url_for('static', filename='') }}";
  var postUrlTemplate = "{{ url_for('community_bulletin_post', slug='__slug__') }}";

  function escapeHtml(str) {
    return (str || "").replace(/[&<>"']/g, function (char) {
      switch (char) {
        case "&": return "&amp;";
        case "<": return "&lt;";
        case ">": return "&gt;";
        case '"': return "&quot;";
        case "'": return "&#39;";
        default: return char;
      }
    });
  }

  function resolveMedia(path) {
    if (!path) return "";
    var lower = path.toLowerCase();
    if (lower.startsWith("http://") || lower.startsWith("https://") || lower.startsWith("/") || lower.startsWith("data:")) {
      return path;
    }
    return staticRoot + path.replace(/^static\//i, "");
  }

  function postUrl(slug) {
    return postUrlTemplate.replace("__slug__", encodeURIComponent(slug || ""));
  }

  function formatDate(iso) {
    if (!iso) return "Soon";
    var date = new Date(iso);
    if (isNaN(date.getTime())) return "Soon";
    return date.toLocaleDateString(undefined, { day: "numeric", month: "short" });
  }

  function updateMode(mode) {
    if (modeLabel) {
      modeLabel.textContent = mode === "filters" ? "Filters" : "Search";
    }
    if (modeTitle) {
      modeTitle.textContent = mode === "filters" ? "Dial in the perfect post" : "Find bulletin posts";
    }
  }

  function openOverlay(mode) {
    overlay.classList.add("is-visible");
    body.classList.add("cb-modal-open");
    updateMode(mode || "search");
    renderResults();
    if (mode === "search" && searchInput) {
      setTimeout(function () {
        searchInput.focus();
      }, 50);
    }
  }

  function closeOverlay() {
    overlay.classList.remove("is-visible");
    body.classList.remove("cb-modal-open");
    if (searchInput) searchInput.value = "";
    selectedCategories.clear();
    selectedTags.clear();
    chips.forEach(function (chip) {
      chip.classList.remove("is-active");
    });
  }

  function tagMatches(post) {
    if (!selectedTags.size) return true;
    var tags = Array.isArray(post.tags) ? post.tags.slice() : [];
    if (post.tag) tags.push(post.tag);
    var normalized = tags.map(function (tag) {
      return (tag || "").toLowerCase();
    });
    return normalized.some(function (tag) {
      return selectedTags.has(tag);
    });
  }

  function categoryMatches(post) {
    if (!selectedCategories.size) return true;
    var cat = (post.category || "").toLowerCase();
    return selectedCategories.has(cat);
  }

  function renderResults() {
    if (!resultsWrap) return;
    var query = (searchInput && searchInput.value ? searchInput.value : "").toLowerCase().trim();

    var filtered = posts.filter(function (post) {
      var matchesQuery = true;
      if (query) {
        var haystack = [
          post.title || "",
          post.summary || "",
          post.tag || "",
          (post.category || "")
        ].join(" ").toLowerCase();
        matchesQuery = haystack.includes(query);
      }
      return matchesQuery && categoryMatches(post) && tagMatches(post);
    });

    if (!filtered.length) {
      resultsWrap.innerHTML = '<p class="cb-search-empty">No posts match yet. Try another phrase or filter.</p>';
      return;
    }

    var cards = filtered.slice(0, 6).map(function (post) {
      var image = resolveMedia(post.header_image || post.hero_image || "");
      var tag = post.tag || "Community";
      var meta = tag + " ‚Ä¢ " + formatDate(post.published_at);
      var title = post.title || "Untitled post";
      return (
        '<a class="cb-search-card" href="' + postUrl(post.slug) + '">' +
          (image ? '<img src="' + image + '" alt="' + escapeHtml(title) + '">' : "") +
          '<h5>' + escapeHtml(title) + '</h5>' +
          '<p>' + escapeHtml(meta) + '</p>' +
        '</a>'
      );
    }).join("");

    resultsWrap.innerHTML = cards;
  }

  triggers.forEach(function (btn) {
    btn.addEventListener("click", function () {
      openOverlay(btn.dataset.searchTrigger || "search");
    });
  });

  closeBtn && closeBtn.addEventListener("click", function () {
    closeOverlay();
  });

  overlay.addEventListener("click", function (evt) {
    if (evt.target === overlay) {
      closeOverlay();
    }
  });

  document.addEventListener("keydown", function (evt) {
    if (evt.key === "Escape" && overlay.classList.contains("is-visible")) {
      closeOverlay();
    }
  });

  searchInput && searchInput.addEventListener("input", renderResults);

  clearBtn && clearBtn.addEventListener("click", function () {
    if (searchInput) {
      searchInput.value = "";
      renderResults();
    }
  });

  chips.forEach(function (chip) {
    chip.addEventListener("click", function () {
      chip.classList.toggle("is-active");
      if (chip.dataset.filterCategory) {
        var cat = chip.dataset.filterCategory.toLowerCase();
        if (chip.classList.contains("is-active")) {
          selectedCategories.add(cat);
        } else {
          selectedCategories.delete(cat);
        }
      }
      if (chip.dataset.filterTag) {
        var tag = chip.dataset.filterTag.toLowerCase();
        if (chip.classList.contains("is-active")) {
          selectedTags.add(tag);
        } else {
          selectedTags.delete(tag);
        }
      }
      renderResults();
    });
  });
})();
</script>
{% include "partials/memory_overlay.html" %}
{% endblock %}
