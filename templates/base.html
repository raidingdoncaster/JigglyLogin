<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="{{ url_for('manifest') }}">
  <meta name="theme-color" content="#3a8dde">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <script>
    // Detect if running as a PWA standalone (iOS + Android)
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                      || window.navigator.standalone === true;
    if (isStandalone) {
      fetch("/pwa-flag", { method: "POST" });
    }
  </script>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="RDAB">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/app-icon-192.png') }}">
  <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/app-icon-512.png') }}">
  <meta name="apple-mobile-web-app-orientations" content="portrait">

  <meta charset="UTF-8" />
  <title>{{ title if title else "JigglyLogin" }}</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#3a8dde;
      --brand2:#5eb8ff;
      --header-height:56px;
      --identity-font:'Source Code Pro','IBM Plex Mono','Fira Mono','Consolas','SFMono-Regular',monospace;
    }
    *,*::before,*::after{box-sizing:border-box;}
    body{
      margin:0;
      font-family:'Montserrat',sans-serif;
      background:#f4f7fa url('/static/hex-bg.png') repeat;
      background-size:200px;
      color:#333;
      padding-top:var(--header-height);
      padding-top:calc(var(--header-height) + env(safe-area-inset-top));
    }
    .identity-text,
    .trainer-name,
    .trainer-campfire,
    .trainer-username,
    .option-name{
      font-family:var(--identity-font);
      letter-spacing:0.04em;
      font-feature-settings:"tnum","ss01","cv02";
    }
    .identity-text{
      font-weight:600;
      color:inherit;
    }

    /* Header */
    header{
      position:fixed; top:0; left:0; right:0; z-index:6000;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      padding:6px 12px;
      display:flex; align-items:center; justify-content:space-between;
      color:#fff;
      width:100%;
    }
    .header-left{display:flex;align-items:center;gap:12px;}
    .logo{
      width:80px; height:36px;
      background:url('/static/logo.png') center/cover no-repeat;
      flex:0 0 auto;
    }
    .nav-back-btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 16px;
      border-radius:999px;
      background:rgba(255,255,255,0.22);
      color:#fff;
      text-decoration:none;
      font-weight:600;
      box-shadow:0 8px 20px rgba(0,0,0,0.18);
      transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
      white-space:nowrap;
    }
    .nav-back-btn:hover{
      transform:translateY(-1px);
      background:rgba(255,255,255,0.3);
      box-shadow:0 12px 26px rgba(0,0,0,0.22);
    }
    .nav-back-icon{font-size:1rem;line-height:1;}
    @media(max-width:520px){
      .nav-back-label{display:none;}
      .nav-back-btn{padding:8px 12px;}
    }

    /* --- NAV BAR --- */
    .nav-icons{ display:flex; align-items:center; justify-content:flex-end; gap:12px; flex-wrap:wrap; }
    .nav-item{
      width:44px; height:44px; display:flex; align-items:center; justify-content:center;
      padding:0; border:0; background:transparent; cursor:pointer; flex:0 0 auto;
    }
    .nav-item img.nav-icon{ max-width:40px; max-height:40px; width:auto; height:auto; display:block; }

    /* Stamp container */
    .stamp-container{ position:relative; height:44px; width:auto; display:block; margin:0 2px; text-decoration:none; -webkit-tap-highlight-color:transparent; }
    .stamp-container:focus-visible{ outline:none; }
    .stamp-container img{ height:100%; width:auto; display:block; }
    .stamp-container .stamp-count{
      position:absolute; top:50%; right:12px; transform:translateY(-50%);
      font-weight:700; font-size:1.05em; color:#333; line-height:1; user-select:none;
    }

    /* Inbox dropdown */
    .inbox-wrapper{ position:relative; }
    .inbox-wrapper button.nav-item{
      all:unset; display:flex; align-items:center; justify-content:center;
      width:44px; height:44px; cursor:pointer;
    }
    .inbox-dropdown{
      position:absolute; right:0; top:50px; display:none; width:240px; background:#fff; color:#333;
      border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,.2); padding:8px; z-index:2000;
    }
    .inbox-dropdown ul{ list-style:none; margin:0; padding:0; }
    .inbox-dropdown li{ font-size:.9em; padding:6px 2px; border-bottom:1px solid #eee; }
    .inbox-dropdown li:last-child{ border-bottom:none; }
    .inbox-dropdown .view-all{
      display:block; margin-top:8px; text-align:center; text-decoration:none;
      background:var(--brand); color:#fff; padding:6px 8px; border-radius:6px; font-weight:600;
    }

    /* Inbox badge */
    .inbox-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #e74c3c;
      color: #fff;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.75em;
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Avatar dropdown */
    .avatar-wrapper{ position:relative; }
    .avatar-icon{
      border-radius:50%;
      border:2px solid #fff;
      width:40px; height:40px; object-fit:cover;
    }
    .avatar-dropdown{
      position:absolute; right:0; top:50px; display:none;
      background:#fff; color:#333; border-radius:10px;
      box-shadow:0 8px 20px rgba(0,0,0,.2); min-width:190px; overflow:hidden; z-index:2100;
    }
    .avatar-dropdown a, .avatar-dropdown button{
      display:block; width:100%; text-align:left;
      padding:10px 14px; border:0; background:#fff; color:#333; text-decoration:none; font-size:.95em; cursor:pointer;
    }
    .avatar-dropdown a:hover, .avatar-dropdown button:hover{ background:#f5f7fb; }
    .avatar-dropdown .sep{ height:1px; background:#eee; margin:4px 0; }

    /* Main content container */
    .container{
      --container-max:540px;
      width:min(100%,var(--container-max));
      margin:clamp(20px,6vh,72px) auto;
      padding:clamp(18px,5vw,28px);
      background:#fff;
      border-radius:16px;
      box-shadow:0 12px 32px rgba(15,23,42,0.12);
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    .container.is-cozy{--container-max:480px;}
    .container.is-wide{--container-max:968px;}
    .container.is-fluid{--container-max:100%; background:transparent; box-shadow:none; padding:0; gap:20px;}

    /* Flash messages */
    .flash{ padding:10px; margin-bottom:10px; border-radius:6px; font-weight:600; text-align:center;
      transition:opacity .5s, transform .5s; }
    .flash-success{ background:#d4edda; border:1px solid #155724; color:#155724; }
    .flash-error{ background:#f8d7da; border:1px solid #721c24; color:#721c24; }
    .flash-warning{ background:#fff3cd; border:1px solid #856404; color:#856404; }

    /* ==== Auth shared styles (login/signup flow) ==== */
    .auth-shell{display:flex;flex-direction:column;gap:24px;color:#0f172a;}
    .auth-hero{position:relative;overflow:hidden;border-radius:24px;padding:32px 26px;background:radial-gradient(circle at 0% 0%,rgba(94,184,255,0.3),transparent 55%),radial-gradient(circle at 100% 0%,rgba(104,226,186,0.28),transparent 55%),linear-gradient(135deg,#0f172a,#1d4ed8);color:#f8fafc;box-shadow:0 20px 48px rgba(15,23,42,0.38);display:flex;flex-wrap:wrap;gap:24px;align-items:center;justify-content:space-between;}
    .auth-hero .hero-glow{position:absolute;inset:-65% -20% auto;min-height:280px;background:radial-gradient(circle,rgba(255,255,255,0.22) 0,rgba(255,255,255,0) 60%);animation:authGlow 7s ease-in-out infinite;}
    @keyframes authGlow{0%,100%{transform:translateY(0);opacity:0.9;}50%{transform:translateY(18px);opacity:0.6;}}
    .auth-hero .hero-text{position:relative;z-index:1;flex:1 1 220px;display:flex;flex-direction:column;gap:12px;}
    .hero-eyebrow{letter-spacing:0.28em;text-transform:uppercase;font-size:0.75rem;font-weight:600;color:rgba(226,232,240,0.85);}
    .auth-hero h1{margin:0;font-size:2rem;line-height:1.2;color:#e2e8f0;}
    .auth-hero p{margin:0;font-size:1rem;line-height:1.6;color:#cbd5f5;}
    .hero-media{position:relative;z-index:1;flex:0 0 auto;display:flex;justify-content:center;align-items:center;}
    .auth-hero .hero-banner{position:relative;z-index:1;width:200px;max-width:45vw;border-radius:18px;box-shadow:0 12px 32px rgba(15,23,42,0.45);}

    .auth-card{background:#fff;border-radius:22px;box-shadow:0 12px 32px rgba(15,23,42,0.16);padding:24px;display:flex;flex-direction:column;gap:18px;}
    .auth-card h2{margin:0;font-size:1.4rem;color:#0f172a;}
    .auth-form{display:flex;flex-direction:column;gap:14px;}
    .auth-label{font-weight:600;font-size:0.9rem;color:#1f2937;}
    .auth-input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:0.95rem;transition:border-color .2s ease, box-shadow .2s ease;}
    .auth-input:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,0.18);}
    .auth-input-row{display:flex;gap:10px;align-items:center;}

    .auth-btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;border-radius:999px;font-weight:600;cursor:pointer;text-decoration:none;font-size:0.95rem;transition:transform .2s ease, box-shadow .2s ease, background .2s ease;color:#0f172a;border:none;}
    .auth-btn--full{width:100%;}
    .auth-btn--primary{background:linear-gradient(135deg,#38bdf8,#2563eb);color:#0f172a;box-shadow:0 12px 32px rgba(37,99,235,0.35);}
    .auth-btn--primary:hover{transform:translateY(-1px);box-shadow:0 16px 40px rgba(37,99,235,0.4);}
    .auth-btn--secondary{background:#eef2ff;color:#1d4ed8;border:1px solid #bfdbfe;box-shadow:0 8px 20px rgba(191,219,254,0.3);}
    .auth-btn--secondary:hover{background:#dbeafe;}
    .auth-btn--ghost{background:rgba(15,23,42,0.08);color:#0f172a;border:1px solid rgba(15,23,42,0.15);}
    .auth-btn--ghost:hover{background:rgba(15,23,42,0.12);}
    .auth-btn--outline{background:#fff;border:1px solid #d1d5db;color:#1f2937;padding:9px 14px;font-size:0.85rem;}
    .auth-btn--outline:hover{border-color:#2563eb;color:#2563eb;}

    .auth-links{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;}
    .auth-tip{background:rgba(15,23,42,0.05);border-radius:16px;padding:16px;text-align:center;color:#1f2937;line-height:1.5;display:flex;flex-direction:column;gap:12px;}

    #reminder-carousel{position:relative;text-align:center;font-size:0.9em;line-height:1.5;margin:0;}
    #reminder-text{display:inline-block;opacity:1;transition:opacity 1s ease-in-out;}
    #pokeball-loader{margin:0 auto;width:28px;height:28px;border-radius:50%;background:linear-gradient(to bottom,#ff1c1c 50%,#fff 50%);border:2px solid #000;position:relative;animation:spin 7s linear infinite;transition:transform .3s ease;}
    #pokeball-loader::before{content:"";position:absolute;top:50%;left:0;width:100%;height:2px;background:#000;transform:translateY(-50%);}
    #pokeball-loader::after{content:"";position:absolute;top:50%;left:50%;width:10px;height:10px;background:#fff;border:2px solid #000;border-radius:50%;transform:translate(-50%,-50%);}
    #pokeball-loader.pop{transform:scale(1.25);}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    .policy-cta{background:linear-gradient(135deg,#f1f5f9,#e0f2fe);border-radius:20px;padding:18px;text-align:center;box-shadow:0 14px 30px rgba(15,23,42,0.15);display:flex;flex-direction:column;gap:10px;font-size:0.95rem;color:#0f172a;}
    .policy-cta h3{margin:0;font-size:1.2rem;color:#0f172a;}
    .policy-cta p{margin:0;color:#334155;}

    .signup-guide{display:flex;gap:14px;align-items:flex-start;background:rgba(248,250,252,0.75);border-radius:16px;padding:16px;}
    .signup-guide__image{width:120px;border-radius:12px;box-shadow:0 8px 18px rgba(15,23,42,0.15);}
    .signup-guide__copy{font-size:0.9rem;color:#1f2937;line-height:1.55;}

    @media(max-width:560px){
      .auth-hero{padding:26px 20px;}
      .auth-hero h1{font-size:1.65rem;}
      .auth-hero .hero-banner{width:160px;}
      .auth-card{padding:20px;}
      .signup-guide{flex-direction:column;align-items:center;text-align:center;}
      .signup-guide__image{width:140px;}
    }

    /* Modal: Manage Account */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:flex-end; justify-content:center; z-index:3000;
    }
    .modal-card{
      width:100%; max-width:520px; background:#fff; border-radius:16px 16px 0 0;
      box-shadow:0 -8px 24px rgba(0,0,0,.25); padding:14px 14px 18px; max-height:92vh; overflow:auto;
      animation:slideUp .25s ease-out;
    }
    @keyframes slideUp{ from{ transform:translateY(24px); opacity:.8;} to{ transform:none; opacity:1;} }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 4px 10px;
      border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index:1;
    }
    .modal-header h3{ margin:0; font-size:1.05em; color:#111; }
    .close-btn{ background:transparent; border:0; font-size:1.6em; line-height:1; cursor:pointer; color:#333; }

    .settings-section{ margin-top:10px; border:1px solid #eee; border-radius:10px; overflow:hidden; }
    .settings-section details{ border-bottom:1px solid #eee; }
    .settings-section details:last-child{ border-bottom:none; }
    .settings-section summary{
      list-style:none; cursor:pointer; padding:12px; background:#f7f8fb; font-weight:700; color:#333;
    }
    .settings-section summary::-webkit-details-marker{ display:none; }
    .settings-body{ padding:12px; }
    .settings-body form input, .settings-body form button{
      width:100%; margin:6px 0; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:.95em;
    }
    .btn-primary{ background:var(--brand); color:#fff; border:none; }
    .btn-danger{ background:#e74c3c; color:#fff; border:none; }
    .meta{ font-size:.9em; color:#666; }
    .pin-row{ display:flex; gap:8px; }
    .pin-row input{ flex:1; }
    .row-actions{ display:flex; gap:8px; }
    .modal-disclaimer{
      margin:18px 0 4px;
      padding:14px;
      border-radius:12px;
      background:#f8fafc;
      border:1px solid #e2e8f0;
      font-size:0.85em;
      color:#475569;
      line-height:1.6;
    }
    .modal-disclaimer p{margin:0 0 10px;}
    .modal-disclaimer .policy-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:999px;
      background:var(--brand);
      color:#fff;
      text-decoration:none;
      font-weight:600;
      box-shadow:0 8px 20px rgba(58,141,222,0.25);
    }

    /* Mobile */
    @media(max-width:480px){
      :root{ --header-height:64px; }
      header{ padding:8px 12px; }
      .nav-icons{ gap:10px; }
      .nav-item{ width:40px; height:40px; }
      .nav-item img.nav-icon{ max-width:36px; max-height:36px; }
      .stamp-container{ height:40px; }
      .container{ margin:16px auto 48px; padding:20px 16px; border-radius:14px; }
    }
  </style>

  <script>
    window.addEventListener("DOMContentLoaded",()=>{
      const headerEl=document.querySelector("header");
      const setHeaderOffset=()=>{
        if(!headerEl) return;
        const height=headerEl.offsetHeight;
        document.documentElement.style.setProperty("--header-height", `${height}px`);
      };
      setHeaderOffset();
      window.addEventListener("resize", setHeaderOffset);
      if(window.ResizeObserver && headerEl){
        const ro=new ResizeObserver(()=>setHeaderOffset());
        ro.observe(headerEl);
      }
      window.addEventListener("load", setHeaderOffset);

      // Auto-hide flashes
      setTimeout(()=>{
        document.querySelectorAll(".flash").forEach(el=>{
          el.style.opacity=0; el.style.transform="translateY(-10px)";
          setTimeout(()=>el.remove(),500);
        });
      },4000);

      // Inbox dropdown
      const btn=document.getElementById("inboxToggle");
      const dd=document.getElementById("inboxDropdown");
      if(btn && dd){
        btn.addEventListener("click",(e)=>{
          e.stopPropagation();
          dd.style.display = dd.style.display==="block" ? "none" : "block";
        });
        document.addEventListener("click",(e)=>{
          if(!dd.contains(e.target)) dd.style.display="none";
        });
      }

      // Avatar dropdown
      const ab=document.getElementById("avatarToggle");
      const ad=document.getElementById("avatarDropdown");
      if(ab && ad){
        ab.addEventListener("click",(e)=>{
          e.stopPropagation();
          ad.style.display = ad.style.display==="block" ? "none" : "block";
        });
        document.addEventListener("click",(e)=>{
          if(!ad.contains(e.target)) ad.style.display="none";
        });
      }

      // Manage Account modal open/close
      const mm = document.getElementById('manageAccountModal');
      const openBtns = document.querySelectorAll('[data-open-account-modal]');
      openBtns.forEach(b=>b.addEventListener('click',()=>{
        document.getElementById("avatarDropdown")?.style && (document.getElementById("avatarDropdown").style.display="none");
        mm.style.display='flex';
        document.body.style.overflow='hidden';
      }));
      document.getElementById('closeAccountModal')?.addEventListener('click', closeAccountModal);
      mm?.addEventListener('click', (e)=>{ if(e.target === mm) closeAccountModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && mm.style.display==='flex') closeAccountModal(); });

      function closeAccountModal(){
        mm.style.display='none';
        document.body.style.overflow='';
      }
      window._closeAccountModal = closeAccountModal; // expose if needed
    });

    function togglePin(id,btn){
      const input=document.getElementById(id);
      if(!input) return;
      if(input.type==="password"){ input.type="text"; btn.textContent="Hide"; }
      else{ input.type="password"; btn.textContent="Show"; }
    }
  </script>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-left">
      <div class="logo"></div>
      {% if header_back_action %}
        <a href="{{ header_back_action.href }}"
           class="nav-back-btn"
           {% if header_back_action.external %}target="_blank" rel="noopener"{% endif %}>
          <span class="nav-back-icon">‚¨Ö</span>
          <span class="nav-back-label">{{ header_back_action.label or "Back" }}</span>
        </a>
      {% endif %}
    </div>

    <nav class="nav-icons">
      {% if session.get('trainer') %}
        <!-- Dashboard -->
        <a href="{{ url_for('dashboard') }}" class="nav-item" title="Home / Dashboard">
          <img src="{{ url_for('static', filename='nav/pikachu-card.png') }}" alt="Home" class="nav-icon">
        </a>

        <!-- Passport -->
        <a href="{{ url_for('passport') }}" class="stamp-container" title="Passport">
          <img src="{{ url_for('static', filename='nav/stamp-icon.png') }}" alt="Passport">
          <span class="stamp-count">{{ current_stamps or 0 }}</span>
        </a>

        <!-- Inbox -->
        <div class="inbox-wrapper" style="position:relative;">
          <button type="button" class="nav-item" id="inboxToggle" title="Inbox">
            <img src="{{ url_for('static', filename='nav/mail-icon.png') }}" alt="Inbox" class="nav-icon">
          </button>
          {% if inbox_unread and inbox_unread > 0 %}
            <span class="inbox-badge">{{ inbox_unread }}</span>
          {% endif %}
          <div id="inboxDropdown" class="inbox-dropdown">
            {% if inbox_preview and inbox_preview|length > 0 %}
            <ul>
              {% for msg in inbox_preview %}
              <li>
                <strong>{{ msg.subject }}</strong><br>
                <span style="font-size:0.8em; color:#555;">
                  {{ msg.message[:40] }}{% if msg.message|length > 40 %}‚Ä¶{% endif %}
                </span><br>
                <span style="font-size:0.7em; color:#888;">
                  {{ msg.sent_at|to_date }}
                </span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p style="margin:6px 0;">No messages</p>
            {% endif %}
            <a href="{{ url_for('inbox') }}" class="view-all">üì® View Inbox</a>
          </div>
        </div>

        <!-- Avatar (profile hub) -->
        {% set nav_avatar = (current_avatar if current_avatar is defined else (avatar if avatar is defined else 'avatar1.png')) %}
        <div class="avatar-wrapper">
          <button type="button" class="nav-item" id="avatarToggle" title="Account">
            <img src="{{ url_for('static', filename='avatars/' ~ nav_avatar) }}"
                 alt="Avatar" class="nav-icon avatar-icon">
          </button>
          <div id="avatarDropdown" class="avatar-dropdown">
            <a href="{{ url_for('change_avatar') }}">üë§ Edit Avatar</a>
            <button type="button" data-open-account-modal>‚öôÔ∏è Manage Account</button>
            <div class="sep"></div>
            <a href="{{ url_for('logout') }}">üö™ Log Out</a>
          </div>
        </div>
      {% endif %}
    </nav>
  </header>

  {% block page_settings %}{% endblock %}
  {% set container_class = container_class|default('') %}
  {% set _container_classes = ('container ' ~ (container_class|default('')))|trim %}
  <!-- Page content -->
  <div class="{{ _container_classes }}">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}

    {% if show_back %}
      <div style="margin-top:20px; text-align:center;">
        <a href="{{ url_for('dashboard') }}"
           style="display:inline-block; padding:10px 18px; background:var(--brand); color:#fff; border-radius:6px; text-decoration:none; font-weight:600;">
          ‚¨Ö Back to Dashboard
        </a>
      </div>
    {% endif %}
  </div>

  <!-- GLOBAL Manage Account MODAL (available on ALL pages) -->
  {% if session.get('trainer') %}
  <div id="manageAccountModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="accountModalTitle">
      <div class="modal-header">
        <h3 id="accountModalTitle">‚öôÔ∏è Manage My Account</h3>
        <button id="closeAccountModal" class="close-btn" aria-label="Close">√ó</button>
      </div>

      <div class="settings-section">
        <details>
          <summary>üîë Change PIN</summary>
          <div class="settings-body">
            <form action="{{ url_for('change_pin') }}" method="post">
              <input type="password" name="old_pin" placeholder="Old PIN" required>
              <input type="text" name="memorable" placeholder="Memorable Password" required>
              <div class="pin-row">
                <input type="password" name="new_pin" id="modal_new_pin" pattern="\d{4}" maxlength="4" placeholder="New 4-digit PIN" required>
                <button type="button" onclick="togglePin('modal_new_pin', this)">Show</button>
              </div>
              <button type="submit" class="btn-primary">Update PIN</button>
            </form>
          </div>
        </details>

        <details>
          <summary>üìù Change Memorable Password</summary>
          <div class="settings-body">
            <form action="{{ url_for('change_memorable') }}" method="post">
              <input type="text" name="old_memorable" placeholder="Old Memorable" required>
              <input type="text" name="new_memorable" placeholder="New Memorable" required>
              <button type="submit" class="btn-primary">Update Memorable</button>
            </form>
          </div>
        </details>

        <details>
          <summary>üîí Security</summary>
          <div class="settings-body">
            <p class="meta">Account type: {{ 'Standard' if account_type|lower == 'standard' else account_type }}</p>
            <form action="{{ url_for('logout_everywhere') }}" method="post" class="row-actions">
              <button type="submit" class="btn-primary">Log Out Everywhere</button>
            </form>
          </div>
        </details>

        <details>
          <summary>üîî Notifications</summary>
          <div class="settings-body">
            <p class="meta" style="text-align:center;">
              Push notifications will be coming soon.<br>
              For now, check your üì¨ <a href="{{ url_for('inbox') }}">Inbox</a> for updates.
            </p>
          </div>
        </details>

        <details>
          <summary>üóëÔ∏è Delete Account</summary>
          <div class="settings-body">
            <p class="meta" style="color:#b00;">
              ‚ö†Ô∏è This will permanently delete your account, including Passport stamps, profile, and prize history.
              <strong>This cannot be undone.</strong>
            </p>
            <form action="{{ url_for('delete_account') }}" method="post">
              <input type="text" name="confirm_name" placeholder="Type your trainer name to confirm" required>
              <button type="submit" class="btn-danger">Delete My Account</button>
            </form>
          </div>
        </details>
      </div>

      <div class="modal-disclaimer">
        <p>
          This is a programme run entirely by volunteers from the ‚ÄòRaiding Doncaster and Beyond‚Äô Campfire group and is in no way affiliated with
          The Pok√©mon Company or Niantic. All competitions, giveaways, prize draws, passports and prize redemption are entirely free and there are no monetary gains.
          For support, please contact the RDAB admin team via the Niantic Campfire app.
        </p>
        <a class="policy-btn" href="{{ url_for('policies_index') }}">üìÑ View community policies</a>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Register Service Worker (single canonical URL) -->
  <script>
  (function () {
    if (!('serviceWorker' in navigator)) return;
    const SW_URL = '/service-worker.js?v=7';
    navigator.serviceWorker.register(SW_URL, { scope: '/' })
      .then(reg => reg.update())
      .then(() => navigator.serviceWorker.ready)
      .then(() => {
        console.log('‚úÖ Service Worker ready');
        document.dispatchEvent(new CustomEvent('rdab-sw-ready'));
      })
      .catch(err => console.error('‚ùå SW failed:', err));
  })();
  </script>

  {% if account_type == "Admin" %}
  <a href="{{ url_for('admin_dashboard') }}" id="admin-fab" title="Admin Dashboard">üëë</a>
  <style>
    #admin-fab {
      position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
      background: var(--brand); color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.6em; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 2000; transition: background 0.2s, transform 0.2s;
    }
    #admin-fab:hover { background: #2f73bb; transform: scale(1.08); }
  </style>

  <!-- === RDAB Session Memory === -->
<script>
  // Save last page before navigating away
  window.addEventListener('beforeunload', () => {
    const path = window.location.pathname;
    if (!['/login', '/', '/logout'].includes(path)) {
      localStorage.setItem('lastPage', path);
    }
  });

  // When the app loads (PWA or browser)
  document.addEventListener('DOMContentLoaded', () => {
    const last = localStorage.getItem('lastPage');
    const path = window.location.pathname;

    // Only auto-redirect on home or login
    if (last && (path === '/' || path === '/login')) {
      fetch('/session-check')
        .then(r => r.json())
        .then(data => {
          if (data.logged_in) {
            window.location.href = last || '/dashboard';
          }
        })
        .catch(() => {});
    }
  });
</script>

  {% endif %}
</body>
</html>
