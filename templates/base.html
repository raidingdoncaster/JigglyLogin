<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="{{ url_for('manifest') }}">
  <meta name="theme-color" content="#3a8dde">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  {% set _session_trainer_obj = session.get('trainer') %}
  {% if _session_trainer_obj is mapping %}
    {% set _current_trainer_username = _session_trainer_obj.get('trainer_username') or _session_trainer_obj.get('username') %}
  {% else %}
    {% set _current_trainer_username = _session_trainer_obj %}
  {% endif %}

  {% set nav_trainer_raw = session.get('trainer') %}
  {% if nav_trainer_raw is mapping %}
    {% set nav_username = nav_trainer_raw.get('username') or nav_trainer_raw.get('trainer_username') %}
  {% else %}
    {% set nav_username = nav_trainer_raw %}
  {% endif %}
  {% set nav_avatar = (current_avatar if current_avatar is defined else (avatar if avatar is defined else 'avatar1.png')) %}

  <script>
    // Detect if running as a PWA standalone (iOS + Android)
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                      || window.navigator.standalone === true;
    if (isStandalone) {
      fetch("/pwa-flag", { method: "POST" });
    }
  </script>
  <script src="{{ url_for('static', filename='js/overlay-manager.js') }}"></script>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="RDAB">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/app-icon-192.png') }}">
  <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/app-icon-512.png') }}">
  <meta name="apple-mobile-web-app-orientations" content="portrait">

  <meta charset="UTF-8" />
  <title>{{ title if title else "JigglyLogin" }}</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Montserrat:wght@400;600&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  {% if nav_trainer_raw %}
    <link rel="preload" as="image" href="{{ url_for('static', filename='nav/pikachu-card.png') }}">
    <link rel="preload" as="image" href="{{ url_for('static', filename='nav/stamp-icon.png') }}">
    <link rel="preload" as="image" href="{{ url_for('static', filename='nav/mail-icon.png') }}">
    <link rel="preload" as="image" href="{{ url_for('static', filename='avatars/' ~ nav_avatar) }}">
  {% endif %}

  <style>
    :root{
      --brand:#3a8dde;
      --brand2:#5eb8ff;
      --header-height:56px;
      --z-overlay-base:9000;
      --z-overlay:var(--z-overlay-base);
      --z-modal:calc(var(--z-overlay-base) + 100);
      --z-dialog:calc(var(--z-overlay-base) + 200);
      --identity-font:'Space Grotesk','JetBrains Mono','Source Code Pro','Consolas','SFMono-Regular',monospace;
    }
    *,*::before,*::after{box-sizing:border-box;}
    html.is-scroll-locked,
    body.is-scroll-locked{
      overflow:hidden;
      touch-action:none;
      overscroll-behavior:none;
      height:100%;
    }
    body{
      margin:0;
      font-family:'Montserrat',sans-serif;
      background:#f4f7fa url('/static/hex-bg.png') repeat;
      background-size:200px;
      color:#333;
      padding-top:var(--header-height);
      padding-top:calc(var(--header-height) + env(safe-area-inset-top));
    }
    .identity-text,
    .trainer-name,
    .trainer-campfire,
    .trainer-username,
    .option-name{
      font-family:var(--identity-font);
      letter-spacing:0.04em;
      font-feature-settings:"tnum","ss01","cv02";
    }
    .identity-text{
      font-weight:600;
      color:inherit;
    }

    /* Header */
    .site-header{
      position:fixed; top:0; left:0; right:0; z-index:6000;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      padding:6px 12px;
      display:flex; align-items:center; justify-content:space-between;
      color:#fff;
      width:100%;
    }
    .header-left{display:flex;align-items:center;gap:12px;}
    .logo{
      width:80px; height:36px;
      background:url('/static/logo.png') center/cover no-repeat;
      flex:0 0 auto;
    }
    .nav-back-btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 16px;
      border-radius:999px;
      background:rgba(255,255,255,0.22);
      color:#fff;
      text-decoration:none;
      font-weight:600;
      box-shadow:0 8px 20px rgba(0,0,0,0.18);
      transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
      white-space:nowrap;
    }
    .nav-back-btn:hover{
      transform:translateY(-1px);
      background:rgba(255,255,255,0.3);
      box-shadow:0 12px 26px rgba(0,0,0,0.22);
    }
    .nav-back-icon{font-size:1rem;line-height:1;}
    @media(max-width:520px){
      .nav-back-label{display:none;}
      .nav-back-btn{padding:8px 12px;}
    }

    /* --- NAV BAR --- */
    .nav-icons{ display:flex; align-items:center; justify-content:flex-end; gap:12px; flex-wrap:wrap; }
    .nav-item{
      width:44px; height:44px; display:flex; align-items:center; justify-content:center;
      padding:0; border:0; background:transparent; cursor:pointer; flex:0 0 auto;
    }
    .nav-item img.nav-icon,
    .nav-item svg{ pointer-events:none; }
    .nav-item img.nav-icon{ max-width:40px; max-height:40px; width:auto; height:auto; display:block; }

    /* Stamp container */
    .stamp-container{ position:relative; height:44px; width:auto; display:block; margin:0 2px; text-decoration:none; -webkit-tap-highlight-color:transparent; }
    .stamp-container:focus-visible{ outline:none; }
    .stamp-container img{ height:100%; width:auto; display:block; }
    .stamp-container .stamp-count{
      position:absolute; top:50%; right:12px; transform:translateY(-50%);
      font-weight:700; font-size:1.05em; color:#333; line-height:1; user-select:none;
    }

    /* Inbox dropdown */
    .inbox-wrapper{ position:relative; }
    .inbox-wrapper button.nav-item{
      all:unset; display:flex; align-items:center; justify-content:center;
      width:44px; height:44px; cursor:pointer;
    }
    .inbox-panel-overlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top,rgba(15,23,42,0.35),rgba(15,23,42,0.75));
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:clamp(20px,8vh,60px) 16px 32px;
      z-index:var(--z-overlay);
      opacity:0;
      pointer-events:none;
      transition:opacity .3s ease;
    }
    .inbox-panel-overlay::after{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 35% 20%,rgba(255,255,255,0.35),rgba(59,130,246,0.08),transparent 55%);
      opacity:0;
      transform:translateY(-40px) scale(1.1);
      transition:opacity .6s ease, transform .6s ease;
      pointer-events:none;
    }
    .inbox-panel-overlay.is-visible{
      opacity:1;
      pointer-events:auto;
    }
    .inbox-panel-overlay.is-visible::after{
      opacity:1;
      transform:translateY(0) scale(1);
    }
    .inbox-panel-dialog{
      width:min(560px,calc(100% - 16px));
      max-height:78vh;
      min-height:78vh;
      background:rgba(255,255,255,0.78);
      border-radius:32px;
      border:1px solid rgba(255,255,255,0.55);
      box-shadow:0 35px 80px rgba(15,23,42,0.45);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
      backdrop-filter:saturate(140%) blur(18px);
      position:relative;
      transform-origin:top center;
      transform:translateY(30px) scale(.94);
      opacity:0;
      transition:transform .5s cubic-bezier(.19,1,.22,1),opacity .35s ease;
      z-index:var(--z-dialog);
    }
    .inbox-panel-overlay.is-visible .inbox-panel-dialog{
      transform:translateY(0) scale(1);
      opacity:1;
    }
    .inbox-panel-dialog::before{
      content:"";
      position:absolute;
      width:140px;
      height:95px;
      top:-88px;
      left:50%;
      transform:translateX(-50%) perspective(500px) rotateX(-95deg);
      transform-origin:bottom center;
      background:linear-gradient(135deg,rgba(255,255,255,.9),rgba(184,201,255,.9));
      border-radius:18px 18px 70px 70px;
      box-shadow:0 15px 30px rgba(15,23,42,0.25);
      opacity:0;
      pointer-events:none;
    }
    .inbox-panel-overlay.is-visible .inbox-panel-dialog::before{
      animation:envelopeFlap .9s ease forwards .05s;
    }
    .inbox-panel-dialog__body{
      padding:26px clamp(18px,4vw,32px);
      overflow-y:auto;
      flex:1;
      min-height:0;
      max-height:inherit;
      min-height:0;
      flex:1;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
    }
    .inbox-panel__loading,
    .inbox-panel__error{
      text-align:center;
      font-weight:600;
      padding:30px 10px;
      color:#0f172a;
    }
    .inbox-message-overlay,
    .inbox-receipt-overlay{
      position:fixed;
      inset:0;
      background:rgba(2,6,23,0.65);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:80px 16px 24px;
      backdrop-filter:blur(4px);
      z-index:var(--z-overlay);
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
    }
    .inbox-message-overlay.is-visible,
    .inbox-receipt-overlay.is-visible{
      opacity:1;
      pointer-events:auto;
    }
    .inbox-message-dialog,
    .inbox-receipt-dialog{
      position:relative;
      width:min(540px,100%);
      min-height:0;
      max-height:90vh;
      background:#fff;
      border-radius:24px;
      box-shadow:0 30px 70px rgba(15,23,42,0.45);
      padding:22px;
      overflow:auto;
      min-height:0;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      transform:translateY(20px);
      transition:transform .25s ease;
      z-index:var(--z-dialog);
    }
    .inbox-message-overlay.is-visible .inbox-message-dialog,
    .inbox-receipt-overlay.is-visible .inbox-receipt-dialog{
      transform:translateY(0);
    }
    .inbox-message-close,
    .inbox-receipt-close{
      position:absolute;
      top:12px;
      right:12px;
      width:38px;
      height:38px;
      border-radius:50%;
      border:none;
      background:rgba(15,23,42,0.08);
      font-size:1.1rem;
      cursor:pointer;
    }
    #inboxMessageContent{
      min-height:120px;
    }
    #inboxReceiptFrame{
      width:100%;
      height:70vh;
      border:none;
      border-radius:18px;
      background:#f8fafc;
    }
    .inbox-panel__error{ color:#b91c1c; }
    body.has-inbox-panel{
      overflow:hidden;
    }
    @media(max-width:640px){
      .inbox-panel-dialog{
        width:100%;
        max-height:90vh;
        border-radius:28px;
      }
      .inbox-panel-dialog__body{
        padding:24px clamp(14px,6vw,26px);
      }
    }
    @keyframes envelopeFlap{
      0%{transform:translateX(-50%) perspective(500px) rotateX(-105deg); opacity:0;}
      60%{transform:translateX(-50%) perspective(500px) rotateX(8deg); opacity:1;}
      100%{transform:translateX(-50%) perspective(500px) rotateX(0deg); opacity:1;}
    }

    /* Inbox badge */
    .inbox-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #e74c3c;
      color: #fff;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.75em;
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Avatar dropdown */
    .avatar-wrapper{ position:relative; }
    .avatar-icon{
      border-radius:50%;
      border:2px solid #fff;
      width:40px; height:40px; object-fit:cover;
    }
    .avatar-dropdown{
      position:absolute; right:0; top:50px;
      background:#fff; color:#333; border-radius:10px;
      box-shadow:0 8px 20px rgba(0,0,0,.2); min-width:190px; overflow:hidden; z-index:2100;
      opacity:0; transform:translateY(8px); pointer-events:none; visibility:hidden;
      transition:opacity .2s ease, transform .2s ease;
    }
    .avatar-dropdown.is-open{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
      visibility:visible;
    }
    .avatar-dropdown__username{
      padding:12px 14px;
      font-weight:700;
      font-size:.95em;
      color:#1f2937;
      background:#f8fafc;
    }
    .avatar-dropdown a, .avatar-dropdown button{
      display:block; width:100%; text-align:left;
      padding:10px 14px; border:0; background:#fff; color:#333; text-decoration:none; font-size:.95em; cursor:pointer;
    }
    .avatar-dropdown a:hover, .avatar-dropdown button:hover{ background:#f5f7fb; }
    .avatar-dropdown .sep{ height:1px; background:#eee; margin:4px 0; }

    /* Main content container */
    .container{
      --container-max:540px;
      width:min(100%,var(--container-max));
      margin:clamp(20px,6vh,72px) auto;
      padding:clamp(18px,5vw,28px);
      background:#fff;
      border-radius:16px;
      box-shadow:0 12px 32px rgba(15,23,42,0.12);
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    .container.is-cozy{--container-max:480px;}
    .container.is-wide{--container-max:968px;}
    .container.is-fluid{--container-max:100%; background:transparent; box-shadow:none; padding:0; gap:20px;}

    /* Flash messages */
    .flash{ padding:10px; margin-bottom:10px; border-radius:6px; font-weight:600; text-align:center;
      transition:opacity .5s, transform .5s; }
    .flash-success{ background:#d4edda; border:1px solid #155724; color:#155724; }
    .flash-error{ background:#f8d7da; border:1px solid #721c24; color:#721c24; }
    .flash-warning{ background:#fff3cd; border:1px solid #856404; color:#856404; }

    /* ==== Auth shared styles (login/signup flow) ==== */
    .auth-shell{display:flex;flex-direction:column;gap:24px;color:#0f172a;}
    .auth-hero{position:relative;overflow:hidden;border-radius:24px;padding:32px 26px;background:radial-gradient(circle at 0% 0%,rgba(94,184,255,0.3),transparent 55%),radial-gradient(circle at 100% 0%,rgba(104,226,186,0.28),transparent 55%),linear-gradient(135deg,#0f172a,#1d4ed8);color:#f8fafc;box-shadow:0 20px 48px rgba(15,23,42,0.38);display:flex;flex-wrap:wrap;gap:24px;align-items:center;justify-content:space-between;}
    .auth-hero .hero-glow{position:absolute;inset:-65% -20% auto;min-height:280px;background:radial-gradient(circle,rgba(255,255,255,0.22) 0,rgba(255,255,255,0) 60%);animation:authGlow 7s ease-in-out infinite;}
    @keyframes authGlow{0%,100%{transform:translateY(0);opacity:0.9;}50%{transform:translateY(18px);opacity:0.6;}}
    .auth-hero .hero-text{position:relative;z-index:1;flex:1 1 220px;display:flex;flex-direction:column;gap:12px;}
    .hero-eyebrow{letter-spacing:0.28em;text-transform:uppercase;font-size:0.75rem;font-weight:600;color:rgba(226,232,240,0.85);}
    .auth-hero h1{margin:0;font-size:2rem;line-height:1.2;color:#e2e8f0;}
    .auth-hero p{margin:0;font-size:1rem;line-height:1.6;color:#cbd5f5;}
    .hero-media{position:relative;z-index:1;flex:0 0 auto;display:flex;justify-content:center;align-items:center;}
    .auth-hero .hero-banner{position:relative;z-index:1;width:200px;max-width:45vw;border-radius:18px;box-shadow:0 12px 32px rgba(15,23,42,0.45);}

    .auth-card{background:#fff;border-radius:22px;box-shadow:0 12px 32px rgba(15,23,42,0.16);padding:24px;display:flex;flex-direction:column;gap:18px;}
    .auth-card h2{margin:0;font-size:1.4rem;color:#0f172a;}
    .auth-form{display:flex;flex-direction:column;gap:14px;}
    .auth-label{font-weight:600;font-size:0.9rem;color:#1f2937;}
    .auth-input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:0.95rem;transition:border-color .2s ease, box-shadow .2s ease;}
    .auth-input:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,0.18);}
    .auth-input-row{display:flex;gap:10px;align-items:center;}

    .auth-btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;border-radius:999px;font-weight:600;cursor:pointer;text-decoration:none;font-size:0.95rem;transition:transform .2s ease, box-shadow .2s ease, background .2s ease;color:#0f172a;border:none;}
    .auth-btn--full{width:100%;}
    .auth-btn--primary{background:linear-gradient(135deg,#38bdf8,#2563eb);color:#0f172a;box-shadow:0 12px 32px rgba(37,99,235,0.35);}
    .auth-btn--primary:hover{transform:translateY(-1px);box-shadow:0 16px 40px rgba(37,99,235,0.4);}
    .auth-btn--secondary{background:#eef2ff;color:#1d4ed8;border:1px solid #bfdbfe;box-shadow:0 8px 20px rgba(191,219,254,0.3);}
    .auth-btn--secondary:hover{background:#dbeafe;}
    .auth-btn--ghost{background:rgba(15,23,42,0.08);color:#0f172a;border:1px solid rgba(15,23,42,0.15);}
    .auth-btn--ghost:hover{background:rgba(15,23,42,0.12);}
    .auth-btn--outline{background:#fff;border:1px solid #d1d5db;color:#1f2937;padding:9px 14px;font-size:0.85rem;}
    .auth-btn--outline:hover{border-color:#2563eb;color:#2563eb;}

    .auth-links{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;}
    .auth-tip{background:rgba(15,23,42,0.05);border-radius:16px;padding:16px;text-align:center;color:#1f2937;line-height:1.5;display:flex;flex-direction:column;gap:12px;}

    #reminder-carousel{position:relative;text-align:center;font-size:0.9em;line-height:1.5;margin:0;}
    #reminder-text{display:inline-block;opacity:1;transition:opacity 1s ease-in-out;}
    #pokeball-loader{margin:0 auto;width:28px;height:28px;border-radius:50%;background:linear-gradient(to bottom,#ff1c1c 50%,#fff 50%);border:2px solid #000;position:relative;animation:spin 7s linear infinite;transition:transform .3s ease;}
    #pokeball-loader::before{content:"";position:absolute;top:50%;left:0;width:100%;height:2px;background:#000;transform:translateY(-50%);}
    #pokeball-loader::after{content:"";position:absolute;top:50%;left:50%;width:10px;height:10px;background:#fff;border:2px solid #000;border-radius:50%;transform:translate(-50%,-50%);}
    #pokeball-loader.pop{transform:scale(1.25);}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    .policy-cta{background:linear-gradient(135deg,#f1f5f9,#e0f2fe);border-radius:20px;padding:18px;text-align:center;box-shadow:0 14px 30px rgba(15,23,42,0.15);display:flex;flex-direction:column;gap:10px;font-size:0.95rem;color:#0f172a;}
    .policy-cta h3{margin:0;font-size:1.2rem;color:#0f172a;}
    .policy-cta p{margin:0;color:#334155;}

    .signup-guide{display:flex;gap:14px;align-items:flex-start;background:rgba(248,250,252,0.75);border-radius:16px;padding:16px;}
    .signup-guide__image{width:120px;border-radius:12px;box-shadow:0 8px 18px rgba(15,23,42,0.15);}
    .signup-guide__copy{font-size:0.9rem;color:#1f2937;line-height:1.55;}

    @media(max-width:560px){
      .auth-hero{padding:26px 20px;}
      .auth-hero h1{font-size:1.65rem;}
      .auth-hero .hero-banner{width:160px;}
      .auth-card{padding:20px;}
      .signup-guide{flex-direction:column;align-items:center;text-align:center;}
      .signup-guide__image{width:140px;}
    }

    /* Modal: Manage Account */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:flex-end; justify-content:center; z-index:var(--z-overlay);
    }
    .modal-backdrop.is-open{display:flex;}
    .modal-backdrop[hidden]{display:none;}
    .modal-card{
      width:100%; max-width:520px; background:#fff; border-radius:16px 16px 0 0;
      box-shadow:0 -8px 24px rgba(0,0,0,.25); padding:14px 14px 18px; max-height:92vh; overflow:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      animation:slideUp .25s ease-out;
      z-index:var(--z-dialog);
    }
    @keyframes slideUp{ from{ transform:translateY(24px); opacity:.8;} to{ transform:none; opacity:1;} }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 4px 10px;
      border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index:1;
    }
    .modal-header h3{ margin:0; font-size:1.05em; color:#111; }
    .close-btn{ background:transparent; border:0; font-size:1.6em; line-height:1; cursor:pointer; color:#333; }

    .settings-section{ margin-top:10px; border:1px solid #eee; border-radius:10px; overflow:hidden; }
    .settings-section details{ border-bottom:1px solid #eee; }
    .settings-section details:last-child{ border-bottom:none; }
    .settings-section summary{
      list-style:none; cursor:pointer; padding:12px; background:#f7f8fb; font-weight:700; color:#333;
    }
    .settings-section summary::-webkit-details-marker{ display:none; }
    .settings-body{ padding:12px; }
    .settings-body form input, .settings-body form button{
      width:100%; margin:6px 0; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:.95em;
    }
    .btn-primary{ background:var(--brand); color:#fff; border:none; }
    .btn-danger{ background:#e74c3c; color:#fff; border:none; }
    .meta{ font-size:.9em; color:#666; }
    .pin-row{ display:flex; gap:8px; }
    .pin-row input{ flex:1; }
    .row-actions{ display:flex; gap:8px; }
    .modal-disclaimer{
      margin:18px 0 4px;
      padding:14px;
      border-radius:12px;
      background:#f8fafc;
      border:1px solid #e2e8f0;
      font-size:0.85em;
      color:#475569;
      line-height:1.6;
    }
    .modal-disclaimer p{margin:0 0 10px;}
    .modal-disclaimer .policy-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:999px;
      background:var(--brand);
      color:#fff;
      text-decoration:none;
      font-weight:600;
      box-shadow:0 8px 20px rgba(58,141,222,0.25);
    }

    .trainer-profile-popover {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: var(--z-overlay);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    .trainer-profile-popover.is-visible {
      opacity: 1;
      pointer-events: auto;
    }
    .trainer-profile-popover__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(8, 15, 37, 0.8);
    }
    .trainer-profile-popover__modal {
      position: relative;
      width: min(520px, 100%);
      min-height: 0;
      max-height: min(720px, 92vh);
      overflow-y: auto;
      min-height: 0;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      background: transparent;
      z-index: var(--z-dialog);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .trainer-profile-popover__close {
      align-self: flex-end;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(15, 23, 42, 0.85);
      color: #fff;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .trainer-profile-popover__loading,
    .trainer-profile-popover__error {
      background: #fff;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      font-weight: 600;
      color: #0f172a;
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.25);
    }
    .trainer-profile-popover__error {
      color: #991b1b;
      background: #fef2f2;
      border: 1px solid #fecaca;
    }
    .trainer-profile-card {
      background: #fff;
      border-radius: 28px;
      box-shadow: 0 26px 70px rgba(15, 23, 42, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .trainer-profile-card__hero {
      position: relative;
      padding: 28px;
      background: linear-gradient(140deg, #5c0b1c, #9d0d37 55%, #c81e1e);
      color: #fff;
      min-height: 260px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .trainer-profile-card__hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(7, 11, 30, 0.2), rgba(5, 9, 24, 0.75));
      pointer-events: none;
    }
    .trainer-profile-card__hero > * {
      position: relative;
      z-index: 1;
    }
    .trainer-profile-card__badge {
      align-self: flex-start;
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.15);
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-weight: 700;
    }
    .trainer-profile-card__identity {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .trainer-profile-card__avatar {
      width: 86px;
      height: 86px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 14px 35px rgba(0, 0, 0, 0.4);
      background: rgba(0, 0, 0, 0.15);
      overflow: hidden;
      flex-shrink: 0;
    }
    .trainer-profile-card__avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .trainer-profile-card__account {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.8);
    }
    .trainer-profile-card__hero h3 {
      margin: 4px 0 0;
      font-size: 2rem;
      line-height: 1.1;
      color: #fff;
    }
    .trainer-profile-card__hero-stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
    }
    .trainer-profile-card__hero-stats dt {
      margin: 0;
      font-size: 0.7rem;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.8);
    }
    .trainer-profile-card__hero-stats dd {
      margin: 6px 0 0;
      font-size: 1.4rem;
      font-weight: 700;
    }
    .trainer-profile-card__code-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 14px 18px;
      border-radius: 18px;
      background: rgba(0, 0, 0, 0.25);
      font-family: var(--identity-font);
    }
    .trainer-profile-card__code-row span {
      display: block;
      font-size: 0.75rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.75);
    }
    .trainer-profile-card__code-row strong {
      display: block;
      margin-top: 4px;
      font-size: 1.2rem;
      letter-spacing: 0.3em;
    }
    .trainer-profile-card__copy {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      font-weight: 600;
      cursor: not-allowed;
    }
    .trainer-profile-card__hero-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .trainer-profile-card__hero-actions button {
      flex: 1;
      min-width: 180px;
      border: none;
      border-radius: 16px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      font-weight: 600;
      cursor: not-allowed;
    }
    .trainer-profile-card__copy-toast {
      margin-top: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      background: #0f172a;
      color: #fff;
      font-weight: 600;
      font-size: 0.85rem;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.35);
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    .trainer-profile-card__copy-toast.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
    .trainer-profile-card__body {
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 28px;
    }
    .trainer-profile-section {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .trainer-profile-section__grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 14px;
    }
    .trainer-profile-badge {
      border-radius: 16px;
      padding: 18px 16px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      text-align: center;
    }
    .trainer-profile-badge img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin: 0 auto 6px;
      object-fit: cover;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.2);
    }
    .trainer-profile-badge span {
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #475569;
    }
    .trainer-profile-badge strong {
      font-size: 1.6rem;
      color: #0f172a;
    }
    .trainer-profile-badge[data-trainer-profile-team] {
      padding: 18px;
      align-items: center;
      justify-content: center;
    }
    .trainer-profile-badge[data-trainer-profile-team] div {
      font-size: 1rem;
      font-weight: 700;
      color: #0f172a;
    }
    .trainer-profile-stat {
      border-radius: 16px;
      padding: 18px;
      border: 1px solid #e2e8f0;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .trainer-profile-stat span {
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #94a3b8;
    }
    .trainer-profile-stat strong {
      font-size: 1.3rem;
      color: #0f172a;
    }
    .trainer-profile-stat small {
      font-size: 0.75rem;
      color: #94a3b8;
    }
    .trainer-profile-section__header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }
    .trainer-profile-eyebrow {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.28em;
      font-size: 0.75rem;
      color: #0f172a;
      font-weight: 700;
    }
    .trainer-profile-subtext {
      margin: 4px 0 0;
      color: #475569;
      max-width: 360px;
      font-size: 0.9rem;
    }
    .trainer-profile-section__header button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      background: #e0f2fe;
      color: #0369a1;
      font-weight: 600;
      cursor: not-allowed;
    }
    .trainer-profile-medals {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    .trainer-profile-medal {
      border-radius: 999px;
      padding: 10px 14px;
      background: #e2e8f0;
      text-align: center;
      font-weight: 600;
      color: #334155;
      font-size: 0.85rem;
    }
    .trainer-profile-medal--cta {
      background: #2563eb;
      color: #fff;
    }
    .trainer-profile-stamps {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      min-height: 64px;
    }
    .trainer-profile-stamp {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #e0f2fe;
      border: 2px dashed #38bdf8;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #0f172a;
    }
    .trainer-profile-stamp img {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.18);
    }
    .trainer-profile-empty {
      margin: 0;
      color: #94a3b8;
      font-size: 0.9rem;
    }
    .trainer-profile-section__actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .trainer-profile-section__actions button {
      flex: 1;
      min-width: 220px;
      border: none;
      border-radius: 16px;
      padding: 12px;
      background: #dbeafe;
      color: #1d4ed8;
      font-weight: 600;
      cursor: not-allowed;
    }
    .trainer-profile-footer {
      padding: 20px 28px 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      border-top: 1px solid #e2e8f0;
    }
    .trainer-profile-edit {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 14px 18px;
      background: #0f172a;
      color: #fff;
      font-size: 1rem;
      font-weight: 700;
      cursor: not-allowed;
    }
    .trainer-profile-close {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      border: none;
      background: #e2e8f0;
      font-size: 1.2rem;
      font-weight: 700;
      color: #0f172a;
      cursor: pointer;
    }
    @media(max-width:640px){
      .trainer-profile-popover {
        padding: 12px;
      }
      .trainer-profile-card__hero {
        padding: 22px;
      }
      .trainer-profile-card__body {
        padding: 22px;
      }
      .trainer-profile-section__actions button {
        min-width: unset;
      }
      .trainer-profile-card__hero-actions {
        flex-direction: column;
      }
      .trainer-profile-card__code-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .trainer-profile-footer {
        flex-direction: column;
        align-items: stretch;
      }
      .trainer-profile-close {
        width: 48px;
        height: 48px;
      }
    }

    /* === Trainer profile concept overrides === */
    .trainer-profile-card {
      width: min(420px, calc(100vw - 32px));
      align-self: center;
    }
    .trainer-profile-card__frame {
      position: relative;
      border-radius: 32px;
      overflow: hidden;
      background: #fff;
      box-shadow: 0 30px 80px rgba(15, 23, 42, 0.35);
      display: flex;
      flex-direction: column;
      max-height: min(680px, 85vh);
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      scrollbar-width: thin;
      scrollbar-color: rgba(15,23,42,0.35) rgba(226,232,240,0.6);
    }
    .trainer-profile-card__frame::-webkit-scrollbar{
      width:6px;
    }
    .trainer-profile-card__frame::-webkit-scrollbar-track{
      background:rgba(226,232,240,0.6);
    }
    .trainer-profile-card__frame::-webkit-scrollbar-thumb{
      background:rgba(15,23,42,0.35);
      border-radius:999px;
    }
    .trainer-profile-card__frame::before,
    .trainer-profile-card__frame::after{
      content:"";
      position:sticky;
      left:0;
      right:0;
      height:28px;
      pointer-events:none;
      z-index:5;
    }
    .trainer-profile-card__frame::before{
      top:0;
      background:linear-gradient(180deg,rgba(8,15,37,0.12),rgba(8,15,37,0));
    }
    .trainer-profile-card__frame::after{
      bottom:0;
      background:linear-gradient(0deg,rgba(8,15,37,0.12),rgba(8,15,37,0));
    }
    .trainer-profile-card__hero {
      background: linear-gradient(140deg, #6b0f1a, #b91372 55%, #f94a1e);
      padding: 28px;
      min-height: 260px;
      position: relative;
      color: #fff;
      gap: 18px;
    }
    .trainer-profile-card__hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(8, 12, 28, 0.2), rgba(5, 8, 24, 0.85));
      pointer-events: none;
    }
    .trainer-profile-card__hero > * {
      position: relative;
      z-index: 1;
    }
    .trainer-profile-card__eyebrow {
      letter-spacing: 0.28em;
      text-transform: uppercase;
      font-size: 0.75rem;
      font-weight: 700;
      margin: 0;
      color: rgba(255,255,255,0.85);
    }
    .trainer-profile-card__identity {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .trainer-profile-card__avatar {
      width: 86px;
      height: 86px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.85);
      overflow: hidden;
      box-shadow: 0 16px 32px rgba(0,0,0,0.45);
      flex-shrink: 0;
    }
    .trainer-profile-card__avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .trainer-profile-card__account {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 0.75rem;
      color: rgba(255,255,255,0.75);
    }
    .trainer-profile-card__hero h3 {
      margin: 4px 0 0;
      font-size: 2rem;
      line-height: 1.1;
    }
    .trainer-profile-card__hero-stats dt {
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.75);
      font-size: 0.7rem;
      margin: 0;
    }
    .trainer-profile-card__hero-stats dd {
      margin: 8px 0 0;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .trainer-profile-card__code-row {
      background: rgba(0,0,0,0.3);
      border-radius: 18px;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      font-family: var(--identity-font);
    }
    .trainer-profile-card__code-row span {
      display: block;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.75);
    }
    .trainer-profile-card__code-row strong {
      display: block;
      margin-top: 4px;
      font-size: 1.3rem;
      letter-spacing: 0.3em;
    }
    .trainer-profile-card__copy {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      background: rgba(255,255,255,0.2);
      color: #fff;
      font-weight: 600;
      cursor: not-allowed;
    }
    .trainer-profile-card__hero-actions button {
      background: rgba(255,255,255,0.2);
      color: #fff;
      cursor: not-allowed;
    }
    .trainer-profile-card__body {
      background: #fff;
      padding: 28px;
      display: flex;
      flex-direction: column;
      gap: 28px;
    }
    .trainer-profile-metric-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 18px;
    }
    .trainer-profile-level,
    .trainer-profile-team {
      border-radius: 18px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      text-align: center;
    }
    .trainer-profile-level__circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 8px solid rgba(15,23,42,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      background: #0f172a;
      color: #fff;
      font-size: 1.6rem;
      font-weight: 700;
    }
    .trainer-profile-team__badge {
      width: 88px;
      height: 88px;
      border-radius: 20px;
      border: 1px dashed #cbd5f5;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      font-weight: 700;
      color: #0f172a;
    }
    .trainer-profile-team__badge img {
      max-width: 64px;
      max-height: 64px;
    }
    .trainer-profile-team__badge strong {
      display: block;
      margin-top: 6px;
      color: #0f172a;
    }
    .trainer-profile-stat {
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .trainer-profile-stat strong {
      font-size: 1.4rem;
      color: #0f172a;
    }
    .trainer-profile-section__header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
    }
    .trainer-profile-pill {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      background: #dbeafe;
      color: #1d4ed8;
      font-weight: 600;
    }
    .trainer-profile-featured-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 14px;
    }
    .trainer-profile-featured-item {
      border-radius: 28px;
      background: #e0f2fe;
      padding: 14px 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    .trainer-profile-featured-item img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 4px solid #fff;
      box-shadow: 0 18px 24px rgba(15,23,42,0.25);
      object-fit: cover;
      background: #fff;
    }
    .trainer-profile-featured-item span {
      font-size: 0.85rem;
      font-weight: 600;
      color: #0f172a;
    }
    .trainer-profile-featured-empty {
      margin: 0;
      text-align: center;
      color: #94a3b8;
      font-style: italic;
    }
    .trainer-profile-bio-pill {
      border: 1px solid #e2e8f0;
      border-radius: 999px;
      padding: 4px 12px;
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #475569;
    }
    .trainer-profile-bio-text {
      margin: 0;
      color: #1f2937;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .trainer-profile-links {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .trainer-profile-links button {
      border: none;
      border-radius: 999px;
      padding: 12px 18px;
      background: #e0f2fe;
      color: #0f172a;
      font-weight: 600;
      cursor: not-allowed;
    }
    .trainer-profile-popover__owner-actions {
      border-radius: 30px;
      background: #fff;
      box-shadow: 0 20px 40px rgba(15,23,42,0.2);
      padding: 18px;
    }
    .trainer-profile-edit-btn {
      background: linear-gradient(135deg,#0f172a,#1e293b);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 12px 32px;
    }

    .content-filter-progress {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #cbd5f5;
      background: #f8fbff;
      color: #1e293b;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .content-filter-progress__spinner {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(37, 99, 235, 0.22);
      border-top-color: #2563eb;
      animation: contentFilterSpin 0.9s linear infinite;
    }
    @keyframes contentFilterSpin {
      to { transform: rotate(360deg); }
    }

    .content-filter-modal {
      position: fixed;
      inset: 0;
      z-index: var(--z-overlay);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(15, 23, 42, 0.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    .content-filter-modal.is-open {
      opacity: 1;
      pointer-events: auto;
    }
    .content-filter-modal__dialog {
      position: relative;
      width: min(420px, 92vw);
      background: #fff;
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 25px 70px rgba(15, 23, 42, 0.25);
      text-align: center;
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      z-index: var(--z-dialog);
    }
    .content-filter-modal__halo {
      position: absolute;
      inset: 18px;
      border-radius: 22px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(99, 102, 241, 0.1));
      pointer-events: none;
    }
    .content-filter-modal__body {
      position: relative;
      z-index: 1;
    }
    .content-filter-modal__icon {
      width: 56px;
      height: 56px;
      margin: 0 auto 16px;
      border-radius: 16px;
      background: #fef3c7;
      color: #b45309;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      box-shadow: inset 0 0 0 1px rgba(180, 83, 9, 0.15);
    }
    .content-filter-modal__title {
      margin: 0;
      font-size: 1.35rem;
      color: #0f172a;
    }
    .content-filter-modal__match {
      margin: 16px 0 10px;
      padding: 10px 14px;
      border-radius: 12px;
      background: #fee2e2;
      color: #b91c1c;
      font-weight: 600;
      font-family: var(--identity-font);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .content-filter-modal__subtitle {
      margin: 12px 0 2px;
      font-size: 0.95rem;
      color: #475569;
      font-weight: 600;
    }
    .content-filter-modal__match span {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(185, 28, 28, 0.12);
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #7f1d1d;
    }
    .content-filter-modal__message {
      font-size: 0.95rem;
      color: #334155;
      line-height: 1.5;
      margin-bottom: 16px;
    }
    .content-filter-modal__message a {
      color: #2563eb;
      font-weight: 600;
      text-decoration: none;
    }
    .content-filter-modal__message a:hover {
      text-decoration: underline;
    }
    .content-filter-modal__actions {
      display: flex;
      justify-content: center;
    }
    .content-filter-modal__close {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      border-radius: 999px;
      padding: 12px 26px;
      background: linear-gradient(135deg, #3a8dde, #5eb8ff);
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 12px 24px rgba(58, 141, 222, 0.35);
    }
    .content-filter-modal__close:focus-visible {
      outline: 2px solid #2563eb;
      outline-offset: 2px;
    }

    /* Mobile */
    @media(max-width:480px){
      :root{ --header-height:64px; }
      .site-header{ padding:8px 12px; }
      .nav-icons{ gap:10px; }
      .nav-item{ width:40px; height:40px; }
      .nav-item img.nav-icon{ max-width:36px; max-height:36px; }
      .stamp-container{ height:40px; }
      .container{ margin:16px auto 48px; padding:20px 16px; border-radius:14px; }
    }
  </style>

  <script>
    window.__COMMUNITY_STANDARDS_URL = "{{ url_for('policy_page', slug='community-standards') }}";
  </script>
  <script src="{{ url_for('static', filename='js/content-filter.js') }}"></script>

  <script>
    (function () {
      const bodyScrollLock = window.__overlayLock || { lock(){}, unlock(){} };
      const warnMissing = (label) => console.warn(`[Overlay] Missing ${label} node`);

      window.addEventListener("DOMContentLoaded",()=>{
      const headerEl=document.querySelector(".site-header");
      const setHeaderOffset=()=>{
        if(!headerEl) return;
        const height=headerEl.offsetHeight;
        document.documentElement.style.setProperty("--header-height", `${height}px`);
      };
      setHeaderOffset();
      window.addEventListener("resize", setHeaderOffset);
      if(window.ResizeObserver && headerEl){
        const ro=new ResizeObserver(()=>setHeaderOffset());
        ro.observe(headerEl);
      }
      window.addEventListener("load", setHeaderOffset);

      // Auto-hide flashes
      setTimeout(()=>{
        document.querySelectorAll(".flash").forEach(el=>{
          el.style.opacity=0; el.style.transform="translateY(-10px)";
          setTimeout(()=>el.remove(),500);
        });
      },4000);

      // Inbox modal panel
      const inboxBtn = document.getElementById("inboxToggle");
      const inboxOverlay = document.getElementById("inboxPanelOverlay");
      const inboxContent = document.getElementById("inboxPanelContent");
      const overlayManagerReady = Boolean(window.OverlayManager && typeof window.OverlayManager.open === "function");
      let inboxLastUrl = "/inbox?panel=1";
      if (!inboxBtn) warnMissing("inbox toggle button");
      if (!inboxOverlay) warnMissing("inbox overlay");
      if (!inboxContent) warnMissing("inbox content container");
      if (!overlayManagerReady) console.warn("[Inbox] OverlayManager unavailable; using fallback overlay handling");

      const setInboxButtonState = (isOpen) => {
        if (!inboxBtn) return;
        inboxBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
      };

      const focusInboxPanel = () => {
        if (!inboxContent) return;
        requestAnimationFrame(() => {
          inboxContent.focus({ preventScroll: true });
        });
      };

      const ensurePanelParam = (url) => {
        const parsed = new URL(url, window.location.origin);
        if (!parsed.searchParams.get("panel")) {
          parsed.searchParams.set("panel", "1");
        }
        return parsed.pathname + "?" + parsed.searchParams.toString();
      };

      const enhanceInboxPanel = (root) => {
        const scope = root instanceof HTMLElement ? root : document;
        const panels = scope.querySelectorAll(".inbox-panel");
        if (!panels.length) return;

        panels.forEach((panel) => {
          if (panel.dataset.inboxEnhanced === "true") return;
          panel.dataset.inboxEnhanced = "true";

          panel.querySelectorAll("[data-inbox-autosubmit]").forEach((select) => {
            select.addEventListener("change", () => {
              select.classList.add("is-flipping");
              window.setTimeout(() => select.classList.remove("is-flipping"), 600);
              const form = select.closest("form");
              if (!form) return;
              if (typeof form.requestSubmit === "function") {
                form.requestSubmit();
                return;
              }
              const submitEvent = new Event("submit", { cancelable: true, bubbles: true });
              if (form.dispatchEvent(submitEvent)) {
                form.submit();
              }
            });
          });

          const searchToggle = panel.querySelector("[data-inbox-search-toggle]");
          const searchRegion = panel.querySelector("[data-inbox-search]");
          const searchInput = panel.querySelector("[data-inbox-search-input]");
          const searchClear = panel.querySelector("[data-inbox-search-clear]");
          const searchCount = panel.querySelector("[data-inbox-search-count]");
          const searchEmpty = panel.querySelector("[data-inbox-search-empty]");
          const mailCards = Array.from(panel.querySelectorAll(".mail-card"));
          const emptyState = panel.querySelector("[data-empty-state]");

          if (searchToggle && searchRegion && searchInput) {
            const ensureSearchText = (card) => {
              if (!card.dataset.searchPrepared) {
                card.dataset.searchText = (card.textContent || "").toLowerCase();
                card.dataset.searchPrepared = "true";
              }
              return card.dataset.searchText || "";
            };

            const updateMatches = () => {
              const term = (searchInput.value || "").trim().toLowerCase();
              let matches = 0;
              mailCards.forEach((card) => {
                const haystack = ensureSearchText(card);
                const match = !term || haystack.includes(term);
                card.hidden = Boolean(term) && !match;
                if (!card.hidden) {
                  matches += 1;
                }
              });
              if (searchCount) {
                searchCount.textContent = term ? `${matches} match${matches === 1 ? "" : "es"}` : "";
              }
              if (searchEmpty) {
                searchEmpty.hidden = matches !== 0 || !term;
              }
              if (emptyState) {
                emptyState.hidden = Boolean(term);
              }
            };

            const closeSearch = () => {
              if (searchRegion.hidden) return;
              searchRegion.hidden = true;
              searchRegion.classList.remove("is-open");
              searchToggle.classList.remove("is-active");
              searchToggle.setAttribute("aria-expanded", "false");
              if (searchInput.value) {
                searchInput.value = "";
                updateMatches();
              } else if (searchCount) {
                searchCount.textContent = "";
              }
              if (searchEmpty) searchEmpty.hidden = true;
            };

            const openSearch = () => {
              if (!searchRegion.hidden) {
                searchInput.focus();
                searchInput.select();
                updateMatches();
                return;
              }
              searchRegion.hidden = false;
              searchRegion.classList.add("is-open");
              searchToggle.classList.add("is-active");
              searchToggle.setAttribute("aria-expanded", "true");
              requestAnimationFrame(() => {
                searchInput.focus();
                searchInput.select();
              });
              updateMatches();
            };

            searchToggle.addEventListener("click", () => {
              if (searchRegion.hidden) {
                openSearch();
              } else {
                closeSearch();
              }
            });

            searchInput.addEventListener("input", updateMatches);
            searchInput.addEventListener("keydown", (event) => {
              if (event.key === "Escape") {
                event.preventDefault();
                closeSearch();
                searchToggle.focus({ preventScroll: true });
              }
            });
            searchClear?.addEventListener("click", () => {
              searchInput.value = "";
              updateMatches();
              searchInput.focus();
            });
          }

          const selectToggle = panel.querySelector("[data-inbox-select-toggle]");
          const bulkBar = panel.querySelector("[data-inbox-bulk]");
          const bulkCount = panel.querySelector("[data-inbox-bulk-count]");
          const bulkButtons = panel.querySelectorAll("[data-inbox-bulk-action]");
          const getSelectableCards = () => Array.from(panel.querySelectorAll(".mail-card:not([data-message-placeholder='true'])"));
          const selectionState = { active: false, selected: new Set() };

          const refreshSelectToggleState = () => {
            if (!selectToggle) return;
            const hasCards = getSelectableCards().length > 0;
            selectToggle.disabled = !hasCards;
          };

          const updateSelectedCount = () => {
            if (bulkCount) {
              bulkCount.textContent = `${selectionState.selected.size} selected`;
            }
            bulkButtons.forEach((btn) => {
              btn.disabled = selectionState.selected.size === 0;
            });
          };

          const clearSelections = () => {
            selectionState.selected.clear();
            panel.querySelectorAll("[data-inbox-select]").forEach((checkbox) => {
              checkbox.checked = false;
              checkbox.closest(".mail-card")?.classList.remove("selected");
            });
            updateSelectedCount();
          };

          const setSelectionMode = (active) => {
            selectionState.active = active;
            panel.classList.toggle("is-selecting", active);
            if (selectToggle) {
              selectToggle.setAttribute("aria-pressed", active ? "true" : "false");
            }
            if (bulkBar) {
              bulkBar.hidden = !active;
            }
            if (!active) {
              clearSelections();
            }
          };

          selectToggle?.addEventListener("click", () => {
            setSelectionMode(!selectionState.active);
          });

          panel.addEventListener("change", (event) => {
            const checkbox = event.target.closest("[data-inbox-select]");
            if (!checkbox || !selectionState.active) return;
            const messageId = checkbox.value;
            const card = checkbox.closest(".mail-card");
            if (!card || card.dataset.messagePlaceholder === "true") return;
            if (checkbox.checked) {
              selectionState.selected.add(messageId);
              card.classList.add("selected");
            } else {
              selectionState.selected.delete(messageId);
              card.classList.remove("selected");
            }
            updateSelectedCount();
          });

          const updateCardReadState = (card, isRead) => {
            card.dataset.messageRead = isRead ? "true" : "false";
            card.classList.toggle("is-read", isRead);
            card.classList.toggle("is-unread", !isRead);
            if (!card.classList.contains("mail-card--digital")) {
              const badge = card.querySelector("[data-mail-new-badge]");
              if (badge) {
                badge.hidden = isRead;
              } else if (!isRead) {
                const meta = card.querySelector(".mail-card__meta");
                if (meta) {
                  const span = document.createElement("span");
                  span.className = "mail-card__badge";
                  span.dataset.mailNewBadge = "true";
                  span.textContent = "New";
                  meta.appendChild(span);
                }
              }
            }
          };

          const performBulkAction = async (action) => {
            if (!selectionState.selected.size) return;
            if (action === "delete") {
              const confirmed = window.confirm(`Delete ${selectionState.selected.size} message(s)? This cannot be undone.`);
              if (!confirmed) return;
            }
            const payload = {
              action,
              message_ids: Array.from(selectionState.selected),
            };
            try {
              const resp = await fetch("/api/inbox/bulk", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              const data = await resp.json();
              if (!data.success) {
                alert(data.error || "Unable to update messages right now.");
                return;
              }
              data.results?.forEach((result) => {
                if (!result || !result.id) return;
                const card = panel.querySelector(`.mail-card[data-message-id='${CSS.escape(result.id)}']`);
                if (!card) return;
                if (action === "delete" && result.success) {
                  card.remove();
                } else if (result.success && (action === "read" || action === "unread")) {
                  updateCardReadState(card, action === "read");
                }
              });
              clearSelections();
              setSelectionMode(false);
              refreshSelectToggleState();
              if (!panel.querySelector(".mail-card")) {
                const empty = panel.querySelector("[data-empty-state]");
                if (empty) empty.hidden = false;
              }
            } catch (err) {
              console.error("Inbox bulk action failed", err);
              alert("Unable to update messages right now.");
            }
          };

          bulkButtons.forEach((btn) => {
            btn.addEventListener("click", () => performBulkAction(btn.dataset.inboxBulkAction));
          });

          panel.querySelectorAll("[data-open-inbox-message]").forEach((link) => {
            link.addEventListener("click", (event) => {
              if (link.closest(".mail-card")?.dataset.messagePlaceholder === "true") return;
              event.preventDefault();
              if (typeof window.RDAB?.openInboxMessage === "function") {
                window.RDAB.openInboxMessage(link.getAttribute("href"));
              } else {
                window.location.href = link.getAttribute("href");
              }
            });
          });

          updateSelectedCount();
          refreshSelectToggleState();
        });
      };

      const loadInboxPanel = async (url) => {
        if (!inboxContent) return;
        inboxLastUrl = url ? ensurePanelParam(url) : inboxLastUrl || "/inbox?panel=1";
        inboxContent.innerHTML = "<div class='inbox-panel__loading'>Loading inbox</div>";
        try {
          const resp = await fetch(inboxLastUrl, {
            headers: { "X-Requested-With": "fetch" }
          });
          if (resp.redirected) {
            window.location.href = resp.url;
            return;
          }
          if (!resp.ok) throw new Error("Inbox load failed");
          const html = await resp.text();
          inboxContent.innerHTML = html;
          enhanceInboxPanel(inboxContent);
          focusInboxPanel();
        } catch (err) {
          inboxContent.innerHTML = "<div class='inbox-panel__error'>Could not load your inbox. Please try again.</div>";
        }
      };

      const openInboxPanel = (url) => {
        if (!inboxOverlay || !inboxContent) {
          console.warn("[Inbox] Overlay not found for user");
          return;
        }
        if (url) inboxLastUrl = url;
        document.body.classList.add("has-inbox-panel");
        if (overlayManagerReady) {
          window.OverlayManager.open("inbox-panel", {
            element: inboxOverlay,
            backdrop: inboxOverlay,
            onRequestClose: closeInboxPanel,
            focusTarget: inboxBtn,
            restoreFocus: false,
          });
        } else {
          bodyScrollLock.lock();
          inboxOverlay.classList.add("is-visible");
          inboxOverlay.setAttribute("aria-hidden", "false");
        }
        setInboxButtonState(true);
        loadInboxPanel(inboxLastUrl);
      };

      const closeInboxPanel = () => {
        if (!inboxOverlay) {
          console.warn("[Inbox] Overlay not found for user");
          return;
        }
        document.body.classList.remove("has-inbox-panel");
        if (overlayManagerReady) {
          window.OverlayManager.close("inbox-panel");
        } else {
          inboxOverlay.classList.remove("is-visible");
          inboxOverlay.setAttribute("aria-hidden", "true");
          bodyScrollLock.unlock();
        }
        setInboxButtonState(false);
        if (inboxBtn) {
          inboxBtn.focus({ preventScroll: true });
        } else {
          warnMissing("inbox toggle button");
        }
      };

      if (overlayManagerReady && inboxOverlay) {
        window.OverlayManager.register("inbox-panel", {
          element: inboxOverlay,
          backdrop: inboxOverlay,
          onRequestClose: closeInboxPanel,
          focusTarget: inboxBtn,
          restoreFocus: false,
        });
      } else if (!inboxOverlay) {
        console.warn("[Inbox] Overlay not found for user");
      }

      window.RDAB = window.RDAB || {};
      window.RDAB.openInboxPanel = openInboxPanel;
      window.RDAB.closeInboxPanel = closeInboxPanel;
      window.RDAB.loadInboxPanel = loadInboxPanel;
      window.RDAB.enhanceInboxPanel = enhanceInboxPanel;
      const inboxMessageOverlay = document.getElementById("inboxMessageOverlay");
      const inboxMessageContent = document.getElementById("inboxMessageContent");
      const inboxMessageClose = document.querySelector("[data-inbox-message-close]");
      let inboxMessageLastFocus = null;
      if (!inboxMessageOverlay) warnMissing("inbox message overlay");
      if (!inboxMessageContent) warnMissing("inbox message content");

      const inboxReceiptOverlay = document.getElementById("inboxReceiptOverlay");
      const inboxReceiptClose = document.querySelector("[data-inbox-receipt-close]");
      const inboxReceiptFrame = document.getElementById("inboxReceiptFrame");
      const inboxReceiptLoading = document.querySelector("[data-inbox-receipt-loading]");
      if (!inboxReceiptOverlay) warnMissing("inbox receipt overlay");
      if (!inboxReceiptFrame) warnMissing("inbox receipt frame");

      const setInboxCardReadState = (messageId, isRead) => {
        if (!messageId) return;
        document.querySelectorAll(`.mail-card[data-message-id='${CSS.escape(messageId)}']`).forEach((card) => {
          card.dataset.messageRead = isRead ? "true" : "false";
          card.classList.toggle("is-read", isRead);
          card.classList.toggle("is-unread", !isRead);
          if (!card.classList.contains("mail-card--digital")) {
            const badge = card.querySelector("[data-mail-new-badge]");
            if (badge) {
              badge.hidden = isRead;
            }
          }
        });
      };

      const removeInboxCard = (messageId) => {
        if (!messageId) return;
        document.querySelectorAll(`.mail-card[data-message-id='${CSS.escape(messageId)}']`).forEach((card) => {
          const list = card.closest(".inbox-list");
          card.remove();
          if (list && !list.querySelector(".mail-card")) {
            const empty = list.closest(".inbox-panel")?.querySelector("[data-empty-state]");
            if (empty) empty.hidden = false;
          }
        });
      };

      const closeReceiptModal = () => {
        if (!inboxReceiptOverlay) return;
        inboxReceiptFrame?.setAttribute("src", "");
        inboxReceiptLoading?.classList.remove("hidden");
        if (overlayManagerReady) {
          window.OverlayManager.close("inbox-receipt");
        } else {
          inboxReceiptOverlay.classList.remove("is-visible");
          inboxReceiptOverlay.setAttribute("aria-hidden", "true");
          bodyScrollLock.unlock();
        }
      };

      const openReceiptModal = (url) => {
        if (!inboxReceiptOverlay || !inboxReceiptFrame) {
          window.open(url, "_blank", "noopener");
          return;
        }
        inboxReceiptLoading?.classList.remove("hidden");
        inboxReceiptFrame.src = url;
        if (overlayManagerReady) {
          window.OverlayManager.open("inbox-receipt", {
            element: inboxReceiptOverlay,
            backdrop: inboxReceiptOverlay,
            onRequestClose: closeReceiptModal,
            restoreFocus: false,
          });
        } else {
          inboxReceiptOverlay.classList.add("is-visible");
          inboxReceiptOverlay.setAttribute("aria-hidden", "false");
          bodyScrollLock.lock();
        }
      };

      inboxReceiptFrame?.addEventListener("load", () => {
        inboxReceiptLoading?.classList.add("hidden");
      });

      inboxReceiptOverlay?.addEventListener("click", (event) => {
        if (event.target === inboxReceiptOverlay) {
          closeReceiptModal();
        }
      });
      inboxReceiptClose?.addEventListener("click", closeReceiptModal);

      const hydrateMessageContent = () => {
        if (!inboxMessageContent) return;
        inboxMessageContent.querySelectorAll("[data-inbox-receipt-link]").forEach((link) => {
          link.addEventListener("click", (event) => {
            event.preventDefault();
            openReceiptModal(link.getAttribute("href"));
          });
        });
        const panel = inboxMessageContent.querySelector(".inbox-message-panel");
        if (panel && panel.dataset.messageId) {
          setInboxCardReadState(panel.dataset.messageId, true);
        }
        const deleteBtn = inboxMessageContent.querySelector("[data-inbox-delete]");
        if (deleteBtn && panel && panel.dataset.messageId) {
          deleteBtn.addEventListener("click", async () => {
            const messageId = panel.dataset.messageId;
            const confirmed = window.confirm("Delete this message? This cannot be undone.");
            if (!confirmed) return;
            try {
              const resp = await fetch("/api/inbox/bulk", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "delete", message_ids: [messageId] }),
              });
              const data = await resp.json();
              if (!data.success) {
                alert(data.error || "Unable to delete this message right now.");
                return;
              }
              const result = (data.results || []).find((r) => r.id === messageId);
              if (!result || !result.success) {
                alert("Unable to delete this message right now.");
                return;
              }
              removeInboxCard(messageId);
              closeInboxMessage();
              if (!document.querySelector(".mail-card") && !document.querySelector("[data-empty-state][hidden=false]")) {
                document.querySelectorAll("[data-empty-state]").forEach((empty) => (empty.hidden = false));
              }
              if (!inboxMessageOverlay) {
                window.location.href = "/inbox";
              }
            } catch (err) {
              console.error("Delete inbox message failed", err);
              alert("Unable to delete this message right now.");
            }
          });
        }
      };

      const loadInboxMessageContent = async (url) => {
        if (!inboxMessageContent) return;
        inboxMessageContent.innerHTML = "<div class='inbox-panel__loading'>Loading message</div>";
        try {
          const resp = await fetch(ensurePanelParam(url), {
            headers: { "X-Requested-With": "fetch" }
          });
          if (resp.redirected) {
            window.location.href = resp.url;
            return;
          }
          if (!resp.ok) throw new Error("Message load failed");
          const html = await resp.text();
          inboxMessageContent.innerHTML = html;
          hydrateMessageContent();
        } catch (err) {
          inboxMessageContent.innerHTML = "<div class='inbox-panel__error'>Unable to load that message.</div>";
        }
      };

      const openInboxMessage = (url) => {
        if (!inboxMessageOverlay) {
          window.location.href = url;
          return;
        }
        inboxMessageLastFocus = document.activeElement;
        if (overlayManagerReady) {
          window.OverlayManager.open("inbox-message", {
            element: inboxMessageOverlay,
            backdrop: inboxMessageOverlay,
            onRequestClose: closeInboxMessage,
            focusTarget: inboxMessageLastFocus,
            restoreFocus: false,
          });
        } else {
          inboxMessageOverlay.classList.add("is-visible");
          inboxMessageOverlay.setAttribute("aria-hidden", "false");
          bodyScrollLock.lock();
        }
        loadInboxMessageContent(url);
      };

      const closeInboxMessage = () => {
        if (!inboxMessageOverlay) return;
        if (overlayManagerReady) {
          window.OverlayManager.close("inbox-message");
        } else {
          inboxMessageOverlay.classList.remove("is-visible");
          inboxMessageOverlay.setAttribute("aria-hidden", "true");
          bodyScrollLock.unlock();
        }
        if (inboxMessageLastFocus && typeof inboxMessageLastFocus.focus === "function") {
          inboxMessageLastFocus.focus({ preventScroll: true });
        }
      };

      if (overlayManagerReady) {
        window.OverlayManager.register("inbox-message", {
          element: inboxMessageOverlay,
          backdrop: inboxMessageOverlay,
          onRequestClose: closeInboxMessage,
          restoreFocus: false,
        });
        window.OverlayManager.register("inbox-receipt", {
          element: inboxReceiptOverlay,
          backdrop: inboxReceiptOverlay,
          onRequestClose: closeReceiptModal,
          restoreFocus: false,
        });
      }

      inboxMessageOverlay?.addEventListener("click", (event) => {
        if (event.target === inboxMessageOverlay) {
          closeInboxMessage();
        }
      });
      inboxMessageClose?.addEventListener("click", closeInboxMessage);

      window.RDAB.openInboxMessage = openInboxMessage;
      window.RDAB.closeInboxMessage = closeInboxMessage;
      window.RDAB.openReceiptModal = openReceiptModal;
      window.RDAB.closeReceiptModal = closeReceiptModal;
      document.addEventListener("click", (event) => {
        const receiptLink = event.target.closest("[data-inbox-receipt-link]");
        if (receiptLink) {
          event.preventDefault();
          openReceiptModal(receiptLink.getAttribute("href"));
        }
      });
      document.querySelectorAll(".inbox-message-panel[data-message-id]").forEach((messagePanel) => {
        if (!messagePanel.closest("#inboxMessageOverlay")) {
          setInboxCardReadState(messagePanel.dataset.messageId, true);
        }
      });

      document.addEventListener("click", (event) => {
        const inboxToggle = event.target.closest("[data-inbox-toggle]");
        if (inboxToggle) {
          event.preventDefault();
          event.stopPropagation();
          openInboxPanel("/inbox?panel=1");
          return;
        }
        if (!inboxOverlay) return;
        if (!inboxOverlay.contains(event.target) && event.target !== inboxOverlay) {
          return;
        }
        if (event.target === inboxOverlay) {
          closeInboxPanel();
          return;
        }
        const closeTrigger = event.target.closest("[data-inbox-panel-close]");
        if (closeTrigger) {
          event.preventDefault();
          closeInboxPanel();
          return;
        }
        const link = event.target.closest("[data-inbox-panel-link]");
        if (link) {
          event.preventDefault();
          loadInboxPanel(link.getAttribute("href"));
        }
      });

      document.addEventListener("submit", (event) => {
        const form = event.target.closest("[data-inbox-panel-form]");
        if (!form || !form.closest("#inboxPanelOverlay")) return;
        event.preventDefault();
        const formData = new FormData(form);
        const url = new URL(form.getAttribute("action") || "/inbox", window.location.origin);
        formData.forEach((value, key) => {
          url.searchParams.set(key, value);
        });
        if (!url.searchParams.get("panel")) {
          url.searchParams.set("panel", "1");
        }
        loadInboxPanel(url.pathname + "?" + url.searchParams.toString());
      });

      document.addEventListener("keydown", (event) => {
        if (overlayManagerReady) return;
        if (event.key !== "Escape") return;
        if (inboxReceiptOverlay && inboxReceiptOverlay.classList.contains("is-visible")) {
          event.preventDefault();
          closeReceiptModal();
          return;
        }
        if (inboxMessageOverlay && inboxMessageOverlay.classList.contains("is-visible")) {
          event.preventDefault();
          closeInboxMessage();
          return;
        }
        if (inboxOverlay && inboxOverlay.classList.contains("is-visible")) {
          event.preventDefault();
          closeInboxPanel();
        }
      });
      enhanceInboxPanel(document);

      // Avatar dropdown
      const ab=document.getElementById("avatarToggle");
      const ad=document.getElementById("avatarDropdown");
      if (!ab) warnMissing("avatar toggle");
      if (!ad) warnMissing("avatar dropdown");
      const closeAvatarDropdown=()=>{
        if(!ad){
          warnMissing("avatar dropdown");
          return;
        }
        ad.classList.remove("is-open");
        ad.setAttribute("aria-hidden","true");
      };
      const openAvatarDropdown=()=>{
        if(!ad){
          warnMissing("avatar dropdown");
          return;
        }
        ad.classList.add("is-open");
        ad.setAttribute("aria-hidden","false");
      };
      document.addEventListener("click",(e)=>{
        const toggle=e.target.closest("#avatarToggle");
        const insideDropdown=ad && ad.contains(e.target);
        if(toggle){
          e.preventDefault();
          if(ad && ad.classList.contains("is-open")) closeAvatarDropdown();
          else openAvatarDropdown();
          return;
        }
        if(ad && !insideDropdown){
          closeAvatarDropdown();
        }
      });
      if(ad){
        ad.addEventListener("click",(e)=>e.stopPropagation());
      }
      window.closeAvatarDropdown=closeAvatarDropdown;
      window.openAvatarDropdown=openAvatarDropdown;
      document.addEventListener("click",(event)=>{
        const navProfileButton=event.target.closest("[data-nav-view-profile]");
        if(!navProfileButton) return;
        event.preventDefault();
        closeAvatarDropdown();
        const username=(navProfileButton.getAttribute("data-nav-profile-username") || CURRENT_TRAINER_USERNAME || "").trim();
        if(!username || !window.TrainerProfilePopover || typeof window.TrainerProfilePopover.open!=="function"){
          return;
        }
        const displayName=navProfileButton.textContent.trim() || username;
        window.TrainerProfilePopover.open({
          username,
          url: `/api/trainers/${encodeURIComponent(username)}/profile`,
          displayName,
          editable:true,
        });
      });

      document.querySelectorAll('[data-modal-open="manage-account"]').forEach((btn)=>{
        btn.addEventListener('click', closeAvatarDropdown);
      });

      const logoutLink=document.querySelector('[data-confirm-logout]');
      if(logoutLink){
        logoutLink.addEventListener('click',(e)=>{
          const confirmLogout=window.confirm('Log out and end your session?');
          if(!confirmLogout){
            e.preventDefault();
            closeAvatarDropdown();
            return;
          }
          closeAvatarDropdown();
        });
      }

      const CURRENT_TRAINER_USERNAME = {{ (_current_trainer_username or '')|lower|tojson }};
      const DEFAULT_TRAINER_AVATAR = "{{ url_for('static', filename='avatars/avatar1.png') }}";

      
      const trainerProfileModule = (()=>{
        const overlay=document.querySelector("[data-trainer-profile]");
        if(!overlay) return null;
        const loadingEl=overlay.querySelector("[data-trainer-profile-loading]");
        const errorEl=overlay.querySelector("[data-trainer-profile-error]");
        const cardEl=overlay.querySelector("[data-trainer-profile-card]");
        const heroEl=overlay.querySelector("[data-trainer-profile-hero]");
        const avatarEl=overlay.querySelector("[data-trainer-profile-avatar]");
        const nameEl=overlay.querySelector("[data-trainer-profile-name]");
        const accountEl=overlay.querySelector("[data-trainer-profile-account]");
        const campfireEl=overlay.querySelector("[data-trainer-profile-campfire]");
        const stampsEl=overlay.querySelector("[data-trainer-profile-stamps]");
        const codeEl=overlay.querySelector("[data-trainer-profile-code]");
        const copyBtn=overlay.querySelector("[data-trainer-profile-copy]");
        const levelValueEl=overlay.querySelector("[data-trainer-profile-level-value]");
        const teamValueEl=overlay.querySelector("[data-trainer-profile-team-value]");
        const levelRow=overlay.querySelector("[data-trainer-profile-level-row]");
        const teamRow=overlay.querySelector("[data-trainer-profile-team-row]");
        const joinedEl=overlay.querySelector("[data-trainer-profile-joined]");
        const meetupsEl=overlay.querySelector("[data-trainer-profile-meetups]");
        const featuredContainer=overlay.querySelector("[data-trainer-profile-featured]");
        const featuredList=overlay.querySelector("[data-trainer-profile-featured-list]");
        const featuredEmpty=overlay.querySelector("[data-trainer-profile-featured-empty]");
        const copyToast=overlay.querySelector("[data-trainer-profile-copy-toast]");
        const bodyLock=window.__overlayLock || {lock(){},unlock(){}};
        const cache={};
        const state={
          username:"",
          profileUrl:null,
          displayName:"Trainer"
        };
        let closeTimer=null;
        let copyToastTimer=null;

        const escapeHtml=(value)=>{
          return (value || "").replace(/[&<>"']/g,(char)=>{
            switch(char){
              case "&": return "&amp;";
              case "<": return "&lt;";
              case ">": return "&gt;";
              case '"': return "&quot;";
              case "'": return "&#039;";
              default: return char;
            }
          });
        };

        const formatDate=(value)=>{
          if(!value) return "DD/MM/YY";
          try{
            const date=new Date(value);
            return date.toLocaleDateString(undefined,{ day:"2-digit", month:"2-digit", year:"2-digit" });
          }catch(err){
            return value;
          }
        };

        const formatCounter=(value)=>{
          if(typeof value==="number"){
            return value.toString().padStart(4,"0");
          }
          if(!value) return "0000";
          return String(value).padStart(4,"0");
        };

        const formatTrainerCode=(value)=>{
          const digits=(value || "").replace(/[^0-9]/g,"");
          if(!digits){
            return "0000 0000 0000";
          }
          const parts=[];
          for(let i=0;i<digits.length;i+=4){
            parts.push(digits.slice(i,i+4));
          }
          return parts.join(" ").trim();
        };

        const setHeroBackground=(url)=>{
          if(!heroEl) return;
          if(url){
            heroEl.style.backgroundImage=`linear-gradient(180deg,rgba(7,11,30,0.2),rgba(5,9,24,0.75)), url('${url}')`;
            heroEl.style.backgroundSize="cover";
            heroEl.style.backgroundPosition="center";
          }else{
            heroEl.style.backgroundImage="linear-gradient(140deg,#5c0b1c,#9d0d37 55%,#c81e1e)";
          }
        };

        const renderTeam=(info)=>{
          if(!teamValueEl){
            return;
          }
          if(!info){
            teamValueEl.innerHTML="";
            if(teamRow) teamRow.hidden=true;
            return;
          }
          const icon=info.icon ? `<img src="${escapeHtml(info.icon)}" alt="${escapeHtml(info.label || "Team icon")}" />` : "";
          const label=escapeHtml(info.label || "Team");
          teamValueEl.innerHTML = icon ? `${icon}<strong>${label}</strong>` : `<strong>${label}</strong>`;
          if(teamRow) teamRow.hidden=false;
        };

        const renderLevel=(levelValue)=>{
          if(!levelValueEl){
            return;
          }
          if(levelValue === undefined || levelValue === null){
            levelValueEl.textContent="--";
            if(levelRow) levelRow.hidden=true;
            return;
          }
          levelValueEl.textContent=String(levelValue).padStart(2,"0");
          if(levelRow) levelRow.hidden=false;
        };

        const renderFeatured=(items)=>{
          if(!featuredList) return;
          const stamps=Array.isArray(items) ? items.slice(0,3) : [];
          if(!stamps.length){
            featuredList.innerHTML="";
            if(featuredContainer) featuredContainer.hidden=true;
            if(featuredEmpty) featuredEmpty.hidden=false;
            return;
          }
          const html=stamps.map((stamp,idx)=>{
            const label=escapeHtml(stamp.label || `Featured stamp ${idx+1}`);
            const icon=stamp.icon ? `<img src="${escapeHtml(stamp.icon)}" alt="${label}">` : "";
            return `<div class="trainer-profile-featured-item">${icon || `<span>${label}</span>`}${icon ? `<span>${label}</span>` : ""}</div>`;
          });
          featuredList.innerHTML=html.join("");
          if(featuredContainer) featuredContainer.hidden=false;
          if(featuredEmpty) featuredEmpty.hidden=true;
        };

        const showCopyToast=(message)=>{
          if(!copyToast) return;
          copyToast.textContent=message;
          copyToast.hidden=false;
          copyToast.classList.add("is-visible");
          if(copyToastTimer) clearTimeout(copyToastTimer);
          copyToastTimer=setTimeout(()=>{
            copyToast.classList.remove("is-visible");
            copyToast.hidden=true;
          },2600);
        };

        const setTrainerCode=(rawValue, displayName)=>{
          const formatted=formatTrainerCode(rawValue);
          if(codeEl){
            codeEl.textContent=formatted;
          }
          if(copyBtn){
            const normalized=(rawValue || "").replace(/[^0-9]/g,"");
            copyBtn.disabled=!normalized;
            copyBtn.dataset.codeRaw=normalized;
            copyBtn.dataset.codeFormatted=formatted;
            copyBtn.dataset.copyName=displayName || state.displayName || "Trainer";
          }
          if(copyToast){
            copyToast.hidden=true;
            copyToast.classList.remove("is-visible");
          }
        };

        const setView=(mode,message)=>{
          if(loadingEl) loadingEl.hidden = mode!=="loading";
          if(cardEl) cardEl.hidden = mode!=="ready";
          if(errorEl){
            errorEl.hidden = mode!=="error";
            if(mode==="error"){
              errorEl.textContent = message || "Unable to load trainer profile right now.";
            }
          }
        };

        const hydrateProfile=(data,fallbackName)=>{
          const displayName = data && data.username ? data.username : (fallbackName || "Trainer");
          state.displayName=displayName;
          if(nameEl) nameEl.textContent = displayName;
          if(accountEl){
            const accountLabel = data && data.account_type ? data.account_type : "Trainer Account";
            accountEl.textContent = accountLabel;
          }
          if(avatarEl){
            avatarEl.src = data && data.avatar_url ? data.avatar_url : DEFAULT_TRAINER_AVATAR;
            avatarEl.alt = `${displayName} avatar`;
          }
          setHeroBackground(data && data.background_url);
          if(campfireEl){
            const campfire=(data && data.campfire_username) ? `@${data.campfire_username.replace(/^@/,"")}` : "";
            campfireEl.textContent = campfire;
          }
          if(stampsEl){
            const stampValue = data && typeof data.stamps !== "undefined" ? data.stamps : 0;
            stampsEl.textContent = typeof stampValue === "number" ? stampValue.toLocaleString() : stampValue;
          }
          setTrainerCode(data && data.trainer_code, displayName);
          renderLevel(data && data.trainer_level);
          renderTeam(data && data.team);
          if(joinedEl){
            joinedEl.textContent = formatDate(data && data.joined_at);
          }
          if(meetupsEl){
            meetupsEl.textContent = formatCounter(data && data.meetups_count);
          }
          renderFeatured(data && data.featured_stamps);
        };

        const open=(options)=>{
          if(!overlay) return;
          const username=(options.username || "").trim();
          state.username=username;
          state.profileUrl=options.url || (username ? `/api/trainers/${encodeURIComponent(username)}/profile` : null);
          state.displayName=options.displayName || username || "Trainer";
          if(copyToast){
            copyToast.hidden=true;
            copyToast.classList.remove("is-visible");
          }
          if (window.OverlayManager) {
            window.OverlayManager.open("trainer-profile", {
              element: overlay,
              backdrop: overlay,
              onRequestClose: close,
              focusTarget: options && options.trigger ? options.trigger : document.activeElement,
            });
          } else {
            overlay.hidden=false;
            requestAnimationFrame(()=>overlay.classList.add("is-visible"));
            bodyLock.lock();
          }
          setView("loading");
          const cacheKey=username.toLowerCase();
          if(cacheKey && cache[cacheKey]){
            hydrateProfile(cache[cacheKey], state.displayName);
            setView("ready");
            return;
          }
          if(!state.profileUrl){
            setView("error","Trainer profile unavailable.");
            return;
          }
          fetch(state.profileUrl)
            .then(resp=>resp.json().then(body=>({ ok:resp.ok, body })))
            .then(({ok,body})=>{
              if(!ok) throw new Error(body && body.error ? body.error : "Unable to load trainer profile.");
              const trainer=body && body.trainer;
              if(!trainer) throw new Error("Trainer profile missing.");
              if(cacheKey) cache[cacheKey]=trainer;
              hydrateProfile(trainer, state.displayName);
              setView("ready");
            })
            .catch(err=>{
              console.warn(err);
              setView("error", err && err.message ? err.message : "Unable to load trainer profile right now.");
            });
        };

        const close=()=>{
          if(!overlay || overlay.hidden) return;
          overlay.classList.remove("is-visible");
          if(closeTimer) clearTimeout(closeTimer);
          closeTimer=setTimeout(()=>{
            overlay.hidden=true;
            setView("loading");
            if (window.OverlayManager) {
              window.OverlayManager.close("trainer-profile");
            } else {
              bodyLock.unlock();
            }
          },220);
        };

        overlay.querySelectorAll("[data-trainer-profile-close]").forEach(btn=>{
          btn.addEventListener("click",(evt)=>{
            evt.preventDefault();
            close();
          });
        });

        document.addEventListener("keydown",(evt)=>{
          if(window.OverlayManager) return;
          if(evt.key==="Escape" && !overlay.hidden){
            close();
          }
        });

        if(copyBtn){
          copyBtn.addEventListener("click",()=>{
            if(copyBtn.disabled) return;
            const rawCode=copyBtn.dataset.codeRaw || "";
            if(!rawCode) return;
            const formatted=copyBtn.dataset.codeFormatted || formatTrainerCode(rawCode);
            const copyName=copyBtn.dataset.copyName || state.displayName || "Trainer";
            const message=`Copied ${copyName}'s trainer code! Open Pokemon GO to add them as a friend!`;
            const clipboardText=rawCode.replace(/\s+/g,"");
            const fallbackCopy=()=>{
              const temp=document.createElement("textarea");
              temp.value=clipboardText;
              temp.setAttribute("readonly","");
              temp.style.position="absolute";
              temp.style.left="-9999px";
              document.body.appendChild(temp);
              temp.select();
              try{
                document.execCommand("copy");
              }catch(err){
                console.warn("Trainer code copy failed:", err);
              }
              document.body.removeChild(temp);
              showCopyToast(message);
            };
            if(navigator.clipboard && typeof navigator.clipboard.writeText==="function"){
              navigator.clipboard.writeText(clipboardText)
                .then(()=>showCopyToast(message))
                .catch(()=>fallbackCopy());
            }else{
              fallbackCopy();
            }
          });
        }

        if (window.OverlayManager) {
          window.OverlayManager.register("trainer-profile", {
            element: overlay,
            backdrop: overlay,
            onRequestClose: close,
          });
        }

        return { open, close };
      })();

      window.TrainerProfilePopover=trainerProfileModule;

      document.addEventListener("click",(event)=>{
        const trigger=event.target.closest("[data-trainer-profile-trigger]");
        if(!trigger || !window.TrainerProfilePopover || typeof window.TrainerProfilePopover.open!=="function"){
          return;
        }
        event.preventDefault();
        let username=(trigger.getAttribute("data-trainer-profile-username") || "").trim();
        if(!username){
          username=(trigger.getAttribute("data-trainer-username") || "").trim();
        }
        const providedUrl=trigger.getAttribute("data-trainer-profile-url");
        const displayName=trigger.getAttribute("data-trainer-display") || trigger.textContent || username || "Trainer";
        const profileUrl=providedUrl || (username ? `/api/trainers/${encodeURIComponent(username)}/profile` : null);
        const editable=trigger.hasAttribute("data-trainer-profile-own");
        if(trigger.hasAttribute("data-close-avatar") && typeof window.closeAvatarDropdown==="function"){
          window.closeAvatarDropdown();
        }
        window.TrainerProfilePopover.open({
          username,
          url: profileUrl,
          displayName,
          editable,
        });
      });
    });

    window.togglePin=function togglePin(id,btn){
      const input=document.getElementById(id);
      if(!input) return;
      if(input.type==="password"){ input.type="text"; btn.textContent="Hide"; }
      else{ input.type="password"; btn.textContent="Show"; }
    };
    })();
  </script>
</head>
<body>
  <!-- Header -->
  <header class="site-header" data-skip-global-loader>
    <div class="header-left">
      <div class="logo"></div>
      {% if header_back_action %}
        <a href="{{ header_back_action.href }}"
           class="nav-back-btn"
           {% if header_back_action.external %}target="_blank" rel="noopener"{% endif %}>
          <span class="nav-back-icon"></span>
          <span class="nav-back-label">{{ header_back_action.label or "Back" }}</span>
        </a>
      {% endif %}
    </div>

    <nav class="nav-icons">
      {% if session.get('trainer') %}
        <!-- Dashboard -->
        <a href="{{ url_for('dashboard') }}" class="nav-item" title="Home / Dashboard">
          <img src="{{ url_for('static', filename='nav/pikachu-card.png') }}"
               alt="Home"
               class="nav-icon"
               decoding="async"
               fetchpriority="high"
               data-fallback-src="{{ url_for('static', filename='logo.png') }}">
        </a>

        <!-- Passport -->
        <a href="{{ url_for('passport') }}" class="stamp-container" title="Passport">
          <img src="{{ url_for('static', filename='nav/stamp-icon.png') }}"
               alt="Passport"
               decoding="async"
               fetchpriority="high"
               data-fallback-src="{{ url_for('static', filename='nav/stamp-icon.png') }}">
          <span class="stamp-count">{{ current_stamps or 0 }}</span>
        </a>

        <!-- Inbox -->
        <div class="inbox-wrapper" style="position:relative;">
          <button type="button" class="nav-item" id="inboxToggle" data-inbox-toggle title="Inbox" aria-haspopup="dialog" aria-expanded="false">
            <img src="{{ url_for('static', filename='nav/mail-icon.png') }}"
                 alt="Inbox"
                 class="nav-icon"
                 decoding="async"
                 fetchpriority="high"
                 data-fallback-src="{{ url_for('static', filename='logo.png') }}">
          </button>
          {% if inbox_unread and inbox_unread > 0 %}
            <span class="inbox-badge">{{ inbox_unread }}</span>
          {% endif %}
        </div>

        <!-- Avatar (profile hub) -->
        <div class="avatar-wrapper">
          <button type="button" class="nav-item" id="avatarToggle" title="Account">
            <img src="{{ url_for('static', filename='avatars/' ~ nav_avatar) }}"
                 alt="Avatar"
                 class="nav-icon avatar-icon"
                 decoding="async"
                 fetchpriority="high"
                 data-fallback-src="{{ url_for('static', filename='avatars/avatar1.png') }}">
          </button>
          <div id="avatarDropdown" class="avatar-dropdown" aria-hidden="true">
            <div class="avatar-dropdown__username">{{ nav_username or 'Trainer' }}</div>
            {% if nav_username %}
            <button type="button"
                    data-trainer-profile-trigger
                    data-trainer-profile-own
                    data-trainer-profile-username="{{ nav_username }}"
                    data-trainer-profile-url="{{ url_for('api_public_trainer_profile', username=nav_username) }}"
                    data-close-avatar
                    data-nav-view-profile
                    data-nav-profile-username="{{ nav_username }}">
               View Profile
            </button>
            {% endif %}
            <div class="sep"></div>
            <a href="{{ url_for('change_avatar') }}"> Customise</a>
            <button type="button" data-modal-open="manage-account"> Manage Account</button>
            <div class="sep"></div>
            <a href="{{ url_for('logout') }}" data-confirm-logout> Log Out</a>
          </div>
        </div>
      {% endif %}
    </nav>
    <script>
      (function () {
        const nav = document.querySelector(".nav-icons");
        if (!nav) return;
        const icons = Array.from(nav.querySelectorAll("img"));
        if (!icons.length) return;

        // Warm the cache to reduce intermittent fetch misses on Safari/PWA
        const seen = new Set();
        icons.forEach((img) => {
          const src = img.currentSrc || img.src;
          if (src && !seen.has(src)) {
            seen.add(src);
            const preloadImg = new Image();
            preloadImg.decoding = "async";
            preloadImg.src = src;
          }
        });

        // Retry once with a cache-buster, then fall back to a safe asset
        icons.forEach((img) => {
          const originalSrc = img.currentSrc || img.src;
          const fallbackSrc = img.dataset.fallbackSrc || originalSrc;
          let retried = false;

          img.addEventListener("error", () => {
            if (!retried && originalSrc) {
              retried = true;
              const bust = originalSrc + (originalSrc.includes("?") ? "&" : "?") + "retry=" + Date.now();
              img.src = bust;
              return;
            }
            img.src = fallbackSrc;
          });
        });
      })();
    </script>
  </header>

  {% block page_settings %}{% endblock %}
  {% set container_class = container_class|default('') %}
  {% set _container_classes = ('container ' ~ (container_class|default('')))|trim %}
  <!-- Page content -->
  <div class="{{ _container_classes }}">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}

    {% if show_back %}
      <div style="margin-top:20px; text-align:center;">
        <a href="{{ url_for('dashboard') }}"
           style="display:inline-block; padding:10px 18px; background:var(--brand); color:#fff; border-radius:6px; text-decoration:none; font-weight:600;">
           Back to Dashboard
        </a>
      </div>
    {% endif %}
  </div>

  <!-- GLOBAL Manage Account MODAL (available on ALL pages) -->
  {% if session.get('trainer') %}
  <div id="manageAccountModal" class="modal-backdrop" aria-hidden="true" hidden data-modal-root="manage-account" data-modal-open-class="is-open" data-modal-lock-scroll="true" data-overlay="manage-account" data-overlay-open-class="is-open">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="accountModalTitle">
      <div class="modal-header">
        <h3 id="accountModalTitle"> Manage My Account</h3>
        <button id="closeAccountModal" class="close-btn" aria-label="Close" data-modal-close data-overlay-close></button>
      </div>

      <div class="settings-section">
        <details>
          <summary> Change PIN</summary>
          <div class="settings-body">
            <form action="{{ url_for('change_pin') }}" method="post">
              <input type="password" name="old_pin" placeholder="Old PIN" required>
              <input type="text" name="memorable" placeholder="Memorable Password" required>
              <div class="pin-row">
                <input type="password" name="new_pin" id="modal_new_pin" pattern="\d{4}" maxlength="4" placeholder="New 4-digit PIN" required>
                <button type="button" onclick="togglePin('modal_new_pin', this)">Show</button>
              </div>
              <button type="submit" class="btn-primary">Update PIN</button>
            </form>
          </div>
        </details>

        <details>
          <summary> Change Memorable Password</summary>
          <div class="settings-body">
            <form action="{{ url_for('change_memorable') }}" method="post">
              <input type="text" name="old_memorable" placeholder="Old Memorable" required>
              <input type="text" name="new_memorable" placeholder="New Memorable" required>
              <button type="submit" class="btn-primary">Update Memorable</button>
            </form>
          </div>
        </details>

        <details>
          <summary> Security</summary>
          <div class="settings-body">
            <p class="meta">Account type: {{ 'Standard' if account_type|lower == 'standard' else account_type }}</p>
            <form action="{{ url_for('logout_everywhere') }}" method="post" class="row-actions">
              <button type="submit" class="btn-primary">Log Out Everywhere</button>
            </form>
          </div>
        </details>

        <details>
          <summary> Notifications</summary>
          <div class="settings-body">
            <p class="meta" style="text-align:center;">
              Push notifications will be coming soon.<br>
              For now, check your  <a href="{{ url_for('inbox') }}">Inbox</a> for updates.
            </p>
          </div>
        </details>

        <details>
          <summary> Delete Account</summary>
          <div class="settings-body">
            <p class="meta" style="color:#b00;">
               This will permanently delete your account, including Passport stamps, profile, and prize history.
              <strong>This cannot be undone.</strong>
            </p>
            <form action="{{ url_for('delete_account') }}" method="post">
              <input type="text" name="confirm_name" placeholder="Type your trainer name to confirm" required>
              <button type="submit" class="btn-danger">Delete My Account</button>
            </form>
          </div>
        </details>
      </div>

      <div class="modal-disclaimer">
        <p>
          This is a programme run entirely by volunteers from the Raiding Doncaster and Beyond Campfire group and is in no way affiliated with
          The Pokmon Company or Niantic. All competitions, giveaways, prize draws, passports and prize redemption are entirely free and there are no monetary gains.
          For support, please contact the RDAB admin team via the Niantic Campfire app.
        </p>
        <a class="policy-btn" href="{{ url_for('policies_index') }}"> View community policies</a>
      </div>
    </div>
  </div>
  {% endif %}

  {% include "partials/trainer_profile_popover.html" %}

  <div class="content-filter-modal" data-content-filter-modal hidden data-modal-root="content-filter" data-modal-open-class="is-open" data-modal-body-class="modal-open" data-overlay="content-filter" data-overlay-open-class="is-open">
    <div class="content-filter-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="contentFilterTitle">
      <div class="content-filter-modal__halo"></div>
      <div class="content-filter-modal__body">
        <div class="content-filter-modal__icon"></div>
        <h3 class="content-filter-modal__title" id="contentFilterTitle">Hold up, Trainer!</h3>
        <p class="content-filter-modal__subtitle">We stopped this phrase to keep the community safe:</p>
        <div class="content-filter-modal__match">
          <span data-filter-severity>critical</span>
          <strong data-filter-match>phrase</strong>
        </div>
        <p class="content-filter-modal__message">
          Read the
          <a href="{{ url_for('policy_page', slug='community-standards') }}"
             target="_blank" rel="noopener">Community Standards</a> 
          our Community Code of Conduct, also known as Arceus Law. Remember
          inappropriate behaviour and language is not tolerated anywhere in RDAB.
        </p>
        <div class="content-filter-modal__actions">
          <button type="button"
                  class="content-filter-modal__close"
                  data-content-filter-dismiss
                  data-overlay-close
                  data-modal-close>
            Ok, I understand
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Service Worker (single canonical URL) -->
  <script>
  (function () {
    if (!('serviceWorker' in navigator)) return;
    const SW_URL = '/service-worker.js?v=TEMP_DISABLE';
    navigator.serviceWorker.register(SW_URL, { scope: '/' })
      .then(reg => reg.update())
      .then(() => navigator.serviceWorker.ready)
      .then(() => {
        console.log(' Service Worker ready');
        document.dispatchEvent(new CustomEvent('rdab-sw-ready'));
      })
      .catch(err => console.error(' SW failed:', err));
  })();
  </script>

  {% if account_type == "Admin" %}
  {% set admin_gate_locked = admin_gate_enabled and not admin_gate_verified %}
  <button
    type="button"
    id="admin-fab"
    class="admin-fab"
    title="Admin shortcuts"
    aria-label="Open admin shortcuts"
    aria-expanded="false"
    aria-controls="admin-quick-menu"
  ></button>
  <div id="admin-quick-menu-overlay" class="admin-quick-menu-overlay" hidden data-overlay-close></div>
  <div
    id="admin-quick-menu"
    class="admin-quick-menu{% if admin_gate_locked %} admin-quick-menu--locked{% endif %}"
    data-overlay="admin-quick"
    data-overlay-backdrop="#admin-quick-menu-overlay"
    data-overlay-focus="#admin-fab"
    data-gate-enabled="{{ 'true' if admin_gate_enabled else 'false' }}"
    data-gate-verified="{{ 'true' if admin_gate_verified else 'false' }}"
    role="dialog"
    aria-modal="true"
    aria-label="Admin quick access"
    aria-hidden="true"
    tabindex="-1"
  >
    <div class="admin-quick-menu__header">
      <div>
        <p class="admin-quick-menu__eyebrow">Admin Tools</p>
        <h3>Quick Access</h3>
      </div>
      <button type="button" id="admin-quick-menu-close" class="admin-quick-menu__close" aria-label="Close admin shortcuts" data-overlay-close></button>
    </div>
    <div
      id="admin-quick-menu-gate"
      class="admin-quick-menu__gate"
      {% if not admin_gate_locked %}hidden{% endif %}
    >
      <p id="admin-quick-menu-gate-message" class="admin-quick-menu__gate-message">
        Enter the admin password to unlock your shortcuts.
      </p>
      <form id="admin-quick-menu-gate-form" class="admin-quick-menu__gate-form" autocomplete="off">
        <label class="admin-quick-menu__gate-label" for="admin-quick-password">Admin password</label>
        <div class="admin-quick-menu__gate-input">
          <input
            id="admin-quick-password"
            name="admin_password"
            type="password"
            inputmode="text"
            autocomplete="off"
            placeholder="Enter admin password"
            required
          >
          <button type="submit" class="admin-quick-menu__gate-button">Unlock</button>
        </div>
      </form>
      <p
        id="admin-quick-menu-gate-status"
        class="admin-quick-menu__gate-status"
        role="status"
        aria-live="polite"
      ></p>
    </div>
    <div class="admin-quick-menu__actions" aria-hidden="{{ 'true' if admin_gate_locked else 'false' }}">
      <a href="{{ url_for('admin_dashboard') }}" class="admin-quick-menu__action">
        <span class="admin-quick-menu__icon"></span>
        <span class="admin-quick-menu__label">Admin Dashboard</span>
      </a>
      <a href="{{ url_for('admin_trainers') }}" class="admin-quick-menu__action">
        <span class="admin-quick-menu__icon"></span>
        <span class="admin-quick-menu__label">Trainer Manager</span>
      </a>
      <a href="{{ url_for('admin_bulletin') }}" class="admin-quick-menu__action">
        <span class="admin-quick-menu__icon"></span>
        <span class="admin-quick-menu__label">Community Bulletin</span>
      </a>
      <a href="{{ url_for('admin_redemptions') }}" class="admin-quick-menu__action">
        <span class="admin-quick-menu__icon"></span>
        <span class="admin-quick-menu__label">Redemptions Manager</span>
      </a>
      <a href="{{ url_for('admin_rdab_support') }}" class="admin-quick-menu__action">
        <span class="admin-quick-menu__icon"></span>
        <span class="admin-quick-menu__label">RDAB Support</span>
      </a>
    </div>
  </div>
  <style>
    .admin-fab {
      position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
      background: var(--brand); color: #fff; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.6em; border: none; cursor: pointer;
      box-shadow: 0 8px 18px rgba(58,141,222,0.4);
      z-index: calc(var(--z-overlay) - 50); transition: transform 0.2s ease, background 0.2s ease;
    }
    .admin-fab * { pointer-events: none; }
    .admin-fab:focus-visible { outline: 3px solid rgba(255,255,255,0.9); outline-offset: 3px; }
    .admin-fab:hover,
    .admin-fab:active {
      background: #2f73bb;
      transform: scale(1.08);
    }
    .admin-quick-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.5);
      z-index: var(--z-overlay);
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    .admin-quick-menu-overlay.is-visible {
      opacity: 1;
    }
    .admin-quick-menu {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 24px clamp(20px, 6vw, 40px) calc(24px + env(safe-area-inset-bottom));
      background: #fff;
      border-radius: 24px 24px 0 0;
      box-shadow: 0 -20px 45px rgba(15,23,42,0.25);
      transform: translateY(110%);
      transition: transform 0.28s ease;
      z-index: var(--z-dialog);
      min-height: clamp(260px, 50vh, 420px);
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
    }
    .admin-quick-menu.is-visible {
      transform: translateY(0);
    }
    .admin-quick-menu__header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .admin-quick-menu__eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.28em;
      font-size: 0.72rem;
      margin: 0;
      color: #94a3b8;
    }
    .admin-quick-menu__header h3 {
      margin: 4px 0 0;
    }
    .admin-quick-menu__close {
      border: none;
      background: rgba(15,23,42,0.05);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .admin-quick-menu__close:hover,
    .admin-quick-menu__close:focus-visible {
      background: rgba(15,23,42,0.1);
      outline: none;
    }
    .admin-quick-menu__actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    .admin-quick-menu--locked .admin-quick-menu__actions {
      opacity: 0.35;
      pointer-events: none;
      filter: grayscale(0.1);
    }
    .admin-quick-menu__gate {
      border: 1px dashed rgba(148,163,184,0.9);
      border-radius: 18px;
      padding: 16px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .admin-quick-menu__gate-message {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: #0f172a;
    }
    .admin-quick-menu__gate-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .admin-quick-menu__gate-label {
      font-size: 0.78rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 2px;
      color: #475569;
    }
    .admin-quick-menu__gate-input {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }
    .admin-quick-menu__gate-input input {
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,0.2);
      padding: 10px 12px;
      font-size: 1rem;
      font-family: inherit;
    }
    .admin-quick-menu__gate-button {
      border: none;
      background: var(--brand);
      color: #fff;
      border-radius: 12px;
      padding: 0 18px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .admin-quick-menu__gate-button:hover:not(:disabled) {
      background: #2f73bb;
    }
    .admin-quick-menu__gate-button:disabled {
      opacity: 0.6;
      cursor: wait;
    }
    .admin-quick-menu__gate-form.is-busy .admin-quick-menu__gate-button {
      opacity: 0.6;
      cursor: wait;
    }
    .admin-quick-menu__gate-status {
      min-height: 1.2em;
      margin: 0;
      font-size: 0.85rem;
      color: #0f172a;
    }
    .admin-quick-menu__gate-status.is-error {
      color: #b91c1c;
    }
    .admin-quick-menu__gate-status.is-success {
      color: #15803d;
    }
    .admin-quick-menu__action {
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      text-decoration: none;
      color: #0f172a;
      font-weight: 600;
      background: linear-gradient(145deg, #fff, #f8fafc);
      box-shadow: 0 12px 20px rgba(15,23,42,0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .admin-quick-menu__action:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 28px rgba(15,23,42,0.15);
    }
    .admin-quick-menu__icon {
      font-size: 1.6rem;
      line-height: 1;
    }
    .admin-quick-menu__label {
      font-size: 0.95rem;
    }
    @media(min-width: 840px) {
      .admin-quick-menu {
        left: 50%;
        width: min(520px, 90vw);
        transform: translate(-50%, 110%);
        border-radius: 28px;
      }
      .admin-quick-menu.is-visible {
        transform: translate(-50%, 0);
      }
    }
  </style>

  <script>
    (function () {
      const fab = document.getElementById("admin-fab");
      const sheet = document.getElementById("admin-quick-menu");
      const overlay = document.getElementById("admin-quick-menu-overlay");
      const closeBtn = document.getElementById("admin-quick-menu-close");
      if (!fab) console.warn("[Overlay] Missing admin fab");
      if (!sheet) console.warn("[Overlay] Missing admin quick menu sheet");
      if (!overlay) console.warn("[Overlay] Missing admin quick menu overlay");
      if (!fab || !sheet || !overlay) return;

      const actions = sheet.querySelector(".admin-quick-menu__actions");
      const gateSection = document.getElementById("admin-quick-menu-gate");
      const gateForm = document.getElementById("admin-quick-menu-gate-form");
      const gateInput = document.getElementById("admin-quick-password");
      const gateStatus = document.getElementById("admin-quick-menu-gate-status");
      const gateEnabled = sheet.dataset.gateEnabled === "true";
      let gateVerified = sheet.dataset.gateVerified === "true";
      let gateStatusCache = null;
      let gateStatusLoading = false;
      let gateUnlockLoading = false;

      const setLockedState = (locked) => {
        sheet.classList.toggle("admin-quick-menu--locked", locked);
        if (actions) {
          actions.setAttribute("aria-hidden", locked ? "true" : "false");
        }
        if (gateSection) {
          gateSection.hidden = !locked;
        }
      };

      setLockedState(gateEnabled && !gateVerified);

      const updateGateStatusText = (status, options) => {
        if (!gateStatus) return;
        const opts = options || {};
        gateStatus.classList.remove("is-error", "is-success");
        if (opts.message) {
          gateStatus.textContent = opts.message;
          if (opts.variant === "error") {
            gateStatus.classList.add("is-error");
          } else if (opts.variant === "success") {
            gateStatus.classList.add("is-success");
          }
          return;
        }
        if (!status || !gateEnabled) {
          gateStatus.textContent = "";
          return;
        }
        if (status.locked && typeof status.lockout_seconds === "number") {
          const seconds = Math.max(parseInt(status.lockout_seconds, 10) || 0, 1);
          gateStatus.textContent = `Locked. Try again in ${seconds}s.`;
          gateStatus.classList.add("is-error");
          return;
        }
        if (typeof status.remaining_attempts === "number") {
          const attempts = status.remaining_attempts;
          const word = attempts === 1 ? "attempt" : "attempts";
          gateStatus.textContent = `${attempts} ${word} remaining.`;
          return;
        }
        gateStatus.textContent = "";
      };

      const applyGateStatus = (status) => {
        if (!gateEnabled) {
          gateVerified = true;
          setLockedState(false);
          updateGateStatusText(null);
          return;
        }
        if (status) {
          gateVerified = Boolean(status.verified);
          gateStatusCache = status;
        }
        setLockedState(gateEnabled && !gateVerified);
        updateGateStatusText(status || gateStatusCache || null);
      };

      const ensureGateStatus = async () => {
        if (!gateEnabled || gateVerified) {
          return gateStatusCache;
        }
        if (gateStatusLoading) {
          return gateStatusCache;
        }
        gateStatusLoading = true;
        if (gateStatus && !gateStatus.textContent) {
          updateGateStatusText(null, { message: "Checking admin lock..." });
        }
        try {
          const response = await fetch("/admin/gate/status", {
            method: "GET",
            headers: { "Accept": "application/json" },
            credentials: "same-origin",
          });
          if (!response.ok) {
            let message = "Unable to check admin lock.";
            if (response.status === 401) {
              message = "Session expired. Please log in again.";
            } else if (response.status === 403) {
              message = "Admin access required.";
            }
            updateGateStatusText(null, { message, variant: "error" });
            return null;
          }
          const status = await response.json();
          applyGateStatus(status);
          return status;
        } catch (err) {
          updateGateStatusText(null, { message: "Unable to check admin lock.", variant: "error" });
          return null;
        } finally {
          gateStatusLoading = false;
        }
      };

      if (gateForm && gateEnabled) {
        gateForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (gateUnlockLoading) {
            return;
          }
          const password = (gateInput && gateInput.value || "").trim();
          if (!password) {
            updateGateStatusText(null, { message: "Enter the admin password.", variant: "error" });
            if (gateInput) {
              gateInput.focus();
            }
            return;
          }
          gateUnlockLoading = true;
          gateForm.classList.add("is-busy");
          updateGateStatusText(null, { message: "Verifying..." });
          try {
            const response = await fetch("/admin/gate/unlock", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Accept": "application/json",
              },
              credentials: "same-origin",
              body: JSON.stringify({ admin_password: password }),
            });
            const payload = await response.json().catch(() => ({}));
            if (!response.ok || !payload.success) {
              const status = payload.status || gateStatusCache;
              if (status) {
                applyGateStatus(status);
              }
              updateGateStatusText(status, {
                message: payload.message || "Unable to unlock admin tools.",
                variant: "error",
              });
              return;
            }
            applyGateStatus(payload.status || null);
            updateGateStatusText(payload.status || null, { message: "Admin tools unlocked.", variant: "success" });
            if (gateInput) {
              gateInput.value = "";
            }
            if (actions) {
              const firstAction = actions.querySelector("a, button");
              if (firstAction) {
                window.setTimeout(() => firstAction.focus({ preventScroll: true }), 30);
              }
            }
          } catch (err) {
            updateGateStatusText(null, { message: "Unable to unlock admin tools.", variant: "error" });
          } finally {
            gateUnlockLoading = false;
            gateForm.classList.remove("is-busy");
          }
        });
      }

      const openSheet = () => {
        if (sheet.classList.contains("is-visible")) return;
        if (window.OverlayManager) {
          window.OverlayManager.register("admin-quick", {
            element: sheet,
            backdrop: overlay,
            focusTarget: fab,
            restoreFocus: false,
            onRequestClose: closeSheet,
          });
          window.OverlayManager.open("admin-quick");
        } else {
          overlay.hidden = false;
          requestAnimationFrame(() => overlay.classList.add("is-visible"));
          sheet.classList.add("is-visible");
          sheet.setAttribute("aria-hidden", "false");
          fab.setAttribute("aria-expanded", "true");
        }

        if (gateEnabled && !gateVerified) {
          if (gateInput) {
            gateInput.focus({ preventScroll: true });
          } else {
            sheet.focus({ preventScroll: true });
          }
          ensureGateStatus();
        } else {
          const focusTarget = sheet.querySelector("a, button:not(#admin-fab)");
          if (focusTarget) {
            focusTarget.focus({ preventScroll: true });
          } else {
            sheet.focus({ preventScroll: true });
          }
        }
      };

      const closeSheet = () => {
        if (!sheet.classList.contains("is-visible")) return;
        if (window.OverlayManager) {
          window.OverlayManager.close("admin-quick");
        } else {
          sheet.classList.remove("is-visible");
          sheet.setAttribute("aria-hidden", "true");
          fab.setAttribute("aria-expanded", "false");
          overlay.classList.remove("is-visible");
          overlay.hidden = true;
        }
        fab.focus({ preventScroll: true });
      };

      if (window.OverlayManager) {
        window.OverlayManager.register("admin-quick", {
          element: sheet,
          backdrop: overlay,
          onRequestClose: closeSheet,
          focusTarget: fab,
          restoreFocus: false,
        });
      }

      const toggleSheet = () => {
        if (sheet.classList.contains("is-visible")) {
          closeSheet();
        } else {
          openSheet();
        }
      };

      document.addEventListener("click", (event) => {
        if (event.target.closest("#admin-fab")) {
          event.preventDefault();
          toggleSheet();
          return;
        }
        if (overlay && event.target === overlay) {
          closeSheet();
          return;
        }
        if (closeBtn && event.target.closest("#admin-quick-menu-close")) {
          closeSheet();
        }
      });
    })();
  </script>

  <div id="inboxPanelOverlay" class="inbox-panel-overlay" aria-hidden="true" data-overlay="inbox-panel">
    <div class="inbox-panel-dialog" role="dialog" aria-modal="true" aria-label="Trainer inbox panel">
      <div id="inboxPanelContent" class="inbox-panel-dialog__body" tabindex="-1">
        <div class="inbox-panel__loading">Loading inbox</div>
      </div>
    </div>
  </div>

  <div id="inboxMessageOverlay" class="inbox-message-overlay" aria-hidden="true" data-overlay="inbox-message">
    <div class="inbox-message-dialog" role="dialog" aria-modal="true" aria-label="Inbox message" tabindex="-1">
      <button type="button" class="inbox-message-close" data-inbox-message-close data-overlay-close aria-label="Close message"></button>
      <div id="inboxMessageContent">
        <div class="inbox-panel__loading">Loading message</div>
      </div>
    </div>
  </div>

  <div id="inboxReceiptOverlay" class="inbox-receipt-overlay" aria-hidden="true" data-overlay="inbox-receipt">
    <div class="inbox-receipt-dialog" role="dialog" aria-modal="true" aria-label="Receipt details">
      <button type="button" class="inbox-receipt-close" data-inbox-receipt-close data-overlay-close aria-label="Close receipt"></button>
      <div class="inbox-panel__loading" data-inbox-receipt-loading>Loading receipt</div>
      <iframe id="inboxReceiptFrame" title="Receipt preview" loading="lazy"></iframe>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/modal-hub.js') }}"></script>
  <!-- === RDAB Session Memory === -->
<script>
  // Save last page before navigating away
  window.addEventListener('beforeunload', () => {
    const path = window.location.pathname;
    if (!['/login', '/', '/logout'].includes(path)) {
      localStorage.setItem('lastPage', path);
    }
  });

  // When the app loads (PWA or browser)
  document.addEventListener('DOMContentLoaded', () => {
    const last = localStorage.getItem('lastPage');
    const path = window.location.pathname;

    // Only auto-redirect on home or login
    if (last && (path === '/' || path === '/login')) {
      fetch('/session-check')
        .then(r => r.json())
        .then(data => {
          if (data.logged_in) {
            window.location.href = last || '/dashboard';
          }
        })
        .catch(() => {});
    }
  });
</script>

  {% endif %}
</body>
</html>
