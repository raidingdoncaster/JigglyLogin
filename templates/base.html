<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="{{ url_for('manifest') }}">
  <meta name="theme-color" content="#3a8dde">

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="RDAB">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/app-icon-192.png') }}">
  <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/app-icon-512.png') }}">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ title if title else "JigglyLogin" }}</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body{
      margin:0;
      font-family:'Montserrat',sans-serif;
      background:#f4f7fa url('/static/hex-bg.png') repeat;
      background-size:200px; color:#333;
    }

    /* Loading screen */
    #loading-screen{
      position:fixed; inset:0;
      background:linear-gradient(135deg,#3a8dde,#5eb8ff);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      z-index:9999; color:#fff; font-size:1.2em;
    }
    #loading-screen img{ width:120px; margin-bottom:1em; }
    .hidden{ opacity:0; visibility:hidden; transition:opacity .8s, visibility .8s; }

    /* Header */
    header{
      position:sticky; top:0; z-index:1000;
      background:linear-gradient(135deg,#3a8dde,#5eb8ff);
      padding:6px 12px;
      display:flex; align-items:center; justify-content:space-between;
      color:#fff;
    }
    .logo{
      width:80px; height:36px;
      background:url('/static/logo.png') center/cover no-repeat;
      flex:0 0 auto;
    }

    /* --- NAV BAR --- */
    .nav-icons{ display:flex; align-items:center; gap:12px; }
    .nav-item{
      width:44px; height:44px; display:flex; align-items:center; justify-content:center;
      padding:0; border:0; background:transparent; cursor:pointer; flex:0 0 auto;
    }
    .nav-item img.nav-icon{ max-width:40px; max-height:40px; width:auto; height:auto; display:block; }

    /* Stamp container */
    .stamp-container{ position:relative; height:44px; width:auto; display:block; margin:0 2px; }
    .stamp-container img{ height:100%; width:auto; display:block; }
    .stamp-container .stamp-count{
      position:absolute; top:50%; right:12px; transform:translateY(-50%);
      font-weight:700; font-size:1.05em; color:#333; line-height:1; user-select:none;
    }

    /* Inbox dropdown */
    .inbox-wrapper{ position:relative; }
    .inbox-wrapper button.nav-item{
      all:unset; display:flex; align-items:center; justify-content:center;
      width:44px; height:44px; cursor:pointer;
    }
    .inbox-dropdown{
      position:absolute; right:0; top:50px; display:none; width:240px; background:#fff; color:#333;
      border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,.2); padding:8px; z-index:2000;
    }
    .inbox-dropdown ul{ list-style:none; margin:0; padding:0; }
    .inbox-dropdown li{ font-size:.9em; padding:6px 2px; border-bottom:1px solid #eee; }
    .inbox-dropdown li:last-child{ border-bottom:none; }
    .inbox-dropdown .view-all{
      display:block; margin-top:8px; text-align:center; text-decoration:none;
      background:#3a8dde; color:#fff; padding:6px 8px; border-radius:6px; font-weight:600;
    }

    /* Main content container */
    .container{
      max-width:420px; margin:60px auto; padding:20px; background:#fff;
      border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,.1);
    }

    /* Flash messages */
    .flash{ padding:10px; margin-bottom:10px; border-radius:6px; font-weight:600; text-align:center;
      transition:opacity .5s, transform .5s; }
    .flash-success{ background:#d4edda; border:1px solid #155724; color:#155724; }
    .flash-error{ background:#f8d7da; border:1px solid #721c24; color:#721c24; }
    .flash-warning{ background:#fff3cd; border:1px solid #856404; color:#856404; }

    /* Mobile */
    @media(max-width:480px){
      .nav-icons{ gap:10px; }
      .nav-item{ width:40px; height:40px; }
      .nav-item img.nav-icon{ max-width:36px; max-height:36px; }
      .stamp-container{ height:40px; }
      .stamp-container .stamp-count{ right:10px; font-size:.95em; }
      .container{ margin:20px auto; border-radius:8px; }
    }
  </style>

  <script>
    window.addEventListener("load",()=>{
      const ls=document.getElementById("loading-screen");
      if(ls) ls.classList.add("hidden");
    });

    window.addEventListener("DOMContentLoaded",()=>{
      // Auto-hide flashes
      setTimeout(()=>{
        document.querySelectorAll(".flash").forEach(el=>{
          el.style.opacity=0; el.style.transform="translateY(-10px)";
          setTimeout(()=>el.remove(),500);
        });
      },4000);

      // Inbox dropdown
      const btn=document.getElementById("inboxToggle");
      const dd=document.getElementById("inboxDropdown");
      if(btn && dd){
        btn.addEventListener("click",(e)=>{
          e.stopPropagation();
          dd.style.display = dd.style.display==="block" ? "none" : "block";
        });
        document.addEventListener("click",(e)=>{
          if(!dd.contains(e.target)) dd.style.display="none";
        });
      }
    });

    function togglePin(id,btn){
      const input=document.getElementById(id);
      if(!input) return;
      if(input.type==="password"){ input.type="text"; btn.textContent="Hide"; }
      else{ input.type="password"; btn.textContent="Show"; }
    }
  </script>
</head>
<body>
  <!-- Loading Splash -->
  <div id="loading-screen">
    <img src="/static/logo.png" alt="Logo"> Loading JigglyLogin‚Ä¶
  </div>

  <!-- Header -->
  <header>
    <div class="logo"></div>

    <nav class="nav-icons">
      {% if session.get('trainer') %}
        <!-- Dashboard -->
        <a href="{{ url_for('dashboard') }}" class="nav-item" title="Home / Dashboard">
          <img src="{{ url_for('static', filename='nav/pikachu-card.png') }}" alt="Home" class="nav-icon">
        </a>

        <!-- Passport -->
        <a href="{{ url_for('passport') }}" class="stamp-container" title="Passport">
          <img src="{{ url_for('static', filename='nav/stamp-icon.png') }}" alt="Passport">
          <span class="stamp-count">{{ current_stamps or 0 }}</span>
        </a>

        <!-- Inbox -->
        <div class="inbox-wrapper">
          <button type="button" class="nav-item" id="inboxToggle" title="Inbox">
            <img src="{{ url_for('static', filename='nav/mail-icon.png') }}" alt="Inbox" class="nav-icon">
          </button>
          <div id="inboxDropdown" class="inbox-dropdown">
            {% if inbox_preview and inbox_preview|length > 0 %}
            <ul>
              {% for msg in inbox_preview %}
              <li>
                <strong>{{ msg.subject }}</strong><br>
                <span style="font-size:0.8em; color:#555;">
                  {{ msg.message[:40] }}{% if msg.message|length > 40 %}‚Ä¶{% endif %}
                </span><br>
                <span style="font-size:0.7em; color:#888;">
                  {{ msg.sent_at|to_date }}
                </span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <p style="margin:6px 0;">No messages</p>
            {% endif %}
            <a href="{{ url_for('inbox') }}" class="view-all">üì® View Inbox</a>
          </div>
        </div>

        <!-- Logout -->
        <a href="{{ url_for('logout') }}" class="nav-item" title="Log out">
          <img src="{{ url_for('static', filename='nav/logout.png') }}" alt="Logout" class="nav-icon">
        </a>
      {% else %}
        <a href="https://pogoprizes.my.canva.site" target="_blank" style="color:#fff; font-weight:600; text-decoration:none;">Back to Website</a>
      {% endif %}
    </nav>
  </header>

  <!-- Page content -->
  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}

    {% if show_back %}
      <div style="margin-top:20px; text-align:center;">
        <a href="{{ url_for('dashboard') }}"
           style="display:inline-block; padding:10px 18px; background:#3a8dde; color:#fff; border-radius:6px; text-decoration:none; font-weight:600;">
          ‚¨Ö Back to Dashboard
        </a>
      </div>
    {% endif %}
  </div>

  <!-- Register Service Worker (single canonical URL) -->
  <script>
  (function () {
    if (!('serviceWorker' in navigator)) return;

    // Keep one URL everywhere; cache-bust with ?v=x when you update the worker.
    const SW_URL = '/service-worker.js?v=7';

    navigator.serviceWorker.register(SW_URL, { scope: '/' })
      .then(reg => reg.update())        // pull the latest worker
      .then(() => navigator.serviceWorker.ready)
      .then(() => {
        console.log('‚úÖ Service Worker ready');
        document.dispatchEvent(new CustomEvent('rdab-sw-ready'));
      })
      .catch(err => console.error('‚ùå SW failed:', err));
  })();
  </script>

  <!-- Install Banners -->
  <script>
    let deferredPrompt;

    function isIos() {
      return /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
    }
    function isInStandaloneMode() {
      return ('standalone' in window.navigator) && window.navigator.standalone;
    }
    function dismissBanner(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      if (isIos()) return;
      e.preventDefault();
      deferredPrompt = e;
      const el = document.getElementById('install-banner');
      if (el) el.style.display = 'flex';
    });

    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.finally(() => {
          deferredPrompt = null;
          dismissBanner('install-banner');
        });
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      if (isIos() && !isInStandaloneMode()) {
        const el = document.getElementById('ios-install-banner');
        if (el) el.style.display = 'flex';
      }
    });
  </script>
</body>

<!-- Android Install Banner -->
<div id="install-banner" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  background:#3a8dde; color:white; padding:15px 20px; border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.2); font-family:'Montserrat',sans-serif;
  align-items:center; gap:12px; z-index:9999; max-width:90%;">
  <img src="{{ url_for('static', filename='icons/app-icon-192.png') }}" style="width:40px;height:40px;border-radius:8px;">
  <div>
    <strong>Install RDAB App</strong><br>
    <small>Add Raiding Doncaster and Beyond to your Home Screen</small>
  </div>
  <button onclick="installApp()" style="margin-left:auto; background:white; color:#3a8dde;
    border:none; padding:6px 12px; border-radius:6px; font-weight:600; cursor:pointer;">Install</button>
  <button onclick="dismissBanner('install-banner')" style="margin-left:8px; background:transparent;
    color:white; border:none; font-size:1.2em; cursor:pointer;">‚ùå</button>
</div>

<!-- iOS Install Banner -->
<div id="ios-install-banner" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  background:#3a8dde; color:white; padding:15px 20px; border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.2); font-family:'Montserrat',sans-serif;
  align-items:center; gap:12px; z-index:9999; max-width:90%;">
  <img src="{{ url_for('static', filename='icons/app-icon-192.png') }}" style="width:40px;height:40px;border-radius:8px;">
  <div>
    <strong>Install RDAB App</strong><br>
    <small>Tap <span style="font-size:1.2em;">‚§¥Ô∏è</span> then <b>Add to Home Screen</b></small>
  </div>
  <button onclick="dismissBanner('ios-install-banner')" style="margin-left:auto; background:transparent;
    color:white; border:none; font-size:1.2em; cursor:pointer;">‚ùå</button>
</div>

</html>