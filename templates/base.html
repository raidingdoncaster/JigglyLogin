<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="{{ url_for('manifest') }}">
  <meta name="theme-color" content="#3a8dde">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <script>
    // Detect if running as a PWA standalone (iOS + Android)
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                      || window.navigator.standalone === true;
    if (isStandalone) {
      fetch("/pwa-flag", { method: "POST" });
    }
  </script>

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="RDAB">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/app-icon-192.png') }}">
  <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/app-icon-512.png') }}">
  <meta name="apple-mobile-web-app-orientations" content="portrait">

  <meta charset="UTF-8" />
  <title>{{ title if title else "JigglyLogin" }}</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Montserrat:wght@400;600&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --brand:#3a8dde;
      --brand2:#5eb8ff;
      --header-height:56px;
      --identity-font:'Space Grotesk','JetBrains Mono','Source Code Pro','Consolas','SFMono-Regular',monospace;
    }
    *,*::before,*::after{box-sizing:border-box;}
    body{
      margin:0;
      font-family:'Montserrat',sans-serif;
      background:#f4f7fa url('/static/hex-bg.png') repeat;
      background-size:200px;
      color:#333;
      padding-top:var(--header-height);
      padding-top:calc(var(--header-height) + env(safe-area-inset-top));
    }
    .identity-text,
    .trainer-name,
    .trainer-campfire,
    .trainer-username,
    .option-name{
      font-family:var(--identity-font);
      letter-spacing:0.04em;
      font-feature-settings:"tnum","ss01","cv02";
    }
    .identity-text{
      font-weight:600;
      color:inherit;
    }

    /* Header */
    .site-header{
      position:fixed; top:0; left:0; right:0; z-index:6000;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      padding:6px 12px;
      display:flex; align-items:center; justify-content:space-between;
      color:#fff;
      width:100%;
    }
    .header-left{display:flex;align-items:center;gap:12px;}
    .logo{
      width:80px; height:36px;
      background:url('/static/logo.png') center/cover no-repeat;
      flex:0 0 auto;
    }
    .nav-back-btn{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 16px;
      border-radius:999px;
      background:rgba(255,255,255,0.22);
      color:#fff;
      text-decoration:none;
      font-weight:600;
      box-shadow:0 8px 20px rgba(0,0,0,0.18);
      transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
      white-space:nowrap;
    }
    .nav-back-btn:hover{
      transform:translateY(-1px);
      background:rgba(255,255,255,0.3);
      box-shadow:0 12px 26px rgba(0,0,0,0.22);
    }
    .nav-back-icon{font-size:1rem;line-height:1;}
    @media(max-width:520px){
      .nav-back-label{display:none;}
      .nav-back-btn{padding:8px 12px;}
    }

    /* --- NAV BAR --- */
    .nav-icons{ display:flex; align-items:center; justify-content:flex-end; gap:12px; flex-wrap:wrap; }
    .nav-item{
      width:44px; height:44px; display:flex; align-items:center; justify-content:center;
      padding:0; border:0; background:transparent; cursor:pointer; flex:0 0 auto;
    }
    .nav-item img.nav-icon{ max-width:40px; max-height:40px; width:auto; height:auto; display:block; }

    /* Stamp container */
    .stamp-container{ position:relative; height:44px; width:auto; display:block; margin:0 2px; text-decoration:none; -webkit-tap-highlight-color:transparent; }
    .stamp-container:focus-visible{ outline:none; }
    .stamp-container img{ height:100%; width:auto; display:block; }
    .stamp-container .stamp-count{
      position:absolute; top:50%; right:12px; transform:translateY(-50%);
      font-weight:700; font-size:1.05em; color:#333; line-height:1; user-select:none;
    }

    /* Inbox dropdown */
    .inbox-wrapper{ position:relative; }
    .inbox-wrapper button.nav-item{
      all:unset; display:flex; align-items:center; justify-content:center;
      width:44px; height:44px; cursor:pointer;
    }
    .inbox-panel-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.65);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:6500;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
    }
    .inbox-panel-overlay.is-visible{
      opacity:1;
      pointer-events:auto;
    }
    .inbox-panel-dialog{
      width:min(100%,580px);
      max-height:90vh;
      background:#f8fafc;
      border-radius:18px;
      box-shadow:0 24px 60px rgba(15,23,42,0.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .inbox-panel-dialog__body{
      padding:20px clamp(18px,4vw,28px);
      overflow-y:auto;
      max-height:inherit;
    }
    .inbox-panel__loading,
    .inbox-panel__error{
      text-align:center;
      font-weight:600;
      padding:30px 10px;
      color:#0f172a;
    }
    .inbox-panel__error{ color:#b91c1c; }
    body.has-inbox-panel{
      overflow:hidden;
    }
    @media(max-width:640px){
      .inbox-panel-dialog{
        width:100%;
        max-height:100vh;
        border-radius:0;
      }
      .inbox-panel-dialog__body{
        padding:20px clamp(14px,4vw,24px);
      }
    }

    /* Inbox badge */
    .inbox-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #e74c3c;
      color: #fff;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.75em;
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Avatar dropdown */
    .avatar-wrapper{ position:relative; }
    .avatar-icon{
      border-radius:50%;
      border:2px solid #fff;
      width:40px; height:40px; object-fit:cover;
    }
    .avatar-dropdown{
      position:absolute; right:0; top:50px;
      background:#fff; color:#333; border-radius:10px;
      box-shadow:0 8px 20px rgba(0,0,0,.2); min-width:190px; overflow:hidden; z-index:2100;
      opacity:0; transform:translateY(8px); pointer-events:none; visibility:hidden;
      transition:opacity .2s ease, transform .2s ease;
    }
    .avatar-dropdown.is-open{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
      visibility:visible;
    }
    .avatar-dropdown__username{
      padding:12px 14px;
      font-weight:700;
      font-size:.95em;
      color:#1f2937;
      background:#f8fafc;
    }
    .avatar-dropdown a, .avatar-dropdown button{
      display:block; width:100%; text-align:left;
      padding:10px 14px; border:0; background:#fff; color:#333; text-decoration:none; font-size:.95em; cursor:pointer;
    }
    .avatar-dropdown a:hover, .avatar-dropdown button:hover{ background:#f5f7fb; }
    .avatar-dropdown .sep{ height:1px; background:#eee; margin:4px 0; }

    /* Main content container */
    .container{
      --container-max:540px;
      width:min(100%,var(--container-max));
      margin:clamp(20px,6vh,72px) auto;
      padding:clamp(18px,5vw,28px);
      background:#fff;
      border-radius:16px;
      box-shadow:0 12px 32px rgba(15,23,42,0.12);
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    .container.is-cozy{--container-max:480px;}
    .container.is-wide{--container-max:968px;}
    .container.is-fluid{--container-max:100%; background:transparent; box-shadow:none; padding:0; gap:20px;}

    /* Flash messages */
    .flash{ padding:10px; margin-bottom:10px; border-radius:6px; font-weight:600; text-align:center;
      transition:opacity .5s, transform .5s; }
    .flash-success{ background:#d4edda; border:1px solid #155724; color:#155724; }
    .flash-error{ background:#f8d7da; border:1px solid #721c24; color:#721c24; }
    .flash-warning{ background:#fff3cd; border:1px solid #856404; color:#856404; }

    /* ==== Auth shared styles (login/signup flow) ==== */
    .auth-shell{display:flex;flex-direction:column;gap:24px;color:#0f172a;}
    .auth-hero{position:relative;overflow:hidden;border-radius:24px;padding:32px 26px;background:radial-gradient(circle at 0% 0%,rgba(94,184,255,0.3),transparent 55%),radial-gradient(circle at 100% 0%,rgba(104,226,186,0.28),transparent 55%),linear-gradient(135deg,#0f172a,#1d4ed8);color:#f8fafc;box-shadow:0 20px 48px rgba(15,23,42,0.38);display:flex;flex-wrap:wrap;gap:24px;align-items:center;justify-content:space-between;}
    .auth-hero .hero-glow{position:absolute;inset:-65% -20% auto;min-height:280px;background:radial-gradient(circle,rgba(255,255,255,0.22) 0,rgba(255,255,255,0) 60%);animation:authGlow 7s ease-in-out infinite;}
    @keyframes authGlow{0%,100%{transform:translateY(0);opacity:0.9;}50%{transform:translateY(18px);opacity:0.6;}}
    .auth-hero .hero-text{position:relative;z-index:1;flex:1 1 220px;display:flex;flex-direction:column;gap:12px;}
    .hero-eyebrow{letter-spacing:0.28em;text-transform:uppercase;font-size:0.75rem;font-weight:600;color:rgba(226,232,240,0.85);}
    .auth-hero h1{margin:0;font-size:2rem;line-height:1.2;color:#e2e8f0;}
    .auth-hero p{margin:0;font-size:1rem;line-height:1.6;color:#cbd5f5;}
    .hero-media{position:relative;z-index:1;flex:0 0 auto;display:flex;justify-content:center;align-items:center;}
    .auth-hero .hero-banner{position:relative;z-index:1;width:200px;max-width:45vw;border-radius:18px;box-shadow:0 12px 32px rgba(15,23,42,0.45);}

    .auth-card{background:#fff;border-radius:22px;box-shadow:0 12px 32px rgba(15,23,42,0.16);padding:24px;display:flex;flex-direction:column;gap:18px;}
    .auth-card h2{margin:0;font-size:1.4rem;color:#0f172a;}
    .auth-form{display:flex;flex-direction:column;gap:14px;}
    .auth-label{font-weight:600;font-size:0.9rem;color:#1f2937;}
    .auth-input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:0.95rem;transition:border-color .2s ease, box-shadow .2s ease;}
    .auth-input:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,0.18);}
    .auth-input-row{display:flex;gap:10px;align-items:center;}

    .auth-btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 18px;border-radius:999px;font-weight:600;cursor:pointer;text-decoration:none;font-size:0.95rem;transition:transform .2s ease, box-shadow .2s ease, background .2s ease;color:#0f172a;border:none;}
    .auth-btn--full{width:100%;}
    .auth-btn--primary{background:linear-gradient(135deg,#38bdf8,#2563eb);color:#0f172a;box-shadow:0 12px 32px rgba(37,99,235,0.35);}
    .auth-btn--primary:hover{transform:translateY(-1px);box-shadow:0 16px 40px rgba(37,99,235,0.4);}
    .auth-btn--secondary{background:#eef2ff;color:#1d4ed8;border:1px solid #bfdbfe;box-shadow:0 8px 20px rgba(191,219,254,0.3);}
    .auth-btn--secondary:hover{background:#dbeafe;}
    .auth-btn--ghost{background:rgba(15,23,42,0.08);color:#0f172a;border:1px solid rgba(15,23,42,0.15);}
    .auth-btn--ghost:hover{background:rgba(15,23,42,0.12);}
    .auth-btn--outline{background:#fff;border:1px solid #d1d5db;color:#1f2937;padding:9px 14px;font-size:0.85rem;}
    .auth-btn--outline:hover{border-color:#2563eb;color:#2563eb;}

    .auth-links{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;}
    .auth-tip{background:rgba(15,23,42,0.05);border-radius:16px;padding:16px;text-align:center;color:#1f2937;line-height:1.5;display:flex;flex-direction:column;gap:12px;}

    #reminder-carousel{position:relative;text-align:center;font-size:0.9em;line-height:1.5;margin:0;}
    #reminder-text{display:inline-block;opacity:1;transition:opacity 1s ease-in-out;}
    #pokeball-loader{margin:0 auto;width:28px;height:28px;border-radius:50%;background:linear-gradient(to bottom,#ff1c1c 50%,#fff 50%);border:2px solid #000;position:relative;animation:spin 7s linear infinite;transition:transform .3s ease;}
    #pokeball-loader::before{content:"";position:absolute;top:50%;left:0;width:100%;height:2px;background:#000;transform:translateY(-50%);}
    #pokeball-loader::after{content:"";position:absolute;top:50%;left:50%;width:10px;height:10px;background:#fff;border:2px solid #000;border-radius:50%;transform:translate(-50%,-50%);}
    #pokeball-loader.pop{transform:scale(1.25);}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    .policy-cta{background:linear-gradient(135deg,#f1f5f9,#e0f2fe);border-radius:20px;padding:18px;text-align:center;box-shadow:0 14px 30px rgba(15,23,42,0.15);display:flex;flex-direction:column;gap:10px;font-size:0.95rem;color:#0f172a;}
    .policy-cta h3{margin:0;font-size:1.2rem;color:#0f172a;}
    .policy-cta p{margin:0;color:#334155;}

    .signup-guide{display:flex;gap:14px;align-items:flex-start;background:rgba(248,250,252,0.75);border-radius:16px;padding:16px;}
    .signup-guide__image{width:120px;border-radius:12px;box-shadow:0 8px 18px rgba(15,23,42,0.15);}
    .signup-guide__copy{font-size:0.9rem;color:#1f2937;line-height:1.55;}

    @media(max-width:560px){
      .auth-hero{padding:26px 20px;}
      .auth-hero h1{font-size:1.65rem;}
      .auth-hero .hero-banner{width:160px;}
      .auth-card{padding:20px;}
      .signup-guide{flex-direction:column;align-items:center;text-align:center;}
      .signup-guide__image{width:140px;}
    }

    /* Modal: Manage Account */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:flex-end; justify-content:center; z-index:3000;
    }
    .modal-card{
      width:100%; max-width:520px; background:#fff; border-radius:16px 16px 0 0;
      box-shadow:0 -8px 24px rgba(0,0,0,.25); padding:14px 14px 18px; max-height:92vh; overflow:auto;
      animation:slideUp .25s ease-out;
    }
    @keyframes slideUp{ from{ transform:translateY(24px); opacity:.8;} to{ transform:none; opacity:1;} }
    .modal-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 4px 10px;
      border-bottom:1px solid #eee; position:sticky; top:0; background:#fff; z-index:1;
    }
    .modal-header h3{ margin:0; font-size:1.05em; color:#111; }
    .close-btn{ background:transparent; border:0; font-size:1.6em; line-height:1; cursor:pointer; color:#333; }

    .settings-section{ margin-top:10px; border:1px solid #eee; border-radius:10px; overflow:hidden; }
    .settings-section details{ border-bottom:1px solid #eee; }
    .settings-section details:last-child{ border-bottom:none; }
    .settings-section summary{
      list-style:none; cursor:pointer; padding:12px; background:#f7f8fb; font-weight:700; color:#333;
    }
    .settings-section summary::-webkit-details-marker{ display:none; }
    .settings-body{ padding:12px; }
    .settings-body form input, .settings-body form button{
      width:100%; margin:6px 0; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:.95em;
    }
    .btn-primary{ background:var(--brand); color:#fff; border:none; }
    .btn-danger{ background:#e74c3c; color:#fff; border:none; }
    .meta{ font-size:.9em; color:#666; }
    .pin-row{ display:flex; gap:8px; }
    .pin-row input{ flex:1; }
    .row-actions{ display:flex; gap:8px; }
    .modal-disclaimer{
      margin:18px 0 4px;
      padding:14px;
      border-radius:12px;
      background:#f8fafc;
      border:1px solid #e2e8f0;
      font-size:0.85em;
      color:#475569;
      line-height:1.6;
    }
    .modal-disclaimer p{margin:0 0 10px;}
    .modal-disclaimer .policy-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border-radius:999px;
      background:var(--brand);
      color:#fff;
      text-decoration:none;
      font-weight:600;
      box-shadow:0 8px 20px rgba(58,141,222,0.25);
    }

    .trainer-profile-popover {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 1200;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    .trainer-profile-popover.is-visible {
      opacity: 1;
      pointer-events: auto;
    }
    .trainer-profile-popover__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(8, 15, 37, 0.75);
    }
    .trainer-profile-popover__modal {
      position: relative;
      width: min(440px, 100%);
      max-height: min(600px, 90vh);
      overflow-y: auto;
      background: transparent;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .trainer-profile-popover__close {
      align-self: flex-end;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(15,23,42,0.75);
      color: #fff;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .trainer-profile-popover__loading,
    .trainer-profile-popover__error {
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      text-align: center;
      font-weight: 600;
      color: #0f172a;
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.25);
    }
    .trainer-profile-popover__error {
      color: #991b1b;
      background: #fef2f2;
      border: 1px solid #fecaca;
    }
    .trainer-profile-card {
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 25px 70px rgba(15, 23, 42, 0.25);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .trainer-profile-card__hero {
      position: relative;
      padding: 24px;
      background-size: cover;
      background-position: center;
      min-height: 220px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .trainer-profile-card__overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(9, 14, 35, 0.15), rgba(9, 14, 35, 0.8));
    }
    .trainer-profile-card__head,
    .trainer-profile-card__stats {
      position: relative;
      z-index: 1;
    }
    .trainer-profile-card__head {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .trainer-profile-card__head img {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.55);
    }
    .trainer-profile-card__eyebrow {
      margin: 0;
      font-size: 0.75rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.8);
    }
    .trainer-profile-card__head h3 {
      margin: 2px 0;
      color: #fff;
      font-size: 1.6rem;
    }
    .trainer-profile-card__account {
      margin: 0;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 600;
    }
    .trainer-profile-card__stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    .trainer-profile-card__stats dt {
      margin: 0;
      font-size: 0.75rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.75);
    }
    .trainer-profile-card__stats dd {
      margin: 4px 0 0 0;
      color: #fff;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .trainer-profile-card__details {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
      padding: 0 24px 12px 24px;
    }
    .trainer-profile-card__details span {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: #94a3b8;
    }
    .trainer-profile-card__details strong {
      display: block;
      font-size: 1.1rem;
      color: #0f172a;
      margin-top: 4px;
    }
    .trainer-profile-card__team {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      color: #0f172a;
    }
    .trainer-profile-card__team img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #fff;
      padding: 4px;
      box-shadow: 0 4px 12px rgba(15,23,42,0.18);
    }
    .trainer-profile-card__level-value {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 60px;
      border-radius: 999px;
      padding: 6px 12px;
      background: #e2e8f0;
      color: #0f172a;
      font-weight: 700;
    }
    .trainer-profile-card__level-value.is-max-level {
      background: linear-gradient(135deg, #f97316, #facc15);
      color: #fff;
      box-shadow: 0 0 12px rgba(250, 204, 21, 0.8);
    }
    .trainer-profile-card__future {
      padding: 0 24px 24px 24px;
      border-top: 1px solid #e2e8f0;
    }
    .trainer-profile-card__future h4 {
      margin: 0 0 6px 0;
      font-size: 1rem;
    }
    .trainer-profile-card__future p {
      margin: 0;
      color: #475569;
      font-size: 0.9rem;
    }
    .trainer-profile-card__featured {
      padding: 0 24px 10px 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .trainer-profile-card__featured-title {
      margin: 0;
      font-size: 0.95rem;
      color: #0f172a;
      font-weight: 700;
    }
    .trainer-profile-card__featured-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .trainer-profile-card__featured-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #eef2ff;
      font-size: 0.85rem;
      font-weight: 600;
      color: #1d4ed8;
    }
    .trainer-profile-card__featured-item img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 4px 8px rgba(15,23,42,0.22);
    }
    .trainer-profile-card__bio {
      padding: 0 24px 24px 24px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .trainer-profile-card__bio-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .trainer-profile-card__bio-header h4 {
      margin: 0;
      font-size: 1rem;
      color: #0f172a;
    }
    .trainer-profile-card__bio-header span {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #475569;
      border: 1px solid #e2e8f0;
      border-radius: 999px;
      padding: 4px 10px;
    }
    .trainer-profile-card__bio-text {
      margin: 0;
      color: #1e293b;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .trainer-profile-card__bio-empty {
      margin: 0;
      color: #94a3b8;
      font-style: italic;
    }
    .trainer-profile-popover__viewer {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .trainer-profile-popover__owner-actions {
      padding: 16px;
      border-radius: 16px;
      background: #f8fafc;
      text-align: center;
      box-shadow: inset 0 0 0 1px rgba(15,23,42,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .trainer-profile-owner-hint {
      margin: 0;
      font-size: 0.85rem;
      color: #475569;
    }
    .trainer-profile-edit-btn {
      border: none;
      border-radius: 999px;
      padding: 10px 26px;
      font-weight: 600;
      font-size: 0.95rem;
      color: #fff;
      background: #0f172a;
      cursor: pointer;
    }
    .trainer-profile-popover__editor {
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: #fff;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 50px rgba(15,23,42,0.18);
    }
    .trainer-profile-editor__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .trainer-profile-editor__eyebrow {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      font-size: 0.7rem;
      color: #94a3b8;
      font-weight: 700;
    }
    .trainer-profile-editor__header h4 {
      margin: 2px 0 0;
      font-size: 1.1rem;
      color: #0f172a;
    }
    .trainer-profile-editor__close {
      border: none;
      background: transparent;
      font-weight: 600;
      color: #2563eb;
      cursor: pointer;
    }
    .trainer-profile-popover__action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: 12px;
      background: #0f172a;
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      text-align: center;
    }
    .trainer-profile-bio {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .trainer-profile-bio label {
      font-size: 0.85rem;
      font-weight: 600;
      color: #0f172a;
    }
    .trainer-profile-bio textarea {
      border-radius: 12px;
      border: 1px solid #cbd5f5;
      padding: 10px;
      resize: none;
      font-family: inherit;
      min-height: 90px;
    }
    .trainer-profile-bio__meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.85rem;
      color: #475569;
      gap: 8px;
    }
    .trainer-profile-bio__meta button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      background: var(--brand);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .trainer-profile-bio__hint {
      margin: 0;
      font-size: 0.75rem;
      color: #94a3b8;
    }
    .trainer-profile-bio__status {
      font-size: 0.85rem;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 10px;
    }
    .trainer-profile-bio__status.is-error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .trainer-profile-bio__status.is-success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    .trainer-profile-bio__status.is-info {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }
    .trainer-profile-featured-editor {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
    }
    .trainer-profile-featured-editor__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .trainer-profile-featured-editor__header label {
      font-weight: 600;
      color: #0f172a;
    }
    .trainer-profile-featured-editor__header span {
      font-size: 0.8rem;
      color: #475569;
    }
    .trainer-profile-featured-selected {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .trainer-profile-featured-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      background: #f1f5f9;
      padding: 6px 10px;
      font-size: 0.85rem;
      color: #0f172a;
    }
    .trainer-profile-featured-chip img {
      width: 26px;
      height: 26px;
      border-radius: 50%;
    }
    .trainer-profile-featured-chip button {
      border: none;
      background: transparent;
      color: #475569;
      font-size: 1rem;
      cursor: pointer;
    }
    .trainer-profile-featured-empty {
      margin: 0;
      font-size: 0.85rem;
      color: #94a3b8;
    }
    .trainer-profile-featured-toggle,
    .trainer-profile-featured-save {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .trainer-profile-featured-toggle {
      background: #e0f2fe;
      color: #0369a1;
    }
    .trainer-profile-featured-save {
      align-self: flex-start;
      background: var(--brand);
      color: #fff;
      margin-top: 8px;
    }
    .trainer-profile-featured-catalog {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .trainer-profile-featured-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .trainer-profile-featured-option {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      background: #fff;
      text-align: left;
      font-family: inherit;
    }
    .trainer-profile-featured-option img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
    }
    .trainer-profile-featured-option strong {
      font-size: 0.9rem;
      color: #0f172a;
    }
    .trainer-profile-featured-option span {
      font-size: 0.75rem;
      color: #475569;
    }
    .trainer-profile-featured-option.is-selected {
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(58,141,222,0.2);
    }
    .trainer-profile-featured-status {
      font-size: 0.85rem;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 10px;
    }
    .trainer-profile-featured-status.is-error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .trainer-profile-featured-status.is-success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    .trainer-profile-featured-status.is-info {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }
    .trainer-profile-meta {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 16px;
    }
    .trainer-profile-meta form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .trainer-profile-meta label {
      font-weight: 600;
      font-size: 0.85rem;
      color: #0f172a;
    }
    .trainer-profile-meta select {
      border-radius: 12px;
      border: 1px solid #cbd5f5;
      padding: 8px 10px;
      font-family: inherit;
      background: #fff;
    }
    .trainer-profile-meta button {
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      background: #0f172a;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
    }
    .trainer-profile-meta-status {
      font-size: 0.85rem;
      font-weight: 600;
      padding: 8px 12px;
      border-radius: 10px;
    }
    .trainer-profile-meta-status.is-error {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .trainer-profile-meta-status.is-success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    .trainer-profile-meta-status.is-info {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .content-filter-progress {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #cbd5f5;
      background: #f8fbff;
      color: #1e293b;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .content-filter-progress__spinner {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(37, 99, 235, 0.22);
      border-top-color: #2563eb;
      animation: contentFilterSpin 0.9s linear infinite;
    }
    @keyframes contentFilterSpin {
      to { transform: rotate(360deg); }
    }

    .content-filter-modal {
      position: fixed;
      inset: 0;
      z-index: 7000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(15, 23, 42, 0.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }
    .content-filter-modal.is-open {
      opacity: 1;
      pointer-events: auto;
    }
    .content-filter-modal__dialog {
      position: relative;
      width: min(420px, 92vw);
      background: #fff;
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 25px 70px rgba(15, 23, 42, 0.25);
      text-align: center;
      overflow: hidden;
    }
    .content-filter-modal__halo {
      position: absolute;
      inset: 18px;
      border-radius: 22px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(99, 102, 241, 0.1));
      pointer-events: none;
    }
    .content-filter-modal__body {
      position: relative;
      z-index: 1;
    }
    .content-filter-modal__icon {
      width: 56px;
      height: 56px;
      margin: 0 auto 16px;
      border-radius: 16px;
      background: #fef3c7;
      color: #b45309;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      box-shadow: inset 0 0 0 1px rgba(180, 83, 9, 0.15);
    }
    .content-filter-modal__title {
      margin: 0;
      font-size: 1.35rem;
      color: #0f172a;
    }
    .content-filter-modal__match {
      margin: 16px 0 10px;
      padding: 10px 14px;
      border-radius: 12px;
      background: #fee2e2;
      color: #b91c1c;
      font-weight: 600;
      font-family: var(--identity-font);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .content-filter-modal__subtitle {
      margin: 12px 0 2px;
      font-size: 0.95rem;
      color: #475569;
      font-weight: 600;
    }
    .content-filter-modal__match span {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(185, 28, 28, 0.12);
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #7f1d1d;
    }
    .content-filter-modal__message {
      font-size: 0.95rem;
      color: #334155;
      line-height: 1.5;
      margin-bottom: 16px;
    }
    .content-filter-modal__message a {
      color: #2563eb;
      font-weight: 600;
      text-decoration: none;
    }
    .content-filter-modal__message a:hover {
      text-decoration: underline;
    }
    .content-filter-modal__actions {
      display: flex;
      justify-content: center;
    }
    .content-filter-modal__close {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      border-radius: 999px;
      padding: 12px 26px;
      background: linear-gradient(135deg, #3a8dde, #5eb8ff);
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 12px 24px rgba(58, 141, 222, 0.35);
    }
    .content-filter-modal__close:focus-visible {
      outline: 2px solid #2563eb;
      outline-offset: 2px;
    }

    /* Mobile */
    @media(max-width:480px){
      :root{ --header-height:64px; }
      .site-header{ padding:8px 12px; }
      .nav-icons{ gap:10px; }
      .nav-item{ width:40px; height:40px; }
      .nav-item img.nav-icon{ max-width:36px; max-height:36px; }
      .stamp-container{ height:40px; }
      .container{ margin:16px auto 48px; padding:20px 16px; border-radius:14px; }
    }
  </style>

  <script>
    window.__COMMUNITY_STANDARDS_URL = "{{ url_for('policy_page', slug='community-standards') }}";
  </script>
  <script src="{{ url_for('static', filename='js/content-filter.js') }}"></script>

  <script>
    window.addEventListener("DOMContentLoaded",()=>{
      const bodyScrollLock=(()=>{
        let locks=0;
        return{
          lock(){
            locks+=1;
            if(locks===1){
              document.body.dataset.scrollLocked="true";
              document.body.style.overflow="hidden";
            }
          },
          unlock(){
            locks=Math.max(locks-1,0);
            if(locks===0){
              delete document.body.dataset.scrollLocked;
              document.body.style.overflow="";
            }
          }
        };
      })();
      window.__overlayLock=bodyScrollLock;

      const TRAINER_TEAM_OPTIONS = {{ (trainer_team_options or []) | tojson }};
      const MAX_TRAINER_LEVEL = 80;

      const headerEl=document.querySelector(".site-header");
      const setHeaderOffset=()=>{
        if(!headerEl) return;
        const height=headerEl.offsetHeight;
        document.documentElement.style.setProperty("--header-height", `${height}px`);
      };
      setHeaderOffset();
      window.addEventListener("resize", setHeaderOffset);
      if(window.ResizeObserver && headerEl){
        const ro=new ResizeObserver(()=>setHeaderOffset());
        ro.observe(headerEl);
      }
      window.addEventListener("load", setHeaderOffset);

      // Auto-hide flashes
      setTimeout(()=>{
        document.querySelectorAll(".flash").forEach(el=>{
          el.style.opacity=0; el.style.transform="translateY(-10px)";
          setTimeout(()=>el.remove(),500);
        });
      },4000);

      // Inbox modal panel
      const inboxBtn = document.getElementById("inboxToggle");
      const inboxOverlay = document.getElementById("inboxPanelOverlay");
      const inboxContent = document.getElementById("inboxPanelContent");
      let inboxLastUrl = "/inbox?panel=1";

      const setInboxButtonState = (isOpen) => {
        if (!inboxBtn) return;
        inboxBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
      };

      const focusInboxPanel = () => {
        if (!inboxContent) return;
        requestAnimationFrame(() => {
          inboxContent.focus({ preventScroll: true });
        });
      };

      const ensurePanelParam = (url) => {
        const parsed = new URL(url, window.location.origin);
        if (!parsed.searchParams.get("panel")) {
          parsed.searchParams.set("panel", "1");
        }
        return parsed.pathname + "?" + parsed.searchParams.toString();
      };

      const loadInboxPanel = async (url) => {
        if (!inboxContent) return;
        inboxLastUrl = url ? ensurePanelParam(url) : inboxLastUrl || "/inbox?panel=1";
        inboxContent.innerHTML = "<div class='inbox-panel__loading'>Loading inbox…</div>";
        try {
          const resp = await fetch(inboxLastUrl, {
            headers: { "X-Requested-With": "fetch" }
          });
          if (resp.redirected) {
            window.location.href = resp.url;
            return;
          }
          if (!resp.ok) throw new Error("Inbox load failed");
          const html = await resp.text();
          inboxContent.innerHTML = html;
          focusInboxPanel();
        } catch (err) {
          inboxContent.innerHTML = "<div class='inbox-panel__error'>Could not load your inbox. Please try again.</div>";
        }
      };

      const openInboxPanel = (url) => {
        if (!inboxOverlay || !inboxContent) return;
        if (url) inboxLastUrl = url;
        inboxOverlay.classList.add("is-visible");
        inboxOverlay.setAttribute("aria-hidden", "false");
        document.body.classList.add("has-inbox-panel");
        setInboxButtonState(true);
        loadInboxPanel(inboxLastUrl);
      };

      const closeInboxPanel = () => {
        if (!inboxOverlay) return;
        inboxOverlay.classList.remove("is-visible");
        inboxOverlay.setAttribute("aria-hidden", "true");
        document.body.classList.remove("has-inbox-panel");
        setInboxButtonState(false);
        if (inboxBtn) {
          inboxBtn.focus({ preventScroll: true });
        }
      };

      if (inboxBtn && inboxOverlay && inboxContent) {
        inboxBtn.addEventListener("click", (event) => {
          event.preventDefault();
          openInboxPanel("/inbox?panel=1");
        });

        inboxOverlay.addEventListener("click", (event) => {
          if (event.target === inboxOverlay) {
            closeInboxPanel();
            return;
          }
          const closeTrigger = event.target.closest("[data-inbox-panel-close]");
          if (closeTrigger) {
            event.preventDefault();
            closeInboxPanel();
            return;
          }
          const link = event.target.closest("[data-inbox-panel-link]");
          if (link) {
            event.preventDefault();
            loadInboxPanel(link.getAttribute("href"));
          }
        });

        inboxOverlay.addEventListener("submit", (event) => {
          const form = event.target.closest("[data-inbox-panel-form]");
          if (!form) return;
          event.preventDefault();
          const formData = new FormData(form);
          const url = new URL(form.getAttribute("action") || "/inbox", window.location.origin);
          formData.forEach((value, key) => {
            url.searchParams.set(key, value);
          });
          if (!url.searchParams.get("panel")) {
            url.searchParams.set("panel", "1");
          }
          loadInboxPanel(url.pathname + "?" + url.searchParams.toString());
        });

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && inboxOverlay.classList.contains("is-visible")) {
            event.preventDefault();
            closeInboxPanel();
          }
        });
      }

      // Avatar dropdown
      const ab=document.getElementById("avatarToggle");
      const ad=document.getElementById("avatarDropdown");
      const closeAvatarDropdown=()=>{
        if(!ad) return;
        ad.classList.remove("is-open");
        ad.setAttribute("aria-hidden","true");
      };
      const openAvatarDropdown=()=>{
        if(!ad) return;
        ad.classList.add("is-open");
        ad.setAttribute("aria-hidden","false");
      };
      if(ab && ad){
        ab.addEventListener("click",(e)=>{
          e.stopPropagation();
          if(ad.classList.contains("is-open")) closeAvatarDropdown();
          else openAvatarDropdown();
        });
        document.addEventListener("click",(e)=>{
          if(!ad.contains(e.target) && !ab.contains(e.target)) closeAvatarDropdown();
        });
        ad.addEventListener("click",(e)=>e.stopPropagation());
      }
      window.closeAvatarDropdown=closeAvatarDropdown;
      window.openAvatarDropdown=openAvatarDropdown;

      // Manage Account modal open/close
      const mm = document.getElementById('manageAccountModal');
      const openBtns = document.querySelectorAll('[data-open-account-modal]');
      openBtns.forEach(b=>b.addEventListener('click',()=>{
        closeAvatarDropdown();
        if(!mm) return;
        mm.style.display='flex';
        bodyScrollLock.lock();
      }));
      const closeAccountBtn = document.getElementById('closeAccountModal');
      if(closeAccountBtn){
        closeAccountBtn.addEventListener('click', closeAccountModal);
      }
      if(mm){
        mm.addEventListener('click',(e)=>{
          if(e.target === mm){
            closeAccountModal();
          }
        });
      }
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && mm && mm.style.display==='flex') closeAccountModal(); });

      function closeAccountModal(){
        if(!mm) return;
        mm.style.display='none';
        bodyScrollLock.unlock();
      }
      window._closeAccountModal = closeAccountModal; // expose if needed

      const logoutLink=document.querySelector('[data-confirm-logout]');
      if(logoutLink){
        logoutLink.addEventListener('click',(e)=>{
          const confirmLogout=window.confirm('Log out and end your session?');
          if(!confirmLogout){
            e.preventDefault();
            closeAvatarDropdown();
            return;
          }
          closeAvatarDropdown();
        });
      }

      const DEFAULT_TRAINER_AVATAR = "{{ url_for('static', filename='avatars/avatar1.png') }}";
      const DEFAULT_TRAINER_BACKGROUND = "{{ url_for('static', filename='backgrounds/standard.png') }}";

      const trainerProfileModule = (()=>{
        const overlay=document.querySelector("[data-trainer-profile]");
        if(!overlay) return null;
        const loadingEl=overlay.querySelector("[data-trainer-profile-loading]");
        const errorEl=overlay.querySelector("[data-trainer-profile-error]");
        const cardEl=overlay.querySelector("[data-trainer-profile-card]");
        const viewerPanel=overlay.querySelector("[data-trainer-profile-viewer]");
        const heroEl=overlay.querySelector("[data-trainer-profile-hero]");
        const avatarEl=overlay.querySelector("[data-trainer-profile-avatar]");
        const nameEl=overlay.querySelector("[data-trainer-profile-name]");
        const accountEl=overlay.querySelector("[data-trainer-profile-account]");
        const campfireEl=overlay.querySelector("[data-trainer-profile-campfire]");
        const stampsEl=overlay.querySelector("[data-trainer-profile-stamps]");
        const joinedEl=overlay.querySelector("[data-trainer-profile-joined]");
        const teamRow=overlay.querySelector("[data-trainer-profile-team-row]");
        const teamValueEl=overlay.querySelector("[data-trainer-profile-team-value]");
        const levelRow=overlay.querySelector("[data-trainer-profile-level-row]");
        const levelValueEl=overlay.querySelector("[data-trainer-profile-level-value]");
        const ownerPanel=overlay.querySelector("[data-trainer-profile-owner]");
        const editOpenBtn=overlay.querySelector("[data-trainer-profile-edit-open]");
        const editorPanel=overlay.querySelector("[data-trainer-profile-editor]");
        const editorCloseBtn=overlay.querySelector("[data-trainer-profile-editor-close]");
        const customizeLink=overlay.querySelector("[data-trainer-profile-customize]");
        const metaPanel=overlay.querySelector("[data-trainer-profile-meta]");
        const metaForm=overlay.querySelector("[data-trainer-profile-meta-form]");
        const teamSelect=overlay.querySelector("[data-trainer-team-select]");
        const levelSelect=overlay.querySelector("[data-trainer-level-select]");
        const metaStatus=overlay.querySelector("[data-trainer-profile-meta-status]");
        const bioForm=overlay.querySelector("[data-trainer-profile-bio-form]");
        const bioInput=overlay.querySelector("[data-trainer-profile-bio-input]");
        const bioCount=overlay.querySelector("[data-trainer-profile-bio-count]");
        const bioStatus=overlay.querySelector("[data-trainer-profile-bio-status]");
        const bioFilterProgress=overlay.querySelector("[data-content-filter-progress]");
        const bioBlock=overlay.querySelector("[data-trainer-profile-bio-block]");
        const bioText=overlay.querySelector("[data-trainer-profile-bio-text]");
        const bioEmpty=overlay.querySelector("[data-trainer-profile-bio-empty]");
        const bioPill=overlay.querySelector("[data-trainer-profile-bio-pill]");
        const featuredRow=overlay.querySelector("[data-trainer-profile-featured]");
        const featuredList=overlay.querySelector("[data-trainer-profile-featured-list]");
        const featuredEditor=overlay.querySelector("[data-trainer-profile-featured-editor]");
        const featuredSelected=overlay.querySelector("[data-trainer-profile-featured-selected]");
        const featuredCount=overlay.querySelector("[data-trainer-profile-featured-count]");
        const featuredCatalogPanel=overlay.querySelector("[data-trainer-profile-featured-catalog]");
        const featuredGrid=overlay.querySelector("[data-trainer-profile-featured-grid]");
        const featuredLoadBtn=overlay.querySelector("[data-trainer-profile-featured-load]");
        const featuredSaveBtn=overlay.querySelector("[data-trainer-profile-featured-save]");
        const featuredStatus=overlay.querySelector("[data-trainer-profile-featured-status]");
        const bodyLock=window.__overlayLock || {lock(){},unlock(){}};
        const cache={};
        const state={
          username:"",
          profileUrl:null,
          isOwner:false,
          mode:"public",
          viewState:"loading",
          displayName:"Trainer",
          featuredSelection:[],
          featuredCatalog:[],
          featuredCatalogLoaded:false,
          featuredCatalogLoading:false,
          catalogPromise:null,
          teamValue:"",
          levelValue:"",
        };
        let closeTimer=null;
        let metaSelectsInitialized=false;

        const escapeHtml=(value)=>{
          return (value || "").replace(/[&<>"']/g,(char)=>{
            switch(char){
              case "&": return "&amp;";
              case "<": return "&lt;";
              case ">": return "&gt;";
              case "\"": return "&quot;";
              case "'": return "&#039;";
              default: return char;
            }
          });
        };

        const formatDate=(value)=>{
          if(!value) return "—";
          try{
            const date=new Date(value);
            return date.toLocaleDateString(undefined,{ month:"short", day:"numeric", year:"numeric" });
          }catch(err){
            return value;
          }
        };

        const setView=(mode,message)=>{
          state.viewState=mode;
          if(loadingEl) loadingEl.hidden = mode!=="loading";
          if(cardEl) cardEl.hidden = mode!=="ready";
          if(errorEl){
            errorEl.hidden = mode!=="error";
            if(mode==="error"){
              errorEl.textContent = message || "Unable to load trainer profile right now.";
            }
          }
          updateModeVisibility();
        };

        const resetStatus=()=>{
          if(!bioStatus) return;
          bioStatus.hidden=true;
          bioStatus.textContent="";
          bioStatus.classList.remove("is-error","is-success","is-info");
        };

        const setBioStatus=(message,tone)=>{
          if(!bioStatus) return;
          bioStatus.hidden=false;
          bioStatus.textContent=message;
          bioStatus.classList.remove("is-error","is-success","is-info");
          if(tone==="error") bioStatus.classList.add("is-error");
          else if(tone==="success") bioStatus.classList.add("is-success");
          else bioStatus.classList.add("is-info");
        };

        const clearMetaStatus=()=>{
          if(!metaStatus) return;
          metaStatus.hidden=true;
          metaStatus.textContent="";
          metaStatus.classList.remove("is-error","is-success","is-info");
        };

        const setMetaStatus=(message,tone)=>{
          if(!metaStatus) return;
          metaStatus.hidden=false;
          metaStatus.textContent=message;
          metaStatus.classList.remove("is-error","is-success","is-info");
          if(tone==="error") metaStatus.classList.add("is-error");
          else if(tone==="success") metaStatus.classList.add("is-success");
          else metaStatus.classList.add("is-info");
        };

        const ensureMetaSelects=()=>{
          if(metaSelectsInitialized) return;
          if(teamSelect){
            let options='<option value=\"\">Select your team</option>';
            TRAINER_TEAM_OPTIONS.forEach(function(opt){
              options += `<option value=\"${opt.value}\">${opt.label}</option>`;
            });
            teamSelect.innerHTML = options;
          }
          if(levelSelect){
            let options='<option value=\"\">Select level</option>';
            for(let lvl=1; lvl<=MAX_TRAINER_LEVEL; lvl++){
              options += `<option value=\"${lvl}\">Level ${lvl}</option>`;
            }
            levelSelect.innerHTML = options;
          }
          metaSelectsInitialized=true;
        };

        const populateMetaForm=()=>{
          if(!metaForm || !state.isOwner) return;
          ensureMetaSelects();
          if(teamSelect){
            teamSelect.value = state.teamValue || "";
          }
          if(levelSelect){
            levelSelect.value = state.levelValue ? String(state.levelValue) : "";
          }
          clearMetaStatus();
        };

        const toggleBioFilterProgress=(active)=>{
          if(!bioFilterProgress) return;
          bioFilterProgress.hidden = !active;
        };

        const runBioFilterCheck=(value)=>{
          const filter=window.RDABContentFilter;
          if(!filter || typeof filter.scan!=="function"){
            return Promise.resolve({ allowed:true });
          }
          toggleBioFilterProgress(true);
          return filter.scan(value)
            .then(result=>{
              toggleBioFilterProgress(false);
              return result;
            })
            .catch(err=>{
              console.warn("Content filter error:", err);
              toggleBioFilterProgress(false);
              return { allowed:true };
            });
        };

        const updateBioCount=()=>{
          if(!bioInput || !bioCount) return;
          const len=bioInput.value.length;
          bioCount.textContent=`${len}/200`;
        };

        const setBioText=(value)=>{
          const text=(value || "").trim();
          if(bioText){
            bioText.textContent=text;
            bioText.hidden=!text;
          }
          if(bioEmpty){
            bioEmpty.hidden=!!text;
          }
        };

        const populateBio=(data)=>{
          if(!bioInput) return;
          const value = data && typeof data.bio === "string" ? data.bio : "";
          bioInput.value=value;
          updateBioCount();
        };

        const updateModeVisibility=()=>{
          const isOwner=state.isOwner;
          const isEditor=state.mode==="editor";
          const canShowOwnerCta=isOwner && state.mode==="owner" && state.viewState==="ready";
          if(viewerPanel) viewerPanel.hidden = isEditor;
          if(ownerPanel) ownerPanel.hidden = !canShowOwnerCta;
          if(editOpenBtn) editOpenBtn.disabled = !canShowOwnerCta;
          if(editorPanel) editorPanel.hidden = !isEditor;
          if(customizeLink) customizeLink.hidden = !isEditor;
          if(metaPanel) metaPanel.hidden = !isEditor;
          if(featuredEditor) featuredEditor.hidden = !isEditor;
          if(bioForm) bioForm.hidden = !isEditor;
          if(bioPill){
            if(state.mode==="public"){
              bioPill.textContent="Public Profile";
            }else if(state.mode==="owner"){
              bioPill.textContent="Player View";
            }else{
              bioPill.textContent="Edit Mode";
            }
          }
          if(!isEditor && featuredCatalogPanel){
            featuredCatalogPanel.hidden=true;
          }
          if(isEditor){
            populateMetaForm();
          }else{
            resetStatus();
            clearFeaturedStatus();
            clearMetaStatus();
          }
        };

        const renderTeamRow=(info)=>{
          if(!teamRow || !teamValueEl){
            return;
          }
          if(!info){
            teamRow.hidden=true;
            teamValueEl.innerHTML="—";
            return;
          }
          const icon=info.icon ? escapeHtml(info.icon) : "";
          const label=escapeHtml(info.label || "Trainer Team");
          teamRow.hidden=false;
          if(icon){
            teamValueEl.innerHTML=`<img src="${icon}" alt="${label} icon"><span>${label}</span>`;
          }else{
            teamValueEl.textContent=label;
          }
        };

        const renderLevelRow=(levelValue,isMax)=>{
          if(!levelRow || !levelValueEl){
            return;
          }
          if(!levelValue){
            levelRow.hidden=true;
            levelValueEl.textContent="—";
            levelValueEl.classList.remove("is-max-level");
            return;
          }
          levelRow.hidden=false;
          levelValueEl.textContent = `Lv. ${levelValue}`;
          levelValueEl.classList.toggle("is-max-level", !!isMax);
        };

        const renderFeaturedRow=(items)=>{
          if(!featuredRow || !featuredList){
            return;
          }
          if(!items || !items.length){
            featuredRow.hidden=true;
            featuredList.innerHTML="";
            return;
          }
          featuredRow.hidden=false;
          featuredList.innerHTML=items.map((item)=>{
            const icon=escapeHtml(item.icon || "");
            const label=escapeHtml(item.label || "Featured stamp");
            return `
              <div class="trainer-profile-card__featured-item">
                <img src="${icon}" alt="${label}">
                <span>${label}</span>
              </div>
            `;
          }).join("");
        };

        const renderFeaturedSelection=()=>{
          if(!featuredSelected) return;
          if(!state.featuredSelection.length){
            featuredSelected.innerHTML='<p class="trainer-profile-featured-empty">No featured stamps yet.</p>';
          }else{
            featuredSelected.innerHTML=state.featuredSelection.map((item, index)=>{
              const icon=escapeHtml(item.icon || "");
              const label=escapeHtml(item.label || "Featured stamp");
              return `
                <span class="trainer-profile-featured-chip">
                  <img src="${icon}" alt="${label}">
                  <span>${label}</span>
                  <button type="button" data-featured-remove="${index}" aria-label="Remove featured stamp">×</button>
                </span>
              `;
            }).join("");
          }
          if(featuredCount){
            featuredCount.textContent = `${state.featuredSelection.length}/3`;
          }
          updateCatalogSelectionState();
        };

        const clearFeaturedStatus=()=>{
          if(!featuredStatus) return;
          featuredStatus.hidden=true;
          featuredStatus.textContent="";
          featuredStatus.classList.remove("is-error","is-success","is-info");
        };

        const setFeaturedStatus=(message,tone)=>{
          if(!featuredStatus) return;
          featuredStatus.hidden=false;
          featuredStatus.textContent=message;
          featuredStatus.classList.remove("is-error","is-success","is-info");
          if(tone==="error") featuredStatus.classList.add("is-error");
          else if(tone==="success") featuredStatus.classList.add("is-success");
          else featuredStatus.classList.add("is-info");
        };

        const syncSelectionTokensWithCatalog=()=>{
          if(!state.featuredCatalog.length) return;
          state.featuredSelection=state.featuredSelection.map((item)=>{
            if(item.token) return item;
            const match=state.featuredCatalog.find(stamp =>
              stamp.icon===item.icon && stamp.label===item.label
            );
            if(match){
              return { ...item, token: match.token };
            }
            return item;
          });
        };

        const updateCatalogSelectionState=()=>{
          if(!featuredGrid) return;
          featuredGrid.querySelectorAll("[data-featured-token]").forEach(btn=>{
            const token=btn.getAttribute("data-featured-token");
            const isSelected=state.featuredSelection.some(item=>item.token && item.token===token);
            btn.classList.toggle("is-selected", isSelected);
          });
        };

        const renderFeaturedCatalog=()=>{
          if(!featuredGrid) return;
          if(!state.featuredCatalog.length){
            featuredGrid.innerHTML='<p class="trainer-profile-featured-empty" style="grid-column:1/-1;">No stamps to show yet. Earn stamps to start featuring them!</p>';
          }else{
            featuredGrid.innerHTML=state.featuredCatalog.map((stamp)=>{
              const icon=escapeHtml(stamp.icon || "");
              const label=escapeHtml(stamp.label || "Stamp");
              const awarded=escapeHtml(stamp.awarded_at || "");
              return `
                <button type="button"
                        class="trainer-profile-featured-option"
                        data-featured-token="${stamp.token}"
                        data-featured-icon="${icon}"
                        data-featured-label="${label}">
                  <img src="${icon}" alt="${label}">
                  <strong>${label}</strong>
                  <span>${awarded || "Recently earned"}</span>
                </button>
              `;
            }).join("");
          }
          updateCatalogSelectionState();
        };

        const ensureCatalogLoaded=()=>{
          if(state.featuredCatalogLoaded){
            return Promise.resolve(state.featuredCatalog);
          }
          if(state.featuredCatalogLoading && state.catalogPromise){
            return state.catalogPromise;
          }
          state.featuredCatalogLoading=true;
          state.catalogPromise=fetch("/api/profile/featured-stamps")
            .then(resp=>resp.json().then(body=>({ ok:resp.ok, body })))
            .then(({ok,body})=>{
              if(!ok) throw new Error(body && body.error ? body.error : "Unable to load stamps.");
              const catalog=Array.isArray(body && body.stamps) ? body.stamps : [];
              state.featuredCatalog=catalog;
              state.featuredCatalogLoaded=true;
              state.featuredCatalogLoading=false;
              state.catalogPromise=null;
              syncSelectionTokensWithCatalog();
              renderFeaturedCatalog();
              renderFeaturedSelection();
              clearFeaturedStatus();
              return catalog;
            })
            .catch(err=>{
              state.featuredCatalogLoading=false;
              state.catalogPromise=null;
              setFeaturedStatus(err && err.message ? err.message : "Unable to load stamps.", "error");
              throw err;
            });
          return state.catalogPromise;
        };

        const toggleCatalogVisibility=()=>{
          if(!featuredCatalogPanel) return;
          featuredCatalogPanel.hidden = !featuredCatalogPanel.hidden;
        };

        const hydrateProfile=(data,fallbackName)=>{
          const displayName = data && data.username ? data.username : (fallbackName || "Trainer");
          if(nameEl) nameEl.textContent = displayName;
          if(accountEl){
            const title = data && data.trainer_title;
            const accountLabel = title || (data && data.account_type ? `${data.account_type} Account` : "Trainer Account");
            accountEl.textContent = accountLabel;
          }
          if(avatarEl){
            avatarEl.src = data && data.avatar_url ? data.avatar_url : DEFAULT_TRAINER_AVATAR;
            avatarEl.alt = `${displayName} avatar`;
          }
          if(heroEl){
            const heroBg = data && data.background_url ? `url('${data.background_url}')` : `url('${DEFAULT_TRAINER_BACKGROUND}')`;
            heroEl.style.backgroundImage = heroBg;
          }
          if(campfireEl){
            campfireEl.textContent = data && data.campfire_username ? `@${data.campfire_username}` : "—";
          }
          if(stampsEl){
            const stampValue = data && typeof data.stamps !== "undefined" ? data.stamps : "—";
            stampsEl.textContent = typeof stampValue === "number" ? stampValue.toLocaleString() : (stampValue || "—");
          }
          if(joinedEl) joinedEl.textContent = data && data.joined_at ? formatDate(data.joined_at) : "—";
          const teamInfo = data && data.team ? data.team : null;
          renderTeamRow(teamInfo);
          state.teamValue = teamInfo && teamInfo.value ? teamInfo.value : "";
          const trainerLevel = (data && typeof data.trainer_level === "number") ? data.trainer_level : null;
          state.levelValue = trainerLevel ? String(trainerLevel) : "";
          renderLevelRow(trainerLevel, data && data.is_max_level);
          setBioText(data && typeof data.bio === "string" ? data.bio : "");
          const featuredItems = Array.isArray(data && data.featured_stamps) ? data.featured_stamps : [];
          renderFeaturedRow(featuredItems);
          state.featuredSelection = featuredItems.map(item=>({
            icon: item.icon || "",
            label: item.label || "Featured stamp",
            token: item.token || null,
          }));
          renderFeaturedSelection();
          if(state.featuredCatalogLoaded){
            syncSelectionTokensWithCatalog();
            updateCatalogSelectionState();
          }
          if(state.isOwner){
            populateBio(data);
            populateMetaForm();
          }
        };

        const open=(options)=>{
          if(!overlay) return;
          const username=(options.username || "").trim();
          state.username=username;
          state.profileUrl=options.url || (username ? `/api/trainers/${encodeURIComponent(username)}/profile` : null);
          state.isOwner=!!options.editable;
          state.mode=state.isOwner ? "owner" : "public";
          state.displayName=options.displayName || username || "Trainer";
          state.teamValue="";
          state.levelValue="";
          state.featuredSelection=[];
          state.featuredCatalog=[];
          state.featuredCatalogLoaded=false;
          state.featuredCatalogLoading=false;
          state.catalogPromise=null;
          state.viewState="loading";
          updateModeVisibility();
          if(!state.isOwner && bioInput){
            bioInput.value="";
            updateBioCount();
          }
          setBioText("");
          renderTeamRow(null);
          renderLevelRow(null,false);
          renderFeaturedRow([]);
          renderFeaturedSelection();
          overlay.hidden=false;
          requestAnimationFrame(()=>overlay.classList.add("is-visible"));
          bodyLock.lock();
          setView("loading");
          const cacheKey=username.toLowerCase();
          if(cacheKey && cache[cacheKey]){
            hydrateProfile(cache[cacheKey], state.displayName);
            setView("ready");
            return;
          }
          if(!state.profileUrl){
            setView("error","Trainer profile unavailable.");
            return;
          }
          fetch(state.profileUrl)
            .then(resp=>resp.json().then(body=>({ ok:resp.ok, body })))
            .then(({ok,body})=>{
              if(!ok) throw new Error(body && body.error ? body.error : "Unable to load trainer profile.");
              const trainer=body && body.trainer;
              if(!trainer) throw new Error("Trainer profile missing.");
              if(cacheKey) cache[cacheKey]=trainer;
              hydrateProfile(trainer, state.displayName);
              setView("ready");
            })
            .catch(err=>{
              console.warn(err);
              setView("error", err && err.message ? err.message : "Unable to load trainer profile right now.");
            });
        };

        const close=()=>{
          if(!overlay || overlay.hidden) return;
          state.mode = state.isOwner ? "owner" : "public";
          updateModeVisibility();
          overlay.classList.remove("is-visible");
          if(closeTimer) clearTimeout(closeTimer);
          closeTimer=setTimeout(()=>{
            overlay.hidden=true;
            setView("loading");
            bodyLock.unlock();
          },220);
        };

        const submitBio=(evt)=>{
          evt.preventDefault();
          if(!state.isOwner || state.mode!=="editor" || !bioForm || !bioInput) return;
          let bioValue=(bioInput.value || "").trim();
          if(bioValue.length>200){
            bioValue=bioValue.slice(0,200);
            bioInput.value=bioValue;
          }
          updateBioCount();
          const submitBtn=bioForm.querySelector("button[type='submit']");
          if(submitBtn) submitBtn.disabled=true;
          runBioFilterCheck(bioValue).then(result=>{
            if(!result.allowed){
              setBioStatus("Community filter blocked that update. Please adjust your wording.","error");
              if(window.RDABContentFilter && typeof window.RDABContentFilter.showWarning==="function"){
                window.RDABContentFilter.showWarning(result);
              }
              if(submitBtn) submitBtn.disabled=false;
              return;
            }
            setBioStatus("Saving bio…","info");
            fetch("/api/profile/bio",{
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body:JSON.stringify({ bio: bioValue })
            })
              .then(resp=>resp.json().then(body=>({ ok:resp.ok, body })))
              .then(({ok,body})=>{
                if(!ok){
                  const error=new Error(body && body.error ? body.error : "Unable to update bio.");
                  if(body && body.filter){
                    error.isFilter=true;
                    error.filter=body.filter;
                  }
                  throw error;
                }
                setBioStatus("Bio updated!","success");
                const trainer=body && body.trainer;
                if(trainer && state.username){
                  cache[state.username.toLowerCase()]=trainer;
                  hydrateProfile(trainer, state.displayName);
                }
              })
              .catch(err=>{
                console.warn(err);
                if(err && err.isFilter && err.filter && window.RDABContentFilter && typeof window.RDABContentFilter.showWarning==="function"){
                  window.RDABContentFilter.showWarning(err.filter);
                  setBioStatus("Community filter blocked that update. Please adjust your wording.","error");
                }else{
                  setBioStatus(err && err.message ? err.message : "Unable to update bio.","error");
                }
              })
              .finally(()=>{
                if(submitBtn) submitBtn.disabled=false;
              });
          });
        };

        overlay.querySelectorAll("[data-trainer-profile-close]").forEach(btn=>{
          btn.addEventListener("click",(evt)=>{
            evt.preventDefault();
            close();
          });
        });
        if(bioForm){
          bioForm.addEventListener("submit", submitBio);
        }
        if(bioInput){
          bioInput.addEventListener("input", updateBioCount);
        }
        if(featuredLoadBtn){
          featuredLoadBtn.addEventListener("click",()=>{
            if(!state.isOwner || state.mode!=="editor"){
              return;
            }
            ensureCatalogLoaded().then(()=>{
              toggleCatalogVisibility();
            }).catch(()=>{});
          });
        }
        if(featuredGrid){
          featuredGrid.addEventListener("click",(event)=>{
            const btn=event.target.closest("[data-featured-token]");
            if(!btn || !state.isOwner || state.mode!=="editor") return;
            const token=btn.getAttribute("data-featured-token");
            const icon=btn.getAttribute("data-featured-icon") || "";
            const label=btn.getAttribute("data-featured-label") || "";
            if(state.featuredSelection.some(item=>item.token===token)){
              state.featuredSelection=state.featuredSelection.filter(item=>item.token!==token);
              renderFeaturedSelection();
              clearFeaturedStatus();
              return;
            }
            if(state.featuredSelection.length >= 3){
              setFeaturedStatus("You can only feature up to three stamps.", "error");
              return;
            }
            state.featuredSelection.push({ token, icon, label });
            renderFeaturedSelection();
            clearFeaturedStatus();
          });
        }
        if(featuredSelected){
          featuredSelected.addEventListener("click",(event)=>{
            const btn=event.target.closest("[data-featured-remove]");
            if(!btn || state.mode!=="editor" || !state.isOwner) return;
            const index=parseInt(btn.getAttribute("data-featured-remove") || "-1", 10);
            if(isNaN(index) || index < 0 || index >= state.featuredSelection.length) return;
            state.featuredSelection.splice(index,1);
            renderFeaturedSelection();
            clearFeaturedStatus();
          });
        }
        if(editOpenBtn){
          editOpenBtn.addEventListener("click",()=>{
            if(!state.isOwner || state.mode!=="owner" || state.viewState!=="ready") return;
            state.mode="editor";
            updateModeVisibility();
          });
        }
        if(editorCloseBtn){
          editorCloseBtn.addEventListener("click",(evt)=>{
            evt.preventDefault();
            if(!state.isOwner) return;
            state.mode="owner";
            updateModeVisibility();
          });
        }
        if(featuredSaveBtn){
          featuredSaveBtn.addEventListener("click",()=>{
            if(!state.isOwner || state.mode!=="editor") return;
            ensureCatalogLoaded().then(()=>{
              const tokens=state.featuredSelection.map(item=>item.token).filter(Boolean);
              if(state.featuredSelection.length && !tokens.length){
                setFeaturedStatus("Please pick stamps from the list to save them.", "error");
                return;
              }
              setFeaturedStatus("Saving featured stamps…","info");
              featuredSaveBtn.disabled=true;
              return fetch("/api/profile/featured-stamps",{
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({ tokens })
              })
                .then(resp=>resp.json().then(body=>({ ok:resp.ok, body })))
                .then(({ok,body})=>{
                  if(!ok) throw new Error(body && body.error ? body.error : "Unable to update featured stamps.");
                  const trainer=body && body.trainer;
                  if(trainer && state.username){
                    cache[state.username.toLowerCase()]=trainer;
                    hydrateProfile(trainer, state.displayName);
                  }
                  setFeaturedStatus("Featured stamps updated!", "success");
                })
                .catch(err=>{
                  console.warn(err);
                  setFeaturedStatus(err && err.message ? err.message : "Unable to update featured stamps.", "error");
                })
                .finally(()=>{
                  featuredSaveBtn.disabled=false;
                });
            }).catch(()=>{});
          });
        }
        if(teamSelect){
          teamSelect.addEventListener("change", clearMetaStatus);
        }
        if(levelSelect){
          levelSelect.addEventListener("change", clearMetaStatus);
        }
        if(metaForm){
          metaForm.addEventListener("submit",(evt)=>{
            evt.preventDefault();
            if(!state.isOwner || state.mode!=="editor") return;
            ensureMetaSelects();
            const desiredTeam=(teamSelect ? (teamSelect.value || "").toLowerCase() : "");
            const currentTeam=state.teamValue || "";
            const desiredLevelRaw=levelSelect ? (levelSelect.value || "") : "";
            const currentLevelRaw=state.levelValue ? String(state.levelValue) : "";
            const payload={};
            if(desiredTeam !== currentTeam){
              payload.team = desiredTeam;
            }
            if(desiredLevelRaw !== currentLevelRaw){
              if(!desiredLevelRaw){
                payload.trainer_level = null;
              }else{
                const levelInt=parseInt(desiredLevelRaw,10);
                if(isNaN(levelInt) || levelInt < 1 || levelInt > MAX_TRAINER_LEVEL){
                  setMetaStatus(`Level must be between 1 and ${MAX_TRAINER_LEVEL}.`,"error");
                  return;
                }
                payload.trainer_level = levelInt;
              }
            }
            if(!("team" in payload) && !("trainer_level" in payload)){
              setMetaStatus("No changes to save.","info");
              return;
            }
            setMetaStatus("Saving profile…","info");
            const submitBtn=metaForm.querySelector("button[type='submit']");
            if(submitBtn) submitBtn.disabled=true;
            fetch("/api/profile/meta",{
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body:JSON.stringify(payload)
            })
              .then(resp=>resp.json().then(body=>({ ok:resp.ok, body })))
              .then(({ok,body})=>{
                if(!ok) throw new Error(body && body.error ? body.error : "Unable to update profile.");
                setMetaStatus("Profile updated!","success");
                const trainer=body && body.trainer;
                if(trainer && state.username){
                  cache[state.username.toLowerCase()]=trainer;
                  hydrateProfile(trainer, state.displayName);
                }
              })
              .catch(err=>{
                console.warn(err);
                setMetaStatus(err && err.message ? err.message : "Unable to update profile.","error");
              })
              .finally(()=>{
                if(submitBtn) submitBtn.disabled=false;
              });
          });
        }

        document.addEventListener("keydown",(evt)=>{
          if(evt.key==="Escape" && !overlay.hidden){
            close();
          }
        });

        return { open, close };
      })();
      window.TrainerProfilePopover=trainerProfileModule;

      document.addEventListener("click",(event)=>{
        const trigger=event.target.closest("[data-trainer-profile-trigger]");
        if(!trigger || !window.TrainerProfilePopover || typeof window.TrainerProfilePopover.open!=="function"){
          return;
        }
        event.preventDefault();
        let username=(trigger.getAttribute("data-trainer-profile-username") || "").trim();
        if(!username){
          username=(trigger.getAttribute("data-trainer-username") || "").trim();
        }
        const providedUrl=trigger.getAttribute("data-trainer-profile-url");
        const displayName=trigger.getAttribute("data-trainer-display") || trigger.textContent || username || "Trainer";
        const profileUrl=providedUrl || (username ? `/api/trainers/${encodeURIComponent(username)}/profile` : null);
        const editable=trigger.hasAttribute("data-trainer-profile-own");
        if(trigger.hasAttribute("data-close-avatar") && typeof window.closeAvatarDropdown==="function"){
          window.closeAvatarDropdown();
        }
        window.TrainerProfilePopover.open({
          username,
          url: profileUrl,
          displayName,
          editable,
        });
      });
    });

    function togglePin(id,btn){
      const input=document.getElementById(id);
      if(!input) return;
      if(input.type==="password"){ input.type="text"; btn.textContent="Hide"; }
      else{ input.type="password"; btn.textContent="Show"; }
    }
  </script>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="header-left">
      <div class="logo"></div>
      {% if header_back_action %}
        <a href="{{ header_back_action.href }}"
           class="nav-back-btn"
           {% if header_back_action.external %}target="_blank" rel="noopener"{% endif %}>
          <span class="nav-back-icon">⬅</span>
          <span class="nav-back-label">{{ header_back_action.label or "Back" }}</span>
        </a>
      {% endif %}
    </div>

    <nav class="nav-icons">
      {% if session.get('trainer') %}
        <!-- Dashboard -->
        <a href="{{ url_for('dashboard') }}" class="nav-item" title="Home / Dashboard">
          <img src="{{ url_for('static', filename='nav/pikachu-card.png') }}" alt="Home" class="nav-icon">
        </a>

        <!-- Passport -->
        <a href="{{ url_for('passport') }}" class="stamp-container" title="Passport">
          <img src="{{ url_for('static', filename='nav/stamp-icon.png') }}" alt="Passport">
          <span class="stamp-count">{{ current_stamps or 0 }}</span>
        </a>

        <!-- Inbox -->
        <div class="inbox-wrapper" style="position:relative;">
          <button type="button" class="nav-item" id="inboxToggle" title="Inbox" aria-haspopup="dialog" aria-expanded="false">
            <img src="{{ url_for('static', filename='nav/mail-icon.png') }}" alt="Inbox" class="nav-icon">
          </button>
          {% if inbox_unread and inbox_unread > 0 %}
            <span class="inbox-badge">{{ inbox_unread }}</span>
          {% endif %}
        </div>

        <!-- Avatar (profile hub) -->
        {% set nav_trainer_raw = session.get('trainer') %}
        {% if nav_trainer_raw is mapping %}
          {% set nav_username = nav_trainer_raw.get('username') or nav_trainer_raw.get('trainer_username') %}
        {% else %}
          {% set nav_username = nav_trainer_raw %}
        {% endif %}
        {% set nav_avatar = (current_avatar if current_avatar is defined else (avatar if avatar is defined else 'avatar1.png')) %}
        <div class="avatar-wrapper">
          <button type="button" class="nav-item" id="avatarToggle" title="Account">
            <img src="{{ url_for('static', filename='avatars/' ~ nav_avatar) }}"
                 alt="Avatar" class="nav-icon avatar-icon">
          </button>
          <div id="avatarDropdown" class="avatar-dropdown" aria-hidden="true">
            <div class="avatar-dropdown__username">{{ nav_username or 'Trainer' }}</div>
            {% if nav_username %}
            <button type="button"
                    data-trainer-profile-trigger
                    data-trainer-profile-own
                    data-trainer-profile-username="{{ nav_username }}"
                    data-trainer-profile-url="{{ url_for('api_public_trainer_profile', username=nav_username) }}"
                    data-close-avatar>
              👀 View Profile
            </button>
            {% endif %}
            <div class="sep"></div>
            <a href="{{ url_for('change_avatar') }}">👤 Customise</a>
            <button type="button" data-open-account-modal>⚙️ Manage Account</button>
            <div class="sep"></div>
            <a href="{{ url_for('logout') }}" data-confirm-logout>🚪 Log Out</a>
          </div>
        </div>
      {% endif %}
    </nav>
  </header>

  {% block page_settings %}{% endblock %}
  {% set container_class = container_class|default('') %}
  {% set _container_classes = ('container ' ~ (container_class|default('')))|trim %}
  <!-- Page content -->
  <div class="{{ _container_classes }}">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}

    {% if show_back %}
      <div style="margin-top:20px; text-align:center;">
        <a href="{{ url_for('dashboard') }}"
           style="display:inline-block; padding:10px 18px; background:var(--brand); color:#fff; border-radius:6px; text-decoration:none; font-weight:600;">
          ⬅ Back to Dashboard
        </a>
      </div>
    {% endif %}
  </div>

  <!-- GLOBAL Manage Account MODAL (available on ALL pages) -->
  {% if session.get('trainer') %}
  <div id="manageAccountModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="accountModalTitle">
      <div class="modal-header">
        <h3 id="accountModalTitle">⚙️ Manage My Account</h3>
        <button id="closeAccountModal" class="close-btn" aria-label="Close">×</button>
      </div>

      <div class="settings-section">
        <details>
          <summary>🔑 Change PIN</summary>
          <div class="settings-body">
            <form action="{{ url_for('change_pin') }}" method="post">
              <input type="password" name="old_pin" placeholder="Old PIN" required>
              <input type="text" name="memorable" placeholder="Memorable Password" required>
              <div class="pin-row">
                <input type="password" name="new_pin" id="modal_new_pin" pattern="\d{4}" maxlength="4" placeholder="New 4-digit PIN" required>
                <button type="button" onclick="togglePin('modal_new_pin', this)">Show</button>
              </div>
              <button type="submit" class="btn-primary">Update PIN</button>
            </form>
          </div>
        </details>

        <details>
          <summary>📝 Change Memorable Password</summary>
          <div class="settings-body">
            <form action="{{ url_for('change_memorable') }}" method="post">
              <input type="text" name="old_memorable" placeholder="Old Memorable" required>
              <input type="text" name="new_memorable" placeholder="New Memorable" required>
              <button type="submit" class="btn-primary">Update Memorable</button>
            </form>
          </div>
        </details>

        <details>
          <summary>🔒 Security</summary>
          <div class="settings-body">
            <p class="meta">Account type: {{ 'Standard' if account_type|lower == 'standard' else account_type }}</p>
            <form action="{{ url_for('logout_everywhere') }}" method="post" class="row-actions">
              <button type="submit" class="btn-primary">Log Out Everywhere</button>
            </form>
          </div>
        </details>

        <details>
          <summary>🔔 Notifications</summary>
          <div class="settings-body">
            <p class="meta" style="text-align:center;">
              Push notifications will be coming soon.<br>
              For now, check your 📬 <a href="{{ url_for('inbox') }}">Inbox</a> for updates.
            </p>
          </div>
        </details>

        <details>
          <summary>🗑️ Delete Account</summary>
          <div class="settings-body">
            <p class="meta" style="color:#b00;">
              ⚠️ This will permanently delete your account, including Passport stamps, profile, and prize history.
              <strong>This cannot be undone.</strong>
            </p>
            <form action="{{ url_for('delete_account') }}" method="post">
              <input type="text" name="confirm_name" placeholder="Type your trainer name to confirm" required>
              <button type="submit" class="btn-danger">Delete My Account</button>
            </form>
          </div>
        </details>
      </div>

      <div class="modal-disclaimer">
        <p>
          This is a programme run entirely by volunteers from the ‘Raiding Doncaster and Beyond’ Campfire group and is in no way affiliated with
          The Pokémon Company or Niantic. All competitions, giveaways, prize draws, passports and prize redemption are entirely free and there are no monetary gains.
          For support, please contact the RDAB admin team via the Niantic Campfire app.
        </p>
        <a class="policy-btn" href="{{ url_for('policies_index') }}">📄 View community policies</a>
      </div>
    </div>
  </div>
  {% endif %}

  {% include "partials/trainer_profile_popover.html" %}

  <div class="content-filter-modal" data-content-filter-modal hidden>
    <div class="content-filter-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="contentFilterTitle">
      <div class="content-filter-modal__halo"></div>
      <div class="content-filter-modal__body">
        <div class="content-filter-modal__icon">⚠️</div>
        <h3 class="content-filter-modal__title" id="contentFilterTitle">Hold up, Trainer!</h3>
        <p class="content-filter-modal__subtitle">We stopped this phrase to keep the community safe:</p>
        <div class="content-filter-modal__match">
          <span data-filter-severity>critical</span>
          <strong data-filter-match>phrase</strong>
        </div>
        <p class="content-filter-modal__message">
          Read the
          <a href="{{ url_for('policy_page', slug='community-standards') }}"
             target="_blank" rel="noopener">Community Standards</a> —
          our Community Code of Conduct, also known as Arceus Law. Remember
          inappropriate behaviour and language is not tolerated anywhere in RDAB.
        </p>
        <div class="content-filter-modal__actions">
          <button type="button"
                  class="content-filter-modal__close"
                  data-content-filter-dismiss>
            Ok, I understand
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Service Worker (single canonical URL) -->
  <script>
  (function () {
    if (!('serviceWorker' in navigator)) return;
    const SW_URL = '/service-worker.js?v=7';
    navigator.serviceWorker.register(SW_URL, { scope: '/' })
      .then(reg => reg.update())
      .then(() => navigator.serviceWorker.ready)
      .then(() => {
        console.log('✅ Service Worker ready');
        document.dispatchEvent(new CustomEvent('rdab-sw-ready'));
      })
      .catch(err => console.error('❌ SW failed:', err));
  })();
  </script>

  {% if account_type == "Admin" %}
  {% set admin_gate_locked = admin_gate_enabled and not admin_gate_verified %}
  <button
    type="button"
    id="admin-fab"
    class="admin-fab"
    title="Admin shortcuts"
    aria-label="Open admin shortcuts"
    aria-expanded="false"
    aria-controls="admin-quick-menu"
  >👑</button>
  <div id="admin-quick-menu-overlay" class="admin-quick-menu-overlay" hidden></div>
  <div
    id="admin-quick-menu"
    class="admin-quick-menu{% if admin_gate_locked %} admin-quick-menu--locked{% endif %}"
    data-gate-enabled="{{ 'true' if admin_gate_enabled else 'false' }}"
    data-gate-verified="{{ 'true' if admin_gate_verified else 'false' }}"
    role="dialog"
    aria-modal="true"
    aria-label="Admin quick access"
    aria-hidden="true"
    tabindex="-1"
  >
    <div class="admin-quick-menu__header">
      <div>
        <p class="admin-quick-menu__eyebrow">Admin Tools</p>
        <h3>Quick Access</h3>
      </div>
      <button type="button" id="admin-quick-menu-close" class="admin-quick-menu__close" aria-label="Close admin shortcuts">✕</button>
    </div>
    <div
      id="admin-quick-menu-gate"
      class="admin-quick-menu__gate"
      {% if not admin_gate_locked %}hidden{% endif %}
    >
      <p id="admin-quick-menu-gate-message" class="admin-quick-menu__gate-message">
        Enter the admin password to unlock your shortcuts.
      </p>
      <form id="admin-quick-menu-gate-form" class="admin-quick-menu__gate-form" autocomplete="off">
        <label class="admin-quick-menu__gate-label" for="admin-quick-password">Admin password</label>
        <div class="admin-quick-menu__gate-input">
          <input
            id="admin-quick-password"
            name="admin_password"
            type="password"
            inputmode="text"
            autocomplete="off"
            placeholder="Enter admin password"
            required
          >
          <button type="submit" class="admin-quick-menu__gate-button">Unlock</button>
        </div>
      </form>
      <p
        id="admin-quick-menu-gate-status"
        class="admin-quick-menu__gate-status"
        role="status"
        aria-live="polite"
      ></p>
    </div>
    <div class="admin-quick-menu__actions" aria-hidden="{{ 'true' if admin_gate_locked else 'false' }}">
      <a href="{{ url_for('admin_dashboard') }}" class="admin-quick-menu__action">
        <span class="admin-quick-menu__icon">👑</span>
        <span class="admin-quick-menu__label">Admin Dashboard</span>
      </a>
      <a href="{{ url_for('admin_trainers') }}" class="admin-quick-menu__action">
        <span class="admin-quick-menu__icon">👥</span>
        <span class="admin-quick-menu__label">Trainer Manager</span>
      </a>
      <a href="{{ url_for('admin_bulletin') }}" class="admin-quick-menu__action">
        <span class="admin-quick-menu__icon">📰</span>
        <span class="admin-quick-menu__label">Community Bulletin</span>
      </a>
      <a href="{{ url_for('admin_redemptions') }}" class="admin-quick-menu__action">
        <span class="admin-quick-menu__icon">🎁</span>
        <span class="admin-quick-menu__label">Redemptions Manager</span>
      </a>
      <a href="{{ url_for('admin_rdab_support') }}" class="admin-quick-menu__action">
        <span class="admin-quick-menu__icon">🆘</span>
        <span class="admin-quick-menu__label">RDAB Support</span>
      </a>
    </div>
  </div>
  <style>
    .admin-fab {
      position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px;
      background: var(--brand); color: #fff; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.6em; border: none; cursor: pointer;
      box-shadow: 0 8px 18px rgba(58,141,222,0.4);
      z-index: 4000; transition: transform 0.2s ease, background 0.2s ease;
    }
    .admin-fab:focus-visible { outline: 3px solid rgba(255,255,255,0.9); outline-offset: 3px; }
    .admin-fab:hover,
    .admin-fab:active {
      background: #2f73bb;
      transform: scale(1.08);
    }
    .admin-quick-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.5);
      z-index: 3990;
      opacity: 0;
      transition: opacity 0.25s ease;
    }
    .admin-quick-menu-overlay.is-visible {
      opacity: 1;
    }
    .admin-quick-menu {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 24px clamp(20px, 6vw, 40px) calc(24px + env(safe-area-inset-bottom));
      background: #fff;
      border-radius: 24px 24px 0 0;
      box-shadow: 0 -20px 45px rgba(15,23,42,0.25);
      transform: translateY(110%);
      transition: transform 0.28s ease;
      z-index: 4010;
      min-height: clamp(260px, 50vh, 420px);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .admin-quick-menu.is-visible {
      transform: translateY(0);
    }
    .admin-quick-menu__header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    .admin-quick-menu__eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.28em;
      font-size: 0.72rem;
      margin: 0;
      color: #94a3b8;
    }
    .admin-quick-menu__header h3 {
      margin: 4px 0 0;
    }
    .admin-quick-menu__close {
      border: none;
      background: rgba(15,23,42,0.05);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .admin-quick-menu__close:hover,
    .admin-quick-menu__close:focus-visible {
      background: rgba(15,23,42,0.1);
      outline: none;
    }
    .admin-quick-menu__actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    .admin-quick-menu--locked .admin-quick-menu__actions {
      opacity: 0.35;
      pointer-events: none;
      filter: grayscale(0.1);
    }
    .admin-quick-menu__gate {
      border: 1px dashed rgba(148,163,184,0.9);
      border-radius: 18px;
      padding: 16px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .admin-quick-menu__gate-message {
      margin: 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: #0f172a;
    }
    .admin-quick-menu__gate-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .admin-quick-menu__gate-label {
      font-size: 0.78rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 2px;
      color: #475569;
    }
    .admin-quick-menu__gate-input {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }
    .admin-quick-menu__gate-input input {
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(15,23,42,0.2);
      padding: 10px 12px;
      font-size: 1rem;
      font-family: inherit;
    }
    .admin-quick-menu__gate-button {
      border: none;
      background: var(--brand);
      color: #fff;
      border-radius: 12px;
      padding: 0 18px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .admin-quick-menu__gate-button:hover:not(:disabled) {
      background: #2f73bb;
    }
    .admin-quick-menu__gate-button:disabled {
      opacity: 0.6;
      cursor: wait;
    }
    .admin-quick-menu__gate-form.is-busy .admin-quick-menu__gate-button {
      opacity: 0.6;
      cursor: wait;
    }
    .admin-quick-menu__gate-status {
      min-height: 1.2em;
      margin: 0;
      font-size: 0.85rem;
      color: #0f172a;
    }
    .admin-quick-menu__gate-status.is-error {
      color: #b91c1c;
    }
    .admin-quick-menu__gate-status.is-success {
      color: #15803d;
    }
    .admin-quick-menu__action {
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      text-decoration: none;
      color: #0f172a;
      font-weight: 600;
      background: linear-gradient(145deg, #fff, #f8fafc);
      box-shadow: 0 12px 20px rgba(15,23,42,0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .admin-quick-menu__action:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 28px rgba(15,23,42,0.15);
    }
    .admin-quick-menu__icon {
      font-size: 1.6rem;
      line-height: 1;
    }
    .admin-quick-menu__label {
      font-size: 0.95rem;
    }
    @media(min-width: 840px) {
      .admin-quick-menu {
        left: 50%;
        width: min(520px, 90vw);
        transform: translate(-50%, 110%);
        border-radius: 28px;
      }
      .admin-quick-menu.is-visible {
        transform: translate(-50%, 0);
      }
    }
  </style>

  <script>
    (function () {
      const fab = document.getElementById("admin-fab");
      const sheet = document.getElementById("admin-quick-menu");
      const overlay = document.getElementById("admin-quick-menu-overlay");
      const closeBtn = document.getElementById("admin-quick-menu-close");
      if (!fab || !sheet || !overlay) return;

      const actions = sheet.querySelector(".admin-quick-menu__actions");
      const gateSection = document.getElementById("admin-quick-menu-gate");
      const gateForm = document.getElementById("admin-quick-menu-gate-form");
      const gateInput = document.getElementById("admin-quick-password");
      const gateStatus = document.getElementById("admin-quick-menu-gate-status");
      const gateEnabled = sheet.dataset.gateEnabled === "true";
      let gateVerified = sheet.dataset.gateVerified === "true";
      let gateStatusCache = null;
      let gateStatusLoading = false;
      let gateUnlockLoading = false;

      const setLockedState = (locked) => {
        sheet.classList.toggle("admin-quick-menu--locked", locked);
        if (actions) {
          actions.setAttribute("aria-hidden", locked ? "true" : "false");
        }
        if (gateSection) {
          gateSection.hidden = !locked;
        }
      };

      setLockedState(gateEnabled && !gateVerified);

      const updateGateStatusText = (status, options) => {
        if (!gateStatus) return;
        const opts = options || {};
        gateStatus.classList.remove("is-error", "is-success");
        if (opts.message) {
          gateStatus.textContent = opts.message;
          if (opts.variant === "error") {
            gateStatus.classList.add("is-error");
          } else if (opts.variant === "success") {
            gateStatus.classList.add("is-success");
          }
          return;
        }
        if (!status || !gateEnabled) {
          gateStatus.textContent = "";
          return;
        }
        if (status.locked && typeof status.lockout_seconds === "number") {
          const seconds = Math.max(parseInt(status.lockout_seconds, 10) || 0, 1);
          gateStatus.textContent = `Locked. Try again in ${seconds}s.`;
          gateStatus.classList.add("is-error");
          return;
        }
        if (typeof status.remaining_attempts === "number") {
          const attempts = status.remaining_attempts;
          const word = attempts === 1 ? "attempt" : "attempts";
          gateStatus.textContent = `${attempts} ${word} remaining.`;
          return;
        }
        gateStatus.textContent = "";
      };

      const applyGateStatus = (status) => {
        if (!gateEnabled) {
          gateVerified = true;
          setLockedState(false);
          updateGateStatusText(null);
          return;
        }
        if (status) {
          gateVerified = Boolean(status.verified);
          gateStatusCache = status;
        }
        setLockedState(gateEnabled && !gateVerified);
        updateGateStatusText(status || gateStatusCache || null);
      };

      const ensureGateStatus = async () => {
        if (!gateEnabled || gateVerified) {
          return gateStatusCache;
        }
        if (gateStatusLoading) {
          return gateStatusCache;
        }
        gateStatusLoading = true;
        if (gateStatus && !gateStatus.textContent) {
          updateGateStatusText(null, { message: "Checking admin lock..." });
        }
        try {
          const response = await fetch("/admin/gate/status", {
            method: "GET",
            headers: { "Accept": "application/json" },
            credentials: "same-origin",
          });
          if (!response.ok) {
            let message = "Unable to check admin lock.";
            if (response.status === 401) {
              message = "Session expired. Please log in again.";
            } else if (response.status === 403) {
              message = "Admin access required.";
            }
            updateGateStatusText(null, { message, variant: "error" });
            return null;
          }
          const status = await response.json();
          applyGateStatus(status);
          return status;
        } catch (err) {
          updateGateStatusText(null, { message: "Unable to check admin lock.", variant: "error" });
          return null;
        } finally {
          gateStatusLoading = false;
        }
      };

      if (gateForm && gateEnabled) {
        gateForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (gateUnlockLoading) {
            return;
          }
          const password = (gateInput && gateInput.value || "").trim();
          if (!password) {
            updateGateStatusText(null, { message: "Enter the admin password.", variant: "error" });
            if (gateInput) {
              gateInput.focus();
            }
            return;
          }
          gateUnlockLoading = true;
          gateForm.classList.add("is-busy");
          updateGateStatusText(null, { message: "Verifying..." });
          try {
            const response = await fetch("/admin/gate/unlock", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Accept": "application/json",
              },
              credentials: "same-origin",
              body: JSON.stringify({ admin_password: password }),
            });
            const payload = await response.json().catch(() => ({}));
            if (!response.ok || !payload.success) {
              const status = payload.status || gateStatusCache;
              if (status) {
                applyGateStatus(status);
              }
              updateGateStatusText(status, {
                message: payload.message || "Unable to unlock admin tools.",
                variant: "error",
              });
              return;
            }
            applyGateStatus(payload.status || null);
            updateGateStatusText(payload.status || null, { message: "Admin tools unlocked.", variant: "success" });
            if (gateInput) {
              gateInput.value = "";
            }
            if (actions) {
              const firstAction = actions.querySelector("a, button");
              if (firstAction) {
                window.setTimeout(() => firstAction.focus({ preventScroll: true }), 30);
              }
            }
          } catch (err) {
            updateGateStatusText(null, { message: "Unable to unlock admin tools.", variant: "error" });
          } finally {
            gateUnlockLoading = false;
            gateForm.classList.remove("is-busy");
          }
        });
      }

      let hideOverlayTimer;

      const openSheet = () => {
        if (sheet.classList.contains("is-visible")) return;
        clearTimeout(hideOverlayTimer);
        overlay.hidden = false;
        requestAnimationFrame(() => overlay.classList.add("is-visible"));
        sheet.classList.add("is-visible");
        sheet.setAttribute("aria-hidden", "false");
        fab.setAttribute("aria-expanded", "true");

        if (gateEnabled && !gateVerified) {
          if (gateInput) {
            gateInput.focus({ preventScroll: true });
          } else {
            sheet.focus({ preventScroll: true });
          }
          ensureGateStatus();
        } else {
          const focusTarget = sheet.querySelector("a, button:not(#admin-fab)");
          if (focusTarget) {
            focusTarget.focus({ preventScroll: true });
          } else {
            sheet.focus({ preventScroll: true });
          }
        }
        document.addEventListener("keydown", handleEscape);
      };

      const closeSheet = () => {
        if (!sheet.classList.contains("is-visible")) return;
        sheet.classList.remove("is-visible");
        sheet.setAttribute("aria-hidden", "true");
        fab.setAttribute("aria-expanded", "false");
        overlay.classList.remove("is-visible");
        hideOverlayTimer = window.setTimeout(() => {
          overlay.hidden = true;
        }, 220);
        document.removeEventListener("keydown", handleEscape);
        fab.focus({ preventScroll: true });
      };

      const toggleSheet = () => {
        if (sheet.classList.contains("is-visible")) {
          closeSheet();
        } else {
          openSheet();
        }
      };

      const handleEscape = (event) => {
        if (event.key === "Escape") {
          closeSheet();
        }
      };

      fab.addEventListener("click", (event) => {
        event.preventDefault();
        toggleSheet();
      });
      overlay.addEventListener("click", closeSheet);
      if (closeBtn) closeBtn.addEventListener("click", closeSheet);
    })();
  </script>

  <div id="inboxPanelOverlay" class="inbox-panel-overlay" aria-hidden="true">
    <div class="inbox-panel-dialog" role="dialog" aria-modal="true" aria-label="Trainer inbox panel">
      <div id="inboxPanelContent" class="inbox-panel-dialog__body" tabindex="-1">
        <div class="inbox-panel__loading">Loading inbox…</div>
      </div>
    </div>
  </div>

  <!-- === RDAB Session Memory === -->
<script>
  // Save last page before navigating away
  window.addEventListener('beforeunload', () => {
    const path = window.location.pathname;
    if (!['/login', '/', '/logout'].includes(path)) {
      localStorage.setItem('lastPage', path);
    }
  });

  // When the app loads (PWA or browser)
  document.addEventListener('DOMContentLoaded', () => {
    const last = localStorage.getItem('lastPage');
    const path = window.location.pathname;

    // Only auto-redirect on home or login
    if (last && (path === '/' || path === '/login')) {
      fetch('/session-check')
        .then(r => r.json())
        .then(data => {
          if (data.logged_in) {
            window.location.href = last || '/dashboard';
          }
        })
        .catch(() => {});
    }
  });
</script>

  {% endif %}
</body>
</html>
