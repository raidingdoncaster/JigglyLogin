{% extends "base.html" %}
{% block content %}
<h2 style="text-align:center; margin-bottom:1em;">Choose Your Avatar</h2>

<div style="text-align:center; margin-bottom:1.5em;">
  <img id="selected-avatar" src="{{ url_for('static', filename='avatars/' + current_avatar) }}"
       alt="Selected Avatar" style="width:80px; height:80px; border-radius:50%; border:3px solid #3a8dde;">
  <p style="margin-top:0.5em; font-size:0.9em; color:#555;">Your current avatar</p>
</div>

<form id="avatar-form" action="{{ url_for('change_avatar') }}" method="post"
      style="display:flex; flex-wrap:wrap; justify-content:center; gap:20px;">
  {% for icon in avatars %}
  <label class="avatar-option">
    <input type="radio" name="avatar_choice" value="{{ icon }}" {% if icon == current_avatar %}checked{% endif %}>
    <img src="{{ url_for('static', filename='avatars/' + icon) }}" alt="Avatar" class="avatar-img">
  </label>
  {% endfor %}
  <button type="submit" style="margin-top:20px; padding:10px 20px; background:#3a8dde; color:white; border:none; border-radius:6px; cursor:pointer;">
    Save Avatar
  </button>
</form>

<p style="text-align:center; margin-top:1em;"><a href="{{ url_for('dashboard') }}">⬅️ Back to Dashboard</a></p>

<style>
.avatar-option input[type="radio"] { display:none; }
.avatar-img {
  width:64px; height:64px; border-radius:50%; border:2px solid #ccc; cursor:pointer;
  transition:transform 0.2s, border 0.2s;
}
.avatar-option input[type="radio"]:checked + .avatar-img {
  border:2px solid #3a8dde; transform:scale(1.05);
}
</style>

<script>
document.getElementById("avatar-form").addEventListener("submit", function(e) {
  e.preventDefault();
  const formData = new FormData(this);

  fetch("{{ url_for('change_avatar') }}", {
    method: "POST",
    body: formData,
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      // ✅ Update preview on THIS page
      document.getElementById("selected-avatar").src = "/static/avatars/" + data.avatar;

      // ✅ Update dashboard avatar (if dashboard is open in another tab)
      const openerAvatar = window.opener?.document.getElementById("dashboard-avatar");
      if (openerAvatar) {
        openerAvatar.src = "/static/avatars/" + data.avatar;
      }

      alert("✅ Avatar updated successfully!");
    }
  });
});
</script>
{% endblock %}