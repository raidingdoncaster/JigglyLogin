{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-fluid' %}
{% endblock %}

{% block content %}
<section class="customizer-shell">
  <form id="customizer-form" class="customizer-card" action="{{ url_for('change_avatar') }}" method="post" novalidate>
    <header class="customizer-header">
      <div>
        <p class="customizer-eyebrow">RDAB Custom Lab</p>
        <h1>Personalise Your RDAB Experience</h1>
        <p>Swap avatars, trainer card backgrounds, and passport themes with a single tap. Every choice saves instantly.</p>
      </div>
      <button type="button"
              class="customizer-help-btn"
              id="customizer-help-button"
              aria-haspopup="dialog"
              aria-controls="customizer-help-dialog"
              aria-expanded="false">
        <span class="sr-only">How does customisation work?</span>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2a10 10 0 1 0 10 10A10.012 10.012 0 0 0 12 2Zm0 15a1.25 1.25 0 1 1 1.25-1.25A1.25 1.25 0 0 1 12 17Zm1.66-5.81-.71.72A1.77 1.77 0 0 0 12.53 13H11v-.38a3.37 3.37 0 0 1 1-2.4l1-1a1.37 1.37 0 0 0 .42-1 1.42 1.42 0 0 0-2.84 0H8.86a3.14 3.14 0 0 1 6.28 0 3 3 0 0 1-.48 1.59Z"/>
        </svg>
      </button>
    </header>

    <div class="customizer-preview">
      <div class="preview-avatar-card">
        <div class="preview-avatar-frame">
          <img src="{{ url_for('static', filename='avatars/' + current_avatar) }}"
               alt="Current avatar"
               data-preview-avatar>
        </div>
        <p class="preview-label">Trainer Icon</p>
      </div>
      <div class="preview-meta">
        <div class="preview-row">
          <p class="preview-label">Trainer Card Background</p>
          <div class="preview-background"
               data-preview-background
               style="background-image: url('{{ url_for('static', filename='backgrounds/' + current_background) }}');">
            <span data-preview-background-label>{{ current_background }}</span>
          </div>
        </div>
        <div class="preview-row">
          <p class="preview-label">Passport Theme</p>
          <div class="preview-theme" data-preview-theme>{{ current_passport_theme_data.label }}</div>
        </div>
      </div>
    </div>

    <div class="customizer-status" data-customizer-status role="status" aria-live="polite">
      Tap an option to save instantly.
    </div>

    <div class="customizer-tabs" role="tablist">
      <button type="button"
              class="customizer-tab is-active"
              id="tab-avatars"
              data-customizer-tab="avatars"
              data-tab-index="0"
              role="tab"
              aria-controls="panel-avatars"
              aria-selected="true">
        Avatars
      </button>
      <button type="button"
              class="customizer-tab"
              id="tab-backgrounds"
              data-customizer-tab="backgrounds"
              data-tab-index="1"
              role="tab"
              aria-controls="panel-backgrounds"
              aria-selected="false">
        Backgrounds
      </button>
      <button type="button"
              class="customizer-tab"
              id="tab-themes"
              data-customizer-tab="themes"
              data-tab-index="2"
              role="tab"
              aria-controls="panel-themes"
              aria-selected="false">
        Passport Themes
      </button>
      <span class="customizer-tabs__glider" aria-hidden="true"></span>
    </div>

    {% set avatar_pages = avatars|batch(8, None) %}
    {% set background_pages = backgrounds|batch(6, None) %}
    {% set theme_pages = passport_themes|batch(3, None) %}

    <div class="customizer-panels">
      <section class="customizer-panel is-active"
               id="panel-avatars"
               role="tabpanel"
               aria-labelledby="tab-avatars"
               data-customizer-panel="avatars">
        <div class="carousel" data-carousel="avatars">
          <div class="carousel-track">
            {% for page in avatar_pages %}
              <div class="carousel-page">
                <div class="option-grid option-grid--avatars">
                  {% for icon in page %}
                    {% if icon %}
                      {% set avatar_id = 'avatar-' ~ loop.parent.index0 ~ '-' ~ loop.index0 %}
                      <label class="option-card"
                             for="{{ avatar_id }}">
                        <input type="radio"
                               id="{{ avatar_id }}"
                               name="avatar_choice"
                               value="{{ icon }}"
                               {% if icon == current_avatar %}checked{% endif %}
                               data-customizer-input>
                        <span class="option-visual">
                          <img src="{{ url_for('static', filename='avatars/' + icon) }}"
                               alt="Select {{ icon|replace('.png','') }}">
                        </span>
                        <span class="option-label">{{ icon|replace('.png','')|replace('_',' ')|title }}</span>
                      </label>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
          <button type="button" class="carousel-nav prev" data-carousel-prev aria-label="Previous avatars">
            <span aria-hidden="true">‹</span>
          </button>
          <button type="button" class="carousel-nav next" data-carousel-next aria-label="Next avatars">
            <span aria-hidden="true">›</span>
          </button>
          <div class="carousel-footer">
            <p class="carousel-progress" data-carousel-progress>Page 1 of {{ avatar_pages|length }}</p>
            <div class="carousel-dots" data-carousel-dots></div>
          </div>
        </div>
      </section>

      <section class="customizer-panel"
               id="panel-backgrounds"
               role="tabpanel"
               aria-labelledby="tab-backgrounds"
               data-customizer-panel="backgrounds"
               hidden>
        <div class="carousel" data-carousel="backgrounds">
          <div class="carousel-track">
            {% for page in background_pages %}
              <div class="carousel-page">
                <div class="option-grid option-grid--backgrounds">
                  {% for bg in page %}
                    {% if bg %}
                      {% set bg_id = 'bg-' ~ loop.parent.index0 ~ '-' ~ loop.index0 %}
                      <label class="option-card option-card--background"
                             for="{{ bg_id }}">
                        <input type="radio"
                               id="{{ bg_id }}"
                               name="background_choice"
                               value="{{ bg }}"
                               {% if bg == current_background %}checked{% endif %}
                               data-customizer-input>
                        <span class="option-visual"
                              style="background-image: url('{{ url_for('static', filename='backgrounds/' + bg) }}');"
                              aria-hidden="true"></span>
                        <span class="option-label">{{ bg }}</span>
                      </label>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
          <button type="button" class="carousel-nav prev" data-carousel-prev aria-label="Previous backgrounds">
            <span aria-hidden="true">‹</span>
          </button>
          <button type="button" class="carousel-nav next" data-carousel-next aria-label="Next backgrounds">
            <span aria-hidden="true">›</span>
          </button>
          <div class="carousel-footer">
            <p class="carousel-progress" data-carousel-progress>Page 1 of {{ background_pages|length }}</p>
            <div class="carousel-dots" data-carousel-dots></div>
          </div>
        </div>
      </section>

      <section class="customizer-panel"
               id="panel-themes"
               role="tabpanel"
               aria-labelledby="tab-themes"
               data-customizer-panel="themes"
               hidden>
        <div class="carousel" data-carousel="themes">
          <div class="carousel-track">
            {% for page in theme_pages %}
              <div class="carousel-page">
                <div class="option-grid option-grid--themes">
                  {% for theme in page %}
                    {% if theme %}
                      <label class="option-card option-card--theme"
                             for="theme-{{ theme.slug }}">
                        <input type="radio"
                               id="theme-{{ theme.slug }}"
                               name="passport_theme_choice"
                               value="{{ theme.slug }}"
                               {% if theme.slug == current_passport_theme %}checked{% endif %}
                               data-customizer-input>
                        {% set colors = theme.preview_colors or [] %}
                        {% if colors|length >= 2 %}
                          {% set gradient = 'linear-gradient(135deg, ' ~ colors[0] ~ ', ' ~ colors[1] ~ ')' %}
                        {% else %}
                          {% set gradient = colors[0] if colors|length == 1 else '#475569' %}
                        {% endif %}
                        <span class="option-visual" style="background: {{ gradient }};"></span>
                        <span class="option-label">
                          <strong>{{ theme.label }}</strong>
                          <small>{{ theme.description }}</small>
                        </span>
                      </label>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            {% endfor %}
          </div>
          <button type="button" class="carousel-nav prev" data-carousel-prev aria-label="Previous themes">
            <span aria-hidden="true">‹</span>
          </button>
          <button type="button" class="carousel-nav next" data-carousel-next aria-label="Next themes">
            <span aria-hidden="true">›</span>
          </button>
          <div class="carousel-footer">
            <p class="carousel-progress" data-carousel-progress>Page 1 of {{ theme_pages|length }}</p>
            <div class="carousel-dots" data-carousel-dots></div>
          </div>
        </div>
      </section>
    </div>

    <noscript>
      <div class="customizer-noscript">
        <p>JavaScript is disabled. Make your selections and press save.</p>
        <button type="submit" class="auth-btn auth-btn--primary">Save selections</button>
      </div>
    </noscript>
  </form>
</section>

<div class="customizer-help-modal"
     id="customizer-help-dialog"
     role="dialog"
     aria-modal="true"
     aria-labelledby="customizer-help-title"
     hidden>
  <div class="customizer-help-card" tabindex="-1">
    <button type="button" class="customizer-help-close" data-close-help aria-label="Close help">✕</button>
    <h3 id="customizer-help-title">Your customisation hub</h3>
    <p>Here’s where you come to change your avatar icon, trainer card background, passport theme and more! Soon you’ll be able to unlock new customisation features by levelling up your community medals - stay tuned!</p>
  </div>
</div>

<style>
.sr-only {
  position:absolute;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}
.customizer-shell {
  padding:20px 0 40px;
}
.customizer-card {
  background:#fdfdff;
  border-radius:28px;
  padding:28px;
  box-shadow:0 24px 60px rgba(15,23,42,0.18);
  max-width:1100px;
  margin:0 auto;
  display:flex;
  flex-direction:column;
  gap:22px;
}
.customizer-header {
  display:flex;
  justify-content:space-between;
  gap:16px;
  flex-wrap:wrap;
}
.customizer-eyebrow {
  margin:0 0 6px;
  text-transform:uppercase;
  letter-spacing:0.12em;
  font-size:0.78rem;
  color:#475569;
}
.customizer-header h1 {
  margin:0;
  font-size:1.7rem;
  color:#0f172a;
}
.customizer-header p {
  margin:8px 0 0;
  color:#475569;
}
.customizer-help-btn {
  width:44px;
  height:44px;
  border-radius:50%;
  border:none;
  background:#e0ecff;
  color:#1d4ed8;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  box-shadow:0 10px 24px rgba(30,64,175,0.22);
  transition:transform 0.2s ease, box-shadow 0.2s ease;
}
.customizer-help-btn:hover,
.customizer-help-btn:focus-visible {
  transform:translateY(-2px) scale(1.02);
  box-shadow:0 16px 30px rgba(30,64,175,0.28);
}
.customizer-help-btn svg {
  width:22px;
  height:22px;
  fill:currentColor;
}
.customizer-preview {
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  background:linear-gradient(135deg, #f8fbff, #eef2ff);
  border-radius:24px;
  padding:20px;
  border:1px solid rgba(148,163,184,0.35);
}
.preview-avatar-card {
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:center;
  justify-content:center;
}
.preview-avatar-frame {
  width:110px;
  height:110px;
  border-radius:50%;
  border:4px solid rgba(59,130,246,0.4);
  padding:4px;
  background:#fff;
  box-shadow:0 20px 35px rgba(15,23,42,0.15);
}
.preview-avatar-frame img {
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:50%;
}
.preview-meta {
  flex:1;
  display:flex;
  gap:16px;
  flex-wrap:wrap;
}
.preview-row {
  flex:1;
  min-width:220px;
}
.preview-label {
  margin:0 0 6px;
  font-weight:600;
  color:#0f172a;
  font-size:0.9rem;
}
.preview-background {
  border-radius:16px;
  min-height:90px;
  background-size:cover;
  background-position:center;
  display:flex;
  align-items:flex-end;
  padding:10px 14px;
  font-weight:600;
  color:#fff;
  text-shadow:0 4px 12px rgba(0,0,0,0.35);
}
.preview-theme {
  border-radius:999px;
  padding:8px 16px;
  background:#1e3a8a;
  color:#e0f2ff;
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-weight:600;
  box-shadow:0 12px 22px rgba(30,58,138,0.25);
}
.customizer-status {
  border-radius:14px;
  padding:10px 14px;
  background:#e0f2ff;
  color:#0f172a;
  font-weight:500;
}
.customizer-status.is-pending {
  background:#fef3c7;
  color:#92400e;
}
.customizer-status.is-error {
  background:#fee2e2;
  color:#991b1b;
}
.customizer-tabs {
  position:relative;
  display:flex;
  gap:10px;
  border-radius:999px;
  background:#f1f5f9;
  padding:6px;
  overflow:hidden;
}
.customizer-tab {
  flex:1;
  border:none;
  background:none;
  border-radius:999px;
  padding:10px 12px;
  font-weight:600;
  color:#475569;
  cursor:pointer;
  position:relative;
  transition:color 0.2s ease;
}
.customizer-tab.is-active {
  color:#0f172a;
}
.customizer-tabs__glider {
  position:absolute;
  top:6px;
  bottom:6px;
  width:33%;
  border-radius:999px;
  background:#fff;
  box-shadow:0 10px 30px rgba(15,23,42,0.12);
  transition:transform 0.3s ease, width 0.3s ease;
}
.customizer-panels {
  position:relative;
}
.customizer-panel {
  transition:opacity 0.25s ease;
}
.customizer-panel[hidden] {
  display:none;
}
.customizer-panel:not(.is-active) {
  opacity:0;
  pointer-events:none;
}
.carousel {
  position:relative;
}
.carousel-track {
  display:flex;
  transition:transform 0.45s cubic-bezier(0.22, 0.61, 0.36, 1);
  will-change:transform;
  touch-action:pan-y;
}
.carousel-page {
  min-width:100%;
  padding:10px 4px;
}
.option-grid {
  display:grid;
  gap:14px;
}
.option-grid--avatars {
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
}
.option-grid--backgrounds {
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
}
.option-grid--themes {
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
}
.option-card {
  position:relative;
  border-radius:18px;
  padding:14px;
  background:#fff;
  border:1px solid rgba(148,163,184,0.35);
  box-shadow:0 16px 35px rgba(15,23,42,0.08);
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
  transition:transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
}
.option-card input {
  position:absolute;
  opacity:0;
  pointer-events:none;
}
.option-card .option-visual img {
  width:70px;
  height:70px;
  border-radius:50%;
  object-fit:cover;
  border:3px solid rgba(59,130,246,0.45);
}
.option-card--background .option-visual {
  width:100%;
  height:90px;
  border-radius:12px;
  background-size:cover;
  background-position:center;
  border:2px solid rgba(255,255,255,0.6);
  box-shadow:inset 0 0 0 1px rgba(15,23,42,0.1);
}
.option-card--theme .option-visual {
  width:100%;
  height:80px;
  border-radius:14px;
  box-shadow:0 12px 20px rgba(15,23,42,0.12);
}
.option-label {
  text-align:center;
  font-weight:600;
  color:#0f172a;
  font-size:0.9rem;
}
.option-card--theme .option-label {
  display:flex;
  flex-direction:column;
  gap:4px;
}
.option-card--theme small {
  font-weight:400;
  color:#475569;
}
.option-card.is-selected {
  border-color:#2563eb;
  box-shadow:0 18px 40px rgba(37,99,235,0.25);
  transform:translateY(-2px);
}
.carousel-nav {
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  width:42px;
  height:42px;
  border-radius:50%;
  border:none;
  background:#fff;
  box-shadow:0 10px 25px rgba(15,23,42,0.18);
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:1.4rem;
  color:#0f172a;
}
.carousel-nav.prev { left:-10px; }
.carousel-nav.next { right:-10px; }
.carousel-nav.is-disabled {
  opacity:0.35;
  pointer-events:none;
}
.carousel-footer {
  margin-top:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:8px;
}
.carousel-progress {
  margin:0;
  font-size:0.85rem;
  color:#475569;
}
.carousel-dots {
  display:flex;
  gap:6px;
}
.carousel-dot {
  width:10px;
  height:10px;
  border-radius:50%;
  border:none;
  background:rgba(148,163,184,0.6);
  cursor:pointer;
  padding:0;
}
.carousel-dot.is-active {
  background:#2563eb;
  transform:scale(1.2);
}
.customizer-noscript {
  margin-top:12px;
  padding:12px;
  border-radius:12px;
  background:#fff4de;
  border:1px solid #fed7aa;
}
.customizer-help-modal {
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
  z-index:1200;
}
.customizer-help-modal[hidden] {
  display:none;
}
.customizer-help-card {
  max-width:420px;
  width:100%;
  background:#fff;
  border-radius:20px;
  padding:24px;
  box-shadow:0 24px 60px rgba(15,23,42,0.25);
  position:relative;
  border:1px solid rgba(148,163,184,0.35);
}
.customizer-help-card h3 {
  margin-top:0;
  color:#0f172a;
}
.customizer-help-card p {
  margin-bottom:0;
  color:#475569;
}
.customizer-help-close {
  position:absolute;
  top:12px;
  right:12px;
  border:none;
  background:rgba(15,23,42,0.08);
  border-radius:50%;
  width:32px;
  height:32px;
  cursor:pointer;
}
@media (max-width: 820px) {
  .carousel-nav.prev { left:0; }
  .carousel-nav.next { right:0; }
  .customizer-card {
    padding:22px;
  }
  .customizer-tabs__glider {
    display:none;
  }
  .customizer-tab {
    background:#fff;
    border:1px solid transparent;
  }
  .customizer-tab.is-active {
    border-color:#2563eb;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const customizerEndpoint = "{{ url_for('change_avatar') }}";
  const form = document.getElementById("customizer-form");
  const previewAvatar = document.querySelector("[data-preview-avatar]");
  const previewBackground = document.querySelector("[data-preview-background]");
  const previewBackgroundLabel = document.querySelector("[data-preview-background-label]");
  const previewTheme = document.querySelector("[data-preview-theme]");
  const statusBadge = document.querySelector("[data-customizer-status]");
  const tabs = document.querySelectorAll("[data-customizer-tab]");
  const panels = document.querySelectorAll("[data-customizer-panel]");
  const glider = document.querySelector(".customizer-tabs__glider");
  const helpButton = document.getElementById("customizer-help-button");
  const helpDialog = document.getElementById("customizer-help-dialog");
  const helpClose = document.querySelector("[data-close-help]");
  const selectionInputs = document.querySelectorAll("[data-customizer-input]");

  const assetRoots = {{ {
    "avatars": url_for('static', filename='avatars') + "/",
    "backgrounds": url_for('static', filename='backgrounds') + "/"
  } | tojson }};
  const initialState = {{ {
    "avatar": current_avatar,
    "background": current_background,
    "theme": current_passport_theme,
    "themeLabel": current_passport_theme_data.label,
  } | tojson }};
  const themeLookup = Object.fromEntries({{ passport_themes | tojson }}.map(theme => [theme.slug, theme.label]));

  let activeTab = "avatars";
  let saving = false;
  let pendingUpdate = null;
  let lastActiveButton = tabs[0] || null;

  form?.addEventListener("submit", (event) => {
    event.preventDefault();
  });

  function positionGlider(target) {
    if (!glider || !target) return;
    const rect = target.getBoundingClientRect();
    const parentRect = target.parentElement.getBoundingClientRect();
    glider.style.width = `${rect.width}px`;
    glider.style.transform = `translateX(${rect.left - parentRect.left}px)`;
  }

  function activateTab(tabName) {
    activeTab = tabName;
    tabs.forEach((tab) => {
      const isActive = tab.dataset.customizerTab === tabName;
      tab.classList.toggle("is-active", isActive);
      tab.setAttribute("aria-selected", isActive ? "true" : "false");
      if (isActive) {
        lastActiveButton = tab;
      }
    });
    panels.forEach((panel) => {
      const isActive = panel.dataset.customizerPanel === tabName;
      panel.classList.toggle("is-active", isActive);
      panel.hidden = !isActive;
    });
    positionGlider(lastActiveButton);
  }

  tabs.forEach((tab) => {
    tab.addEventListener("click", () => activateTab(tab.dataset.customizerTab));
  });

  window.addEventListener("resize", () => positionGlider(lastActiveButton));
  positionGlider(lastActiveButton);

  function updateStatus(message, variant = "info") {
    if (!statusBadge) return;
    statusBadge.textContent = message;
    statusBadge.classList.remove("is-pending", "is-error");
    if (variant === "pending") {
      statusBadge.classList.add("is-pending");
    } else if (variant === "error") {
      statusBadge.classList.add("is-error");
    }
  }

  function applyPreview(field, value) {
    if (field === "avatar_choice" && previewAvatar) {
      previewAvatar.src = assetRoots.avatars + value;
    } else if (field === "background_choice") {
      if (previewBackground) {
        previewBackground.style.backgroundImage = `url(${assetRoots.backgrounds + value})`;
      }
      if (previewBackgroundLabel) {
        previewBackgroundLabel.textContent = value;
      }
    } else if (field === "passport_theme_choice" && previewTheme) {
      previewTheme.textContent = themeLookup[value] || previewTheme.textContent;
    }
  }

  async function sendUpdate(field, value) {
    const formData = new FormData();
    formData.append(field, value);
    const response = await fetch(customizerEndpoint, {
      method: "POST",
      body: formData,
      headers: { "X-Requested-With": "XMLHttpRequest" },
    });

    if (!response.ok) {
      const errorPayload = await response.json().catch(() => ({}));
      throw new Error(errorPayload.error || "Unable to save your changes right now.");
    }
    const payload = await response.json();
    if (!payload.success) {
      throw new Error(payload.error || "Unable to save your changes right now.");
    }
    return payload;
  }

  async function processQueue() {
    if (!pendingUpdate || saving) return;
    saving = true;
    updateStatus("Saving your look…", "pending");

    const { field, value } = pendingUpdate;
    pendingUpdate = null;

    try {
      const data = await sendUpdate(field, value);
      if (previewAvatar && data.avatar) {
        previewAvatar.src = assetRoots.avatars + data.avatar;
      }
      if (previewBackground && data.background) {
        previewBackground.style.backgroundImage = `url(${assetRoots.backgrounds + data.background})`;
      }
      if (previewBackgroundLabel && data.background) {
        previewBackgroundLabel.textContent = data.background;
      }
      if (previewTheme && data.passport_theme_label) {
        previewTheme.textContent = data.passport_theme_label;
      }
      updateStatus("Saved! ✨");
    } catch (error) {
      updateStatus(error.message, "error");
    } finally {
      saving = false;
      if (pendingUpdate) {
        processQueue();
      }
    }
  }

  function queueUpdate(field, value) {
    pendingUpdate = { field, value };
    processQueue();
  }

  function syncOptionStates() {
    document.querySelectorAll(".option-card").forEach((card) => {
      const input = card.querySelector("input");
      card.classList.toggle("is-selected", Boolean(input?.checked));
    });
  }

  selectionInputs.forEach((input) => {
    input.addEventListener("change", () => {
      syncOptionStates();
      applyPreview(input.name, input.value);
      queueUpdate(input.name, input.value);
    });
  });
  syncOptionStates();

  document.querySelectorAll("[data-carousel]").forEach(initCarousel);

  function initCarousel(wrapper) {
    const track = wrapper.querySelector(".carousel-track");
    const pages = wrapper.querySelectorAll(".carousel-page");
    const prevBtn = wrapper.querySelector("[data-carousel-prev]");
    const nextBtn = wrapper.querySelector("[data-carousel-next]");
    const progress = wrapper.querySelector("[data-carousel-progress]");
    const dotsContainer = wrapper.querySelector("[data-carousel-dots]");
    const totalPages = pages.length || 1;
    let index = 0;

    function updateUI() {
      if (track) {
        track.style.transform = `translateX(-${index * 100}%)`;
      }
      const disablePrev = index === 0;
      const disableNext = index >= totalPages - 1;
      if (prevBtn) {
        prevBtn.classList.toggle("is-disabled", disablePrev);
        prevBtn.setAttribute("aria-disabled", disablePrev);
      }
      if (nextBtn) {
        nextBtn.classList.toggle("is-disabled", disableNext);
        nextBtn.setAttribute("aria-disabled", disableNext);
      }
      if (progress) {
        progress.textContent = `Page ${index + 1} of ${totalPages}`;
      }
      if (dotsContainer) {
        dotsContainer.querySelectorAll(".carousel-dot").forEach((dot, dotIndex) => {
          dot.classList.toggle("is-active", dotIndex === index);
        });
      }
    }

    function goTo(newIndex) {
      index = Math.max(0, Math.min(totalPages - 1, newIndex));
      updateUI();
    }

    if (prevBtn) prevBtn.addEventListener("click", () => goTo(index - 1));
    if (nextBtn) nextBtn.addEventListener("click", () => goTo(index + 1));

    if (dotsContainer) {
      dotsContainer.innerHTML = "";
      pages.forEach((_page, dotIndex) => {
        const dot = document.createElement("button");
        dot.type = "button";
        dot.className = "carousel-dot";
        dot.setAttribute("aria-label", `Go to page ${dotIndex + 1}`);
        dot.addEventListener("click", () => goTo(dotIndex));
        dotsContainer.appendChild(dot);
      });
    }

    let pointerActive = false;
    let pointerStartX = 0;

    function onPointerDown(event) {
      pointerActive = true;
      pointerStartX = event.clientX;
      event.currentTarget.setPointerCapture?.(event.pointerId);
    }

    function onPointerUp(event) {
      if (!pointerActive) return;
      const delta = event.clientX - pointerStartX;
      if (Math.abs(delta) > 40) {
        goTo(delta < 0 ? index + 1 : index - 1);
      }
      pointerActive = false;
      event.currentTarget.releasePointerCapture?.(event.pointerId);
    }

    track?.addEventListener("pointerdown", onPointerDown);
    track?.addEventListener("pointerup", onPointerUp);
    track?.addEventListener("pointercancel", () => { pointerActive = false; });

    updateUI();
  }

  function openHelp() {
    if (!helpDialog) return;
    helpDialog.hidden = false;
    helpDialog.querySelector(".customizer-help-card")?.focus();
    helpButton?.setAttribute("aria-expanded", "true");
  }

  function closeHelp() {
    if (!helpDialog) return;
    helpDialog.hidden = true;
    helpButton?.setAttribute("aria-expanded", "false");
    helpButton?.focus();
  }

  helpButton?.addEventListener("click", openHelp);
  helpClose?.addEventListener("click", closeHelp);
  helpDialog?.addEventListener("click", (event) => {
    if (event.target === helpDialog) {
      closeHelp();
    }
  });
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && helpDialog && !helpDialog.hidden) {
      closeHelp();
    }
  });
});
</script>
{% endblock %}
