{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-cozy' %}
{% endblock %}

{% block content %}
<h2 style="text-align:center; margin-bottom:1em;">Customize Your Trainer Card</h2>

<!-- Current preview -->
<div style="text-align:center; margin-bottom:1.5em;">
  <div style="display:inline-block; padding:15px; border-radius:12px; background:#f4f7fa;">
    <img id="selected-avatar"
         src="{{ url_for('static', filename='avatars/' + current_avatar) }}"
         alt="Avatar"
         style="width:80px; height:80px; border-radius:50%; border:3px solid #3a8dde;">
    <p style="margin:0.5em 0 0; font-size:0.9em; color:#555;">Current Avatar</p>
    {% if current_background %}
      <p style="font-size:0.85em; color:#777;" data-current-background>Background: {{ current_background }}</p>
    {% endif %}
    <p style="font-size:0.85em; color:#777;" data-current-passport-theme>
      Passport Theme: {{ current_passport_theme_data.label }}
    </p>
  </div>
</div>

<!-- Tabs -->
<div class="tab-buttons">
  <button type="button" class="tab-btn active" data-tab="avatars">Avatars</button>
  <button type="button" class="tab-btn" data-tab="backgrounds">Backgrounds</button>
  <button type="button" class="tab-btn" data-tab="passport-themes">Passport Themes</button>
</div>

<form id="appearance-form" action="{{ url_for('change_avatar') }}" method="post">
  <!-- Avatars -->
  <div class="tab-content active" id="avatars">
    <div class="grid">
      {% for icon in avatars %}
      <label class="option">
        <input type="radio" name="avatar_choice" value="{{ icon }}"
               {% if icon == current_avatar %}checked{% endif %}>
        <img src="{{ url_for('static', filename='avatars/' + icon) }}" alt="Avatar">
      </label>
      {% endfor %}
    </div>
  </div>

  <!-- Backgrounds -->
  <div class="tab-content" id="backgrounds">
    <div class="grid">
      {% for bg in backgrounds %}
      <label class="option">
        <input type="radio" name="background_choice" value="{{ bg }}"
               {% if bg == current_background %}checked{% endif %}>
        <img src="{{ url_for('static', filename='backgrounds/' + bg) }}" alt="Background"
             style="border-radius:8px; width:100px; height:60px; object-fit:cover;">
      </label>
      {% endfor %}
    </div>
  </div>

  <!-- Passport Themes -->
  <div class="tab-content" id="passport-themes">
    <div class="theme-grid">
      {% for theme in passport_themes %}
      {% set colors = theme.preview_colors or [] %}
      {% if colors|length == 0 %}
        {% set gradient = '#94a3b8' %}
      {% elif colors|length == 1 %}
        {% set gradient = colors[0] %}
      {% else %}
        {% set gradient = 'linear-gradient(135deg, ' ~ colors[0] ~ ', ' ~ colors[1] ~ ')' %}
      {% endif %}
      <label class="theme-option">
        <input type="radio"
               name="passport_theme_choice"
               value="{{ theme.slug }}"
               {% if theme.slug == current_passport_theme %}checked{% endif %}>
        <span class="theme-preview" style="background: {{ gradient }};"></span>
        <div class="theme-copy">
          <strong>{{ theme.label }}</strong>
          <p>{{ theme.description }}</p>
        </div>
      </label>
      {% endfor %}
    </div>
  </div>

  <div style="text-align:center; margin-top:20px;">
    <button type="submit" class="auth-btn auth-btn--primary">Save Changes</button>
  </div>
</form>

<p style="text-align:center; margin-top:1em;">
  <a href="{{ url_for('dashboard') }}">⬅️ Back to Dashboard</a>
</p>

<style>
.tab-buttons {
  display:flex;
  justify-content:center;
  margin-bottom:15px;
  gap:10px;
}
.tab-btn {
  padding:8px 16px;
  border:none;
  border-radius:6px;
  background:#eee;
  cursor:pointer;
  font-weight:600;
}
.tab-btn.active { background:#3a8dde; color:white; }

.tab-content { display:none; }
.tab-content.active { display:block; }

.grid {
  display:flex;
  flex-wrap:wrap;
  gap:15px;
  justify-content:center;
}
.option input[type="radio"] { display:none; }
.option img {
  width:64px; height:64px; border-radius:50%;
  border:2px solid #ccc;
  cursor:pointer;
  transition:transform 0.2s, border 0.2s, box-shadow 0.2s;
}
.option input[type="radio"]:checked + img {
  border:2px solid #3a8dde;
  box-shadow:0 6px 16px rgba(58,141,222,0.25);
  transform:scale(1.05);
}
.theme-grid {
  display:flex;
  flex-direction:column;
  gap:12px;
}
.theme-option {
  display:flex;
  align-items:center;
  gap:14px;
  border:1px solid #d4d8e0;
  border-radius:14px;
  padding:12px 14px;
  cursor:pointer;
  transition:border 0.2s, box-shadow 0.2s, transform 0.2s;
}
.theme-option input[type="radio"] {
  display:none;
}
.theme-option strong {
  display:block;
  font-size:1rem;
  color:#1e293b;
}
.theme-option p {
  margin:2px 0 0;
  font-size:0.85rem;
  color:#475569;
}
.theme-preview {
  width:56px;
  height:56px;
  border-radius:12px;
  box-shadow:0 8px 18px rgba(0,0,0,0.12);
  border:2px solid rgba(255,255,255,0.35);
}
.theme-option.selected {
  border-color:#3a8dde;
  box-shadow:0 10px 18px rgba(58,141,222,0.2);
  transform:translateY(-1px);
}
.theme-option.selected .theme-preview {
  border-color:#3a8dde;
  box-shadow:0 12px 24px rgba(58,141,222,0.25);
}
.theme-option.selected strong {
  color:#0f4597;
}
.theme-copy {
  flex:1;
}
</style>

<script>
const tabButtons = document.querySelectorAll(".tab-btn");
const tabPanels = document.querySelectorAll(".tab-content");
const appearanceForm = document.getElementById("appearance-form");
const selectedAvatar = document.getElementById("selected-avatar");
const currentBackgroundLabel = document.querySelector("[data-current-background]");
const currentThemeLabel = document.querySelector("[data-current-passport-theme]");
const themeRadios = document.querySelectorAll("input[name='passport_theme_choice']");

// Tabs
tabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    tabPanels.forEach(panel => panel.classList.remove("active"));
    btn.classList.add("active");
    const target = document.getElementById(btn.dataset.tab);
    if (target) {
      target.classList.add("active");
    }
  });
});

// Theme card highlight
function syncThemeCards() {
  document.querySelectorAll(".theme-option").forEach(option => option.classList.remove("selected"));
  themeRadios.forEach(radio => {
    if (radio.checked) {
      const option = radio.closest(".theme-option");
      if (option) {
        option.classList.add("selected");
      }
    }
  });
}
themeRadios.forEach(radio => radio.addEventListener("change", syncThemeCards));
syncThemeCards();

// AJAX submit
appearanceForm.addEventListener("submit", function(e) {
  e.preventDefault();
  const formData = new FormData(this);

  fetch("{{ url_for('change_avatar') }}", {
    method: "POST",
    body: formData,
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      throw new Error("Unable to update appearance right now.");
    }
    if (selectedAvatar) {
      selectedAvatar.src = "/static/avatars/" + data.avatar;
    }
    if (currentBackgroundLabel) {
      currentBackgroundLabel.textContent = "Background: " + data.background;
    }
    if (currentThemeLabel && data.passport_theme_label) {
      currentThemeLabel.textContent = "Passport Theme: " + data.passport_theme_label;
    }
    alert("✅ Appearance updated!");
  })
  .catch(() => {
    alert("⚠️ Something went wrong while saving. Please try again.");
  });
});
</script>
{% endblock %}
