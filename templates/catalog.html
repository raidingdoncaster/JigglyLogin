{% extends "base.html" %}
{% block content %}

<style>
/* =============== GLOBAL TWEAKS & SPACING =============== */
:root{
  --blue:#3a8dde;
  --sky:#e9f0ff;
  --card:#ffffff;
  --ink:#0b213d;
  --muted:#6b7280;
  --chip:#eef2ff;
  --radius:16px;
}
.section-gap{ margin:10px 0; }

/* =============== HERO =============== */
.catalog-hero{
  display:flex; align-items:center; gap:12px;
  background:var(--blue); color:#fff;
  padding:14px; border-radius:18px; margin:8px 0 12px;
}
.catalog-icon{
  width:64px; height:64px;
  background:url('{{ url_for("static", filename="catalog/catalog-app.png") }}') center/cover no-repeat;
  border-radius:14px; flex:0 0 auto;
}
.catalog-title h1{ margin:0; font-size:1.8rem; line-height:1; }
.catalog-title p{ margin:.35rem 0 .4rem; opacity:.95; }
.back-link{ color:#e0eaff; text-decoration:none; font-size:.92rem; }

/* =============== FEATURED (shorter banner) =============== */
.featured-carousel{ position:relative; overflow:hidden; border-radius:18px; margin:6px 0 8px; }
.carousel-track{ display:flex; transition:transform .6s ease; }
.carousel-slide{ min-width:100%; display:flex; justify-content:center; }
.carousel-slide img{
  width:100%; height:auto; border-radius:18px;
  max-height:220px; object-fit:cover;
}
@media (min-width:768px){ .carousel-slide img{ max-height:320px; } }

.carousel-controls{
  position:absolute; bottom:10px; left:50%; transform:translateX(-50%);
  display:flex; align-items:center; gap:10px;
}
.carousel-prev,.carousel-next{
  background:rgba(255,255,255,.85); border:none; border-radius:50%;
  width:32px; height:32px; font-size:1.15rem; line-height:32px; cursor:pointer;
}

/* Pokéball dots */
.carousel-dots{ display:flex; gap:10px; }
.carousel-dots .dot{
  width:18px; height:18px; border-radius:50%; background:#fff; border:2px solid #000;
  position:relative; overflow:hidden; cursor:pointer; box-shadow:0 1px 2px rgba(0,0,0,.18);
}
.carousel-dots .dot::before{ content:""; position:absolute; left:0; top:0; width:100%; height:50%; background:#e11d24; }
.carousel-dots .dot::after{
  content:""; position:absolute; left:50%; top:50%; width:6px; height:6px;
  background:#fff; border:2px solid #000; border-radius:50%; transform:translate(-50%,-50%);
}
.carousel-dots .dot.active{ transform:scale(1.2); border-color:var(--blue); box-shadow:0 0 6px rgba(58,141,222,.6); }

/* =============== QUICK LINKS =============== */
.quick-links{
  display:flex; align-items:center; gap:8px; flex-wrap:nowrap; justify-content:flex-start;
  margin:6px 0 8px; overflow:hidden;
}
.quick-links .quick-link{
  display:inline-flex; align-items:center; justify-content:center;
  height:40px; padding:0 12px;
  background:var(--chip); color:var(--blue); border-radius:12px;
  text-decoration:none; font-weight:700; font-size:.92rem; white-space:nowrap;
}
.quick-links .watchlist-btn{
  display:inline-flex; align-items:center; justify-content:center;
  width:48px; height:40px; padding:0; border:none; cursor:pointer;
  background:var(--chip); border-radius:12px; flex:0 0 auto;
}
.quick-links .watchlist-btn img{ width:22px; height:22px; object-fit:contain; }

/* =============== CATEGORIES (exact catbg.png frame, 2×1) =============== */
.categories{ margin:6px 0 10px; }
.cat-frame{
  position:relative; width:100%;
  aspect-ratio: 2 / 1;     /* your background (1536×768 ≈ 2:1) */
  background:url('{{ url_for("static", filename="catalog/catbg.png") }}') center/contain no-repeat;
  border-radius:18px; overflow:hidden;
}
.cat-title{
  position:absolute; top:6%; left:5%;
  color:#000000; font-weight:800; font-size:clamp(1.1rem, 3.8vw, 1.6rem);
  text-shadow:0 2px 6px rgba(0,0,0,.35);
}
.cat-grid{
  position:absolute; inset: 18% 5% 10% 5%;
  display:grid; grid-template-columns:repeat(5, 1fr); grid-template-rows:repeat(2, 1fr);
  gap:clamp(6px, 1.8vw, 16px); align-items:center; justify-items:center;
}
.category-btn{
  display:flex; flex-direction:column; align-items:center; gap:6px;
  text-decoration:none; color:#000000; font-weight:800;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,.25));
}
.category-btn img{ width:min(68px, 13vw); height:auto; }
.category-btn span{ font-size:clamp(.85rem, 2.5vw, 1.1rem); text-shadow:0 2px 6px rgba(0,0,0,.35); }

/* =============== ITEM GRID — MATCH THE CONCEPT =============== */
.item-grid{
  display:grid; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr));
  gap:14px; margin:10px 0 16px;
}
.item-card{
  background:var(--card); border-radius:22px; overflow:hidden;
  box-shadow:0 4px 18px rgba(0,0,0,.08), inset 0 0 0 1px rgba(0,0,0,.04);
  position:relative;
}

/* top bar badges */
.card-topbar{ position:relative; height:0; }

/* NEW: use cost.png as the badge container */
.cost-pill{
  position:absolute; top:10px; left:10px;
  width:128px; height:48px;                 /* tune if needed to match the art */
  background:url('{{ url_for("static", filename="catalog/container/cost.png") }}') center/contain no-repeat;
  display:flex; align-items:center; justify-content:center;
  font-weight:800; font-size:1.05rem; color:#0a5c2b;
  text-shadow:0 1px 0 rgba(255,255,255,.5);
  /* remove old visual styles */
  border:none; box-shadow:none; padding:0; border-radius:0;
}
/* hide the old little icon span if it’s still in the markup */
.cost-pill .icon{ display:none; }

.watch-circle{
  position:absolute; top:10px; right:10px;
  width:42px; height:42px; background:#b6f1e4; border:1.5px solid #7bd7c3;
  border-radius:50%; display:flex; align-items:center; justify-content:center;
  cursor:pointer; box-shadow:0 2px 0 rgba(0,0,0,.08);
}
.watch-circle img{ width:24px; height:24px; }

/* hero image (the grey area between top bar and title) */
.card-hero{
  display:block;                 /* <-- makes the height work so image shows */
  margin:0 12px; height:200px; border-radius:14px;
  background:#eef3f8 center/cover no-repeat;
}

/* bottom blue band + big buy button */
.card-bottom{
  position:relative;
  background:#74bdf0; color:#e7f3ff;
  border-top-left-radius:18px; border-top-right-radius:18px;
  margin-top:12px; padding:14px 14px 58px;
}
.item-name{ margin:0 0 4px; font-size:1.35rem; font-weight:800; color:var(--ink); }
.item-desc{ margin:0; color:#e7f3ff; opacity:.95; font-size:1rem; }

.buy-fab{
  position:absolute; right:14px; bottom:14px;
  width:96px; height:96px; border-radius:50%;
  background:#75c06a; box-shadow:0 8px 18px rgba(0,0,0,.12);
  display:flex; align-items:center; justify-content:center;
}
.buy-fab img{ width:66px; height:66px; object-fit:contain; }

/* footer: stock + one-line tags with overflow */
.card-footer{
  display:flex; align-items:center; gap:10px;
  padding:10px 14px 14px;
}
.stock-pill{
  background:#f89e3c; color:#2a1800; border-radius:14px;
  padding:6px 12px; font-weight:800; white-space:nowrap;
}
.tags-row{
  position:relative;
  display:flex; align-items:center; gap:8px; flex:1 1 auto;
  overflow:hidden; white-space:nowrap;
}
.tag-chip{
  background:#cfefff; color:#0c4781;
  padding:6px 10px; border-radius:14px; font-weight:700;
  display:inline-flex; align-items:center; white-space:nowrap; flex:0 0 auto;
}
.tag-chip.more{ cursor:pointer; }
.more-pop{
  position:absolute; right:0; top:calc(100% + 6px);
  background:#fff; border:1px solid #e5e7eb; border-radius:12px;
  padding:8px; box-shadow:0 10px 24px rgba(0,0,0,.12);
  display:none; z-index:10; max-width:min(80vw, 320px);
}
.more-pop .tag-chip{ margin:4px 4px 0 0; }

/* =============== WATCHLIST MODAL =============== */
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.42); display:flex; align-items:center; justify-content:center; z-index:50; }
.modal.hidden{ display:none; }
.modal-content{ width:min(420px, 92vw); background:#fff; border-radius:16px; padding:16px; }
.close-btn{ background:var(--blue); color:#fff; padding:8px 12px; border:none; border-radius:10px; cursor:pointer; float:right; }

/* =============== SMALL REFINEMENTS =============== */
@media (max-width:360px){
  .quick-links .quick-link{ font-size:.85rem; padding:0 10px; }
  .buy-fab{ width:86px; height:86px; }
  .buy-fab img{ width:58px; height:58px; }
}
</style>

<!-- =============== HERO =============== -->
<div class="catalog-hero">
  <div class="catalog-icon"></div>
  <div class="catalog-title">
    <h1>catalog</h1>
    <p>{{ catalog_description }}</p>
    <a href="{{ url_for('dashboard') }}" class="back-link">&lt; back to dashboard</a>
  </div>
</div>

<!-- =============== FEATURED =============== -->
<div class="featured-carousel">
  <div class="carousel-track">
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide1.png') }}" alt=""></div>
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide2.png') }}" alt=""></div>
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide3.png') }}" alt=""></div>
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide4.png') }}" alt=""></div>
  </div>
  <div class="carousel-controls">
    <button class="carousel-prev" aria-label="Previous">‹</button>
    <div class="carousel-dots">
      <span class="dot active"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <button class="carousel-next" aria-label="Next">›</button>
  </div>
</div>

<!-- =============== QUICK LINKS =============== -->
<div class="quick-links">
  <a href="#" class="quick-link">New here? Tap here to learn how it works!</a>
  <a href="{{ url_for('orders') }}" class="quick-link">Order history</a>
  <button class="watchlist-btn" onclick="toggleWatchlist()" title="Watchlist">
    <img src="{{ url_for('static', filename='catalog/binocularsb.png') }}" alt="Watchlist">
  </button>
</div>

<!-- =============== CATEGORIES (exact frame) =============== -->
<section class="categories">
  <div class="cat-frame">
    <div class="cat-title">Categories</div>
    <div class="cat-grid">
      <a href="#pins" class="category-btn"><img src="{{ url_for('static', filename='catalog/pins.png') }}" alt=""><span>Pins</span></a>
      <a href="#plushies" class="category-btn"><img src="{{ url_for('static', filename='catalog/plushies.png') }}" alt=""><span>Plushies</span></a>
      <a href="#tcg" class="category-btn"><img src="{{ url_for('static', filename='catalog/tcg.png') }}" alt=""><span>TCG</span></a>
      <a href="#keychains" class="category-btn"><img src="{{ url_for('static', filename='catalog/keychains.png') }}" alt=""><span>Keychains</span></a>
      <a href="#accessories" class="category-btn"><img src="{{ url_for('static', filename='catalog/accessories.png') }}" alt=""><span>Accessories</span></a>
      <a href="#games" class="category-btn"><img src="{{ url_for('static', filename='catalog/games.png') }}" alt=""><span>Games</span></a>
      <a href="#bundles" class="category-btn"><img src="{{ url_for('static', filename='catalog/bundles.png') }}" alt=""><span>Bundles</span></a>
      <a href="#codes" class="category-btn"><img src="{{ url_for('static', filename='catalog/digital-codes.png') }}" alt=""><span>Digital</span></a>
      <a href="#latest" class="category-btn"><img src="{{ url_for('static', filename='catalog/latest.png') }}" alt=""><span>Latest</span></a>
      <a href="#all" class="category-btn"><img src="{{ url_for('static', filename='catalog/viewall.png') }}" alt=""><span>View All</span></a>
    </div>
  </div>
</section>

<!-- =============== ITEM GRID =============== -->
<section class="item-grid">
  {% for it in items %}
  <div class="item-card">
    <div class="card-topbar">
      <div class="cost-pill">
        <span class="icon" aria-hidden="true"></span>
        <strong>{{ it.cost_stamps }}</strong>
      </div>

      <button class="watch-circle" data-id="{{ it.id }}" onclick="toggleWatch(this)" title="Toggle watch">
        <img
          src="{{ url_for('static', filename='catalog/binocularsb.png') if it.id in watch_ids else url_for('static', filename='catalog/binocularsa.png') }}"
          data-a="{{ url_for('static', filename='catalog/binocularsa.png') }}"
          data-b="{{ url_for('static', filename='catalog/binocularsb.png') }}"
          alt="watch">
      </button>
    </div>

    <a class="card-hero" style="background-image:url('{{ it.image_url }}');" href="{{ url_for('catalog_item', item_id=it.id) }}"></a>

    <div class="card-bottom">
      <h3 class="item-name">{{ it.name }}</h3>
      <p class="item-desc">{{ it.description }}</p>

      <a class="buy-fab" href="{{ url_for('catalog_item', item_id=it.id) }}" aria-label="Buy / View">
        <img src="{{ url_for('static', filename='catalog/container/trade.PNG') }}" alt="">
      </a>
    </div>

    <div class="card-footer">
      <span class="stock-pill">stock: {{ it.stock }}</span>
      <div class="tags-row">
        {% for t in it.tags %}
          <span class="tag-chip">#{{ t }}</span>
        {% endfor %}
        <button class="tag-chip more" type="button" title="More tags">…</button>
        <div class="more-pop"></div>
      </div>
    </div>
  </div>
  {% endfor %}
</section>

<!-- =============== WATCHLIST MODAL =============== -->
<div id="watchlist-modal" class="modal hidden">
  <div class="modal-content">
    <button onclick="toggleWatchlist()" class="close-btn">Close</button>
    <h2>👀 Your Watchlist</h2>
    <div id="watchlist-items">Loading...</div>
  </div>
</div>

<script>
/* ---------- Carousel ---------- */
const track = document.querySelector(".carousel-track");
const slides = document.querySelectorAll(".carousel-slide");
const dots = document.querySelectorAll(".carousel-dots .dot");
let currentIndex = 0;
let interval = setInterval(nextSlide, 6000);

function updateCarousel(){
  if(!track) return;
  track.style.transform = `translateX(-${currentIndex * 100}%)`;
  dots.forEach((d,i)=>d.classList.toggle("active", i===currentIndex));
}
function nextSlide(){ currentIndex = (currentIndex + 1) % slides.length; updateCarousel(); }
function prevSlide(){ currentIndex = (currentIndex - 1 + slides.length) % slides.length; updateCarousel(); }
document.querySelector(".carousel-next")?.addEventListener("click", ()=>{ nextSlide(); resetTimer(); });
document.querySelector(".carousel-prev")?.addEventListener("click", ()=>{ prevSlide(); resetTimer(); });
dots.forEach((dot,i)=>dot.addEventListener("click", ()=>{ currentIndex=i; updateCarousel(); resetTimer(); }));
function resetTimer(){ clearInterval(interval); interval = setInterval(nextSlide, 6000); }
updateCarousel();

/* ---------- Watchlist modal ---------- */
function toggleWatchlist(){
  const m = document.getElementById("watchlist-modal");
  m.classList.toggle("hidden");
  if(!m.classList.contains("hidden")) loadWatchlist();
}
function loadWatchlist(){
  const c = document.getElementById("watchlist-items");
  c.innerHTML = "Loading...";
  fetch("/watchlist").then(r=>r.json()).then(data=>{
    if(!data.success){ c.textContent = "⚠️ Error loading watchlist."; return; }
    if(data.count===0){ c.textContent = "📭 Your watchlist is empty."; return; }
    c.innerHTML = "";
    data.items.forEach(item=>{
      const row = document.createElement("div");
      row.style.cssText = "display:flex;align-items:center;gap:10px;background:#f9fafb;border-radius:10px;padding:10px;margin:6px 0;";
      row.innerHTML = `
        <div style="width:48px;height:48px;border-radius:8px;background:#eef3f8 center/cover no-repeat;background-image:url('${item.image_url}')"></div>
        <div style="flex:1;"><strong>${item.name}</strong><div style="color:#6b7280;font-size:.9em;">🪙 ${item.cost_stamps} — 📦 ${item.stock}</div></div>
        <button style="background:#fee2e2;color:#991b1b;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;"
                onclick="toggleWatchFromModal('${item.id}')">Remove</button>`;
      c.appendChild(row);
    });
  });
}
function toggleWatchFromModal(id){
  fetch(`/watchlist/toggle/${id}`,{method:"POST"}).then(r=>r.json()).then(data=>{
    if(data.success){ loadWatchlist(); 
      const btn = document.querySelector(`.watch-circle[data-id='${id}'] img`);
      if(btn){ btn.src = data.watched ? btn.dataset.b : btn.dataset.a; }
    }
  });
}

/* ---------- Watch toggle on cards ---------- */
function toggleWatch(el){
  const id = el.getAttribute("data-id");
  const img = el.querySelector("img");
  fetch(`/watchlist/toggle/${id}`,{method:"POST"}).then(r=>r.json()).then(data=>{
    if(data.success){ img.src = data.watched ? img.dataset.b : img.dataset.a; }
  });
}

/* ---------- One-line tags with "…" overflow ---------- */
function layoutTags(){
  document.querySelectorAll('.item-card .card-footer').forEach(footer=>{
    const row = footer.querySelector('.tags-row');
    if(!row) return;

    const chips = Array.from(row.querySelectorAll('.tag-chip:not(.more)'));
    const moreBtn = row.querySelector('.tag-chip.more');
    const pop = row.querySelector('.more-pop');

    // Reset all
    chips.forEach(ch=>ch.style.display = 'inline-flex');
    moreBtn.style.display = 'none';
    pop.style.display = 'none';
    pop.innerHTML = '';

    const available = row.clientWidth - 6;
    moreBtn.style.display = 'inline-flex';
    const moreW = moreBtn.offsetWidth + 8;
    let used = 0;
    const hidden = [];

    chips.forEach(ch=>{
      const w = ch.offsetWidth + 8;
      if (used + w + moreW <= available){
        used += w;
      } else {
        ch.style.display = 'none';
        hidden.push(ch.textContent.trim());
      }
    });

    if(hidden.length){
      pop.innerHTML = hidden.map(t=>`<span class="tag-chip"> ${t} </span>`).join('');
      moreBtn.onclick = (e)=>{
        e.stopPropagation();
        pop.style.display = (pop.style.display === 'block') ? 'none' : 'block';
      };
      document.addEventListener('click', ()=>{ pop.style.display = 'none'; }, {once:true});
    } else {
      moreBtn.style.display = 'none';
    }
  });
}
window.addEventListener('resize', layoutTags);
if (document.fonts && document.fonts.ready) { document.fonts.ready.then(layoutTags); }
document.addEventListener('DOMContentLoaded', layoutTags);
</script>

{% endblock %}