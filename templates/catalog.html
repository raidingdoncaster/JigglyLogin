{% extends "base.html" %}
{% block content %}

<style>
/* =============== THEME =============== */
:root{
  --blue:#3a8dde; --sky:#e9f0ff; --card:#fff; --ink:#1f2937; --muted:#6b7280;
  --chip:#eef2ff; --radius:18px;
}

/* =============== HERO =============== */
.catalog-hero{
  display:flex;align-items:center;gap:12px;
  background:var(--blue);color:#fff;padding:14px;border-radius:18px;margin:8px 0 10px;
}
.catalog-icon{
  width:64px;height:64px;border-radius:14px;flex:0 0 auto;
  background:url('{{ url_for("static", filename="catalog/catalog-app.png") }}') center/cover no-repeat;
}
.catalog-title h1{margin:0;font-size:1.8rem;line-height:1;}
.catalog-title p{margin:.35rem 0 .4rem;opacity:.95;}
.back-link{color:#e0eaff;text-decoration:none;font-size:.92rem;}

/* =============== FEATURED (shorter) =============== */
.featured-carousel{position:relative;overflow:hidden;border-radius:18px;margin:6px 0 8px;}
.carousel-track{display:flex;transition:transform .6s ease;}
.carousel-slide{min-width:100%;display:flex;justify-content:center;}
.carousel-slide img{width:100%;height:auto;border-radius:18px;max-height:220px;object-fit:cover;}
@media(min-width:768px){ .carousel-slide img{max-height:320px;} }
.carousel-controls{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:10px;}
.carousel-prev,.carousel-next{background:rgba(255,255,255,.85);border:none;border-radius:50%;width:32px;height:32px;font-size:1.15rem;line-height:32px;cursor:pointer;}
.carousel-dots{display:flex;gap:10px;}
.carousel-dots .dot{width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid #000;position:relative;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,.18);cursor:pointer;}
.carousel-dots .dot::before{content:"";position:absolute;left:0;top:0;width:100%;height:50%;background:#e11d24;}
.carousel-dots .dot::after{content:"";position:absolute;left:50%;top:50%;width:6px;height:6px;background:#fff;border:2px solid #000;border-radius:50%;transform:translate(-50%,-50%);}
.carousel-dots .dot.active{transform:scale(1.2);border-color:var(--blue);box-shadow:0 0 6px rgba(58,141,222,.6);}

/* =============== QUICK LINKS =============== */
.quick-links{display:flex;align-items:center;gap:8px;margin:6px 0 8px;}
.quick-links .quick-link{
  display:inline-flex;align-items:center;justify-content:center;height:40px;padding:0 12px;
  background:var(--chip);color:var(--blue);border-radius:12px;text-decoration:none;font-weight:700;font-size:.92rem;white-space:nowrap;
}
.quick-links .watchlist-btn{
  display:inline-flex;align-items:center;justify-content:center;width:48px;height:40px;background:var(--chip);
  border:none;border-radius:12px;cursor:pointer;flex:0 0 auto;
}
.quick-links .watchlist-btn img{width:22px;height:22px;object-fit:contain;}

/* =============== CATEGORIES (exact catbg frame) =============== */
.categories{margin:6px 0 10px;}
.cat-frame{
  position:relative;width:100%;aspect-ratio:2/1;border-radius:18px;overflow:hidden;
  background:url('{{ url_for("static", filename="catalog/catbg.png") }}') center/contain no-repeat;
}
.cat-title{position:absolute;top:6%;left:5%;color:#fff;font-weight:800;font-size:clamp(1.1rem,3.8vw,1.6rem);text-shadow:0 2px 6px rgba(0,0,0,.35);}
.cat-grid{
  position:absolute;inset:18% 5% 10% 5%;
  display:grid;grid-template-columns:repeat(5,1fr);grid-template-rows:repeat(2,1fr);
  gap:clamp(6px,1.8vw,16px);align-items:center;justify-items:center;
}
.category-btn{display:flex;flex-direction:column;align-items:center;gap:6px;text-decoration:none;color:#fff;font-weight:800;filter:drop-shadow(0 1px 2px rgba(0,0,0,.25));}
.category-btn img{width:min(68px,13vw);height:auto;}
.category-btn span{font-size:clamp(.85rem,2.5vw,1.1rem);text-shadow:0 2px 6px rgba(0,0,0,.35);}

/* =============== ITEM GRID (2 columns) =============== */
.item-grid{
  display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:12px;margin:10px 0 16px;
}
@media (max-width:360px){ .item-grid{grid-template-columns:1fr;} }

.item-card{
  position:relative;background:var(--card);border-radius:22px;overflow:hidden;
  box-shadow:0 4px 18px rgba(0,0,0,.08), inset 0 0 0 1px rgba(0,0,0,.04);
}

/* --- media (square image) + badges over it --- */
.media{
  position:relative;
  margin:12px;
  border-radius:18px;
  overflow:hidden; /* ensures nothing overflows */
}
.card-hero{
  display:block;
  aspect-ratio:1/1;
  width:100%;
  border-radius:18px;
  background:#eef3f8 center/cover no-repeat;
  overflow:hidden;
}
.badge-layer{position:absolute;inset:0;pointer-events:none;}
/* stamp container uses the artwork as the container */
.cost-pill{
  position:absolute;top:10px;left:10px;z-index:3;pointer-events:auto;
  width:clamp(120px, 36vw, 160px);aspect-ratio:2.8/1;
  background:url('{{ url_for("static", filename="catalog/container/cost.png") }}') center/contain no-repeat;
  display:flex;align-items:center;justify-content:flex-end;padding-right:16px;
}
.cost-pill .num{
  font-weight:800;font-size:clamp(.9rem,2.8vw,1.1rem);line-height:1;color:#0d4e2b;
  text-shadow:0 1px 0 rgba(255,255,255,.75);
}
/* watchlist circle – icon fills full circle */
.watch-circle{
  position:absolute;top:10px;right:10px;z-index:3;pointer-events:auto;
  width:44px;height:44px;border-radius:50%;background:rgba(182,241,228,.85);border:1.5px solid #7bd7c3;
  display:flex;align-items:center;justify-content:center;box-shadow:0 2px 0 rgba(0,0,0,.08);cursor:pointer;
}
.watch-circle img{width:100%;height:100%;object-fit:contain;}

/* --- info row with trade icon filling height --- */
.card-bottom{
  display:grid;grid-template-columns:1fr min(28vw, 92px);align-items:stretch;
  background:#74bdf0;color:#0b213d;border-top-left-radius:18px;border-top-right-radius:18px;
  padding:12px;
}
.info{
  min-height:72px;
  display:flex;flex-direction:column;justify-content:center;gap:4px;
}
.item-name{margin:0;font-size:1.05rem;font-weight:800;line-height:1.2;max-height:2.4em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.item-desc{margin:0;color:#e7f3ff;opacity:.95;font-size:.95rem;line-height:1.25;max-height:2.5em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
.trade-btn{align-self:stretch;justify-self:end;display:flex;align-items:center;justify-content:center;background:transparent;border:none;padding:0;cursor:pointer;}
.trade-btn img{height:100%;width:auto;display:block;}

/* --- footer chips (thinner, not bold) + single-line clamp with … --- */
.card-footer{display:flex;gap:8px;flex-wrap:nowrap;align-items:center;padding:10px 12px 12px;overflow:hidden;}
.stock-pill{background:#f8c07a;color:#2a1800;border-radius:12px;padding:4px 8px;font-weight:500;line-height:1;flex:0 0 auto;}
.tag-chip{background:#dcebfb;color:#0c4781;border-radius:12px;padding:4px 8px;font-weight:500;line-height:1;flex:0 0 auto;white-space:nowrap;}
.more-chip{background:#eef2ff;color:#375a9e;border-radius:12px;padding:4px 10px;font-weight:600;cursor:pointer;flex:0 0 auto;}
</style>

<!-- =============== HERO =============== -->
<div class="catalog-hero">
  <div class="catalog-icon"></div>
  <div class="catalog-title">
    <h1>catalog</h1>
    <p>{{ catalog_description }}</p>
    <a href="{{ url_for('dashboard') }}" class="back-link">&lt; back to dashboard</a>
  </div>
</div>

<!-- =============== FEATURED =============== -->
<div class="featured-carousel">
  <div class="carousel-track">
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide1.png') }}" alt=""></div>
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide2.png') }}" alt=""></div>
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide3.png') }}" alt=""></div>
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide4.png') }}" alt=""></div>
  </div>
  <div class="carousel-controls">
    <button class="carousel-prev" aria-label="Previous">‹</button>
    <div class="carousel-dots">
      <span class="dot active"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
    </div>
    <button class="carousel-next" aria-label="Next">›</button>
  </div>
</div>

<!-- =============== QUICK LINKS =============== -->
<div class="quick-links">
  <a href="#" class="quick-link">New here? Tap here to learn how it works!</a>
  <a href="{{ url_for('orders') }}" class="quick-link">Order history</a>
  <button class="watchlist-btn" onclick="toggleWatchlist()" title="Watchlist">
    <img src="{{ url_for('static', filename='catalog/binocularsb.png') }}" alt="Watchlist">
  </button>
</div>

<!-- =============== CATEGORIES =============== -->
<section class="categories">
  <div class="cat-frame">
    <div class="cat-title">Categories</div>
    <div class="cat-grid">
      <a href="#pins" class="category-btn"><img src="{{ url_for('static', filename='catalog/pins.png') }}" alt=""><span>Pins</span></a>
      <a href="#plushies" class="category-btn"><img src="{{ url_for('static', filename='catalog/plushies.png') }}" alt=""><span>Plushies</span></a>
      <a href="#tcg" class="category-btn"><img src="{{ url_for('static', filename='catalog/tcg.png') }}" alt=""><span>TCG</span></a>
      <a href="#keychains" class="category-btn"><img src="{{ url_for('static', filename='catalog/keychains.png') }}" alt=""><span>Keychains</span></a>
      <a href="#accessories" class="category-btn"><img src="{{ url_for('static', filename='catalog/accessories.png') }}" alt=""><span>Accessories</span></a>
      <a href="#games" class="category-btn"><img src="{{ url_for('static', filename='catalog/games.png') }}" alt=""><span>Games</span></a>
      <a href="#bundles" class="category-btn"><img src="{{ url_for('static', filename='catalog/bundles.png') }}" alt=""><span>Bundles</span></a>
      <a href="#codes" class="category-btn"><img src="{{ url_for('static', filename='catalog/digital-codes.png') }}" alt=""><span>Digital</span></a>
      <a href="#latest" class="category-btn"><img src="{{ url_for('static', filename='catalog/latest.png') }}" alt=""><span>Latest</span></a>
      <a href="#all" class="category-btn"><img src="{{ url_for('static', filename='catalog/viewall.png') }}" alt=""><span>View All</span></a>
    </div>
  </div>
</section>

<!-- =============== ITEM GRID (2 COLS) =============== -->
<section class="item-grid">
  {% for it in items %}
  <div class="item-card">
    <!-- Square media with badges layered -->
    <div class="media">
      <a class="card-hero" style="background-image:url('{{ it.image_url }}');" href="{{ url_for('catalog_item', item_id=it.id) }}"></a>
      <div class="badge-layer">
        <div class="cost-pill"><span class="num">{{ it.cost_stamps }}</span></div>
        <button class="watch-circle" data-id="{{ it.id }}" onclick="toggleWatch(this)" title="Toggle watch">
          <img
            src="{{ url_for('static', filename='catalog/' + ('binocularsb.png' if it.id in watch_ids else 'binocularsa.png')) }}"
            data-a="{{ url_for('static', filename='catalog/binocularsa.png') }}"
            data-b="{{ url_for('static', filename='catalog/binocularsb.png') }}"
            alt="watch">
        </button>
      </div>
    </div>

    <!-- Info row with trade icon filling height -->
    <div class="card-bottom">
      <div class="info">
        <h3 class="item-name">{{ it.name }}</h3>
        <p class="item-desc">{{ it.description }}</p>
      </div>
      <a class="trade-btn" href="{{ url_for('catalog_item', item_id=it.id) }}" aria-label="Buy / View">
        <img src="{{ url_for('static', filename='catalog/container/trade.PNG') }}" alt="">
      </a>
    </div>

    <!-- Chips (single-line with …) -->
    <div class="card-footer js-tag-row">
      <span class="stock-pill">stock: {{ it.stock }}</span>
      {% for t in it.tags %}
        <span class="tag-chip">#{{ t }}</span>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</section>

<!-- =============== WATCHLIST MODAL =============== -->
<div id="watchlist-modal" class="modal hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.42);display:flex;align-items:center;justify-content:center;z-index:50;">
  <div class="modal-content" style="width:min(420px,92vw);background:#fff;border-radius:16px;padding:16px;">
    <button onclick="toggleWatchlist()" class="close-btn" style="background:var(--blue);color:#fff;padding:8px 12px;border:none;border-radius:10px;cursor:pointer;float:right;">Close</button>
    <h2>👀 Your Watchlist</h2>
    <div id="watchlist-items">Loading...</div>
  </div>
</div>

<script>
/* ---------- Featured carousel ---------- */
const track=document.querySelector(".carousel-track");
const slides=document.querySelectorAll(".carousel-slide");
const dots=document.querySelectorAll(".carousel-dots .dot");
let currentIndex=0, interval=setInterval(nextSlide,6000);
function updateCarousel(){ track.style.transform=`translateX(-${currentIndex*100}%)`; dots.forEach((d,i)=>d.classList.toggle("active",i===currentIndex)); }
function nextSlide(){ currentIndex=(currentIndex+1)%slides.length; updateCarousel(); }
function prevSlide(){ currentIndex=(currentIndex-1+slides.length)%slides.length; updateCarousel(); }
document.querySelector(".carousel-next")?.addEventListener("click",()=>{nextSlide();resetTimer();});
document.querySelector(".carousel-prev")?.addEventListener("click",()=>{prevSlide();resetTimer();});
dots.forEach((dot,i)=>dot.addEventListener("click",()=>{currentIndex=i;updateCarousel();resetTimer();}));
function resetTimer(){ clearInterval(interval); interval=setInterval(nextSlide,6000); }
updateCarousel();

/* ---------- Watchlist modal & toggle ---------- */
function toggleWatchlist(){
  const m=document.getElementById("watchlist-modal");
  m.classList.toggle("hidden");
  if(!m.classList.contains("hidden")) loadWatchlist();
}
function loadWatchlist(){
  const c=document.getElementById("watchlist-items");
  c.innerHTML="Loading...";
  fetch("/watchlist").then(r=>r.json()).then(data=>{
    if(!data.success){c.textContent="⚠️ Error loading watchlist.";return;}
    if(data.count===0){c.textContent="📭 Your watchlist is empty.";return;}
    c.innerHTML="";
    data.items.forEach(item=>{
      const row=document.createElement("div");
      row.style.cssText="display:flex;align-items:center;gap:10px;background:#f9fafb;border-radius:10px;padding:10px;margin:6px 0;";
      row.innerHTML=`
        <div style="width:48px;height:48px;border-radius:8px;background:#eef3f8 center/cover no-repeat;background-image:url('${item.image_url}')"></div>
        <div style="flex:1;"><strong>${item.name}</strong><div style="color:#6b7280;font-size:.9em;">🪙 ${item.cost_stamps} — 📦 ${item.stock}</div></div>
        <button style="background:#fee2e2;color:#991b1b;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;" onclick="toggleWatchFromModal('${item.id}')">Remove</button>`;
      c.appendChild(row);
    });
  });
}
function toggleWatchFromModal(id){
  fetch(`/watchlist/toggle/${id}`,{method:"POST"}).then(r=>r.json()).then(data=>{
    if(data.success){ loadWatchlist();
      const img=document.querySelector(`.watch-circle[data-id='${id}'] img`);
      if(img){ img.src = data.watched ? img.dataset.b : img.dataset.a; }
    }
  });
}
function toggleWatch(el){
  const id=el.getAttribute("data-id");
  const img=el.querySelector("img");
  fetch(`/watchlist/toggle/${id}`,{method:"POST"}).then(r=>r.json()).then(data=>{
    if(data.success){ img.src = data.watched ? img.dataset.b : img.dataset.a; }
  });
}

/* ---------- Single-line tag clamp with “…” ---------- */
function clampTagRow(row){
  const maxWidth=row.clientWidth;
  const chips=[...row.querySelectorAll(".tag-chip")];
  if(!chips.length) return;
  let used=row.querySelector(".stock-pill")?.offsetWidth||0;
  let i=0;
  while(i<chips.length && used + chips[i].offsetWidth + 36 < maxWidth){
    used += chips[i].offsetWidth + 8; i++;
  }
  const hidden=chips.slice(i);
  hidden.forEach(ch=>ch.style.display="none");
  if(hidden.length){
    const more=document.createElement("span");
    more.className="more-chip";
    more.textContent="…";
    more.title=hidden.map(h=>h.textContent).join(" ");
    more.addEventListener("click", ()=>{ hidden.forEach(h=>h.style.display="inline-flex"); more.remove(); });
    row.appendChild(more);
  }
}
window.addEventListener("load", ()=>{ document.querySelectorAll(".js-tag-row").forEach(clampTagRow); });
window.addEventListener("resize", ()=>{ document.querySelectorAll(".js-tag-row").forEach(row=>{
  row.querySelectorAll(".more-chip").forEach(m=>m.remove());
  row.querySelectorAll(".tag-chip").forEach(t=>t.style.display="inline-flex");
  clampTagRow(row);
});});
</script>

{% endblock %}