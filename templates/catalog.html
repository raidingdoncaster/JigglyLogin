{% extends "base.html" %}
{% block content %}

<style>
:root {
  --blue:#3a8dde; --sky:#e9f0ff; --card:#fff; --ink:#1f2937; --muted:#6b7280;
  --chip:#eef2ff; --radius:18px; --divider:#e5e7eb;
}

.section{margin:20px 0;padding-bottom:10px;border-bottom:1px solid var(--divider);}
.section:last-of-type{border-bottom:none;}

/* HERO */
.catalog-hero{
  display:flex;align-items:center;gap:12px;
  background:var(--blue);color:#fff;padding:14px;border-radius:18px;margin-bottom:12px;
}
.catalog-icon{width:64px;height:64px;border-radius:14px;flex:0 0 auto;
  background:url('{{ url_for("static", filename="catalog/catalog-app.png") }}') center/cover no-repeat;}
.catalog-title h1{margin:0;font-size:1.8rem;line-height:1;}
.catalog-title p{margin:.35rem 0 .4rem;opacity:.95;}
.back-link{color:#e0eaff;text-decoration:none;font-size:.92rem;}

/* FEATURED */
.featured-carousel{position:relative;overflow:hidden;border-radius:18px;}
.carousel-track{display:flex;transition:transform .6s ease;}
.carousel-slide{min-width:100%;display:flex;justify-content:center;}
.carousel-slide img{width:100%;height:auto;border-radius:18px;max-height:220px;object-fit:cover;}
@media(min-width:768px){ .carousel-slide img{max-height:320px;} }
.carousel-controls{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:10px;}
.carousel-prev,.carousel-next{background:rgba(255,255,255,.85);border:none;border-radius:50%;width:32px;height:32px;font-size:1.15rem;line-height:32px;cursor:pointer;}
.carousel-dots{display:flex;gap:10px;}
.carousel-dots .dot{width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid #000;position:relative;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,.18);cursor:pointer;}
.carousel-dots .dot::before{content:"";position:absolute;left:0;top:0;width:100%;height:50%;background:#e11d24;}
.carousel-dots .dot::after{content:"";position:absolute;left:50%;top:50%;width:6px;height:6px;background:#fff;border:2px solid #000;border-radius:50%;transform:translate(-50%,-50%);}
.carousel-dots .dot.active{transform:scale(1.2);border-color:var(--blue);box-shadow:0 0 6px rgba(58,141,222,.6);}

/* QUICK LINKS */
.quick-links{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.quick-links .quick-link{
  display:inline-flex;align-items:center;justify-content:center;
  height:36px;padding:0 10px;background:var(--chip);color:var(--blue);
  border-radius:10px;text-decoration:none;font-weight:500;font-size:0.85rem;white-space:nowrap;
}
.quick-links .watchlist-btn{
  display:inline-flex;align-items:center;justify-content:center;width:42px;height:36px;background:var(--chip);
  border:none;border-radius:10px;cursor:pointer;flex:0 0 auto;
}
.quick-links .watchlist-btn img{width:20px;height:20px;object-fit:contain;}

/* CATEGORY TITLE + ICON (new) */
.catalog-header {
  display:flex;align-items:center;gap:10px;margin:14px 0;
}
.icon-wrapper {position:relative;width:36px;height:36px;}
.icon-wrapper img{width:36px;height:36px;object-fit:contain;transition:opacity .3s, transform .3s;}
.catalog-header.fading img,.catalog-header.fading h2{opacity:0;transform:scale(.95);}
.catalog-header h2{font-size:1.5rem;margin:0;font-weight:700;color:var(--ink);transition:opacity .3s, transform .3s;}
.shine{
  position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;opacity:0;pointer-events:none;
}
.icon-wrapper.pulse .shine{animation:pulseShine .9s ease-out;}
@keyframes pulseShine{0%{transform:scale(.5);opacity:.9;}60%{transform:scale(1.3);opacity:.5;}100%{transform:scale(1.6);opacity:0;}}
.icon-wrapper[data-cat="Pins"] .shine{background:radial-gradient(circle,rgba(255,215,0,0.8),transparent 70%);}
.icon-wrapper[data-cat="Plushies"] .shine{background:radial-gradient(circle,rgba(255,105,180,0.8),transparent 70%);}
.icon-wrapper[data-cat="TCG"] .shine{background:radial-gradient(circle,rgba(0,191,255,0.8),transparent 70%);}
.icon-wrapper[data-cat="Keychains"] .shine{background:radial-gradient(circle,rgba(255,140,0,0.8),transparent 70%);}
.icon-wrapper[data-cat="Accessories"] .shine{background:radial-gradient(circle,rgba(144,238,144,0.8),transparent 70%);}
.icon-wrapper[data-cat="Games"] .shine{background:radial-gradient(circle,rgba(186,85,211,0.8),transparent 70%);}
.icon-wrapper[data-cat="Master Bundles"] .shine{background:radial-gradient(circle,rgba(255,0,0,0.8),transparent 70%);}
.icon-wrapper[data-cat="default"] .shine{background:radial-gradient(circle,rgba(255,255,255,0.7),transparent 70%);}

/* SEARCH + FILTER BAR */
.category-tools{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:12px;}
.category-tools input[type="search"]{flex:1;padding:8px 10px;border:1px solid var(--divider);border-radius:10px;font-size:0.9rem;}
.category-actions{display:flex;gap:8px;}
.category-actions select{padding:8px 10px;border:1px solid var(--divider);border-radius:10px;background:var(--chip);font-size:0.9rem;cursor:pointer;}

/* ITEM GRID */
.item-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin:10px 0 16px;}
@media(max-width:400px){.item-grid{grid-template-columns:1fr;}}
.item-card{background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden;display:flex;flex-direction:column;}
.card-top{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;}
.cost-pill{display:flex;align-items:center;gap:6px;}
.cost-pill img{height:28px;width:auto;}
.cost-pill span{font-weight:700;font-size:.95rem;color:#064e3b;}
.watch-btn{background:none;border:none;width:32px;height:32px;padding:0;cursor:pointer;}
.watch-btn img{width:100%;height:100%;object-fit:contain;}
.card-image{width:100%;aspect-ratio:1/1;background:#eef3f8 center/cover no-repeat;}
.card-info{display:flex;justify-content:space-between;align-items:stretch;background:#74bdf0;color:#fff;padding:10px;}
.card-info .text{flex:1;display:flex;flex-direction:column;justify-content:center;gap:4px;}
.card-info h3{margin:0;font-size:1rem;font-weight:700;line-height:1.2;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;display:-webkit-box;}
.card-info p{margin:0;font-size:.85rem;opacity:.9;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;display:-webkit-box;}
.trade-btn{display:flex;align-items:center;justify-content:center;background:none;border:none;padding:0;}
.trade-btn img{height:100%;max-height:60px;width:auto;}
.card-footer{display:flex;gap:6px;align-items:center;padding:8px 10px 10px;overflow:hidden;}
.stock-pill{background:#f8c07a;color:#2a1800;border-radius:12px;padding:3px 6px;font-size:.8rem;}
.tag-chip{background:#dcebfb;color:#0c4781;border-radius:12px;padding:3px 6px;font-size:.8rem;white-space:nowrap;}
.more-chip{background:#eef2ff;color:#375a9e;border-radius:12px;padding:3px 8px;font-size:.8rem;cursor:pointer;}
</style>

<!-- HERO -->
<div class="section catalog-hero">
  <div class="catalog-icon"></div>
  <div class="catalog-title">
    <h1>Catalog</h1>
    <p>Discover exclusive community rewards, merch, and digital codes you can unlock with your Passport stamps.</p>
    <a href="{{ url_for('dashboard') }}" class="back-link">&lt; back to dashboard</a>
  </div>
</div>

<!-- FEATURED -->
<div class="section featured-carousel">
  <div class="carousel-track">
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide1.png') }}"></div>
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide2.png') }}"></div>
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide3.png') }}"></div>
    <div class="carousel-slide"><img src="{{ url_for('static', filename='featured/slide4.png') }}"></div>
  </div>
  <div class="carousel-controls">
    <button class="carousel-prev">‹</button>
    <div class="carousel-dots"><span class="dot active"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
    <button class="carousel-next">›</button>
  </div>
</div>

<!-- QUICK LINKS -->
<div class="section quick-links">
  <a href="#" class="quick-link">ℹ️ New here?!</a>
  <a href="{{ url_for('inbox', tab='receipts') }}" class="quick-link">Order history</a>
  <button class="watchlist-btn" onclick="toggleWatchlist()"><img src="{{ url_for('static', filename='catalog/binocularsb.png') }}" alt="Watchlist"></button>
</div>

<!-- CATEGORY TITLE + FILTER BAR -->
<div class="catalog-header">
  <div class="icon-wrapper" data-cat="default">
    <img id="categoryIcon" src="{{ url_for('static', filename='icons/tickstamp.png') }}" alt="icon">
    <div class="shine"></div>
  </div>
  <h2 id="categoryTitle">All Items</h2>
</div>

<div class="category-tools">
  <input type="search" id="catalog-search" placeholder="Search catalog...">
  <div class="category-actions">
    <select id="filter-select">
      <option value="all">All Categories</option>
      <option value="Pins">Pins</option>
      <option value="Plushies">Plushies</option>
      <option value="TCG">TCG</option>
      <option value="Keychains">Keychains</option>
      <option value="Accessories">Accessories</option>
      <option value="Games">Games</option>
      <option value="Master Bundles">Bundles</option>
    </select>
    <select id="sort-select">
      <option value="newest">Newest</option>
      <option value="lowcost">Lowest Cost</option>
      <option value="highcost">Highest Cost</option>
      <option value="stock">Stock</option>
    </select>
  </div>
</div>

<!-- ITEM GRID -->
<section class="item-grid">
  {% for it in items %}
  <div class="item-card">
    <div class="card-top">
      <div class="cost-pill">
        <img src="{{ url_for('static', filename='catalog/container/cost.png') }}" alt="cost">
        <span>{{ it.cost_stamps }}</span>
      </div>
      <button class="watch-btn" data-id="{{ it.id }}" onclick="toggleWatch(this)">
        <img
          src="{{ url_for('static', filename='catalog/' + ('binocularsb.png' if it.id in watch_ids else 'binocularsa.png')) }}"
          data-a="{{ url_for('static', filename='catalog/binocularsa.png') }}"
          data-b="{{ url_for('static', filename='catalog/binocularsb.png') }}"
          alt="watch">
      </button>
    </div>

    <div class="card-image" style="background-image:url('{{ it.image_url }}');"></div>

    <div class="card-info">
      <div class="text">
        <h3>{{ it.name }}</h3>
        <p>{{ it.description }}</p>
      </div>
      <a class="trade-btn" href="{{ url_for('catalog_item', item_id=it.id) }}">
        <img src="{{ url_for('static', filename='catalog/container/trade.PNG') }}" alt="trade">
      </a>
    </div>

    <div class="card-footer js-tag-row">
      <span class="stock-pill">stock: {{ it.stock }}</span>
      {% for t in it.tags %}
        <span class="tag-chip">#{{ t }}</span>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</section>

<!-- WATCHLIST MODAL -->
<div id="watchlist-modal" class="modal hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.42);display:flex;align-items:center;justify-content:center;z-index:50;">
  <div class="modal-content" style="width:min(420px,92vw);background:#fff;border-radius:16px;padding:16px;">
    <button onclick="toggleWatchlist()" class="close-btn" style="background:var(--blue);color:#fff;padding:8px 12px;border:none;border-radius:10px;cursor:pointer;float:right;">Close</button>
    <h2>👀 Your Watchlist</h2>
    <div id="watchlist-items">Loading...</div>
  </div>
</div>

<script>
/* --- Featured Carousel --- */
const track=document.querySelector(".carousel-track");
const slides=document.querySelectorAll(".carousel-slide");
const dots=document.querySelectorAll(".carousel-dots .dot");
let currentIndex=0,interval=setInterval(nextSlide,6000);
function updateCarousel(){track.style.transform=`translateX(-${currentIndex*100}%)`;dots.forEach((d,i)=>d.classList.toggle("active",i===currentIndex));}
function nextSlide(){currentIndex=(currentIndex+1)%slides.length;updateCarousel();}
function prevSlide(){currentIndex=(currentIndex-1+slides.length)%slides.length;updateCarousel();}
document.querySelector(".carousel-next")?.addEventListener("click",()=>{nextSlide();resetTimer();});
document.querySelector(".carousel-prev")?.addEventListener("click",()=>{prevSlide();resetTimer();});
dots.forEach((dot,i)=>dot.addEventListener("click",()=>{currentIndex=i;updateCarousel();resetTimer();}));
function resetTimer(){clearInterval(interval);interval=setInterval(nextSlide,6000);}
updateCarousel();

/* --- Watchlist --- */
function toggleWatchlist(){const m=document.getElementById("watchlist-modal");m.classList.toggle("hidden");if(!m.classList.contains("hidden"))loadWatchlist();}
function loadWatchlist(){const c=document.getElementById("watchlist-items");c.innerHTML="Loading...";fetch("/watchlist").then(r=>r.json()).then(data=>{if(!data.success){c.textContent="⚠️ Error loading watchlist.";return;}if(data.count===0){c.textContent="📭 Your watchlist is empty.";return;}c.innerHTML="";data.items.forEach(item=>{const row=document.createElement("div");row.style.cssText="display:flex;align-items:center;gap:10px;background:#f9fafb;border-radius:10px;padding:10px;margin:6px 0;";row.innerHTML=`<div style="width:48px;height:48px;border-radius:8px;background:#eef3f8 center/cover no-repeat;background-image:url('${item.image_url}')"></div><div style="flex:1;"><strong>${item.name}</strong><div style="color:#6b7280;font-size:.9em;">🪙 ${item.cost_stamps} — 📦 ${item.stock}</div></div><button style="background:#fee2e2;color:#991b1b;border:none;border-radius:8px;padding:6px 10px;cursor:pointer;" onclick="toggleWatchFromModal('${item.id}')">Remove</button>`;c.appendChild(row);});});}
function toggleWatchFromModal(id){fetch(`/watchlist/toggle/${id}`,{method:"POST"}).then(r=>r.json()).then(data=>{if(data.success){loadWatchlist();const img=document.querySelector(`.watch-btn[data-id='${id}'] img`);if(img){img.src=data.watched?img.dataset.b:img.dataset.a;}}});}
function toggleWatch(el){const id=el.getAttribute("data-id");const img=el.querySelector("img");fetch(`/watchlist/toggle/${id}`,{method:"POST"}).then(r=>r.json()).then(data=>{if(data.success){img.src=data.watched?img.dataset.b:img.dataset.a;}});}

/* --- Filter + Search --- */
const searchInput=document.getElementById("catalog-search");
const filterSelect=document.getElementById("filter-select");
const sortSelect=document.getElementById("sort-select");
const itemGrid=document.querySelector(".item-grid");
const titleEl=document.getElementById("categoryTitle");
const iconEl=document.getElementById("categoryIcon");
const iconWrap=document.querySelector(".icon-wrapper");
const header=document.querySelector(".catalog-header");
const iconMap={
  "Pins":"/static/icons/pins.png",
  "Plushies":"/static/icons/plushies.png",
  "TCG":"/static/icons/tcg.png",
  "Keychains":"/static/icons/keychain.png",
  "Accessories":"/static/icons/accessories.png",
  "Games":"/static/icons/games.png",
  "Master Bundles":"/static/icons/bundle.png"
};
function updateIcon(val){
  const newSrc=iconMap[val]||"/static/icons/tickstamp.png";
  const newTitle=val||"All Items";
  header.classList.add("fading");
  setTimeout(()=>{iconEl.src=newSrc;titleEl.textContent=newTitle;header.classList.remove("fading");
  const cat=val||"default";iconWrap.dataset.cat=cat;iconWrap.classList.remove("pulse");void iconWrap.offsetWidth;iconWrap.classList.add("pulse");},250);
}
function applyFilters(){
  const term=searchInput.value.toLowerCase();const filter=filterSelect.value.toLowerCase();
  document.querySelectorAll(".item-card").forEach(card=>{
    const name=card.querySelector("h3").textContent.toLowerCase();
    const desc=card.querySelector("p").textContent.toLowerCase();
    const tags=(card.querySelector(".card-footer")?.innerText||"").toLowerCase();
    let matchSearch=!term||name.includes(term)||desc.includes(term);
    let matchFilter=filter==="all"||tags.includes(filter);
    card.style.display=(matchSearch&&matchFilter)?"":"none";
  });
  updateIcon(filter==="all"?"":filter.charAt(0).toUpperCase()+filter.slice(1));
}
function applySort(){
  const sortVal=sortSelect.value;const cards=Array.from(document.querySelectorAll(".item-card"));
  cards.sort((a,b)=>{
    const costA=parseInt(a.querySelector(".cost-pill span").textContent)||0;
    const costB=parseInt(b.querySelector(".cost-pill span").textContent)||0;
    const stockA=parseInt(a.querySelector(".stock-pill").textContent.replace(/\D/g,""))||0;
    const stockB=parseInt(b.querySelector(".stock-pill").textContent.replace(/\D/g,""))||0;
    switch(sortVal){case"lowcost":return costA-costB;case"highcost":return costB-costA;case"stock":return stockB-stockA;default:return 0;}
  });cards.forEach(c=>itemGrid.appendChild(c));
}
searchInput.addEventListener("input",applyFilters);
filterSelect.addEventListener("change",applyFilters);
sortSelect.addEventListener("change",applySort);
</script>

{% endblock %}