{% extends "base.html" %}
{% block content %}

<!-- HERO / HEADER -->
<div class="hero">
  <div class="hero-icon"></div>
  <div class="hero-body">
    <h1>catalog</h1>
    <p class="sub">{{ catalog_description }}</p>
    <a href="{{ url_for('dashboard') }}" class="backlink">&lt; back to dashboard</a>
  </div>
</div>

<!-- FEATURED -->
<section class="featured">
  <div class="featured-tab">‚≠ê featured</div>

  {% if featured_items and featured_items|length %}
  <div class="featured-stage" id="featuredStage">
    {% for it in featured_items %}
      <a class="featured-slide {% if loop.first %}active{% endif %}" href="{{ url_for('catalog_item', item_id=it.id) }}"
         style="background-image:url('{{ it.image_url }}');">
        <span class="slide-alt">Image, tapping takes the player to the relevant link</span>
      </a>
    {% endfor %}
    <div class="loadbar"><div class="fill" id="featuredFill"></div></div>
  </div>

  <div class="selector">
    <span class="selector-title">Selector</span>
    <div class="dots" id="featuredDots">
      {% for it in featured_items %}
        <button class="dot {% if loop.first %}active{% endif %}" data-idx="{{ loop.index0 }}"></button>
      {% endfor %}
    </div>
  </div>
  {% else %}
    <div class="featured-empty">No featured items yet.</div>
  {% endif %}
</section>

<!-- INFO & QUICK LINKS -->
<section class="quick">
  <button class="pill-btn" id="howBtn">New here? Tap here to learn how it works!</button>
  <a class="pill-btn" href="{{ url_for('orders') }}">Order history</a>
  <button class="pill-icon" id="watchBtn" title="Open watch list">üî≠</button>
</section>

<!-- CATEGORIES -->
<section class="cats">
  <div class="cats-head">Categories</div>
  <div class="cat-grid">
    {% for label in category_order %}
      <button class="cat-btn" data-cat="{{ label }}">
        <span class="cat-pokeball"></span>
        <span class="cat-name">{{ label }}</span>
      </button>
    {% endfor %}
    <button class="cat-btn" data-cat="All">
      <span class="cat-pokeball"></span>
      <span class="cat-name">View All</span>
    </button>
  </div>
</section>

<!-- TOOLBAR -->
<section class="toolbar">
  <div class="search">
    <span class="icon">üîé</span>
    <input id="searchBox" placeholder="Search" autocomplete="off">
  </div>
  <div class="bar-actions">
    <div class="menu">
      <button id="filterBtn">Filter</button>
      <div class="menu-dd" id="filterMenu">
        <button data-filter="All">All</button>
        {% for label in category_order %}
          <button data-filter="{{ label }}">{{ label }}</button>
        {% endfor %}
      </div>
    </div>

    <div class="menu">
      <button id="sortBtn">Sort</button>
      <div class="menu-dd" id="sortMenu">
        <button data-sort="new">Newest</button>
        <button data-sort="cost-asc">Cost ‚Üë</button>
        <button data-sort="cost-desc">Cost ‚Üì</button>
        <button data-sort="stock-desc">Stock</button>
      </div>
    </div>

    <div class="view">
      <span>Grid</span>
      <button class="view-tgl active" id="gridToggle">‚ñ¶</button>
      <span>List</span>
      <button class="view-tgl" id="listToggle">‚â£</button>
    </div>
  </div>
</section>

<!-- ITEMS GRID -->
<section class="items">
  <div id="itemsGrid" class="grid grid-mode">
    {% for it in items %}
      <a class="card"
         href="{{ url_for('catalog_item', item_id=it.id) }}"
         data-id="{{ it.id }}"
         data-name="{{ it.name | lower }}"
         data-cat="{{ it._cat }}"
         data-cost="{{ it.cost_stamps }}"
         data-stock="{{ it.stock }}"
         data-created="{{ it._created }}">

        <!-- top badges -->
        <div class="badges">
          <span class="cost">Cost<br><b>{{ it.cost_stamps }}</b></span>
          <button class="watch {% if it.id in watch_ids %}active{% endif %}"
                  type="button" title="Watch"
                  data-id="{{ it.id }}"
                  onclick="toggleWatch(event, '{{ it.id }}')">üëÄ</button>
        </div>

        <!-- image -->
        <div class="thumb" style="background-image:url('{{ it.image_url }}');">
          <span class="thumb-alt">Image</span>
        </div>

        <!-- meta -->
        <div class="meta">
          <div class="title">{{ it.name }}</div>
          <div class="desc">{{ it.description or "Description" }}</div>
        </div>

        <!-- actions row -->
        <div class="actions">
          <div class="tags">
            {% for t in (it.tags or [])[:3] %}
              <span class="tag">#{{ t }}</span>
            {% endfor %}
            {% if (it.tags or [])|length > 3 %}<span class="tag">‚Ä¶</span>{% endif %}
          </div>
          <span class="buy" title="Buy / View">Buy/View</span>
        </div>
      </a>
    {% else %}
      <p class="empty">No prizes online yet.</p>
    {% endfor %}
  </div>
</section>

<!-- FLOATING BACK TO TOP -->
<button class="backtop" id="backTopBtn">Back to top</button>

<!-- HOW IT WORKS MODAL -->
<div class="modal" id="howModal" aria-hidden="true">
  <div class="modal-card">
    <button class="close" data-close>‚úñ</button>
    <h3>How the Catalog Works</h3>
    <ol>
      <li>Browse categories and pick a prize.</li>
      <li>Tap a card to view details, then Redeem with stamps.</li>
      <li>Select a meet-up to collect your prize.</li>
      <li>Track it in <b>Order history</b> ‚Äî status updates land in your inbox.</li>
    </ol>
  </div>
</div>

<!-- WATCHLIST MODAL -->
<div class="modal" id="watchModal" aria-hidden="true">
  <div class="modal-card">
    <button class="close" data-close>‚úñ</button>
    <h3>Watch list</h3>
    <div id="watchList" class="watch-list">Loading‚Ä¶</div>
  </div>
</div>

<style>
/* ---------- Hero ---------- */
.hero{display:flex;gap:12px;background:#51aaf4;border-radius:20px;padding:14px;align-items:center;
  box-shadow:0 6px 16px rgba(0,0,0,.08);}
.hero-icon{width:72px;height:72px;border-radius:16px;background:#a8d6ff;}
.hero-body h1{margin:0;font-size:42px;line-height:1;letter-spacing:.5px;}
.hero-body .sub{margin:.25rem 0 .4rem;color:#083b66;opacity:.9}
.backlink{color:#083b66;text-decoration:none}

/* ---------- Featured ---------- */
.featured{margin-top:14px;}
.featured-tab{display:inline-block;background:#e6f3ff;color:#0f3a66;border-radius:8px 8px 0 0;padding:6px 10px;font-weight:700}
.featured-stage{position:relative;background:#bfc7d2;border-radius:12px;overflow:hidden;height:220px}
.featured-slide{position:absolute;inset:0;background:center/cover no-repeat;opacity:0;pointer-events:none;transition:opacity .25s}
.featured-slide.active{opacity:1;pointer-events:auto}
.slide-alt{position:absolute;left:-9999px}
.loadbar{position:absolute;left:0;right:0;bottom:0;height:6px;background:rgba(255,255,255,.5)}
.loadbar .fill{height:100%;width:0;background:#3a8dde}
.selector{display:flex;align-items:center;gap:10px;background:#e6f3ff;border-radius:0 0 12px 12px;padding:8px 10px}
.selector-title{font-weight:700}
.dots{display:flex;gap:8px;align-items:center}
.dot{width:12px;height:12px;border-radius:50%;border:2px solid #0f3a66;background:transparent;cursor:pointer}
.dot.active{background:#0f3a66}

/* ---------- Quick Links ---------- */
.quick{display:flex;gap:10px;align-items:center;margin-top:12px}
.pill-btn{border:none;background:#e6f6ff;color:#0f3a66;padding:8px 10px;border-radius:999px;font-weight:700;cursor:pointer}
.pill-icon{width:40px;height:40px;border-radius:999px;border:none;background:#ffeab5;cursor:pointer;font-size:18px}

/* ---------- Categories ---------- */
.cats{background:#51aaf4;border-radius:14px;padding:12px;margin-top:10px;color:#0b2239}
.cats-head{font-weight:800;margin-bottom:8px}
.cat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media(min-width:560px){.cat-grid{grid-template-columns:repeat(5,1fr)}}
.cat-btn{border:none;background:transparent;cursor:pointer;text-align:center}
.cat-pokeball{display:inline-block;width:70px;height:70px;border-radius:50%;
  background:radial-gradient(circle at 50% 50%, #111 30%, #fff 31% 60%, transparent 61%), 
             radial-gradient(circle at 50% 50%, transparent 0 43%, #e94d3c 44% 60%, transparent 61%);
  box-shadow:0 0 0 8px #e94d3c, inset 0 0 0 4px #111;}
.cat-name{display:block;margin-top:6px;font-weight:700}

/* ---------- Toolbar ---------- */
.toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:12px 0}
.search{display:flex;align-items:center;background:#f3f6fb;border-radius:8px;padding:6px 10px;flex:1}
.search .icon{margin-right:6px}
.search input{border:none;background:transparent;outline:none;flex:1}
.bar-actions{display:flex;align-items:center;gap:10px}
.menu{position:relative}
.menu > button{border:none;background:#f3f6fb;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
.menu-dd{position:absolute;top:calc(100% + 6px);left:0;background:#fff;border:1px solid #e5e7eb;border-radius:10px;display:none;flex-direction:column;min-width:140px;box-shadow:0 8px 18px rgba(0,0,0,.08);z-index:5}
.menu-dd button{border:none;background:transparent;padding:8px 10px;text