{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-wide' %}
{% endblock %}

{% block content %}

<style>
:root {
  --blue:#3a8dde; --sky:#e9f0ff; --card:#fff; --ink:#1f2937; --muted:#6b7280;
  --chip:#eef2ff; --radius:18px; --divider:#e5e7eb;
}

.section{margin:10px 0;padding-bottom:4px;border-bottom:1px solid var(--divider);}
.section:last-of-type{border-bottom:none;}

/* HERO */
.catalog-hero{
  display:flex;align-items:center;gap:10px;
  background:var(--blue);color:#fff;padding:10px;border-radius:18px;margin-bottom:6px;
}
.catalog-icon{width:60px;height:60px;border-radius:14px;flex:0 0 auto;
  background:url('{{ url_for("static", filename="catalog/catalog-app.png") }}') center/cover no-repeat;}
.catalog-title h1{margin:0;font-size:1.7rem;line-height:1;}
.catalog-title p{margin:.25rem 0 .3rem;opacity:.95;}
.back-link{color:#e0eaff;text-decoration:none;font-size:.92rem;}

/* FEATURED */
.featured-carousel{position:relative;overflow:hidden;border-radius:18px;margin-bottom:8px;}
.carousel-track{display:flex;transition:transform .65s cubic-bezier(.25,.8,.25,1);will-change:transform;}
.carousel-slide{min-width:100%;display:flex;justify-content:center;}
.carousel-slide img{width:100%;height:auto;max-height:260px;object-fit:cover;border-radius:18px;transform:scale(.96);transition:transform .65s cubic-bezier(.25,.8,.25,1);}
.carousel-slide.active img{transform:scale(1);}
@media(min-width:768px){.carousel-slide img{max-height:340px;}}
.carousel-controls{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:10px;}
.carousel-prev,.carousel-next{background:rgba(255,255,255,.85);border:none;border-radius:50%;width:32px;height:32px;font-size:1.15rem;line-height:32px;cursor:pointer;}
.carousel-dots{display:flex;gap:10px;}
.carousel-dots .dot{width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid #000;position:relative;overflow:hidden;box-shadow:0 1px 2px rgba(0,0,0,.18);cursor:pointer;}
.carousel-dots .dot::before{content:"";position:absolute;left:0;top:0;width:100%;height:100%;background:linear-gradient(135deg,#f472b6,#3b82f6);transform:scaleX(0);transform-origin:left;transition:transform .4s ease;}
.carousel-dots .dot::after{content:"";position:absolute;left:50%;top:50%;width:6px;height:6px;background:#fff;border:2px solid #000;border-radius:50%;transform:translate(-50%,-50%);}
.carousel-dots .dot.active{transform:scale(1.2);border-color:var(--blue);box-shadow:0 0 6px rgba(58,141,222,.6);}
.carousel-dots .dot.active::before{transform:scaleX(1);}

/* QUICK LINKS */
.quick-links{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.quick-links .quick-link{
  display:inline-flex;align-items:center;justify-content:center;
  height:36px;padding:0 10px;background:var(--chip);color:var(--blue);
  border-radius:10px;text-decoration:none;font-weight:500;font-size:0.85rem;white-space:nowrap;
}
.quick-links .watchlist-btn{
  display:inline-flex;align-items:center;justify-content:center;width:42px;height:36px;background:var(--chip);
  border:none;border-radius:10px;cursor:pointer;flex:0 0 auto;
}
.quick-links .watchlist-btn img{width:20px;height:20px;object-fit:contain;}

/* CATEGORY TITLE + ICON */
.catalog-header{display:flex;align-items:center;gap:10px;margin:10px 0;}
.icon-wrapper{position:relative;width:36px;height:36px;}
.icon-wrapper img{width:36px;height:36px;object-fit:contain;transition:opacity .3s, transform .3s;}
.catalog-header.fading img,.catalog-header.fading h2{opacity:0;transform:scale(.95);}
.catalog-header h2{font-size:1.5rem;margin:0;font-weight:700;color:var(--ink);transition:opacity .3s, transform .3s;}
.shine{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:50%;opacity:0;pointer-events:none;}
.icon-wrapper.pulse .shine{animation:pulseShine .9s ease-out;}
@keyframes pulseShine{0%{transform:scale(.5);opacity:.9;}60%{transform:scale(1.3);opacity:.5;}100%{transform:scale(1.6);opacity:0;}}
.icon-wrapper[data-cat="Pins"] .shine{background:radial-gradient(circle,rgba(255,215,0,0.8),transparent 70%);}
.icon-wrapper[data-cat="Plushies"] .shine{background:radial-gradient(circle,rgba(255,105,180,0.8),transparent 70%);}
.icon-wrapper[data-cat="TCG"] .shine{background:radial-gradient(circle,rgba(0,191,255,0.8),transparent 70%);}
.icon-wrapper[data-cat="Keychains"] .shine{background:radial-gradient(circle,rgba(255,140,0,0.8),transparent 70%);}
.icon-wrapper[data-cat="Accessories"] .shine{background:radial-gradient(circle,rgba(144,238,144,0.8),transparent 70%);}
.icon-wrapper[data-cat="Games"] .shine{background:radial-gradient(circle,rgba(186,85,211,0.8),transparent 70%);}
.icon-wrapper[data-cat="Bundles"] .shine{background:radial-gradient(circle,rgba(255,0,0,0.8),transparent 70%);}
.icon-wrapper[data-cat="default"] .shine{background:radial-gradient(circle,rgba(255,255,255,0.7),transparent 70%);}

/* SEARCH + FILTER BAR */
.category-tools{display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:6px;margin-bottom:8px;position:relative;}
.search-wrapper{position:relative;flex:1 1 100%;}
.search-wrapper input[type="search"]{width:100%;padding:8px 34px 8px 10px;border:1px solid var(--divider);border-radius:10px;font-size:0.9rem;}
.clear-btn{
  position:absolute;right:10px;top:50%;transform:translateY(-50%);
  background:var(--blue);color:#fff;border:none;width:20px;height:20px;border-radius:50%;
  font-weight:700;font-size:0.8rem;cursor:pointer;display:none;
}
.category-actions{display:flex;gap:6px;flex-wrap:wrap;}
.category-actions select{padding:8px 10px;border:1px solid var(--divider);border-radius:10px;background:var(--chip);font-size:0.9rem;cursor:pointer;max-width:160px;}

/* ITEM GRID */
.item-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:8px 0 12px;}
.item-card{
  background:#fff;
  border-radius:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  transition:opacity .35s ease, transform .35s ease;
}
.item-card.filter-hidden{opacity:0;transform:translateY(12px);}
.card-top{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;}
.cost-pill{display:flex;align-items:center;gap:6px;background:#d1fae5;border-radius:12px;padding:4px 8px;}
.cost-pill img{height:20px;width:auto;}
.cost-pill span{font-weight:700;font-size:.95rem;color:#064e3b;line-height:1;}
.watch-btn{background:none;border:none;width:32px;height:32px;padding:0;cursor:pointer;}
.watch-btn img{width:100%;height:100%;object-fit:contain;}
.card-image{width:100%;aspect-ratio:1/1;background:#eef3f8 center/cover no-repeat;}
.card-info{display:flex;justify-content:space-between;align-items:stretch;background:#74bdf0;color:#fff;padding:9px;}
.card-info .text{flex:1;display:flex;flex-direction:column;justify-content:center;gap:4px;}
.card-info h3{margin:0;font-size:1rem;font-weight:700;line-height:1.2;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;display:-webkit-box;}
.card-info p{margin:0;font-size:.85rem;opacity:.9;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;display:-webkit-box;}
.trade-btn img{height:100%;max-height:60px;width:auto;}
.card-footer{display:flex;flex-wrap:nowrap;gap:6px;align-items:center;padding:8px 10px 10px;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
.card-footer::-webkit-scrollbar{display:none;}
.stock-pill{background:#f8c07a;color:#2a1800;border-radius:12px;padding:3px 6px;font-size:.8rem;flex-shrink:0;}
.tag-chip{background:#dcebfb;color:#0c4781;border-radius:12px;padding:3px 6px;font-size:.8rem;white-space:nowrap;cursor:pointer;transition:background .2s;}
.tag-chip:hover{background:#c7dbf9;}

/* BOTTOM TOOLBAR */
.bottom-bar{
  position:fixed;bottom:-60px;left:50%;transform:translateX(-50%);
  background:rgba(58,141,222,0.88);color:#fff;border-radius:30px;
  display:flex;align-items:center;justify-content:center;gap:26px;
  padding:8px 20px;z-index:99;box-shadow:0 4px 10px rgba(0,0,0,0.2);
  transition:bottom .3s ease;
}
.bottom-bar.show{bottom:20px;}
.bottom-bar button{
  background:none;border:none;color:#fff;font-size:1.2rem;
  cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;
}
.bottom-bar button img{width:24px;height:24px;object-fit:contain;}

/* WATCHLIST MODAL */
#watchlist-modal{
  position:fixed;inset:0;background:rgba(15,23,42,0.45);
  display:flex;align-items:center;justify-content:center;z-index:120;
  transition:opacity .25s ease;
  opacity:1;
  visibility:visible;
}
#watchlist-modal.hidden{opacity:0;pointer-events:none;visibility:hidden;}
.watchlist-modal{
  position:relative;
  width:min(420px,92vw);
  background:linear-gradient(160deg,#ffffff 0%,#e8f0ff 65%,#dfe7ff 100%);
  border-radius:22px;
  padding:20px 18px 22px;
  box-shadow:0 22px 50px rgba(15,23,42,0.35);
  display:flex;
  flex-direction:column;
  gap:18px;
  transform:scale(.95);
  opacity:0;
  transition:transform .3s ease, opacity .3s ease;
}
#watchlist-modal:not(.hidden) .watchlist-modal{transform:scale(1);opacity:1;}
.watchlist-head{display:flex;flex-direction:column;gap:6px;}
.watchlist-head h2{margin:0;font-size:1.5rem;color:#0f172a;}
.watchlist-count{margin:4px 0 0;font-weight:600;color:#1d4ed8;}
.watchlist-note{margin:2px 0 0;color:#475569;font-size:0.85rem;}
.watchlist-list{display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow-y:auto;padding-right:4px;}
.watchlist-list::-webkit-scrollbar{width:6px;}
.watchlist-list::-webkit-scrollbar-thumb{background:rgba(29,78,216,0.3);border-radius:999px;}
.watchlist-empty,.watchlist-loading{background:rgba(241,245,249,0.9);border-radius:16px;padding:18px;text-align:center;color:#475569;font-weight:600;line-height:1.5;}
.watchlist-card{display:flex;align-items:center;gap:12px;background:#fff;border-radius:18px;padding:12px;box-shadow:0 10px 22px rgba(15,23,42,0.14);}
.watch-thumb{width:70px;height:70px;border-radius:16px;background:#eef3f8 center/cover no-repeat;flex-shrink:0;}
.watch-details{flex:1;display:flex;flex-direction:column;gap:10px;}
.watch-title{display:flex;align-items:center;justify-content:space-between;gap:10px;}
.watch-title h3{margin:0;font-size:1rem;color:#0f172a;line-height:1.2;}
.watch-remove{background:transparent;border:1px solid rgba(239,68,68,0.4);color:#b91c1c;border-radius:999px;padding:4px 10px;font-size:0.75rem;font-weight:600;cursor:pointer;transition:background .2s ease, color .2s ease, border-color .2s ease;}
.watch-remove:hover{background:#fee2e2;border-color:#fca5a5;color:#991b1b;}
.watch-meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
.cost-pill--small{padding:3px 8px;}
.cost-pill--small img{height:18px;}
.cost-pill--small span{font-size:0.85rem;}
.stock-pill--small{padding:3px 8px;font-size:0.75rem;}
.tag-chip--small{font-size:0.75rem;padding:3px 6px;}
.watch-view{align-self:stretch;display:inline-flex;align-items:center;justify-content:center;width:94px;padding:10px 12px;background:#2563eb;color:#fff;text-decoration:none;border-radius:14px;font-weight:600;transition:transform .2s ease, box-shadow .2s ease;}
.watch-view:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(37,99,235,0.25);}
.close-circle{position:absolute;top:12px;right:12px;background:rgba(15,23,42,0.08);border:none;border-radius:50%;width:32px;height:32px;font-size:1.2rem;line-height:1;color:#0f172a;cursor:pointer;transition:background .2s ease;}
.close-circle:hover{background:rgba(15,23,42,0.2);}

/* TUTORIAL MODAL */
#catalog-tutorial{
  position:fixed;inset:0;background:rgba(15,23,42,0.5);
  display:flex;align-items:flex-start;justify-content:center;z-index:130;
  padding:90px 14px 24px;
  overflow-y:auto;
  transition:opacity .25s ease;
  opacity:1;
  visibility:visible;
}
#catalog-tutorial.hidden{opacity:0;pointer-events:none;visibility:hidden;}
.tutorial-modal{
  position:relative;
  width:min(480px,92vw);
  max-height:calc(100vh - 140px);
  background:linear-gradient(150deg,#ffffff 0%,#f2f6ff 100%);
  border-radius:28px;
  padding:22px 22px 24px;
  box-shadow:0 30px 60px rgba(15,23,42,0.4);
  display:flex;
  flex-direction:column;
  gap:18px;
  overflow-y:auto;
  transform:scale(.95);
  opacity:0;
  transition:transform .3s ease, opacity .3s ease;
}
#catalog-tutorial:not(.hidden) .tutorial-modal{transform:scale(1);opacity:1;}
.tutorial-hero{display:flex;gap:14px;align-items:center;}
.tutorial-hero img{
  width:72px;
  height:72px;
  border-radius:18px;
  object-fit:cover;
  box-shadow:0 6px 18px rgba(37,99,235,0.25);
}
.tutorial-hero h2{margin:0;font-size:1.35rem;color:#0f172a;}
.tutorial-hero p{margin:4px 0 0;color:#475569;font-size:0.95rem;line-height:1.4;}
.tutorial-steps{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
}
.tutorial-card{
  background:#fff;
  border-radius:18px;
  padding:14px;
  box-shadow:0 10px 26px rgba(15,23,42,0.12);
  display:flex;
  flex-direction:column;
  gap:8px;
}
.tutorial-card img{width:56px;height:56px;object-fit:contain;}
.tutorial-card h3{margin:0;color:#0f172a;font-size:1rem;}
.tutorial-card p{margin:0;color:#475569;font-size:0.9rem;line-height:1.4;}
.tutorial-note{margin:0;color:#475569;font-size:0.85rem;}
.tutorial-actions{display:flex;flex-direction:column;gap:10px;}
.tutorial-actions button{
  border:none;
  border-radius:999px;
  background:#2563eb;
  color:#fff;
  font-weight:700;
  font-size:1rem;
  padding:12px;
  cursor:pointer;
  box-shadow:0 12px 24px rgba(37,99,235,0.35);
  transition:transform .1s ease;
}
.tutorial-actions button:active{transform:translateY(1px);}
.tutorial-secondary{
  display:inline-flex;
  justify-content:center;
  align-items:center;
  text-decoration:none;
  font-weight:600;
  color:#1d4ed8;
  font-size:0.9rem;
}
@media(min-width:520px){
  .tutorial-actions{flex-direction:row;align-items:center;}
  .tutorial-secondary{flex:1;}
}

</style>

<!-- HERO -->
<div class="section catalog-hero">
  <div class="catalog-icon"></div>
  <div class="catalog-title">
    <h1>Catalog</h1>
    <p>Trade in your stamps for community rewards, merch, and digital codes!</p>
    <a href="{{ url_for('dashboard') }}" class="back-link">&lt; back to dashboard</a>
  </div>
</div>

<!-- FEATURED -->
{% if featured_slides %}
<div class="section featured-carousel" id="featuredSection">
  <div class="carousel-track">
    {% for slide in featured_slides %}
    <div class="carousel-slide">
      <img src="{{ slide.url }}" alt="{{ slide.alt }}">
    </div>
    {% endfor %}
  </div>
  <div class="carousel-controls">
    <button class="carousel-prev" type="button" aria-label="Previous featured slide">‚Äπ</button>
    <div class="carousel-dots">
      {% for slide in featured_slides %}
        <span class="dot{% if loop.first %} active{% endif %}" data-index="{{ loop.index0 }}"></span>
      {% endfor %}
    </div>
    <button class="carousel-next" type="button" aria-label="Next featured slide">‚Ä∫</button>
  </div>
</div>
{% endif %}

<!-- QUICK LINKS -->
<div class="section quick-links">
  <a href="#" id="catalogTutorialLink" class="quick-link" role="button">‚ÑπÔ∏è New here?!</a>
  <a href="#" id="orderHistoryLink" class="quick-link" role="button">Order history</a>
  <button class="watchlist-btn" onclick="toggleWatchlist()"><img src="{{ url_for('static', filename='catalog/binocularsb.png') }}" alt="Watchlist"></button>
</div>

<!-- CATEGORY TITLE + FILTER BAR -->
<div class="catalog-header">
  <div class="icon-wrapper" data-cat="default">
    <img id="categoryIcon" src="{{ url_for('static', filename='icons/tickstamp.png') }}" alt="icon">
    <div class="shine"></div>
  </div>
  <h2 id="categoryTitle">All Items</h2>
</div>

<div class="category-tools">
  <div class="search-wrapper">
    <input type="search" id="catalog-search" placeholder="Search...">
    <button id="clearSearch" class="clear-btn">√ó</button>
  </div>
  <div class="category-actions">
    <select id="filter-select">
      <option value="all">All Categories</option>
      <option value="Pins">Pins</option>
      <option value="Plushies">Plushies</option>
      <option value="TCG">TCG</option>
      <option value="Keychains">Keychains</option>
      <option value="Accessories">Accessories</option>
      <option value="Games">Games</option>
      <option value="Bundles">Bundles</option>
    </select>
    <select id="sort-select">
      <option value="newest">Newest</option>
      <option value="oldest">Oldest</option>
      <option value="lowcost">Lowest Cost</option>
      <option value="highcost">Highest Cost</option>
    </select>
  </div>
</div>

<!-- ITEM GRID -->
<section class="item-grid">
  {% for it in items %}
  <div class="item-card">
    <div class="card-top">
      <div class="cost-pill">
        <img src="{{ url_for('static', filename='passport/stamper.png') }}" alt="cost">
        <span>{{ it.cost_stamps }}</span>
      </div>
      <button class="watch-btn" data-id="{{ it.id }}" onclick="toggleWatch(this)">
        <img
          src="{{ url_for('static', filename='catalog/' + ('binocularsb.png' if it.id in watch_ids else 'binocularsa.png')) }}"
          data-a="{{ url_for('static', filename='catalog/binocularsa.png') }}"
          data-b="{{ url_for('static', filename='catalog/binocularsb.png') }}"
          alt="watch">
      </button>
    </div>

    <div class="card-image" style="background-image:url('{{ it.image_url }}');"></div>

    <div class="card-info">
      <div class="text">
        <h3>{{ it.name }}</h3>
        <p>{{ it.description }}</p>
      </div>
      <a class="trade-btn" href="{{ url_for('catalog_item', item_id=it.id) }}">
        <img src="{{ url_for('static', filename='catalog/container/trade.PNG') }}" alt="trade">
      </a>
    </div>

    <div class="card-footer js-tag-row">
      <span class="stock-pill">üì¶ {{ it.stock }}</span>
      {% for t in it.tags %}
        <span class="tag-chip">#{{ t }}</span>
      {% endfor %}
    </div>
  </div>
  {% endfor %}
</section>

<!-- WATCHLIST MODAL -->
<div id="watchlist-modal" class="modal hidden">
  <div class="watchlist-modal">
    <button class="close-circle" type="button" onclick="toggleWatchlist()">√ó</button>
    <header class="watchlist-head">
      <h2>üëÄ Your Watchlist</h2>
      <p id="watchlist-count" class="watchlist-count"></p>
      <p class="watchlist-note">Save up to {{ watchlist_limit }} catalog items to revisit them quickly.</p>
    </header>
    <div id="watchlist-items" class="watchlist-list">Loading...</div>
  </div>
</div>

<!-- ONBOARDING MODAL -->
<div id="catalog-tutorial" class="modal hidden">
  <div class="tutorial-modal">
    <button type="button" class="close-circle" id="closeTutorialBtn">√ó</button>
    <section class="tutorial-hero">
      <img src="{{ url_for('static', filename='catalog/catalog-app.png') }}" alt="Catalog preview">
      <div>
        <h2>New here?</h2>
        <p>Here is the quickstart guide to earning stamps, navigating the catalog, and redeeming merch.</p>
      </div>
    </section>
    <div class="tutorial-steps">
      <article class="tutorial-card">
        <img src="{{ url_for('static', filename='passport/stamper.png') }}" alt="Stamp icon">
        <div>
          <h3>1. Earn stamps</h3>
          <p>Check in at RDAB events, participate in special events, work on your community medals, or win competitions. Your current stamp allowance always lives at the top of every page in the app.</p>
        </div>
      </article>
      <article class="tutorial-card">
        <img src="{{ url_for('static', filename='catalog/binocularsb.png') }}" alt="Watchlist icon">
        <div>
          <h3>2. Make a watchlist</h3>
          <p>Explore the catalog! See something you want? Tap the binoculars on the item to save it to your wishlist, so that you know what to grind for.</p>
        </div>
      </article>
      <article class="tutorial-card">
        <img src="{{ url_for('static', filename='catalog/container/trade.PNG') }}" alt="Trade button">
        <div>
          <h3>3. Redeem and collect</h3>
          <p>Find the item you want to redeem stamps for, hit the trade icon, and confirm everything. Select a meet-up to pick the merch up from. You'll then be sent a receipt to your inbox so you can double check when and where you wanted to pick it up from! If you don't make the meet-up and don't let us know before hand, we'll cancel your redemption and put the prize back out there!</p>
        </div>
      </article>
    </div>
    <p class="tutorial-note">Pro tip: Pins, plushies, merch and codes rotate each month, so check back regularly after meetups for fresh drops.</p>
    <div class="tutorial-actions">
      <button type="button" id="tutorialStartBtn">Got it, let's shop</button>
      <a href="{{ url_for('inbox', tab='receipts') }}" class="tutorial-secondary">See my redemptions</a>
    </div>
  </div>
</div>

<!-- üîµ Bottom Toolbar -->
<div class="bottom-bar" id="bottomBar">
  <button id="scrollToSearch" title="Search">üîç</button>
  <button id="scrollTop" title="Top">‚¨ÜÔ∏è</button>
  <button id="openWatchlist" title="Watchlist"><img src="{{ url_for('static', filename='catalog/binocularsb.png') }}"></button>
</div>

<script>
/* --- Clear Search --- */
const searchInput=document.getElementById("catalog-search");
const clearBtn=document.getElementById("clearSearch");
searchInput.addEventListener("input",()=>{clearBtn.style.display=searchInput.value? "block":"none";applyFilters();});
clearBtn.addEventListener("click",()=>{searchInput.value="";clearBtn.style.display="none";applyFilters();});

/* --- Tag click ‚Üí auto filter --- */
document.addEventListener("click", e=>{
  if(e.target.classList.contains("tag-chip")){
    const tag=e.target.textContent.replace("#","").trim();
    searchInput.value=tag;
    applyFilters();
  }
});

/* --- Featured Carousel --- */
const track=document.querySelector(".carousel-track");
const slides=track?Array.from(track.querySelectorAll(".carousel-slide")):[];
const dots=document.querySelectorAll(".carousel-dots .dot");
const prevBtn=document.querySelector(".carousel-prev");
const nextBtn=document.querySelector(".carousel-next");
let currentIndex=0;
let autoTimer=null;
function updateCarousel(){
  if(!track||!slides.length)return;
  track.style.transform=`translateX(-${currentIndex*100}%)`;
  slides.forEach((slide,i)=>slide.classList.toggle("active",i===currentIndex));
  dots.forEach((d,i)=>d.classList.toggle("active",i===currentIndex));
}
function goTo(index){
  if(!slides.length)return;
  const total=slides.length;
  currentIndex=(index%total+total)%total;
  updateCarousel();
}
function nextSlide(){goTo(currentIndex+1);}
function prevSlide(){goTo(currentIndex-1);}
function restartAuto(){
  if(autoTimer){clearInterval(autoTimer);}
  if(slides.length>1){autoTimer=setInterval(nextSlide,6000);}
}
if(track&&slides.length){
  updateCarousel();
  if(slides.length<=1){
    const controls=document.querySelector(".carousel-controls");
    if(controls){controls.style.display="none";}
  }else{
    restartAuto();
  }
  nextBtn?.addEventListener("click",()=>{nextSlide();restartAuto();});
  prevBtn?.addEventListener("click",()=>{prevSlide();restartAuto();});
  dots.forEach(dot=>dot.addEventListener("click",()=>{
    const idx=parseInt(dot.dataset.index||"0",10);
    goTo(Number.isNaN(idx)?0:idx);
    restartAuto();
  }));
}

/* --- Watchlist --- */
const WATCHLIST_LIMIT = {{ watchlist_limit }};
const watchlistModal = document.getElementById("watchlist-modal");
const watchlistContainer = document.getElementById("watchlist-items");
const watchlistCountEl = document.getElementById("watchlist-count");
const stamperIcon = "{{ url_for('static', filename='passport/stamper.png') }}";
const tutorialModal = document.getElementById("catalog-tutorial");
const tutorialLink = document.getElementById("catalogTutorialLink");
const tutorialStartBtn = document.getElementById("tutorialStartBtn");
const tutorialCloseBtn = document.getElementById("closeTutorialBtn");
const orderHistoryLink = document.getElementById("orderHistoryLink");
const inboxReceiptsPanelUrl = "{{ url_for('inbox', tab='receipts', panel=1) }}";
const inboxReceiptsPageUrl = "{{ url_for('inbox', tab='receipts') }}";

function setWatchlistCount(count) {
  if (watchlistCountEl) {
    watchlistCountEl.textContent = `${count}/${WATCHLIST_LIMIT} saved`;
  }
}

function syncBodyScrollLock() {
  const modalOpen =
    (watchlistModal && !watchlistModal.classList.contains("hidden")) ||
    (tutorialModal && !tutorialModal.classList.contains("hidden"));
  document.body.style.overflow = modalOpen ? "hidden" : "";
}

function renderWatchlistMessage(message, count) {
  if (typeof count === "number") setWatchlistCount(count);
  if (!watchlistContainer) return;
  watchlistContainer.innerHTML = "";
  const box = document.createElement("div");
  box.className = message.includes("Loading") ? "watchlist-loading" : "watchlist-empty";
  box.innerHTML = message;
  watchlistContainer.appendChild(box);
}

function toggleWatchlist() {
  if (!watchlistModal) return;
  const willOpen = watchlistModal.classList.contains("hidden");
  watchlistModal.classList.toggle("hidden");
  syncBodyScrollLock();
  if (willOpen) {
    renderWatchlistMessage("Loading‚Ä¶");
    loadWatchlist();
  }
}

function loadWatchlist() {
  if (!watchlistContainer) return;
  fetch("/watchlist")
    .then(r => r.json())
    .then(data => {
      if (!data.success) {
        renderWatchlistMessage("‚ö†Ô∏è Error loading watchlist.");
        return;
      }
      const limit = Number(data.limit) || WATCHLIST_LIMIT;
      const count = Number(data.count) || 0;
      setWatchlistCount(count);
      if (count === 0) {
        renderWatchlistMessage(`üì≠ Your watchlist is empty.<br>Add up to ${limit} catalog items to find them fast.`, count);
        return;
      }
      watchlistContainer.innerHTML = "";
      data.items.forEach(item => {
        const card = document.createElement("article");
        card.className = "watchlist-card";

        const thumb = document.createElement("div");
        thumb.className = "watch-thumb";
        thumb.style.backgroundImage = `url('${item.image_url}')`;

        const details = document.createElement("div");
        details.className = "watch-details";

        const titleRow = document.createElement("div");
        titleRow.className = "watch-title";

        const title = document.createElement("h3");
        title.textContent = item.name || "Untitled";

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "watch-remove";
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", () => toggleWatchFromModal(item.id));

        titleRow.append(title, removeBtn);

        const meta = document.createElement("div");
        meta.className = "watch-meta";

        const cost = document.createElement("span");
        cost.className = "cost-pill cost-pill--small";
        cost.innerHTML = `<img src="${stamperIcon}" alt="Stamps"><span>${item.cost_stamps}</span>`;

        const stock = document.createElement("span");
        stock.className = "stock-pill stock-pill--small";
        stock.textContent = `üì¶ ${item.stock}`;

        meta.append(cost, stock);

        if (Array.isArray(item.tags)) {
          item.tags.forEach(tag => {
            if (!tag) return;
            const chip = document.createElement("span");
            chip.className = "tag-chip tag-chip--small";
            chip.textContent = `#${tag}`;
            meta.appendChild(chip);
          });
        }

        details.append(titleRow, meta);

        const view = document.createElement("a");
        view.className = "watch-view";
        view.href = `/catalog/item/${item.id}`;
        view.textContent = "View item";

        card.append(thumb, details, view);
        watchlistContainer.appendChild(card);
      });
    })
    .catch(() => {
      renderWatchlistMessage("‚ö†Ô∏è Something went wrong. Please try again.");
    });
}

function toggleWatchFromModal(id) {
  fetch(`/watchlist/toggle/${id}`, { method: "POST" })
    .then(r => r.json())
    .then(data => {
      if (typeof data.count === "number") {
        setWatchlistCount(data.count);
      }
      if (!data.success) {
        alert(data.error || "Unable to update watchlist right now.");
        return;
      }
      loadWatchlist();
      document.querySelectorAll(`.watch-btn[data-id='${id}'] img`).forEach(img => {
        if (img.dataset?.a) {
          img.src = img.dataset.a;
        }
      });
    })
    .catch(() => alert("Unable to update watchlist right now."));
}

function toggleWatch(el) {
  const id = el.getAttribute("data-id");
  const img = el.querySelector("img");
  fetch(`/watchlist/toggle/${id}`, { method: "POST" })
    .then(r => r.json())
    .then(data => {
      if (typeof data.count === "number") {
        setWatchlistCount(data.count);
      }
      if (!data.success) {
        alert(data.error || "Unable to update watchlist right now.");
        return;
      }
      if (img) {
        img.src = data.watched ? img.dataset.b : img.dataset.a;
      }
      if (watchlistModal && !watchlistModal.classList.contains("hidden")) {
        loadWatchlist();
      }
    })
    .catch(() => alert("Unable to update watchlist right now."));
}

watchlistModal?.addEventListener("click", e => {
  if (e.target === watchlistModal) {
    toggleWatchlist();
  }
});

function openTutorial() {
  if (!tutorialModal) return;
  tutorialModal.classList.remove("hidden");
  syncBodyScrollLock();
}

function closeTutorial() {
  if (!tutorialModal) return;
  tutorialModal.classList.add("hidden");
  syncBodyScrollLock();
}

tutorialLink?.addEventListener("click", e => {
  e.preventDefault();
  openTutorial();
});
tutorialStartBtn?.addEventListener("click", closeTutorial);
tutorialCloseBtn?.addEventListener("click", closeTutorial);
tutorialModal?.addEventListener("click", e => {
  if (e.target === tutorialModal) {
    closeTutorial();
  }
});

function openReceiptsInboxPanel() {
  const openFn = (window.RDAB && typeof window.RDAB.openInboxPanel === "function")
    ? window.RDAB.openInboxPanel
    : (typeof window.openInboxPanel === "function" ? window.openInboxPanel : null);
  if (openFn) {
    openFn(inboxReceiptsPanelUrl);
  } else {
    window.location.href = inboxReceiptsPageUrl;
  }
}

orderHistoryLink?.addEventListener("click", e => {
  e.preventDefault();
  openReceiptsInboxPanel();
});

document.addEventListener("keydown", e => {
  if (e.key !== "Escape") return;
  if (tutorialModal && !tutorialModal.classList.contains("hidden")) {
    closeTutorial();
    return;
  }
  if (watchlistModal && !watchlistModal.classList.contains("hidden")) {
    toggleWatchlist();
  }
});

setWatchlistCount({{ watch_ids|length }});

/* --- Filters + Sort --- */
const filterSelect=document.getElementById("filter-select");
const sortSelect=document.getElementById("sort-select");
const itemGrid=document.querySelector(".item-grid");
const titleEl=document.getElementById("categoryTitle");
const iconEl=document.getElementById("categoryIcon");
const iconWrap=document.querySelector(".icon-wrapper");
const header=document.querySelector(".catalog-header");
const itemCards=Array.from(document.querySelectorAll(".item-card"));
const iconMap={
  "Pins":"/static/catalog/pins.png",
  "Plushies":"/static/catalog/plushies.png",
  "TCG":"/static/catalog/tcg.png",
  "Keychains":"/static/catalog/keychain.png",
  "Accessories":"/static/catalog/accessories.png",
  "Games":"/static/catalog/games.png",
  "Bundles":"/static/catalog/bundle.png"
};
function showCard(card){
  if(!card)return;
  if(card._hideHandler){
    card.removeEventListener("transitionend",card._hideHandler);
    card._hideHandler=null;
  }
  if(card.style.display==="none"){
    card.style.display="";
    card.classList.add("filter-hidden");
    requestAnimationFrame(()=>card.classList.remove("filter-hidden"));
  }else{
    card.classList.remove("filter-hidden");
  }
}
function hideCard(card){
  if(!card||card.style.display==="none")return;
  if(card._hideHandler){
    card.removeEventListener("transitionend",card._hideHandler);
    card._hideHandler=null;
  }
  card.classList.add("filter-hidden");
  const onEnd=e=>{
    if(e.propertyName!=="opacity")return;
    card.style.display="none";
    card.removeEventListener("transitionend",onEnd);
    card._hideHandler=null;
  };
  card._hideHandler=onEnd;
  card.addEventListener("transitionend",onEnd);
}
function updateIcon(val){
  const newSrc=iconMap[val]||"/static/icons/tickstamp.png";
  const newTitle=val||"All Items";
  header.classList.add("fading");
  setTimeout(()=>{iconEl.src=newSrc;titleEl.textContent=newTitle;header.classList.remove("fading");
  const cat=val||"default";iconWrap.dataset.cat=cat;iconWrap.classList.remove("pulse");void iconWrap.offsetWidth;iconWrap.classList.add("pulse");},250);
}
function applyFilters(){
  const term=searchInput.value.toLowerCase();const filter=filterSelect.value.toLowerCase();
  itemCards.forEach(card=>{
    const name=card.querySelector("h3").textContent.toLowerCase();
    const desc=card.querySelector("p").textContent.toLowerCase();
    const tags=(card.querySelector(".card-footer")?.innerText||"").toLowerCase();
    let matchSearch=!term||name.includes(term)||desc.includes(term)||tags.includes(term);
    let matchFilter=filter==="all"||tags.includes(filter);
    if(matchSearch&&matchFilter){showCard(card);}else{hideCard(card);}
  });
  updateIcon(filter==="all"?"":filter.charAt(0).toUpperCase()+filter.slice(1));
}
function applySort(){
  const sortVal=sortSelect.value;const cards=Array.from(document.querySelectorAll(".item-card"));
  cards.sort((a,b)=>{
    const costA=parseInt(a.querySelector(".cost-pill span").textContent)||0;
    const costB=parseInt(b.querySelector(".cost-pill span").textContent)||0;
    const stockA=parseInt(a.querySelector(".stock-pill").textContent.replace(/\D/g,""))||0;
    const stockB=parseInt(b.querySelector(".stock-pill").textContent.replace(/\D/g,""))||0;
    switch(sortVal){
      case"lowcost":return costA-costB;
      case"highcost":return costB-costA;
      case"oldest":return 1;
      default:return 0;
    }
  });
  cards.forEach(c=>itemGrid.appendChild(c));
}
filterSelect.addEventListener("change",applyFilters);
sortSelect.addEventListener("change",applySort);
</script>

<script>
/* --- Bottom bar scroll logic --- */
const bottomBar=document.getElementById("bottomBar");
window.addEventListener("scroll",()=>{
  if(window.scrollY>150){bottomBar.classList.add("show");}
  else{bottomBar.classList.remove("show");}
});
document.getElementById("scrollToSearch").addEventListener("click",()=>{
  document.querySelector(".category-tools").scrollIntoView({behavior:"smooth",block:"center"});
});
document.getElementById("scrollTop").addEventListener("click",()=>{
  window.scrollTo({top:0,behavior:"smooth"});
});
document.getElementById("openWatchlist").addEventListener("click",toggleWatchlist);
</script>

{% endblock %}
