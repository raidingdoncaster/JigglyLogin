{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-cozy' %}
{% endblock %}

{% block content %}

<h1>ðŸ“© Message</h1>

<div class="msg-card">
  <div class="head">
    <div class="left">
      <div class="subject">{{ msg.subject }}</div>
      <div class="meta">
        {% if msg.type %}<span class="type-pill">{{ msg.type }}</span>{% endif %}
        <span class="date">{{ msg.sent_at|to_date }}</span>
        {% if msg.audience and msg.audience != 'ALL' %}
          <span class="aud">To: {{ msg.audience }}</span>
        {% endif %}
      </div>
    </div>
    <div class="right">
      <a class="btn secondary" href="{{ url_for('inbox') }}">â¬… Back to Inbox</a>
    </div>
  </div>

  {% set metadata = msg.metadata or {} %}
  {% set comment_thread = metadata.comment_reply %}
  {% set comment_thread_url = metadata.url if comment_thread else None %}
  {% set comment_thread_cta = metadata.cta_label if comment_thread else None %}
  {% set body_content = msg.message or '' %}
  <div class="body">
    {% if '<' in body_content %}
      {{ body_content|safe }}
    {% else %}
      {{ body_content|nl2br }}
    {% endif %}

    {% if comment_thread %}
      {% set parent_body = comment_thread.parent.body if comment_thread.parent else '' %}
      {% set reply_body = comment_thread.reply.body if comment_thread.reply else '' %}
      <div class="thread-card">
        <div class="thread-header">
          Conversation on <strong>{{ metadata.post_title or 'the community bulletin' }}</strong>
        </div>
        <div class="thread-comments">
          <div class="thread-bubble yours">
            <p class="bubble-label">Your comment</p>
            <p class="comment-text">{{ (parent_body or 'Comment unavailable')|e|replace('\n','<br>')|safe }}</p>
          </div>
          <div class="thread-bubble reply">
            <p class="bubble-label">Reply from {{ (comment_thread.reply.author or 'Trainer') if comment_thread.reply else 'Trainer' }}</p>
            <p class="comment-text">{{ (reply_body or 'Reply unavailable')|e|replace('\n','<br>')|safe }}</p>
          </div>
        </div>
        {% if comment_thread_url %}
        <div class="cta">
          <a class="btn primary" href="{{ comment_thread_url }}">{{ comment_thread_cta or 'Open comment thread' }}</a>
        </div>
        {% endif %}
      </div>
    {% endif %}

    {% if metadata.url and not comment_thread %}
    <div class="cta">
      <a class="btn primary" href="{{ metadata.url }}">{{ metadata.cta_label or ( 'View receipt' if msg.type == 'receipt' else 'View details') }}</a>
    </div>
    {% endif %}
  </div>
</div>

<style>
.msg-card { background:#fff; border-radius:18px; padding:22px; box-shadow:0 12px 28px rgba(15,23,42,0.14); display:flex; flex-direction:column; gap:16px; }
.head { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap; }
.subject { font-weight:800; font-size:1.2em; color:#1f2937; }
.meta { margin-top:4px; display:flex; gap:8px; align-items:center; color:#475569; font-size:.9em; flex-wrap:wrap; }
.type-pill { font-size:.75em; padding:2px 10px; border-radius:999px; background:#eef2ff; color:#334155; text-transform:uppercase; font-weight:700; }
.body { color:#1f2937; line-height:1.6; word-break:break-word; }
.body p { margin:0 0 12px 0; }
.body p:last-child { margin-bottom:0; }
.body ul, .body ol { margin:0 0 12px 18px; padding-left:18px; }
.body li { margin-bottom:6px; }
.body a { color:#3a8dde; text-decoration:underline; font-weight:600; }
.cta { margin-top:16px; }
.btn { text-decoration:none; padding:10px 18px; border-radius:999px; font-weight:700; display:inline-flex; align-items:center; gap:6px; }
.btn.primary { background:#3a8dde; color:#fff; box-shadow:0 8px 20px rgba(58,141,222,0.25); }
.btn.secondary { background:#eef2ff; color:#3a8dde; }
.aud { background:#f4f4f5; padding:2px 8px; border-radius:999px; font-size:.8em; font-weight:600; }
.thread-card { margin-top:18px; padding:16px; border-radius:14px; background:#f8fafc; border:1px solid #e2e8f0; }
.thread-header { font-weight:600; margin-bottom:12px; color:#0f172a; }
.thread-comments { display:flex; flex-direction:column; gap:12px; }
.thread-bubble { padding:12px; border-radius:12px; background:#fff; border:1px solid #dbeafe; box-shadow:0 4px 12px rgba(15,23,42,0.06); }
.thread-bubble.yours { border-color:#c7d2fe; }
.thread-bubble.reply { border-color:#bfdbfe; background:#f0f7ff; }
.bubble-label { font-size:.8em; font-weight:700; color:#475569; margin-bottom:6px; text-transform:uppercase; letter-spacing:.04em; }
.comment-text { margin:0; color:#0f172a; line-height:1.4; }
</style>

{% endblock %}
