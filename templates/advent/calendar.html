{% extends "base.html" %}
{# Edit advent/config/advent_2025.json to change stamps/messages, then reuse this template for player routes later. #}

{% block page_settings %}
  {% set container_class = 'is-wide' %}
  <style>
    body {
      background: #020815 url("{{ url_for('static', filename='advent/advent25bg.png') }}") center top / cover fixed no-repeat;
      color: #fff;
    }
    @media (max-width: 720px) {
      body {
        background-attachment: scroll;
      }
    }
  </style>
{% endblock %}

{% block content %}
{% set is_test_mode = admin_mode|default(False) %}
{% set open_endpoint = open_endpoint | default('admin_advent.open_day', true) %}
{% set stats_percent = (((opened_count | default(0)) / (total_days | default(1))) * 100) | round(0, 'floor') %}

{% macro advent_quest_icon(slug) -%}
  {% if slug == 'digital-code' -%}
    <svg viewBox="0 0 48 48" role="img" aria-hidden="true">
      <rect x="5" y="10" width="38" height="28" rx="6" fill="url(#ticketGradient-{{ slug }})" stroke="rgba(255,255,255,0.5)" stroke-width="2"></rect>
      <path d="M9 15h30" stroke="rgba(255,255,255,0.3)" stroke-width="2" stroke-linecap="round"></path>
      <path d="M9 33h30" stroke="rgba(255,255,255,0.3)" stroke-width="2" stroke-linecap="round"></path>
      <circle cx="18" cy="24" r="4" fill="#fff5e1"></circle>
      <path d="M15 24h6" stroke="#f25c54" stroke-width="2" stroke-linecap="round"></path>
      <path d="M22 19l14 10" stroke="#ffd166" stroke-width="2.4" stroke-linecap="round"></path>
      <defs>
        <linearGradient id="ticketGradient-{{ slug }}" x1="5" y1="10" x2="40" y2="38" gradientUnits="userSpaceOnUse">
          <stop stop-color="#ff8a00"/>
          <stop offset="1" stop-color="#ff3d7f"/>
        </linearGradient>
      </defs>
    </svg>
  {% elif slug == 'charizard-medal' -%}
    <svg viewBox="0 0 48 48" role="img" aria-hidden="true">
      <circle cx="24" cy="24" r="18" fill="url(#medalGradient-{{ slug }})" stroke="rgba(255,255,255,0.4)" stroke-width="2"></circle>
      <path d="M24 13l3 6 6 .5-4.5 4 1.3 6.5-5.8-3.4-5.8 3.4 1.3-6.5-4.5-4 6-.5z" fill="#fff4d6"></path>
      <path d="M20 6l4 8 4-8" stroke="#ff9f43" stroke-width="3" stroke-linecap="round"></path>
      <defs>
        <radialGradient id="medalGradient-{{ slug }}" cx="0" cy="0" r="1" gradientTransform="translate(24 24) scale(18)" gradientUnits="userSpaceOnUse">
          <stop stop-color="#ffe27d"/>
          <stop offset="1" stop-color="#ffb347"/>
        </radialGradient>
      </defs>
    </svg>
  {% else -%}
    <svg viewBox="0 0 48 48" role="img" aria-hidden="true">
      <circle cx="24" cy="24" r="20" fill="rgba(255,255,255,0.15)" stroke="rgba(255,255,255,0.3)" stroke-width="2"></circle>
    </svg>
  {% endif -%}
{%- endmacro %}
<div class="advent-scene">
  <div class="advent-back-link">
    <a href="{{ url_for('dashboard') }}">‚Üê Back to Dashboard</a>
  </div>
  <div class="advent-hero-logo">
    <img src="{{ url_for('static', filename='advent/advent25logo.png') }}" alt="Advent Calendar 2025">
  </div>
  <div class="admin-header advent-header">
    <div class="header-text">
      <p class="advent-tag">
        {% if is_test_mode %}
          RDAB Live Event
        {% else %}
          25 days of RDAB cheer
        {% endif %}
      </p>
      <h1>
        {% if is_test_mode %}
          üéÑ Advent Calendar (Test Mode)
        {% else %}
          üéÅ Advent Calendar
        {% endif %}
      </h1>
      {% if is_test_mode %}
        <p>Effective day: <strong>{{ effective_day }}</strong>{% if day_override %} (override active){% endif %}</p>
        <div class="advent-controls">
          <p>Use <code>?day_override=&lt;1-25&gt;</code> on the URL to simulate different December days.</p>
        </div>
      {% else %}
        <p>Open the door that matches today's date to collect your Advent stamp and quote.</p>
      {% endif %}
    </div>
    <div class="header-tree">
      <div class="tree"></div>
      <div class="tree-shadow"></div>
    </div>
  </div>

  <div class="advent-intro-grid">
    <div class="advent-intro-copy">
      <p class="advent-intro-lede">
        Unlock a fresh quote, festival-ready stamp, and seasonal surprise each day of December. Keep pace with RDAB to earn digital codes and a shot at the Charizard plushie.
      </p>
      <div class="advent-quests-pill">
        <div>
          <p class="advent-pill-title">Advent Quests</p>
          <p class="advent-pill-copy">Trainers can open one door per day to collect digital passport stamps ‚Äî up to 25 can be claimed across the season.</p>
        </div>
      </div>
    </div>
    <div class="advent-intro-sidecard">
      <p class="sidecard-eyebrow">Season Window</p>
      <p class="sidecard-heading">1 Dec ‚Üí 26 Dec</p>
      <p class="sidecard-copy">Doors open daily at 00:01 (UK). Unlock them before the next sunrise to stay on track.</p>
    </div>
  </div>

  <div class="advent-feature-widgets">
    <article class="advent-feature-card">
      <img src="{{ url_for('static', filename='advent/digitalcode.png') }}" alt="Digital Code Quest illustration">
      <div>
        <p class="feature-eyebrow">Complete the Digital Code Quest</p>
        <h3>Open 12 doors</h3>
        <p class="feature-body">
          Collect stamps on any 12 Advent days to receive a digital code worth 1√ó Premium Battle Pass, 1√ó Star Piece, 1√ó Incubator, and 1√ó Lure Module in your RDAB inbox.
        </p>
      </div>
    </article>
    <article class="advent-feature-card">
      <img src="{{ url_for('static', filename='advent/charizardplush.png') }}" alt="Christmas Charizard Quest illustration">
      <div>
        <p class="feature-eyebrow">Christmas Charizard Quest</p>
        <h3>Open all 25 days</h3>
        <p class="feature-body">
          Finish every door to enter the Holiday Charizard plushie raffle. Qualifiers unlock the Advent 25 Community Medal inside the RDAB app when the feature ships.
        </p>
      </div>
    </article>
  </div>

  <details class="advent-rules">
    <summary>Advent Calendar 2025 ‚Äî Rules of Play</summary>
    <ul>
      <li>The calendar runs from 1 December at 00:01 (UK) through 26 December at 23:59. Door 26 celebrates the Boxing Day epilogue.</li>
      <li>You may open today‚Äôs door and, if needed, catch up on yesterday‚Äôs ‚Äî earlier doors remain locked to keep the story linear.</li>
      <li>Digital codes are awarded instantly via the RDAB inbox when the 12-day quest completes. Watch for the golden mail icon.</li>
      <li>The Charizard plushie draw happens on 27 December; one qualifying trainer is selected at random and notified via inbox + Discord.</li>
      <li>If Community Medals slip past 25 December, every Advent 25 awardee will receive the medal the moment the feature launches plus a bonus passport stamp for the delay.</li>
    </ul>
  </details>

  {% set opened_days = state.opened_days %}
  {% set openable_day = state.openable_day %}

  <div
    class="advent-grid compact"
    data-stamp-base="{{ url_for('static', filename='advent/') }}"
    data-day-override="{{ day_override or '' }}"
  >
    {% for day in range(1, 26) %}
      {% set day_config = config.get(day) %}
      {% set opened = day in opened_days %}
      {% set is_openable = day == openable_day %}
      <div
        class="advent-cell{% if opened %} is-opened{% elif is_openable %} is-openable{% else %} is-locked{% endif %}"
        data-day="{{ day }}"
        data-open-url="{{ url_for(open_endpoint, day=day) }}"
      >
        <div class="advent-lights" aria-hidden="true">
          {% for idx in range(1, 11) %}
            <span class="advent-light" style="--light-index: {{ idx }}"></span>
          {% endfor %}
        </div>
        <div class="advent-day-label">
          <span>Day {{ "%02d"|format(day) }}</span>
          <span class="advent-badge{% if is_openable %} is-today{% endif %}">
            {% if opened %}
              ‚ú®
            {% elif is_openable %}
              ‚òÖ
            {% else %}
              &nbsp;
            {% endif %}
          </span>
        </div>

        <div class="advent-cell-content">
          {% if opened and day_config %}
            <img src="{{ url_for('static', filename='advent/' ~ day_config.stamp_png) }}" alt="Stamp for day {{ day }}">
            <button
              type="button"
              class="message-btn"
              data-day="{{ day }}"
              data-message="{{ day_config.message|e }}"
              data-stamp="{{ url_for('static', filename='advent/' ~ day_config.stamp_png) }}"
            >
              View quote
            </button>
            <small class="advent-status">Opened</small>
          {% elif is_openable %}
            <form class="open-day-form" method="POST" action="{{ url_for(open_endpoint, day=day) }}">
              {% if day_override %}
                <input type="hidden" name="day_override" value="{{ day_override }}">
              {% endif %}
              <button type="submit" data-day="{{ day }}">Open</button>
            </form>
            <small class="advent-hint">Ready to unlock</small>
          {% else %}
            <div class="advent-placeholder">üîí</div>
            <small class="advent-status">Locked</small>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="advent-modal" id="advent-modal" hidden>
    <div class="advent-modal__backdrop"></div>
    <div class="advent-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="advent-modal-day">
      <button type="button" class="advent-modal__close" aria-label="Close">&times;</button>
      <div class="advent-modal__body">
        <p class="advent-modal__eyebrow">Advent stamp acquired</p>
        <img id="advent-modal-stamp" alt="Advent stamp" hidden>
        <h2 id="advent-modal-day"></h2>
        <p id="advent-modal-message"></p>
      </div>
    </div>
  </div>
</div>

{% if not is_test_mode %}
  <div class="advent-floating-bar" data-advent-floating-bar>
    <button class="advent-floating-bar__help" type="button" data-advent-help-toggle aria-expanded="false">
      <span>Help</span>
    </button>
    <div class="advent-floating-bar__stats" aria-label="Advent progress">
      <p data-advent-progress-text><strong>{{ opened_count }}</strong> / {{ total_days }} doors opened</p>
      <div class="advent-floating-bar__progress">
        <div data-advent-progress-fill style="width: {{ stats_percent }}%"></div>
      </div>
    </div>
    <button class="advent-floating-bar__quests" type="button" data-advent-quests-toggle aria-expanded="false">
      Advent Quests
    </button>
  </div>

  <div class="advent-help-popover" data-advent-help-panel hidden>
    <p>Need help unlocking today's door? Check the RDAB Discord announcements or contact your event host for hints.</p>
  </div>

  <div class="advent-quests-drawer" data-advent-quests-drawer hidden>
    <div class="advent-quests-drawer__backdrop" data-advent-quests-close aria-hidden="true"></div>
    <div class="advent-quests-drawer__panel" role="dialog" aria-labelledby="advent-quests-title" aria-modal="true">
      <div class="advent-quests-drawer__header">
        <h3 id="advent-quests-title">Advent Quests</h3>
        <button class="advent-quests-drawer__close" type="button" data-advent-quests-close aria-label="Close Advent quests">&times;</button>
      </div>
      <p class="advent-quests-subtitle">Complete these seasonal challenges to unlock extra cheer.</p>
      <div class="advent-quests-list" data-advent-quests-list>
        {% for quest in quests %}
          <article class="advent-quest-card{% if quest.completed %} is-complete{% endif %}" data-quest-id="{{ quest.id }}">
            <div class="advent-quest-card__icon" aria-hidden="true">
              {{ advent_quest_icon(quest.icon) }}
            </div>
            <div class="advent-quest-card__meta">
              <p class="advent-quest-card__title">{{ quest.title }}</p>
              <p class="advent-quest-card__reward">{{ quest.reward }}</p>
            </div>
            <p class="advent-quest-card__description">{{ quest.description }}</p>
            <div
              class="advent-quest-card__progress"
              role="progressbar"
              aria-valuemin="0"
              aria-valuemax="{{ quest.target_days }}"
              aria-valuenow="{{ quest.progress_days }}"
              data-quest-progress
            >
              <div data-quest-progress-fill style="width: {{ quest.percent }}%"></div>
            </div>
            <p class="advent-quest-card__status">
              <span data-quest-status-text>{{ quest.progress_days }} / {{ quest.target_days }} doors</span>
              <span class="advent-quest-card__badge"{% if not quest.completed %} hidden{% endif %} data-quest-badge>Completed</span>
            </p>
          </article>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="advent-snow-layer" id="advent-snow-layer" aria-hidden="true"></div>
{% endif %}

<style>
.advent-scene {
  position: relative;
  padding: 24px;
  border-radius: 28px;
  background: linear-gradient(145deg, #012d3b, #045a4a 35%, #77000f 100%);
  color: #fff;
  overflow: hidden;
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.35);
}
.advent-scene::before,
.advent-scene::after {
  content: "";
  position: absolute;
  top: -20%;
  left: 0;
  width: 200%;
  height: 200%;
  pointer-events: none;
  background-image: radial-gradient(#ffffff 1px, transparent 1px);
  background-size: 180px 180px;
  opacity: 0.35;
  animation: snowfall 18s linear infinite;
}
.advent-scene::after {
  animation-duration: 30s;
  opacity: 0.5;
  filter: blur(1px);
}
.advent-back-link {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 12px;
}
.advent-back-link a {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.16);
  color: #fff;
  font-weight: 600;
  letter-spacing: 0.02em;
  text-decoration: none;
  border: 1px solid rgba(255, 255, 255, 0.25);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
  transition: background 0.2s ease, transform 0.2s ease;
}
.advent-back-link a:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}
.advent-hero-logo {
  display: flex;
  justify-content: center;
  margin-bottom: 18px;
}
.advent-hero-logo img {
  width: min(540px, 100%);
  height: auto;
}
.advent-intro-grid {
  display: grid;
  grid-template-columns: 1.4fr 0.6fr;
  gap: 20px;
  margin-bottom: 24px;
  align-items: stretch;
}
.advent-intro-copy {
  background: rgba(255, 255, 255, 0.08);
  border-radius: 20px;
  padding: 18px 20px;
  border: 1px solid rgba(255, 255, 255, 0.18);
  box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
}
.advent-intro-lede {
  margin: 0 0 12px;
  font-size: 1.05rem;
  line-height: 1.5;
  color: rgba(255, 255, 255, 0.92);
}
.advent-quests-pill {
  display: flex;
  gap: 16px;
  padding: 14px 16px;
  border-radius: 14px;
  background: rgba(15, 213, 138, 0.12);
  border: 1px solid rgba(26, 255, 156, 0.35);
}
.advent-pill-title {
  margin: 0;
  font-size: 0.9rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: #8fffd8;
}
.advent-pill-copy {
  margin: 4px 0 0;
  color: rgba(255, 255, 255, 0.9);
}
.advent-intro-sidecard {
  background: rgba(255, 255, 255, 0.08);
  border-radius: 20px;
  padding: 18px 20px;
  border: 1px solid rgba(255, 255, 255, 0.18);
  text-align: left;
  box-shadow: inset 0 0 30px rgba(255, 255, 255, 0.08);
}
.sidecard-eyebrow {
  margin: 0;
  text-transform: uppercase;
  letter-spacing: 0.24em;
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.7);
}
.sidecard-heading {
  margin: 8px 0 6px;
  font-size: 1.4rem;
  font-weight: 700;
}
.sidecard-copy {
  margin: 0;
  color: rgba(255, 255, 255, 0.85);
  line-height: 1.4;
}
.advent-feature-widgets {
  display: flex;
  gap: 16px;
  margin-bottom: 18px;
  flex-wrap: nowrap;
  overflow-x: auto;
  padding-bottom: 6px;
  scroll-snap-type: x proximity;
}
.advent-feature-card {
  flex: 0 0 calc(50% - 8px);
  display: flex;
  align-items: center;
  gap: 16px;
  border-radius: 20px;
  padding: 16px;
  border: 1px solid rgba(255, 255, 255, 0.18);
  background: rgba(1, 7, 14, 0.55);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
  scroll-snap-align: center;
}
.advent-feature-card img {
  width: 88px;
  height: 88px;
  object-fit: contain;
  flex: 0 0 auto;
}
.feature-eyebrow {
  margin: 0;
  font-size: 0.78rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: rgba(255, 255, 255, 0.6);
}
.advent-feature-card h3 {
  margin: 4px 0;
  font-size: 1.1rem;
}
.feature-body {
  margin: 0;
  font-size: 0.92rem;
  color: rgba(255, 255, 255, 0.88);
  line-height: 1.4;
}
.advent-rules {
  margin: 0 0 20px;
  background: rgba(0, 0, 0, 0.4);
  border-radius: 18px;
  border: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow: inset 0 0 25px rgba(255, 255, 255, 0.05);
}
.advent-rules summary {
  cursor: pointer;
  padding: 14px 18px;
  font-weight: 600;
  letter-spacing: 0.08em;
}
.advent-rules ul {
  margin: 0;
  padding: 0 22px 18px 35px;
  color: rgba(255, 255, 255, 0.85);
  line-height: 1.4;
}
.advent-rules li {
  margin-bottom: 8px;
}
.advent-header {
  display: flex;
  justify-content: space-between;
  gap: 24px;
  align-items: center;
  flex-wrap: wrap;
  background: rgba(255, 255, 255, 0.08);
  padding: 20px;
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.15);
  position: relative;
  z-index: 1;
}
.advent-tag {
  text-transform: uppercase;
  letter-spacing: 0.2em;
  font-size: 0.65rem;
  margin: 0 0 6px 0;
  color: #ffd6d9;
}
.advent-controls {
  margin-top: 8px;
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.85);
}
.advent-controls code {
  background: rgba(255, 255, 255, 0.15);
  padding: 2px 6px;
  border-radius: 6px;
}
.header-tree {
  position: relative;
  width: 160px;
  height: 140px;
  flex: 0 0 auto;
}
.tree {
  width: 0;
  height: 0;
  border-left: 70px solid transparent;
  border-right: 70px solid transparent;
  border-bottom: 120px solid #0fd58a;
  position: relative;
  filter: drop-shadow(0 8px 12px rgba(0, 0, 0, 0.4));
}
.tree::before,
.tree::after {
  content: "";
  position: absolute;
  left: -60px;
  border-left: 60px solid transparent;
  border-right: 60px solid transparent;
  border-bottom: 110px solid #1aff9c;
  top: -60px;
  opacity: 0.9;
}
.tree::after {
  top: -110px;
  left: -50px;
  border-left: 50px solid transparent;
  border-right: 50px solid transparent;
  border-bottom: 90px solid #8cffcd;
  opacity: 0.7;
}
.tree-shadow {
  position: absolute;
  bottom: 10px;
  left: 20px;
  width: 120px;
  height: 20px;
  background: rgba(0, 0, 0, 0.35);
  filter: blur(8px);
  border-radius: 50%;
}
.advent-grid.compact {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 12px;
  margin-top: 24px;
  position: relative;
  z-index: 1;
}
.advent-cell {
  background: rgba(255, 255, 255, 0.12);
  border-radius: 16px;
  padding: 12px;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.2);
  min-height: 150px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  gap: 8px;
  backdrop-filter: blur(4px);
  position: relative;
  overflow: hidden;
}
.advent-cell img {
  max-width: 100%;
  height: 60px;
  object-fit: contain;
  filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.3));
}
.advent-cell button {
  background: linear-gradient(135deg, #ff6b6b, #ffd93d);
  color: #fff;
  border: none;
  border-radius: 999px;
  padding: 10px 16px;
  cursor: pointer;
  font-weight: 600;
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
}
.advent-cell button:hover { filter: brightness(1.05); }
.advent-cell.is-opened {
  border-color: rgba(135, 255, 196, 0.5);
  background: linear-gradient(160deg, rgba(148, 255, 233, 0.2), rgba(25, 255, 173, 0.05));
  box-shadow: inset 0 0 30px rgba(148, 255, 233, 0.3);
}
.advent-cell.is-openable {
  border-color: rgba(255, 231, 138, 0.7);
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.25), rgba(255, 233, 185, 0.15));
  animation: pulseGlow 2s infinite;
}
.advent-cell.is-openable::before,
.advent-cell.is-openable::after {
  content: "";
  position: absolute;
  inset: 8px;
  border-radius: inherit;
  border: 1px dashed rgba(255, 255, 255, 0.25);
  animation: orbit 6s linear infinite;
  pointer-events: none;
}
.advent-cell.is-openable::after {
  inset: 14px;
  border-style: dotted;
  animation-duration: 4s;
}
.advent-cell.is-openable::before,
.advent-cell.is-openable::after {
  content: "";
  position: absolute;
  inset: 8px;
  border-radius: inherit;
  border: 1px dashed rgba(255, 255, 255, 0.25);
  animation: orbit 6s linear infinite;
  pointer-events: none;
}
.advent-cell.is-openable::after {
  inset: 14px;
  border-style: dotted;
  animation-duration: 4s;
}
.advent-cell.is-locked {
  border-color: rgba(255, 255, 255, 0.08);
  color: rgba(255, 255, 255, 0.7);
}
.advent-placeholder { font-size: 2rem; }
.advent-cell-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.advent-day-label {
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.advent-badge {
  padding: 2px 6px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.15);
  font-size: 0.85rem;
  min-width: 28px;
  text-align: center;
}
.advent-badge.is-today {
  background: rgba(255, 255, 255, 0.35);
}
.message-btn {
  font-size: 0.85rem;
  padding: 6px 12px;
}
.advent-status { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.18em; color: rgba(255, 255, 255, 0.85); }
.advent-hint { font-size: 0.85rem; color: #fff; }
.advent-modal {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50;
}
.advent-modal[hidden] {
  display: none;
}
.advent-modal__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(3px);
}
.advent-modal__dialog {
  position: relative;
  background: #fff;
  color: #062324;
  border-radius: 20px;
  padding: 24px;
  width: min(420px, 90vw);
  box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
  z-index: 1;
}
.advent-modal__close {
  position: absolute;
  top: 12px;
  right: 16px;
  background: transparent;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
}
.advent-modal__eyebrow {
  text-transform: uppercase;
  letter-spacing: 0.2em;
  font-size: 0.7rem;
  margin-bottom: 6px;
  color: #0a9b7a;
}
.advent-modal__body h2 {
  margin-top: 0;
  margin-bottom: 12px;
}
.advent-modal__body p {
  margin: 0;
}
.advent-modal__body img {
  max-height: 120px;
  margin: 0 auto 12px auto;
  display: block;
}
.advent-cell.is-openable.unlocking {
  animation: unlockBurst 0.8s forwards;
  pointer-events: none;
}
.advent-cell.is-openable.unlocking::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, transparent 65%);
  animation: shimmer 0.8s forwards;
}
.magic-burst {
  position: absolute;
  inset: 0;
  pointer-events: none;
}
.magic-burst__spark {
  position: absolute;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: radial-gradient(circle, #fff 0%, rgba(255,255,255,0) 70%);
  animation: sparkleDrift 1.2s ease-out forwards;
  mix-blend-mode: screen;
}
.magic-burst__spark.is-heart::after {
  content: "‚ù§";
  font-size: 0.9rem;
  color: #ff9fb3;
  position: absolute;
  inset: -4px;
}
.magic-burst__spark.is-star::after {
  content: "‚òÖ";
  font-size: 0.9rem;
  color: #ffd93d;
  position: absolute;
  inset: -4px;
}
.advent-lights {
  position: absolute;
  inset: 0;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}
.advent-cell.is-opened .advent-lights {
  opacity: 1;
}
.advent-light {
  position: absolute;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: radial-gradient(circle, #fff 0%, rgba(255,255,255,0) 70%);
  animation: lightTwinkle 2.4s ease-in-out infinite;
  filter: drop-shadow(0 0 6px rgba(255,255,255,0.8));
}
.advent-light:nth-child(odd) {
  background: radial-gradient(circle, #ffe066 0%, rgba(255,255,255,0) 70%);
}
.advent-light:nth-child(even) {
  background: radial-gradient(circle, #ff6bcb 0%, rgba(255,255,255,0) 70%);
}
.advent-light:nth-child(3n) {
  background: radial-gradient(circle, #7af7d0 0%, rgba(255,255,255,0) 70%);
}
.advent-light:nth-child(1) { top: 6px; left: 12px; }
.advent-light:nth-child(2) { top: 4px; left: 50%; transform: translateX(-50%); }
.advent-light:nth-child(3) { top: 6px; right: 12px; }
.advent-light:nth-child(4) { top: 28px; right: 4px; }
.advent-light:nth-child(5) { top: 56px; right: 2px; }
.advent-light:nth-child(6) { bottom: 6px; right: 12px; }
.advent-light:nth-child(7) { bottom: 4px; left: 50%; transform: translateX(-50%); }
.advent-light:nth-child(8) { bottom: 6px; left: 12px; }
.advent-light:nth-child(9) { top: 56px; left: 2px; }
.advent-light:nth-child(10) { top: 28px; left: 4px; }
.advent-beam {
  position: absolute;
  inset: -10%;
  background: radial-gradient(circle, rgba(255,255,255,0.65) 0%, rgba(255,255,255,0) 65%);
  animation: beamPulse 3s ease-out forwards;
  pointer-events: none;
  filter: blur(2px);
  mix-blend-mode: screen;
  z-index: 2;
}
.advent-beam.is-fading {
  opacity: 0;
}
.confetti-container {
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 60;
}
.confetti-piece {
  position: absolute;
  width: 10px;
  height: 18px;
  border-radius: 3px;
  opacity: 0;
  animation: confettiFall var(--duration, 3s) ease-out forwards;
}
.advent-modal.is-open .advent-modal__dialog {
  animation: modalCelebrate 0.9s cubic-bezier(0.16, 1, 0.3, 1);
}
.advent-modal.is-open .advent-modal__backdrop {
  animation: backdropFade 0.9s ease;
}
.advent-quest-card {
  position: relative;
  padding-left: 88px;
}
.advent-quest-card__icon {
  position: absolute;
  top: 18px;
  left: 18px;
  width: 54px;
  height: 54px;
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.08);
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
}
.advent-quest-card__icon svg {
  width: 38px;
  height: 38px;
}
.advent-quest-card__meta {
  padding-left: 4px;
}
.advent-snow-layer {
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 5;
  mix-blend-mode: screen;
}
.advent-snowflake {
  position: absolute;
  top: -10%;
  width: var(--size, 8px);
  height: var(--size, 8px);
  border-radius: 999px;
  background: radial-gradient(circle, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.55) 60%, rgba(255,255,255,0) 100%);
  box-shadow: 0 0 8px rgba(148, 197, 255, 0.35);
  opacity: var(--opacity, 0.6);
  animation: snowDrift var(--duration, 12s) linear infinite;
  transform: translate3d(0, -10%, 0) scale(var(--scale, 1));
}
@media (max-width: 640px) {
  .advent-quest-card {
    padding-left: 18px;
  }
  .advent-quest-card__icon {
    position: static;
    margin-bottom: 12px;
    width: 64px;
    height: 64px;
  }
  .advent-quest-card__meta {
    padding-left: 0;
  }
}
.advent-cell.is-openable.unlocking {
  animation: unlockBurst 0.8s forwards;
  pointer-events: none;
}
.advent-cell.is-openable.unlocking::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, transparent 65%);
  animation: shimmer 0.8s forwards;
}
.magic-burst {
  position: absolute;
  inset: 0;
  pointer-events: none;
}
.magic-burst__spark {
  position: absolute;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: radial-gradient(circle, #fff 0%, rgba(255,255,255,0) 70%);
  animation: sparkleDrift 1.2s ease-out forwards;
  mix-blend-mode: screen;
}
.magic-burst__spark.is-heart::after {
  content: "‚ù§";
  font-size: 0.9rem;
  color: #ff9fb3;
  position: absolute;
  inset: -4px;
}
.magic-burst__spark.is-star::after {
  content: "‚òÖ";
  font-size: 0.9rem;
  color: #ffd93d;
  position: absolute;
  inset: -4px;
}

@keyframes snowfall {
  from {
    transform: translateY(-10%);
  }
  to {
    transform: translateY(10%);
  }
}
@keyframes pulseGlow {
  0% { box-shadow: 0 0 12px rgba(255, 255, 255, 0.3); }
  50% { box-shadow: 0 0 24px rgba(255, 255, 255, 0.6); }
  100% { box-shadow: 0 0 12px rgba(255, 255, 255, 0.3); }
}
@keyframes unlockBurst {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(255,255,255,0);
  }
  40% {
    transform: scale(1.05);
    box-shadow: 0 0 25px rgba(255,255,255,0.6);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(255,255,255,0);
  }
}
@keyframes shimmer {
  from { opacity: 1; }
  to { opacity: 0; }
}
@keyframes orbit {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
@keyframes sparkleDrift {
  0% {
    transform: translate(0, 0) scale(0.6);
    opacity: 1;
  }
  70% { opacity: 1; }
  100% {
    transform: translate(var(--dx, 0), var(--dy, -40px)) scale(1.4);
    opacity: 0;
  }
}
@keyframes lightTwinkle {
  0%, 100% { opacity: 0.25; transform: scale(0.9); }
  50% { opacity: 1; transform: scale(1.2); }
}
@keyframes beamPulse {
  0% { opacity: 0; transform: scale(0.6); }
  20% { opacity: 1; transform: scale(1); }
  80% { opacity: 0.8; }
  100% { opacity: 0; transform: scale(1.2); }
}
@keyframes confettiFall {
  0% { opacity: 1; transform: translate3d(var(--x-start, 0), -10%, 0) rotate(0deg); }
  100% { opacity: 0; transform: translate3d(var(--x-end, 20px), 110vh, 0) rotate(540deg); }
}
@keyframes modalCelebrate {
  0% { transform: translateY(30px) scale(0.85); opacity: 0; }
  40% { transform: translateY(-8px) scale(1.02); opacity: 1; }
  70% { transform: translateY(4px) scale(0.98); }
  100% { transform: translateY(0) scale(1); opacity: 1; }
}
@keyframes backdropFade {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes unlockBurst {
  0% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(255,255,255,0);
  }
  40% {
    transform: scale(1.05);
    box-shadow: 0 0 25px rgba(255,255,255,0.6);
  }
  100% {
    transform: scale(1);
    box-shadow: 0 0 0 rgba(255,255,255,0);
  }
}
@keyframes shimmer {
  from { opacity: 1; }
  to { opacity: 0; }
}
@keyframes orbit {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
@keyframes sparkleDrift {
  0% {
    transform: translate(0, 0) scale(0.6);
    opacity: 1;
  }
  70% { opacity: 1; }
  100% {
    transform: translate(var(--dx, 0), var(--dy, -40px)) scale(1.4);
    opacity: 0;
  }
}
.advent-floating-bar {
  position: fixed;
  left: 50%;
  bottom: 32px;
  transform: translateX(-50%);
  width: min(720px, calc(100% - 32px));
  background: rgba(2, 23, 30, 0.92);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 999px;
  padding: 12px 18px;
  display: flex;
  align-items: center;
  gap: 16px;
  box-shadow: 0 18px 35px rgba(0, 0, 0, 0.55);
  z-index: 10;
  backdrop-filter: blur(6px);
}
.advent-floating-bar button {
  border: none;
  background: none;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}
.advent-floating-bar__help,
.advent-floating-bar__quests {
  padding: 10px 18px;
  border-radius: 999px;
  transition: background 0.2s ease, color 0.2s ease;
}
.advent-floating-bar__help {
  background: rgba(255, 255, 255, 0.12);
}
.advent-floating-bar__help:hover,
.advent-floating-bar__quests:hover {
  background: rgba(255, 255, 255, 0.2);
}
.advent-floating-bar__quests {
  background: linear-gradient(120deg, #ff8a00, #ff3d3d);
  color: #1a0808;
}
.advent-floating-bar__stats {
  flex: 1;
}
.advent-floating-bar__stats p {
  margin: 0;
  font-size: 0.95rem;
}
.advent-floating-bar__progress {
  width: 100%;
  height: 6px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.15);
  margin-top: 6px;
  overflow: hidden;
}
.advent-floating-bar__progress div {
  height: 100%;
  border-radius: 999px;
  background: linear-gradient(120deg, #0fd58a, #1aff9c);
}
.advent-help-popover {
  position: fixed;
  bottom: 98px;
  left: 50%;
  transform: translateX(-50%);
  width: min(600px, calc(100% - 48px));
  background: rgba(1, 23, 33, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 18px;
  padding: 16px 20px;
  color: #e6f7ff;
  font-size: 0.95rem;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
  z-index: 9;
}
.advent-quests-drawer {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: flex-end;
  z-index: 20;
  pointer-events: none;
  transition: opacity 0.25s ease;
  opacity: 0;
}
.advent-quests-drawer.is-open {
  pointer-events: auto;
  opacity: 1;
}
.advent-quests-drawer__backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
}
.advent-quests-drawer__panel {
  position: relative;
  width: 100%;
  background: #011721;
  border-radius: 28px 28px 0 0;
  padding: 28px 24px 36px;
  color: #fff;
  transform: translateY(110%);
  transition: transform 0.3s ease;
}
.advent-quests-drawer.is-open .advent-quests-drawer__panel {
  transform: translateY(0);
}
.advent-quests-drawer__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.advent-quests-drawer__close {
  background: none;
  border: none;
  color: #fff;
  font-size: 1.4rem;
  cursor: pointer;
}
.advent-quests-subtitle {
  margin: 10px 0 18px;
  color: rgba(255, 255, 255, 0.75);
}
.advent-quests-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.advent-quest-card {
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 18px;
  padding: 16px 18px;
  background: rgba(255, 255, 255, 0.02);
}
.advent-quest-card.is-complete {
  border-color: #1aff9c;
  background: rgba(16, 213, 138, 0.08);
}
.advent-quest-card__meta {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}
.advent-quest-card__title {
  margin: 0;
  font-weight: 600;
}
.advent-quest-card__reward {
  margin: 0;
  font-size: 0.9rem;
  color: #ffd6d9;
}
.advent-quest-card__description {
  margin: 10px 0;
  color: rgba(255, 255, 255, 0.8);
}
.advent-quest-card__progress {
  height: 8px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.15);
  overflow: hidden;
}
.advent-quest-card__progress div {
  height: 100%;
  border-radius: 999px;
  background: linear-gradient(120deg, #ffb347, #ff3d77);
}
.advent-quest-card__status {
  margin: 8px 0 0;
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  gap: 8px;
  color: rgba(255, 255, 255, 0.8);
}
.advent-quest-card__badge {
  padding: 4px 10px;
  background: rgba(26, 255, 156, 0.15);
  color: #1aff9c;
  border-radius: 999px;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
@media (max-width: 720px) {
  .advent-floating-bar {
    flex-direction: column;
    border-radius: 24px;
    padding: 16px;
    gap: 12px;
  }
  .advent-floating-bar__stats {
    width: 100%;
  }
  .advent-floating-bar__help,
  .advent-floating-bar__quests {
    width: 100%;
    text-align: center;
  }
  .advent-help-popover {
    width: calc(100% - 32px);
  }
  .advent-quests-drawer__panel {
    border-radius: 24px 24px 0 0;
  }
}
@media (max-width: 900px) {
  .advent-grid.compact { grid-template-columns: repeat(3, minmax(0, 1fr)); }
  .advent-scene { padding: 16px; }
  .header-tree { width: 120px; height: 110px; }
  .advent-intro-grid { grid-template-columns: 1fr; }
}
@media (max-width: 640px) {
  .advent-grid.compact { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .advent-feature-card { flex: 0 0 80%; }
}
@media (max-width: 420px) {
  .advent-grid.compact { grid-template-columns: repeat(1, minmax(0, 1fr)); }
}
</style>

<script>
(function() {
  const modal = document.getElementById("advent-modal");
  if (!modal) return;

  const grid = document.querySelector(".advent-grid");
  const stampBase = grid ? grid.dataset.stampBase || "" : "";
  const dayOverride = grid ? grid.dataset.dayOverride || "" : "";
  const dayEl = document.getElementById("advent-modal-day");
  const messageEl = document.getElementById("advent-modal-message");
  const stampImg = document.getElementById("advent-modal-stamp");
  const closeButtons = modal.querySelectorAll(".advent-modal__close, .advent-modal__backdrop");
  const statsText = document.querySelector("[data-advent-progress-text]");
  const statsFill = document.querySelector("[data-advent-progress-fill]");
  const helpButton = document.querySelector("[data-advent-help-toggle]");
  const helpPanel = document.querySelector("[data-advent-help-panel]");
  const questsDrawer = document.querySelector("[data-advent-quests-drawer]");
  const questToggles = document.querySelectorAll("[data-advent-quests-toggle]");
  const questClosers = document.querySelectorAll("[data-advent-quests-close]");
  const REVEAL_DELAY_MS = 3000;
  const MODAL_DELAY_AFTER_REVEAL_MS = 450;
  let snowResizeTimer = null;

  function buildStampUrl(stampName) {
    if (!stampName) return "";
    if (/^https?:/i.test(stampName) || stampName.startsWith("/")) {
      return stampName;
    }
    return `${stampBase}${stampName}`;
  }

  function openModal(day, message, stampUrl) {
    dayEl.textContent = `Day ${day}`;
    messageEl.textContent = message;
    if (stampUrl) {
      stampImg.hidden = false;
      stampImg.src = stampUrl;
    } else {
      stampImg.hidden = true;
    }
    modal.hidden = false;
    requestAnimationFrame(() => modal.classList.add("is-open"));
  }

  function closeModal() {
    modal.classList.remove("is-open");
    setTimeout(() => {
      modal.hidden = true;
    }, 250);
  }

  function toggleHelp(forceState) {
    if (!helpPanel || !helpButton) return;
    const shouldOpen = typeof forceState === "boolean" ? forceState : helpPanel.hasAttribute("hidden");
    if (shouldOpen) {
      helpPanel.hidden = false;
    } else {
      helpPanel.hidden = true;
    }
    helpButton.setAttribute("aria-expanded", String(shouldOpen));
  }

  function setDrawerState(open) {
    if (!questsDrawer) return;
    if (open) {
      questsDrawer.hidden = false;
      requestAnimationFrame(() => questsDrawer.classList.add("is-open"));
    } else {
      questsDrawer.classList.remove("is-open");
      setTimeout(() => {
        questsDrawer.hidden = true;
      }, 250);
    }
    questToggles.forEach((btn) => btn.setAttribute("aria-expanded", String(open)));
  }

  function updateStatsUI(payload) {
    if (!payload) return;
    const opened = typeof payload.opened_count === "number" ? payload.opened_count : null;
    const total = typeof payload.total_days === "number" ? payload.total_days : null;
    if (opened !== null && total) {
      if (statsText) {
        statsText.innerHTML = `<strong>${opened}</strong> / ${total} doors opened`;
      }
      if (statsFill && total > 0) {
        const percent = Math.min(100, Math.round((opened / total) * 100));
        statsFill.style.width = `${percent}%`;
      }
    }
  }

  function updateQuestUI(quests) {
    if (!quests || !quests.length) return;
    quests.forEach((quest) => {
      const card = document.querySelector(`[data-quest-id="${quest.id}"]`);
      if (!card) return;
      card.classList.toggle("is-complete", Boolean(quest.completed));
      const progressBar = card.querySelector("[data-quest-progress]");
      const progressFill = card.querySelector("[data-quest-progress-fill]");
      if (progressBar) {
        progressBar.setAttribute("aria-valuenow", quest.progress_days ?? 0);
        progressBar.setAttribute("aria-valuemax", quest.target_days ?? 0);
      }
      if (progressFill) {
        progressFill.style.width = `${Math.min(100, quest.percent || 0)}%`;
      }
      const statusText = card.querySelector("[data-quest-status-text]");
      if (statusText) {
        statusText.textContent = `${quest.progress_days} / ${quest.target_days} doors`;
      }
      const badge = card.querySelector("[data-quest-badge]");
      if (badge) {
        badge.hidden = !quest.completed;
      }
    });
  }

  document.addEventListener("click", (event) => {
    const trigger = event.target.closest(".message-btn");
    if (trigger) {
      const day = trigger.dataset.day;
      const message = trigger.dataset.message || "No message provided.";
      const stamp = trigger.dataset.stamp || "";
      openModal(day, message, stamp);
    }
  });

  closeButtons.forEach((btn) => btn.addEventListener("click", closeModal));
  questToggles.forEach((btn) => btn.addEventListener("click", () => setDrawerState(true)));
  questClosers.forEach((btn) => btn.addEventListener("click", () => setDrawerState(false)));
  if (helpButton) {
    helpButton.addEventListener("click", () => toggleHelp());
  }
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      setDrawerState(false);
      toggleHelp(false);
      closeModal();
    }
  });

  const createMagicBurst = (cell) => {
    const burst = document.createElement("div");
    burst.className = "magic-burst";
    for (let i = 0; i < 8; i++) {
      const spark = document.createElement("span");
      spark.className = "magic-burst__spark";
      if (i % 3 === 0) {
        spark.classList.add("is-heart");
      } else if (i % 3 === 1) {
        spark.classList.add("is-star");
      }
      const angle = (Math.PI * 2 * i) / 8;
      const distance = 50 + Math.random() * 30;
      spark.style.setProperty("--dx", `${Math.cos(angle) * distance}px`);
      spark.style.setProperty("--dy", `${Math.sin(angle) * distance}px`);
      spark.style.left = "50%";
      spark.style.top = "50%";
      burst.appendChild(spark);
    }
    cell.appendChild(burst);
    setTimeout(() => burst.remove(), 1200);
  };

  function launchConfetti() {
    const colors = ["#ffedd5", "#ffd93d", "#ff8a00", "#0fd58a", "#5cc4ff", "#ff6bcb"];
    const container = document.createElement("div");
    container.className = "confetti-container";
    const pieceCount = window.matchMedia("(max-width: 640px)").matches ? 35 : 70;
    for (let i = 0; i < pieceCount; i++) {
      const piece = document.createElement("span");
      piece.className = "confetti-piece";
      const color = colors[i % colors.length];
      piece.style.background = color;
      piece.style.left = `${Math.random() * 100}%`;
      piece.style.setProperty("--x-start", `${(Math.random() - 0.5) * 40}px`);
      piece.style.setProperty("--x-end", `${(Math.random() - 0.5) * 240}px`);
      piece.style.setProperty("--duration", `${2.8 + Math.random() * 1.6}s`);
      piece.style.animationDelay = `${Math.random() * 0.6}s`;
      container.appendChild(piece);
    }
    document.body.appendChild(container);
    setTimeout(() => container.remove(), 4000);
  }

  function playDoorCelebration(cell) {
    return new Promise((resolve) => {
      launchConfetti();
      if (cell) {
        const beam = document.createElement("div");
        beam.className = "advent-beam";
        cell.appendChild(beam);
        setTimeout(() => {
          beam.classList.add("is-fading");
        }, REVEAL_DELAY_MS - 600);
        setTimeout(() => {
          beam.remove();
        }, REVEAL_DELAY_MS + 400);
      }
      setTimeout(resolve, REVEAL_DELAY_MS);
    });
  }

  function updateBadge(cell, symbol, highlight = false) {
    const badge = cell.querySelector(".advent-badge");
    if (!badge) return;
    badge.textContent = symbol || "";
    if (highlight) {
      badge.classList.add("is-today");
    } else {
      badge.classList.remove("is-today");
    }
  }

  function convertCellToOpened(cell, payload) {
    if (!cell) return;
    cell.classList.remove("is-openable", "unlocking");
    cell.classList.add("is-opened");
    updateBadge(cell, "‚ú®");
    const content = cell.querySelector(".advent-cell-content");
    if (!content) return;
    content.innerHTML = "";
    const stampUrl = buildStampUrl(payload.stamp_png);
    if (stampUrl) {
      const img = document.createElement("img");
      img.src = stampUrl;
      img.alt = `Stamp for day ${payload.day}`;
      content.appendChild(img);
    }
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "message-btn";
    btn.textContent = "View quote";
    btn.dataset.day = payload.day;
    btn.dataset.message = payload.message || "";
    if (stampUrl) {
      btn.dataset.stamp = stampUrl;
    }
    content.appendChild(btn);
    const status = document.createElement("small");
    status.className = "advent-status";
    status.textContent = "Opened";
    content.appendChild(status);
  }

  function activateNextCell(day) {
    if (!day) return;
    const cell = document.querySelector(`.advent-cell[data-day="${day}"]`);
    if (!cell) return;
    cell.classList.remove("is-locked");
    cell.classList.add("is-openable");
    const content = cell.querySelector(".advent-cell-content");
    if (!content) return;
    content.innerHTML = "";
    const form = document.createElement("form");
    form.className = "open-day-form";
    form.method = "POST";
    form.action = cell.dataset.openUrl;
    if (dayOverride) {
      const hidden = document.createElement("input");
      hidden.type = "hidden";
      hidden.name = "day_override";
      hidden.value = dayOverride;
      form.appendChild(hidden);
    }
    const button = document.createElement("button");
    button.type = "submit";
    button.textContent = "Open";
    button.dataset.day = day;
    form.appendChild(button);
    content.appendChild(form);
    const hint = document.createElement("small");
    hint.className = "advent-hint";
    hint.textContent = "Ready to unlock";
    content.appendChild(hint);
    updateBadge(cell, "‚òÖ", true);
    bindOpenForm(form);
  }

  function handleOpenError(cell, button, message) {
    if (cell) {
      cell.classList.remove("unlocking");
    }
    if (button) {
      button.disabled = false;
      button.textContent = "Open";
    }
    alert(message || "Something went wrong opening this day.");
  }

  function bindOpenForm(form) {
    form.addEventListener("submit", (event) => {
      event.preventDefault();
      const cell = form.closest(".advent-cell");
      const button = form.querySelector("button[type='submit']");
      if (cell) {
        cell.classList.add("unlocking");
        createMagicBurst(cell);
      }
      if (button) {
        button.disabled = true;
        button.textContent = "Opening...";
      }

      const formData = new FormData(form);
      fetch(form.action, {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "X-Requested-With": "XMLHttpRequest",
        },
        body: formData,
      })
        .then((resp) => resp.json())
        .then((payload) => {
          if (payload.status === "ok") {
            playDoorCelebration(cell).then(() => {
              convertCellToOpened(cell, payload);
              activateNextCell(payload.next_openable_day);
              updateStatsUI(payload);
              updateQuestUI(payload.quests || []);
              setTimeout(
                () => openModal(payload.day, payload.message, buildStampUrl(payload.stamp_png)),
                MODAL_DELAY_AFTER_REVEAL_MS
              );
            });
          } else {
            handleOpenError(cell, button, payload.reason);
          }
        })
        .catch(() => handleOpenError(cell, button));
    });
  }

  function initAdventSnow() {
    const snowLayer = document.getElementById("advent-snow-layer");
    if (!snowLayer) return;
    const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)");
    if (prefersReducedMotion.matches) {
      snowLayer.innerHTML = "";
      snowLayer.hidden = true;
      return;
    }

    snowLayer.hidden = false;
    snowLayer.innerHTML = "";
    const flakeCount = window.matchMedia("(max-width: 640px)").matches ? 32 : 80;
    for (let i = 0; i < flakeCount; i++) {
      const flake = document.createElement("span");
      flake.className = "advent-snowflake";
      flake.style.left = `${Math.random() * 100}%`;
      flake.style.animationDelay = `${Math.random() * 12}s`;
      flake.style.setProperty("--size", `${4 + Math.random() * 12}px`);
      flake.style.setProperty("--duration", `${10 + Math.random() * 10}s`);
      flake.style.setProperty("--opacity", (0.25 + Math.random() * 0.55).toFixed(2));
      flake.style.setProperty("--scale", (0.55 + Math.random() * 1).toFixed(2));
      flake.style.setProperty("--drift", `${(Math.random() - 0.5) * 180}px`);
      snowLayer.appendChild(flake);
    }
  }

  document.querySelectorAll(".open-day-form").forEach(bindOpenForm);
  initAdventSnow();
  window.addEventListener("resize", () => {
    clearTimeout(snowResizeTimer);
    snowResizeTimer = setTimeout(initAdventSnow, 500);
  });
})();
</script>

{% endblock %}
