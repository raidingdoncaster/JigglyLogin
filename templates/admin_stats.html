{% extends "base.html" %}

{% block page_settings %}
  {% set container_class = 'is-wide' %}
{% endblock %}

{% block content %}

<h1>üìä RDAB Stats</h1>

<!-- Summary Cards -->
<div class="stats-summary">
  <div class="stat-card">
    <h3>{{ total_meetups }}</h3>
    <p>Total Meet-ups</p>
  </div>
  <div class="stat-card">
    <h3>{{ total_attendances }}</h3>
    <p>Total Attendances</p>
  </div>
  <div class="stat-card">
    <h3>{{ highlights.unique_attendees }}</h3>
    <p>Unique Attendees</p>
  </div>
  <div class="stat-card">
    <h3>{{ highlights.avg_attendance }}</h3>
    <p>Avg Attendance / Meetup</p>
  </div>
</div>

<!-- Engagement Highlights -->
<h2>‚ú® Engagement Highlights</h2>
<div class="highlight-grid">
  <div class="highlight">
    <strong>{{ highlights.meetups_with_checkins }}</strong>
    <p>Meetups with Check-ins</p>
  </div>
  <div class="highlight">
    <strong>{{ highlights.returning_pct }}%</strong>
    <p>Returning Attendees</p>
  </div>
</div>

<!-- Top Meetups -->
<h2>üèÜ Top Attended Meet-ups</h2>
<canvas id="topMeetupsChart" height="200"></canvas>
<div class="table-scroll">
  <table class="stats-table">
    <thead>
      <tr>
        <th>Meet-up</th>
        <th>Date</th>
        <th>Attendances</th>
      </tr>
    </thead>
    <tbody>
      {% for m in top_meetups %}
      <tr>
        <td>{{ m.name }}</td>
        <td>{{ m.date|to_date }}</td>
        <td>{{ m.count }}</td>
      </tr>
      {% else %}
      <tr><td colspan="3">No data available.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Top Trainers -->
<h2>üí™ Top Trainers by Attendance</h2>
<canvas id="topTrainersChart" height="200"></canvas>
<div class="table-scroll">
  <table class="stats-table">
    <thead>
      <tr>
        <th>Trainer</th>
        <th>Attendances</th>
      </tr>
    </thead>
    <tbody>
      {% for t in top_trainers %}
      <tr>
        <td>{{ t.trainer }}</td>
        <td>{{ t.count }}</td>
      </tr>
      {% else %}
      <tr><td colspan="2">No data available.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Growth Trends -->
<h2>üìà Growth Trends</h2>
<canvas id="growthChart" height="200"></canvas>

<!-- Distributions -->
<h2>üßæ Stamp Distribution</h2>
<canvas id="stampChart" height="200"></canvas>

<h2>üë§ Account Types</h2>
<canvas id="accountChart" height="200"></canvas>

<style>
.stats-summary {display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:24px;}
.stat-card {background:#fff;border-radius:16px;padding:18px;text-align:center;box-shadow:0 10px 24px rgba(15,23,42,0.12);}
.stat-card h3 { margin:0; font-size:1.6em; color:#1d4ed8; }
.stat-card p { margin:6px 0 0; font-size:0.9em; color:#64748b; }

.highlight-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:24px;}
.highlight {background:#fff;padding:18px;border-radius:16px;text-align:center;box-shadow:0 10px 24px rgba(15,23,42,0.12);}
.highlight strong { font-size:1.3em; color:#2563eb; }

.table-scroll{overflow-x:auto;border-radius:16px;box-shadow:0 10px 24px rgba(15,23,42,0.12);margin:16px 0;}
.stats-table { width:100%; border-collapse:separate; border-spacing:0; min-width:520px; }
.stats-table th { text-align:left; font-size:0.85rem; font-weight:700; padding:12px 14px; background:#f1f5f9; color:#1f2937; }
.stats-table td { padding:12px 14px; border-top:1px solid #e2e8f0; font-size:0.9rem; color:#334155; }
.stats-table tbody tr:nth-child(even){ background:#f8fafc; }
.stats-table tbody tr:hover{ background:#eef2ff; }
</style>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Top Meetups
  new Chart(document.getElementById("topMeetupsChart"), {
    type: "bar",
    data: {
      labels: {{ top_meetups | map(attribute="name") | list | tojson }},
      datasets: [{
        label: "Attendances",
        data: {{ top_meetups | map(attribute="count") | list | tojson }},
        backgroundColor: "#3a8dde"
      }]
    },
    options: { responsive: true, plugins: { legend: { display:false } } }
  });

  // Top Trainers
  new Chart(document.getElementById("topTrainersChart"), {
    type: "bar",
    data: {
      labels: {{ top_trainers | map(attribute="trainer") | list | tojson }},
      datasets: [{
        label: "Attendances",
        data: {{ top_trainers | map(attribute="count") | list | tojson }},
        backgroundColor: "#5eb8ff"
      }]
    },
    options: { responsive: true, plugins: { legend: { display:false } } }
  });

  // Growth Trends
  new Chart(document.getElementById("growthChart"), {
    type: "line",
    data: {
      labels: {{ growth_labels | tojson }},
      datasets: [
        { label: "Meet-ups", data: {{ growth_events | tojson }}, borderColor: "#3a8dde", fill:false },
        { label: "Attendances", data: {{ growth_attend | tojson }}, borderColor: "#ff9900", fill:false }
      ]
    },
    options: { responsive: true }
  });

  // Stamp Distribution
  new Chart(document.getElementById("stampChart"), {
    type: "pie",
    data: {
      labels: {{ stamp_labels | tojson }},
      datasets: [{
        data: {{ stamp_counts | tojson }},
        backgroundColor: ["#3a8dde","#5eb8ff","#87cefa","#b0e0e6"]
      }]
    }
  });

  // Account Types
  new Chart(document.getElementById("accountChart"), {
    type: "pie",
    data: {
      labels: {{ account_labels | tojson }},
      datasets: [{
        data: {{ account_counts | tojson }},
        backgroundColor: ["#3a8dde","#ff9900","#77dd77","#ff6961"]
      }]
    }
  });
});
</script>

{% endblock %}
